MWF.widget=MWF.widget||{};MWF.widget.ImageClipper=MWF.ImageClipper=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",path:MWF.defaultPath+"/widget/$ImageClipper/",imageUrl:"",editorSize:400,aspectRatio:1,frameMinSize:30,previewerSize:300,resultMaxSize:800,showPreviewer:true,formLocalEnable:true,formFileEnable:true,resetEnable:false},initialize:function(t,e){this.node=t;this.setOptions(e);this.path=this.options.path||MWF.defaultPath+"/widget/$ImageClipper/";this.cssPath=this.path+this.options.style+"/css.wcss";this._loadCss();this.fireEvent("init")},load:function(t){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node);this.container.addEvent("selectstart",function(t){t.preventDefault();t.stopPropagation()});if(!this.checkBroswer())return;this.lastPoint=null;this.loadToolBar();this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.container);this.loadEditorNode();this.loadResultNode();if(this.options.imageUrl){this.loadImageAsUrl(this.options.imageUrl)}if(t){this.loadImageAsFile(this.base64ToBlob(t))}},getFormData:function(){var t=new FormData;t.append("file",this.resizedImage);return t},getResizedImage:function(){return this.resizedImage},getBase64Code:function(){return this.base64Code},getBase64Image:function(){if(!this.base64Code)return null;return"data:image/png;base64,"+this.base64Code},checkBroswer:function(){if(Uint8Array&&HTMLCanvasElement&&atob&&Blob){this.available=true;return true}else{this.available=false;this.container.set("html","<p>您的浏览器不支持以下特性:</p><ul><li>canvas</li><li>Blob</li><li>Uint8Array</li><li>FormData</li><li>atob</li></ul>");return false}},close:function(){this.docBody.removeEvent("touchmove",this.bodyMouseMoveFun);this.docBody.removeEvent("mousemove",this.bodyMouseMoveFun);this.docBody.removeEvent("touchend",this.bodyMouseEndFun);this.docBody.removeEvent("mouseup",this.bodyMouseEndFun);this.container.destroy();delete this},loadToolBar:function(){this.uploadToolbar=new Element("div.uploadToolbar",{styles:this.css.uploadToolbar}).inject(this.container);if(this.options.formLocalEnable){this.uploadLocalImage=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:"选择本地图片"}).inject(this.uploadToolbar);this.uploadLocalImage.addEvents({click:function(){this.fileNode.click()}.bind(this)});this.fileNode=new Element("input.file",{type:"file",accept:"images/*",styles:{display:"none"}}).inject(this.container);this.fileNode.addEvent("change",function(t){var e=this.fileNode.files[0];this.loadImageAsFile(e)}.bind(this))}this._createUploadButtom();if(this.options.formFileEnable){this.uploadCloudFile=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:"选择云文件图片"}).inject(this.uploadToolbar);this.uploadCloudFile.addEvents({click:function(){this.selectFileImage(function(t,e){this.loadImageAsUrl(t)}.bind(this))}.bind(this)})}if(this.options.resetEnable){this.resetAction=new Element("button.resetAction",{styles:this.css.resetActionNode,text:"重置"}).inject(this.uploadToolbar);this.resetAction.addEvents({click:function(){this.reset()}.bind(this)})}},_createUploadButtom:function(){},reset:function(){this.resizedImage="";this.base64Code="";this.resetImage();this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});this.resultNode.empty();this.editorContainer.setStyles(this.css.editorContainer);this.imageNode.setStyle("display","none");this.innerNode.setStyles({width:0,height:0})},selectFileImage:function(t,e){var i=this;MWF.xDesktop.requireApp("File","FileSelector",function(){i.selector_cloud=new MWF.xApplication.File.FileSelector(document.body,{style:"default",title:"选择云文件图片",listStyle:"preview",toBase64:false,selectType:"images",onPostSelectAttachment:function(e,i){if(t)t(e,i)}});i.selector_cloud.load()},true)},loadResultNode:function(){if(this.options.showPreviewer){this.resultContainer=new Element("div",{styles:this.css.resultContainer}).inject(this.contentNode);var t=Math.max(this.options.editorSize,this.options.previewerSize)-parseInt(this.resultContainer.getStyle("padding-left"))*2;this.resultContainer.setStyles({width:this.options.previewerSize+"px",height:t+"px"});this.resultTitleNode=new Element("div",{styles:this.css.resultTitleNode,text:"预览"}).inject(this.resultContainer);var e=this.resultTitleNode.getSize().y;var i=this.options.aspectRatio?this.options.previewerSize/this.options.aspectRatio:this.options.previewerSize;this.resultNode=new Element("div.resultNode",{styles:this.css.resultNode}).inject(this.resultContainer);this.resultNode.setStyles({"padding-top":(t-e-i)/2-10+"px"})}else{this.resultNode=new Element("div",{styles:{display:"none"}}).inject(this.contentNode)}},loadEditorNode:function(){this.docBody=window.document.body;this.editorContainer=new Element("div.editorContainer",{styles:this.css.editorContainer}).inject(this.contentNode);this.editorContainer.setStyles({width:this.options.editorSize+"px",height:this.options.editorSize+"px"});this.editorNode=new Element("div.editorNode",{styles:this.css.editorNode}).inject(this.editorContainer);this.innerNode=new Element("div.innerNode",{styles:this.css.innerNode}).inject(this.editorNode);this.imageNode=new Element("img",{styles:this.css.imageNode}).inject(this.innerNode);this.imageNode.ondragstart=function(){return false};this.frameNode=new Element("div.frameNode",{styles:this.css.frameNode}).inject(this.innerNode);this.frameOffset={top:0,left:0};this.frameNode.addEvents({touchstart:function(t){this.getOffset(t)}.bind(this),mousedown:function(t){this.getOffset(t)}.bind(this),touchmove:function(t){if(!this.lastPoint)return;var e=this.getOffset(t);if(this.resizeMode){this.resizeFrames(e)}else{this.moveFrames(e)}t.stopPropagation()}.bind(this),mousemove:function(t){if(!this.lastPoint)return;var e=this.getOffset(t);if(this.resizeMode){this.resizeFrames(e)}else{this.moveFrames(e)}t.stopPropagation()}.bind(this),touchend:function(t){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false}this.clipImage();t.stopPropagation()}.bind(this),mouseup:function(t){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false}this.clipImage();t.stopPropagation()}.bind(this)});this.reizeNode=new Element("div.reizeNode",{styles:this.css.reizeNode}).inject(this.frameNode);this.reizeNode.addEvents({touchstart:function(t){this.frameNode.setStyle("cursor","nw-resize");this.docBody.setStyle("cursor","nw-resize");this.resizeMode=true;this.getOffset(t);t.stopPropagation()}.bind(this),mousedown:function(t){this.frameNode.setStyle("cursor","nw-resize");this.docBody.setStyle("cursor","nw-resize");this.resizeMode=true;this.getOffset(t);t.stopPropagation()}.bind(this),touchmove:function(t){if(!this.lastPoint)return;var e=this.getOffset(t);this.resizeFrames(e);t.stopPropagation()}.bind(this),mousemove:function(t){if(!this.lastPoint)return;var e=this.getOffset(t);this.resizeFrames(e);t.stopPropagation()}.bind(this),touchend:function(t){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.lastPoint=null;this.clipImage();t.stopPropagation()}.bind(this),mouseup:function(t){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.lastPoint=null;this.clipImage();t.stopPropagation()}.bind(this)});this.bodyMouseMoveFun=this.bodyMouseMove.bind(this);this.docBody.addEvent("touchmove",this.bodyMouseMoveFun);this.docBody.addEvent("mousemove",this.bodyMouseMoveFun);this.bodyMouseEndFun=this.bodyMouseEnd.bind(this);this.docBody.addEvent("touchend",this.bodyMouseEndFun);this.docBody.addEvent("mouseup",this.bodyMouseEndFun)},bodyMouseMove:function(t){if(!this.lastPoint)return;if(this.resizeMode){var e=this.getOffset(t);this.resizeFrames(e)}},bodyMouseEnd:function(t){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.clipImage()}},clipImage:function(){this.resultNode.empty();var t=this.imageNode.naturalHeight,e=this.imageNode.naturalWidth,i=this.options.resultMaxSize,s,o;o=this.options.aspectRatio?this.options.aspectRatio:this.frameOffset.size.width/this.frameOffset.size.height;if(i==0||t<=i&&e<=i){s=this.getRatioMaxSize(e,t,o)}else{var n=Math.min(i,t,e);s=this.getRatioMaxSize(n,n,o)}var h=new Element("canvas",s);var a=h.getContext("2d"),r=e/this.offset.width,d=this.frameOffset.left*r,l=this.frameOffset.top*r,f=this.frameOffset.size.width*r,u=this.frameOffset.size.height*r;a.drawImage(this.imageNode,d,l,f,u,0,0,s.width,s.height);var c=h.toDataURL();this.canvas=h;h.inject(this.resultNode);c=c.split(",")[1];if(!c){this.resizedImage=null;this.base64Code="";return}this.base64Code=c;c=window.atob(c);var m=new Uint8Array(c.length);for(var p=0;p<c.length;p++){m[p]=c.charCodeAt(p)}this.resizedImage=new Blob([m],{type:"image/png"});var n=Math.min(this.options.previewerSize,t,e);s=this.getRatioMaxSize(n,n,o);h.setStyles({width:s.width+"px",height:s.height+"px"})},loadImageAsFile:function(t){this.resetImage();this.editorContainer.setStyles(this.css.editorContainer_active);this.imageNode.setStyle("display","");this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});var e=new FileReader;e.onload=function(){this.imageNode.src=e.result;e=null;this.onImageLoad()}.bind(this);e.readAsDataURL(t)},loadImageAsUrl:function(t){this.resetImage();this.editorContainer.setStyles(this.css.editorContainer_active);this.imageNode.setStyle("display","");this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});this.onImageLoadFun=this.onImageLoad.bind(this);this.imageNode.addEvent("load",this.onImageLoadFun);this.imageNode.src=t},onImageLoad:function(){var t=this.imageNode.naturalHeight,e=this.imageNode.naturalWidth;if(isNaN(t)||isNaN(e)||t==0||e==0){setTimeout(function(){this.onImageLoad()}.bind(this),100)}else{this._onImageLoad()}},_onImageLoad:function(){this.setImageSize();this.setFrameSize(this.getDefaultSize());this.clipImage();if(this.onImageLoadFun){this.imageNode.removeEvent("load",this.onImageLoadFun);this.onImageLoadFun=null}},resetImage:function(){this.imageNode.src="";if(this.canvas)this.canvas.destroy()},setImageSize:function(){var t=this.imageNode.naturalHeight,e=this.imageNode.naturalWidth,i;if(e>t){i={width:this.options.editorSize,height:this.options.editorSize*(t/e)}}else{i={width:this.options.editorSize*(e/t),height:this.options.editorSize}}this.offset=i;this.imageNode.setStyles(i)},setFrameSize:function(t){this.frameOffset.size=t;return this.frameNode.setStyles({width:t.width+"px",height:t.height+"px"})},getDefaultSize:function(){this.innerNode.setStyles({width:this.offset.width,height:this.offset.height,"margin-left":(this.options.editorSize-this.offset.width)/2+"px","margin-top":(this.options.editorSize-this.offset.height)/2+"px"});if(this.options.aspectRatio){return this.getRatioMaxSize(this.offset.width,this.offset.height)}else{var t=Math.min(this.offset.width,this.offset.height);return{width:t,height:t}}},getRatioMaxSize:function(t,e,i){if(!i)i=this.options.aspectRatio;var s=t/e;if(s>i){return{width:e*i,height:e}}else{return{width:t,height:t/i}}},resizeFrames:function(t){var e=t.x;if(e==0)return;var i=t.y;if(i==0)return;var s=this.frameOffset.top,o=this.frameOffset.left,n=this.frameOffset.size,h=this.offset.width,a=this.offset.height,r=this.options.aspectRatio,d,l;if(r){if(Math.abs(e)/Math.abs(i)>r){if(e+n.width+o>h){return}else{d=e+n.width;l=d/r;if(l+s>a){return}}}else{if(i+n.height+s>a){return}else{l=i+n.height;d=l*r}if(d+o>h){return}}}else{if(e+n.width+o>h){return}else{d=e+n.width}if(i+n.height+s>a){return}else{l=i+n.height}}var f=this.options.frameMinSize;var u=r?f/r:f;d=d<f?f:d;l=l<u?u:l;this.frameNode.setStyles({width:d+"px",height:l+"px"});this.frameOffset.size={width:d,height:l}},moveFrames:function(t){var e=t.x,i=t.y,s=this.frameOffset.top,o=this.frameOffset.left,n=this.frameOffset.size,h=this.offset.width,a=this.offset.height;if(e+n.width+o>h){e=h-n.width}else{e=e+o}if(i+n.height+s>a){i=a-n.height}else{i=i+s}e=e<0?0:e;i=i<0?0:i;this.frameNode.setStyles({top:i+"px",left:e+"px"});this.frameOffset.top=i;this.frameOffset.left=e},getOffset:function(t){t=t.event;var e,i;if(t.touches){var s=t.touches[0];e=s.clientX;i=s.clientY}else{e=t.clientX;i=t.clientY}if(!this.lastPoint){this.lastPoint={x:e,y:i}}var o={x:e-this.lastPoint.x,y:i-this.lastPoint.y};this.lastPoint={x:e,y:i};return o},base64ToBlob:function(t){if(t.substr(0,10)=="data:image"){var e=window.atob(t.split(",")[1])}else{var e=window.atob(t)}var i=new ArrayBuffer(e.length);var s=new Uint8Array(i);for(var o=0;o<e.length;o++){s[o]=e.charCodeAt(o)}return new Blob([i],{type:"image/png"})}});