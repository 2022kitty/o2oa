MWF.widget=MWF.widget||{};MWF.widget.ImageClipper=MWF.ImageClipper=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",path:MWF.defaultPath+"/widget/$ImageClipper/",imageUrl:"",editorSize:400,aspectRatio:1,frameMinSize:30,previewerSize:300,resultMaxSize:800,reference:"",referenceType:"",showPreviewer:true,formLocalEnable:true,formFileEnable:true,resetEnable:false},initialize:function(e,t){this.node=e;this.setOptions(t);this.path=this.options.path||MWF.defaultPath+"/widget/$ImageClipper/";this.cssPath=this.path+this.options.style+"/css.wcss";this.fileName="untitled.png";this.fileType="image/png";this.fileSize=null;this._loadCss();this.fireEvent("init")},load:function(e){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node);this.container.addEvent("selectstart",function(e){e.preventDefault();e.stopPropagation()});if(!this.checkBroswer())return;this.lastPoint=null;this.loadToolBar();this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.container);this.loadEditorNode();this.loadResultNode();if(this.options.imageUrl){this.loadImageAsUrl(this.options.imageUrl)}if(e){this.loadImageAsFile(this.base64ToBlob(e))}},uploadImage:function(e,t){if(this.resizedImage){MWF.xDesktop.uploadImageByScale(this.options.reference,this.options.referenceType,800,this.getFormData(),this.resizedImage,e,t)}else{}},getFormData:function(){var e=new FormData;e.append("file",this.resizedImage,this.fileName);return e},getResizedImage:function(){return this.resizedImage},getBase64Code:function(){return this.base64Code},getBase64Image:function(){if(!this.base64Code)return null;return"data:"+this.fileType+";base64,"+this.base64Code},checkBroswer:function(){if(Uint8Array&&HTMLCanvasElement&&atob&&Blob){this.available=true;return true}else{this.available=false;this.container.set("html","<p>您的浏览器不支持以下特性:</p><ul><li>canvas</li><li>Blob</li><li>Uint8Array</li><li>FormData</li><li>atob</li></ul>");return false}},close:function(){this.docBody.removeEvent("touchmove",this.bodyMouseMoveFun);this.docBody.removeEvent("mousemove",this.bodyMouseMoveFun);this.docBody.removeEvent("touchend",this.bodyMouseEndFun);this.docBody.removeEvent("mouseup",this.bodyMouseEndFun);this.container.destroy();delete this},loadToolBar:function(){this.uploadToolbar=new Element("div.uploadToolbar",{styles:this.css.uploadToolbar}).inject(this.container);if(this.options.formLocalEnable){this.uploadLocalImage=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:"选择本地图片"}).inject(this.uploadToolbar);this.uploadLocalImage.addEvents({click:function(){this.fileNode.click()}.bind(this)});this.fileNode=new Element("input.file",{type:"file",accept:"images/*",styles:{display:"none"}}).inject(this.container);this.fileNode.addEvent("change",function(e){var t=this.fileNode.files[0];this.fileType=t.type;this.fileName=t.name;this.fileSize=t.size;this.loadImageAsFile(t)}.bind(this))}this._createUploadButtom();if(this.options.formFileEnable){this.uploadCloudFile=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:"选择云文件图片"}).inject(this.uploadToolbar);this.uploadCloudFile.addEvents({click:function(){this.selectFileImage(function(e,t,i){this.fileName=i.name;this.fileType=["jpeg","jpg"].contains(i.extension.toLowerCase())?"image/jpeg":"image/png";this.fileSize=i.length;this.loadImageAsUrl(e)}.bind(this))}.bind(this)})}if(this.options.resetEnable){this.resetAction=new Element("button.resetAction",{styles:this.css.resetActionNode,text:"重置"}).inject(this.uploadToolbar);this.resetAction.addEvents({click:function(){this.reset()}.bind(this)})}},_createUploadButtom:function(){},reset:function(){this.fileName="untitled.png";this.fileType="image/png";this.fileSize=null;this.resizedImage="";this.base64Code="";this.resetImage();this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});this.resultNode.empty();this.editorContainer.setStyles(this.css.editorContainer);this.imageNode.setStyle("display","none");this.innerNode.setStyles({width:0,height:0})},selectFileImage:function(e){var t=this;MWF.xDesktop.requireApp("File","FileSelector",function(){t.selector_cloud=new MWF.xApplication.File.FileSelector(document.body,{style:"default",title:"选择云文件图片",copyToPublic:false,listStyle:"preview",selectType:"images",onPostSelectAttachment:function(t,i,s){if(e)e(t,i,s)}});t.selector_cloud.load()},true)},loadResultNode:function(){if(this.options.showPreviewer){this.resultContainer=new Element("div",{styles:this.css.resultContainer}).inject(this.contentNode);var e=Math.max(this.options.editorSize,this.options.previewerSize)-parseInt(this.resultContainer.getStyle("padding-left"))*2;this.resultContainer.setStyles({width:this.options.previewerSize+"px",height:e+"px"});this.resultTitleNode=new Element("div",{styles:this.css.resultTitleNode,text:"预览"}).inject(this.resultContainer);var t=this.resultTitleNode.getSize().y;var i=this.options.aspectRatio?this.options.previewerSize/this.options.aspectRatio:this.options.previewerSize;this.resultNode=new Element("div.resultNode",{styles:this.css.resultNode}).inject(this.resultContainer);this.resultNode.setStyles({"padding-top":(e-t-i)/2-10+"px"})}else{this.resultNode=new Element("div",{styles:{display:"none"}}).inject(this.contentNode)}},loadEditorNode:function(){this.docBody=window.document.body;this.editorContainer=new Element("div.editorContainer",{styles:this.css.editorContainer}).inject(this.contentNode);this.editorContainer.setStyles({width:this.options.editorSize+"px",height:this.options.editorSize+"px"});this.editorNode=new Element("div.editorNode",{styles:this.css.editorNode}).inject(this.editorContainer);this.innerNode=new Element("div.innerNode",{styles:this.css.innerNode}).inject(this.editorNode);this.imageNode=new Element("img",{styles:this.css.imageNode}).inject(this.innerNode);this.imageNode.ondragstart=function(){return false};this.frameNode=new Element("div.frameNode",{styles:this.css.frameNode}).inject(this.innerNode);this.frameOffset={top:0,left:0};this.frameNode.addEvents({touchstart:function(e){this.getOffset(e)}.bind(this),mousedown:function(e){this.getOffset(e)}.bind(this),touchmove:function(e){if(!this.lastPoint)return;var t=this.getOffset(e);if(this.resizeMode){this.resizeFrames(t)}else{this.moveFrames(t)}e.stopPropagation()}.bind(this),mousemove:function(e){if(!this.lastPoint)return;var t=this.getOffset(e);if(this.resizeMode){this.resizeFrames(t)}else{this.moveFrames(t)}e.stopPropagation()}.bind(this),touchend:function(e){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false}this.clipImage();e.stopPropagation()}.bind(this),mouseup:function(e){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false}this.clipImage();e.stopPropagation()}.bind(this)});this.reizeNode=new Element("div.reizeNode",{styles:this.css.reizeNode}).inject(this.frameNode);this.reizeNode.addEvents({touchstart:function(e){this.frameNode.setStyle("cursor","nw-resize");this.docBody.setStyle("cursor","nw-resize");this.resizeMode=true;this.getOffset(e);e.stopPropagation()}.bind(this),mousedown:function(e){this.frameNode.setStyle("cursor","nw-resize");this.docBody.setStyle("cursor","nw-resize");this.resizeMode=true;this.getOffset(e);e.stopPropagation()}.bind(this),touchmove:function(e){if(!this.lastPoint)return;var t=this.getOffset(e);this.resizeFrames(t);e.stopPropagation()}.bind(this),mousemove:function(e){if(!this.lastPoint)return;var t=this.getOffset(e);this.resizeFrames(t);e.stopPropagation()}.bind(this),touchend:function(e){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.lastPoint=null;this.clipImage();e.stopPropagation()}.bind(this),mouseup:function(e){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.lastPoint=null;this.clipImage();e.stopPropagation()}.bind(this)});this.bodyMouseMoveFun=this.bodyMouseMove.bind(this);this.docBody.addEvent("touchmove",this.bodyMouseMoveFun);this.docBody.addEvent("mousemove",this.bodyMouseMoveFun);this.bodyMouseEndFun=this.bodyMouseEnd.bind(this);this.docBody.addEvent("touchend",this.bodyMouseEndFun);this.docBody.addEvent("mouseup",this.bodyMouseEndFun)},bodyMouseMove:function(e){if(!this.lastPoint)return;if(this.resizeMode){var t=this.getOffset(e);this.resizeFrames(t)}},bodyMouseEnd:function(e){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.clipImage()}},clipImage:function(){this.resultNode.empty();var e=this.imageNode.naturalHeight,t=this.imageNode.naturalWidth,i=this.options.resultMaxSize,s,o;o=this.options.aspectRatio?this.options.aspectRatio:this.frameOffset.size.width/this.frameOffset.size.height;if(i==0||e<=i&&t<=i){s=this.getRatioMaxSize(t,e,o)}else{var n=Math.min(i,e,t);s=this.getRatioMaxSize(n,n,o)}var h=new Element("canvas",s);var a=h.getContext("2d"),r=t/this.offset.width,d=this.frameOffset.left*r,l=this.frameOffset.top*r,f=this.frameOffset.size.width*r,u=this.frameOffset.size.height*r;a.drawImage(this.imageNode,d,l,f,u,0,0,s.width,s.height);var c=h.toDataURL(this.fileType);this.canvas=h;h.inject(this.resultNode);c=c.split(",")[1];if(!c){this.resizedImage=null;this.base64Code="";return}this.base64Code=c;c=window.atob(c);var m=new Uint8Array(c.length);for(var p=0;p<c.length;p++){m[p]=c.charCodeAt(p)}this.resizedImage=new Blob([m],{type:this.fileType});var n=Math.min(this.options.previewerSize,e,t);s=this.getRatioMaxSize(n,n,o);h.setStyles({width:s.width+"px",height:s.height+"px"})},loadImageAsFile:function(e){this.resetImage();this.editorContainer.setStyles(this.css.editorContainer_active);this.imageNode.setStyle("display","");this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});var t=new FileReader;t.onload=function(){this.imageNode.src=t.result;t=null;this.onImageLoad()}.bind(this);t.readAsDataURL(e)},loadImageAsUrl:function(e){this.resetImage();this.editorContainer.setStyles(this.css.editorContainer_active);this.imageNode.setStyle("display","");this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});this.onImageLoadFun=this.onImageLoad.bind(this);this.imageNode.addEvent("load",this.onImageLoadFun);this.imageNode.src=e},onImageLoad:function(){debugger;var e=this.imageNode.naturalHeight,t=this.imageNode.naturalWidth;if(isNaN(e)||isNaN(t)||e==0||t==0){setTimeout(function(){this.onImageLoad()}.bind(this),100)}else{this._onImageLoad()}},_onImageLoad:function(){this.setImageSize();this.setFrameSize(this.getDefaultSize());this.clipImage();if(this.onImageLoadFun){this.imageNode.removeEvent("load",this.onImageLoadFun);this.onImageLoadFun=null}},resetImage:function(){this.imageNode.src="";if(this.canvas)this.canvas.destroy()},setImageSize:function(){var e=this.imageNode.naturalHeight,t=this.imageNode.naturalWidth,i;if(t>e){i={width:this.options.editorSize,height:this.options.editorSize*(e/t)}}else{i={width:this.options.editorSize*(t/e),height:this.options.editorSize}}this.offset=i;this.imageNode.setStyles(i)},setFrameSize:function(e){this.frameOffset.size=e;return this.frameNode.setStyles({width:e.width+"px",height:e.height+"px"})},getDefaultSize:function(){this.innerNode.setStyles({width:this.offset.width,height:this.offset.height,"margin-left":(this.options.editorSize-this.offset.width)/2+"px","margin-top":(this.options.editorSize-this.offset.height)/2+"px"});if(this.options.aspectRatio){return this.getRatioMaxSize(this.offset.width,this.offset.height)}else{return{width:this.offset.width,height:this.offset.height}}},getRatioMaxSize:function(e,t,i){if(!i)i=this.options.aspectRatio;var s=e/t;if(s>i){return{width:t*i,height:t}}else{return{width:e,height:e/i}}},resizeFrames:function(e){var t=e.x;if(t==0)return;var i=e.y;if(i==0)return;var s=this.frameOffset.top,o=this.frameOffset.left,n=this.frameOffset.size,h=this.offset.width,a=this.offset.height,r=this.options.aspectRatio,d,l;if(r){if(Math.abs(t)/Math.abs(i)>r){if(t+n.width+o>h){return}else{d=t+n.width;l=d/r;if(l+s>a){return}}}else{if(i+n.height+s>a){return}else{l=i+n.height;d=l*r}if(d+o>h){return}}}else{if(t+n.width+o>h){return}else{d=t+n.width}if(i+n.height+s>a){return}else{l=i+n.height}}var f=this.options.frameMinSize;var u=r?f/r:f;d=d<f?f:d;l=l<u?u:l;this.frameNode.setStyles({width:d+"px",height:l+"px"});this.frameOffset.size={width:d,height:l}},moveFrames:function(e){var t=e.x,i=e.y,s=this.frameOffset.top,o=this.frameOffset.left,n=this.frameOffset.size,h=this.offset.width,a=this.offset.height;if(t+n.width+o>h){t=h-n.width}else{t=t+o}if(i+n.height+s>a){i=a-n.height}else{i=i+s}t=t<0?0:t;i=i<0?0:i;this.frameNode.setStyles({top:i+"px",left:t+"px"});this.frameOffset.top=i;this.frameOffset.left=t},getOffset:function(e){e=e.event;var t,i;if(e.touches){var s=e.touches[0];t=s.clientX;i=s.clientY}else{t=e.clientX;i=e.clientY}if(!this.lastPoint){this.lastPoint={x:t,y:i}}var o={x:t-this.lastPoint.x,y:i-this.lastPoint.y};this.lastPoint={x:t,y:i};return o},base64ToBlob:function(e){if(e.substr(0,10)=="data:image"){var t=window.atob(e.split(",")[1])}else{var t=window.atob(e)}var i=new ArrayBuffer(t.length);var s=new Uint8Array(i);for(var o=0;o<t.length;o++){s[o]=t.charCodeAt(o)}return new Blob([i],{type:this.fileType})}});