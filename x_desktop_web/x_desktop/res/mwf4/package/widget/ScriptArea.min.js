MWF.widget=MWF.widget||{};MWF.require("MWF.widget.ScriptEditor",null,false);MWF.require("MWF.widget.JavascriptEditor",null,false);MWF.widget.ScriptArea=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{title:"ScriptArea",style:"default",helpStyle:"default",maxObj:document.body},initialize:function(t,e){this.setOptions(e);this.node=$(t);this.container=new Element("div");this.path=MWF.defaultPath+"/widget/$ScriptArea/";this.cssPath=MWF.defaultPath+"/widget/$ScriptArea/"+this.options.style+"/css.wcss";this._loadCss()},load:function(t){if(this.fireEvent("queryLoad")){this.container.set("styles",this.css.container);this.container.inject(this.node);this.createTitleNode();this.createContent(t);this.fireEvent("postLoad")}},createTitleNode:function(){this.titleNode=new Element("div",{styles:this.css.titleNode,events:{dblclick:this.toggleSize.bind(this)}}).inject(this.container);this.titleActionNode=new Element("div",{styles:this.css.titleActionNode,events:{click:this.toggleSize.bind(this)}}).inject(this.titleNode);this.referenceNode=new Element("div",{styles:this.css.referenceNode}).inject(this.titleNode);this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode)},toggleSize:function(t){var e=this.titleActionNode.retrieve("status","max");if(e=="max"){this.maxSize()}else{this.returnSize()}},maxSize:function(){var t=this.options.maxObj;var e=t.getCoordinates(t.getOffsetParent());this.container.store("size",{height:this.container.getStyle("height"),width:this.container.getStyle("width")});this.jsEditor.showLineNumbers();this.jsEditor.max();this.container.setStyles({position:"absolute",top:e.top,left:e.left,width:e.width,height:e.height-2,"z-index":20001});this.resizeContentNodeSize();this.titleActionNode.setStyle("background","url("+this.path+this.options.style+"/icon/return.png) center center no-repeat");this.titleActionNode.store("status","return")},returnSize:function(){var t=this.container.retrieve("size");this.editor.setOption("lineNumbers",false);this.container.setStyles({position:"static",top:0,left:0,width:t.width,height:t.height});this.resizeContentNodeSize();this.titleActionNode.setStyle("background","url("+this.path+this.options.style+"/icon/max.png) center center no-repeat");this.titleActionNode.store("status","max")},resizeContentNodeSize:function(){var t=this.titleNode.getSize();var e=this.container.getSize();var i=e.y-t.y-2-6;this.contentNode.setStyle("height",""+i+"px");if(this.editor)this.editor.resize()},toJson:function(){return this.editor?{code:this.editor.getValue(),html:this.editor.getValue()}:this.contentCode},createContent:function(t){this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container);this.resizeContentNodeSize();var e=new Element("div",{styles:this.css.inforNode,text:"点击此处，编写脚本代码"}).inject(this.contentNode);if(!t||!t.code){this.referenceNode.setStyle("background","url("+MWF.defaultPath+"/widget/$ScriptArea/"+this.options.style+"/icon/reference_empty.png) center center no-repeat")}this.contentCode=t;var i=this;e.addEvent("click",function(){this.destroy();i.loadEditor(t)})},loadEditor:function(t){var e=t?t.code:"";e=e?e:"";this.jsEditor=new MWF.widget.JavascriptEditor(this.contentNode,{option:{value:e,lineNumbers:false},onPostLoad:function(){this.editor=this.jsEditor.editor;this.editor.on("change",function(){this.fireEvent("change")}.bind(this));this.fireEvent("postLoad")}.bind(this),onSave:function(){this.fireEvent("change");this.fireEvent("save")}.bind(this)});this.jsEditor.load();this.createScriptReferenceMenu();this.jsEditor.addEvent("reference",function(t,e,i){if(!this.scriptReferenceMenu){this.createScriptReferenceMenu(this.showReferenceMenu.bind(this))}else{this.showReferenceMenu()}}.bind(this));this.referenceNode.setStyle("background","url("+MWF.defaultPath+"/widget/$ScriptArea/"+this.options.style+"/icon/reference.png) center center no-repeat")},createScriptReferenceMenu:function(t){MWF.require("MWF.widget.ScriptHelp",function(){this.scriptReferenceMenu=new MWF.widget.ScriptHelp(this.referenceNode,this.jsEditor.editor,{style:this.options.helpStyle,event:"click",onPostLoad:function(){if(t)t()}.bind(this)});this.scriptReferenceMenu.getEditor=function(){return this.jsEditor.editor}.bind(this)}.bind(this))},showReferenceMenu:function(){var t=this.jsEditor.getCursorPixelPosition();var e={page:{}};e.page.x=t.left;e.page.y=t.top;this.scriptReferenceMenu.menu.showIm(e)},focus:function(){if(this.editor)this.editor.focus()}});