MWF.xDesktop=MWF.xDesktop||{};MWF.xDesktop.requireApp=function(t,e,i,s){var n=t.split(".");var o="x_component_"+n.join("_");var a=e||"Main";path="/"+o+"/"+a.replace(/\./g,"/")+".js";COMMON.AjaxModule.load(path,i,s)};MWF.xApplication=MWF.xApplication||{};MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.xDesktop.Common",null,false);MWF.require("MWF.xDesktop.Menu",null,false);MWF.require("MWF.widget.UUID",null,false);MWF.require("MWF.xDesktop.Lnk",null,false);MWF.require("MWF.xDesktop.Actions.RestActions",null,false);MWF.require("MWF.xDesktop.Authentication",null,false);MWF.require("MWF.xDesktop.Message",null,false);MWF.require("MWF.xDesktop.UserData",null,false);MWF.require("MWF.xDesktop.shortcut",null,false);MWF.xDesktop.requireApp("Common","",null,false);MWF.xDesktop.requireApp("Common","Widget",null,false);MWF.require("MWF.xDesktop.WebSocket",null,false);MWF.require("MWF.xDesktop.Access",null,false);MWF.xDesktop.Layout=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",topShim:"layout_top_shim",top:"layout_top",desktop:"layout_desktop",content:"desktop_content",navi:"desktop_navi"},categoryCount:20,processCount:40,initialize:function(t,e){this.setOptions(e);this.type="layout";this.initData(function(){this.authentication=new MWF.xDesktop.Authentication({onLogin:this.load.bind(this)});this.authentication.isAuthenticated(function(e){this.session.user=e.data;MWF.UD.getData("layout",function(e){if(e.data){this.status=JSON.decode(e.data);if(this.status.style)this.options.style=this.status.style;this.initNode(t);this.load()}else{MWF.UD.getPublicData("defaultLayout",function(e){if(e){this.status=e;if(this.status.style)this.options.style=this.status.style}this.initNode(t);this.load()}.bind(this))}}.bind(this))}.bind(this),function(){this.initNode(t);this.load()}.bind(this))}.bind(this))},initNode:function(t){this.path=MWF.defaultPath+"/xDesktop/$Layout/";this.cssPath=MWF.defaultPath+"/xDesktop/$Layout/"+this.options.style+"/css.wcss";this._loadCss();this.node=$(t);this.topShimNode=this.node.getElement("#"+this.options.topShim);this.topNode=this.node.getElement("#"+this.options.top);this.topAreaNode=this.node.getElement("#"+this.options.top);this.desktopNode=this.node.getElement("#"+this.options.desktop);this.contentNode=this.node.getElement("#"+this.options.content);this.naviNode=this.node.getElement("#"+this.options.navi);if(this.node)this.node.setStyles(this.css.layoutNode);if(this.topShimNode)this.topShimNode.setStyles(this.css.layoutTopShimNode);if(this.topNode)this.topNode.setStyles(this.css.layoutTopNode);if(this.desktopNode)this.desktopNode.setStyles(this.css.desktopNode);if(this.contentNode)this.contentNode.setStyles(this.css.contentNode);if(this.naviNode)this.naviNode.setStyles(this.css.naviNode)},initData:function(t){this.apps={};this.widgets={};this.appCurrentList=[];this.lnkAreas=[];this.lnks=[];this.currentApp=null;this.status=null;this.session={};this.serviceAddressList=null;this.getServiceAddress(t)},getServiceAddress:function(t){var e=layout.config.center.host||window.location.hostname;var i=layout.config.center.port;var s="";if(!i||i=="80"){s="http://"+e+"/x_program_center/jaxrs/distribute/assemble/source/{source}"}else{s="http://"+e+":"+i+"/x_program_center/jaxrs/distribute/assemble/source/{source}"}var n=window.location.hostname;s=s.replace(/{source}/g,n);MWF.restful("get",s,null,function(e){this.serviceAddressList=e.data;if(t)t()}.bind(this))},isAuthentication:function(t){var e=true;if(this.session.user){if(t)t()}else{this.authentication.loadLogin(this.node);e=false}return e},load:function(){if(document.body.addEventListener){document.body.addEventListener("dragover",function(t){t.stopPropagation();t.preventDefault()}.bind(this),false)}this.isAuthentication(function(){MWF.UD.getData("layout",function(t){if(t.data){this.status=JSON.decode(t.data);if(this.status.style){if(this.options.style!=this.status.style){this.changStyle(this.status.style)}}this.loadDesktop()}else{MWF.UD.getPublicData("defaultLayout",function(t){if(t){this.status=t;if(this.status.style){if(this.options.style!=this.status.style){this.changStyle(this.status.style)}}}this.loadDesktop()}.bind(this))}if(this.session.user.passwordExpired){this.openApplication({page:{x:0,y:0}},"Profile",{tab:"passwordConfigPage"});window.setTimeout(function(){MWF.xDesktop.notice("error",{y:"top",x:"left"},MWF.LP.desktop.notice.changePassword,this.desktopNode)}.bind(this),500)}}.bind(this))}.bind(this))},loadDesktop:function(){this.setHeight();var t=this.desktopNode.getSize();this.size={x:t.x,y:t.y};this.loadTop();this.loadLnkArea();this.setEvent();this.loadWidget();this.loadStatus(function(){this.openWebSocket()}.bind(this))},openWebSocket:function(){this.socket=new MWF.xDesktop.WebSocket;window.setTimeout(this.checkWebSocket.bind(this),3e4)},checkWebSocket:function(){if(!this.socket||this.socket.webSocket.readyState!=1){this.socket=new MWF.xDesktop.WebSocket}window.setTimeout(this.checkWebSocket.bind(this),3e4)},loadWidget:function(){},loadLnkAreaContainer:function(){this.lnkAreaContainer=new Element("div",{styles:{height:"100%",overflow:"hidden"}}).inject(this.contentNode)},loadLnkArea:function(){if(!this.lnkAreaContainer)this.loadLnkAreaContainer();var t=new Element("div",{styles:this.css.dsektopLnkArea}).inject(this.lnkAreaContainer);this.lnkAreas.push(t);var e=t.getSize().x*this.lnkAreas.length;var i=this.contentNode.getSize();this.lnkAreaContainer.setStyle("width",""+Math.max(e,i.x)+"px");this.setCurrentLnkArea()},setCurrentLnkArea:function(){if(this.lnkAreas.length>1){var t=this.lnkAreas[0].getSize().x;var e=t*this.lnkAreas.length;var i=this.contentNode.getSize();var s=this.lnkAreas[this.lnkAreas.length-1];if(e<i.x){e=e-t;s.setStyles({width:"auto","margin-left":""+e+"px",float:"none"})}else{s.setStyles(this.css.dsektopLnkArea)}}else{if(this.lnkAreas.length){this.lnkAreas[0].setStyles({width:"auto","margin-left":"0px",float:"none"})}}},addLnkArea:function(){if(this.lnkAreas.length){this.lnkAreas[this.lnkAreas.length-1].setStyles(this.css.dsektopLnkArea)}this.loadLnkArea()},addLnk:function(t){var e=new MWF.xDesktop.Lnk(t.icon,t.title,t.par);if(!this.lnkAreas.length)this.loadLnkArea();e.inject(this.lnkAreas[this.lnkAreas.length-1]);this.lnks.push(e)},resizeLnk:function(){if(this.lnkAreaContainer){if(this.lnkAreas.length>1){var t=this.lnkAreas[0].getSize().x*this.lnkAreas.length;var e=this.contentNode.getSize();this.lnkAreaContainer.setStyle("width",""+Math.max(t,e.x)+"px")}else{this.lnkAreaContainer.setStyle("width",""+this.contentNode.getSize().x+"px")}}var i=0;var s=0;this.lnks.each(function(t,e){while(!this.lnkAreas[i])this.addLnkArea();var n=this.lnkAreas[i];t.inject(n);s++;var o=t.node.getSize().y+t.node.getStyle("margin-top").toFloat();if(o*(s+1)>n.getSize().y){if(e<this.lnks.length-1)i++;s=0}}.bind(this));if(this.lnkAreas.length)while(this.lnkAreas.length>i+1)this.lnkAreas.pop().destroy();this.setCurrentLnkArea()},refreshApp:function(t){if(t.window){var e={id:t.id,name:t.options.name,style:t.options.style,window:{size:{x:t.window.css.to.width.toFloat(),y:t.window.css.to.height.toFloat()},position:{x:t.window.css.to.left.toFloat(),y:t.window.css.to.top.toFloat()},isMax:t.window.isMax,isHide:t.window.isHide,style:t.window.options.style},app:null};if(t.recordStatus)e.app=t.recordStatus();t.close();this.openApplicationWithStatus(e)}},openApplicationWithStatus:function(t){var e=t.name;var i=t.style?t.style:"default";this.requireApp(e,function(e){var s=new e["Main"](this,{style:i,isRefresh:true,onLoadWindow:function(){this.window.setOptions({top:t.window.position.y,left:t.window.position.x,width:t.window.size.x,height:t.window.size.y});this.window.reStyle()},onPostLoadWindow:function(){if(t.window.isMax){this.maxSize(function(){this.fireAppEvent("postLoadWindowMax")}.bind(this))}if(t.window.isHide){this.minSize(function(){this.fireAppEvent("postLoadWindowMin")}.bind(this))}},onPostLoad:function(){}});s.desktop=this;s.appId=t.id;s.taskitem=new MWF.xDesktop.Layout.Taskitem(s,this);this.apps[t.id]=s;s.status=t.app;this.appCurrentList.push(s);debugger;s.loadNoAnimation(true,t.window.isMax,t.window.isHide)}.bind(this))},loadStatus:function(t){if(this.status){if(this.status.apps){Object.each(this.status.apps,function(t,e){var i=t.name;var s=t.style?t.style:"default";this.requireApp(i,function(i){var n=new i["Main"](this,{style:s,isRefresh:true,onLoadWindow:function(){this.window.setOptions({top:t.window.position.y,left:t.window.position.x,width:t.window.size.x,height:t.window.size.y});this.window.reStyle()},onPostLoadWindow:function(){if(t.window.isMax){this.maxSize(function(){this.fireAppEvent("postLoadWindowMax")}.bind(this))}if(t.window.isHide){this.minSize(function(){this.fireAppEvent("postLoadWindowMin")}.bind(this))}},onPostLoad:function(){}});n.desktop=this;n.appId=e;n.taskitem=new MWF.xDesktop.Layout.Taskitem(n,this);this.apps[e]=n;n.status=t.app;this.appCurrentList.push(n);debugger;n.loadNoAnimation(this.status.currentApp==e,t.window.isMax,t.window.isHide)}.bind(this))}.bind(this))}if(this.status.widgets){Object.each(this.status.widgets,function(t,e){var i=t.name;var s=t.appName;this.requireApp(s,function(s){var n=new s[i](this,{position:t.position,onLoadWidget:function(){this.widget.setOptions({position:t.position})}});n.desktop=this;n.widgetId=e;this.widgets[e]=n;n.status=t.widget;n.load()}.bind(this),i)}.bind(this))}if(this.status.lnks){this.status.lnks.each(function(t){this.addLnk(t)}.bind(this));this.resizeLnk()}}var e=false;var i=false;var s=function(){if(e&&i)if(t)t()};var n=MWF.defaultPath+"/xDesktop/$Layout/applications.json";MWF.getJSON(n,function(t){t.each(function(t,e){if(t.widgetName){if(t.widgetStart){this.openWidget(null,t.widgetName,t.path)}}}.bind(this));e=true;s()}.bind(this));var o=new MWF.xDesktop.Actions.RestActions("/xDesktop/Actions/action.json","x_component_assemble_control");o.invoke({name:"listComponent",success:function(t){var e=this.session.user.name;t.data.each(function(t,i){if(t.visible){var s=t.allowList.length?t.allowList.indexOf(e)!=-1:true;var n=t.denyList.length?t.denyList.indexOf(e)!=-1:false;if(!n&&s||MWF.AC.isAdministrator()){if(t.widgetName){if(t.widgetStart){this.openWidget(null,t.widgetName,t.path)}}}}}.bind(this));i=true;s()}.bind(this)})},setEvent:function(){this.node.addEvent("selectstart",function(t){var e="text";if(t.target.getStyle("-webkit-user-select")){e=t.target.getStyle("-webkit-user-select").toString().toLowerCase()}if(e!="text"&&e!="auto")t.preventDefault()});window.onunload=function(t){if(this.socket){this.socket.close()}}.bind(this);window.onbeforeunload=function(t){if(!this.isLogout){if(!this.notRecordStatus)this.recordDesktopStatus();this.fireEvent("unload");t=t||window.event;t.returnValue=MWF.LP.desktop.notice.unload;return MWF.LP.desktop.notice.unload}}.bind(this)},recordDesktopStatus:function(t){Object.each(this.apps,function(t,e){if(!t.options.desktopReload){this.closeApp(t)}}.bind(this));this.recordStatusData(function(){if(t)t()})},getLayoutStatusData:function(){var t={style:this.options.style,currentApp:this.currentApp?this.currentApp.appId:"",apps:{},lnks:[],widgets:{}};Object.each(this.apps,function(e,i){if(e.window){if(e.options.desktopReload){var s={name:e.options.name,style:e.options.style,window:{size:{x:e.window.css.to.width.toFloat(),y:e.window.css.to.height.toFloat()},position:{x:e.window.css.to.left.toFloat(),y:e.window.css.to.top.toFloat()},isMax:e.window.isMax,isHide:e.window.isHide,style:e.window.options.style},app:null};if(e.recordStatus)s.app=e.recordStatus();t.apps[i]=s}}});this.lnks.each(function(e){t.lnks.push({icon:e.icon,title:e.title,par:e.par})});Object.each(this.widgets,function(e,i){var s={name:e.options.name,appName:e.options.appName,position:e.options.position,widget:null};if(e.recordStatus)s.widget=e.recordStatus();t.widgets[i]=s});return t},recordStatusData:function(t){var e=this.getLayoutStatusData();MWF.UD.putData("layout",e,function(){if(t)t()})},getFormDesignerStyle:function(t){if(!this.formDesignerStyle){this.formDesignerStyle="default";MWF.UD.getData("formDesignerStyle",function(e){if(e.data){var i=JSON.decode(e.data);this.formDesignerStyle=i.style}if(t)t()}.bind(this))}else{if(t)t()}},recordStatusCookies:function(t){var e=JSON.encode(t);Cookie.write("xdesktop",e)},setHeight:function(){this.resizeHeight();$(window).addEvent("resize",function(){this.resizeHeight()}.bind(this))},resizeHeight:function(){var t=this.topNode.getSize().y;var e=$(document.body).getSize().y;var i=e-t;this.desktopNode.setStyle("height",""+i+"px");this.desktopHeight=i;var s=this.naviNode.getSize().y;i=i-s;this.contentNode.setStyle("height",""+i+"px");this.resizeApps();this.resizeLnk();this.resizeMessage();this.setTaskitemSize();if(this.top)if(this.top.userPanel)this.top.userPanel.setPosition();this.fireEvent("resize")},setTaskitemSize:function(){if(this.top){var t=10;var e=5;var i=this.top.taskbar.getSize();var s=this.top.taskbar.getChildren();var n=(i.x-t)/s.length;if(n<165){var o=n-e;s.each(function(t){t.setStyle("width",""+o+"px")})}else{s.each(function(t){t.setStyle("width","auto")})}}},resizeMessage:function(){if(this.message)this.message.resize()},resizeApps:function(){var t=$(document.body).getSize();Object.each(this.apps,function(e,i){var s=e.window.css.to.left.toFloat();var n=e.window.css.to.top.toFloat();if(s>t.x)s=t.x-100;if(n>t.y)n=t.y-100;e.window.css.to.left=s+"px";e.window.css.to.top=n+"px";if(e.window.css.spacerTo)e.window.css.spacerTo.left=s+"px";if(e.window.css.spacerTo)e.window.css.spacerTo.top=n+"px";if(!e.window.isHide){if(e.window.isMax){e.window.maxSizeIm()}else{e.window.restoreIm()}}}.bind(this))},loadTop:function(){if(!this.top){this.top=new MWF.xDesktop.Layout.Top(this.topNode,this);this.top.load()}},loadNavi:function(){if(!this.navi){this.navi=new MWF.xDesktop.Layout.Navi(this.naviNode,this);this.navi.load()}},changStyle:function(t){this.options.style=t;this.cssPath=MWF.defaultPath+"/xDesktop/$Layout/"+this.options.style+"/css.wcss";this._loadCss();MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop"});this.mask.load();window.setTimeout(function(){if(this.node)this.node.setStyles(this.css.layoutNode);if(this.topShimNode)this.topShimNode.setStyles(this.css.layoutTopShimNode);if(this.topNode)this.topNode.setStyles(this.css.layoutTopNode);if(this.desktopNode)this.desktopNode.setStyles(this.css.desktopNode);if(this.contentNode)this.contentNode.setStyles(this.css.contentNode);if(this.naviNode)this.naviNode.setStyles(this.css.naviNode);this.changeAppsStyle();if(this.top)this.top.changStyle();if(this.navi)this.navi.changStyle();Object.each(this.apps,function(t){if(t.taskitem)t.taskitem.changStyle()});this.resizeHeight();this.mask.hide()}.bind(this),0)}.bind(this))},changeAppsStyle:function(){Object.each(this.apps,function(t,e){t.window.options.style="desktop_"+this.options.style;t.window.changeStyle()}.bind(this))},openProcessApp:function(t,e){var i={id:e.id,appId:"process.Application"+e.id};this.openApplication(t,"process.Application",i)},openCMSApp:function(t,e){var i="cms.Module"+e.id;if(this.apps[i]){this.apps[i].setCurrent()}else{this.openApplication(t,"cms.Module",{columnData:e,appId:i})}},openWidget:function(t,e,i,s,n){this.requireApp(i,function(o){if(!this.widgets[i+e]){this.createNewWidget(t,o,i+e,e,s,n)}}.bind(this),e)},openApplication:function(t,e,i,s){var n=e.split(".");var o=n[n.length-1];this.requireApp(e,function(e){if(e.options.multitask){if(i&&i.appId){if(this.apps[i.appId]){this.apps[i.appId].setCurrent()}else{this.createNewApplication(t,e,o,i,s)}}else{this.createNewApplication(t,e,o,i,s)}}else{if(this.apps[o]){this.apps[o].setCurrent()}else{this.createNewApplication(t,e,o,i,s)}}}.bind(this))},createNewWidget:function(t,e,i,s,n,o){var a=new e[s](this,n);a.desktop=this;if(o){Object.each(o,function(t,e){app[e]=t})}a.load(true);var l=i;if(n){if(n.widgetId){l=n.widgetId}}a.widgetId=l;this.widgets[l]=a},createNewApplication:function(t,e,i,s,n){if(s){s.event=t}else{s={event:t}}var o=new e["Main"](this,s);o.desktop=this;if(n){Object.each(n,function(t,e){o[e]=t})}o.load(true);var a=i;if(s.appId){a=s.appId}else{if(e.options.multitask)a=a+"-"+new MWF.widget.UUID}o.appId=a;o.taskitem=new MWF.xDesktop.Layout.Taskitem(o,this);this.apps[a]=o},closeApp:function(t){var e=t.appId;this.appCurrentList.erase(t);delete this.apps[e]},closeWidget:function(t){var e=t.widgetId;delete this.widgets[e]},requireApp:function(t,e,i){var s=t.split(".");var n=s[s.length-1];var o="MWF.xApplication."+t;var a=i||"Main";var l=o+"."+a;var c=o+".lp."+MWF.language;var p=MWF.xApplication;s.each(function(t,e){if(e<s.length-1){p[t]=p[t]||{}}else{p[t]=p[t]||{options:Object.clone(MWF.xApplication.Common.options)}}p=p[t]}.bind(this));if(!p.options)p.options=Object.clone(MWF.xApplication.Common.options);MWF.xDesktop.requireApp(t,"lp."+MWF.language,null,false);MWF.xDesktop.requireApp(t,i,function(){if(e)e(p)})},playMessageAudio:function(){var t=true;if(this.playMessageAudioTime){var e=new Date;var i=e.getTime()-this.playMessageAudioTime.getTime();if(i<5e3)t=false}if(t){if(!this.messageAudioNode){var s=MWF.defaultPath+"/xDesktop/$Layout/"+layout.desktop.options.style+"/sound/message.wav";var n=MWF.defaultPath+"/xDesktop/$Layout/"+layout.desktop.options.style+"/sound/message.mp3";this.messageAudioNode=new Element("div",{html:'<audio autoplay="autoplay" volume=0.6 preload="metadata"><source src="'+s+'" type="audio/x-wav"><source src="'+n+'" type="audio/mpeg"></source></audio>',styles:{display:"none"}}).inject(this.node);this.messageAudio=this.messageAudioNode.getFirst()}this.messageAudio.play();this.playMessageAudioTime=new Date}}});MWF.xDesktop.Layout.Taskitem=new Class({initialize:function(t,e){this.layout=e;this.app=t;this.node=new Element("div",{styles:this.layout.css.taskItemNode,title:this.app.options.title+"-"+this.app.appId}).inject(this.layout.top.taskbar);this.iconNode=new Element("div",{styles:this.layout.css.taskItemIconNode}).inject(this.node);this.iconNode.setStyle("background-image","url("+this.app.options.icon+")");this.closeNode=new Element("div",{styles:this.layout.css.taskItemCloseNode}).inject(this.node);this.textNode=new Element("div",{styles:this.layout.css.taskItemTextNode}).inject(this.node);this.textNode.set("text",this.app.options.title);this.setTaskitemSize();this.setEvent()},setTaskitemSize:function(){var t=10;var e=5;var i=this.layout.top.taskbar.getSize();var s=this.layout.top.taskbar.getChildren();var n=(i.x-t)/s.length;if(n<165){var o=n-e;s.each(function(t){t.setStyle("width",""+o+"px")})}else{s.each(function(t){t.setStyle("width","auto")})}},setText:function(t){this.textNode.set("text",t||this.app.options.title)},setEvent:function(){this.textNode.addEvents({mouseover:function(){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this)this.node.setStyles(this.layout.css.taskItemNode_over)}.bind(this),mouseout:function(){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this)this.node.setStyles(this.layout.css.taskItemNode)}.bind(this),mousedown:function(){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this)this.node.setStyles(this.layout.css.taskItemNode_down)}.bind(this),mouseup:function(){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this)this.node.setStyles(this.layout.css.taskItemNode_over)}.bind(this),click:function(){if(this.layout.currentApp==this.app){this.app.minSize()}else{this.app.setCurrent()}}.bind(this)});this.iconNode.addEvents({mouseover:function(){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this)this.node.setStyles(this.layout.css.taskItemNode_over)}.bind(this),mouseout:function(){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this)this.node.setStyles(this.layout.css.taskItemNode)}.bind(this),mousedown:function(){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this)this.node.setStyles(this.layout.css.taskItemNode_down)}.bind(this),mouseup:function(){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this)this.node.setStyles(this.layout.css.taskItemNode_over)}.bind(this),click:function(){if(this.layout.currentApp==this.app){this.app.minSize()}else{this.app.setCurrent()}}.bind(this)});this.node.addEvents({mouseover:function(){this.closeNode.fade("in")}.bind(this),mouseout:function(){this.closeNode.fade("out")}.bind(this)});this.closeNode.addEvent("click",function(){this.app.close()}.bind(this))},selected:function(){this.node.setStyles(this.layout.css.taskItemNode_current)},unSelected:function(){this.node.setStyles(this.layout.css.taskItemNode)},changStyle:function(){if(this.node){if(!this.layout.currentApp||this.layout.currentApp.taskitem!=this){this.node.setStyles(this.layout.css.taskItemNode)}else{this.node.setStyles(this.layout.css.taskItemNode_current)}}if(this.iconNode)this.iconNode.setStyles(this.layout.css.taskItemIconNode);if(this.textNode)this.textNode.setStyles(this.layout.css.taskItemTextNode)},destroy:function(){this.node.destroy()}});MWF.xDesktop.Layout.Top=new Class({initialize:function(t,e){this.layout=e;this.node=$(t)},load:function(){this.loadMenuAction();this.loadSeparate();this.loadShowDesktop();this.loadClock();this.loadSeparate("right");this.loadUserMenu();this.loadStyleAction();this.loadUserChat();this.loadMessageAction();this.loadSeparate("right");this.loadTaskbar()},loadMenuAction:function(){this.loadMenuAction=new Element("div",{styles:this.layout.css.loadMenuAction,title:MWF.LP.desktop.menuAction}).inject(this.node);this.loadMenuAction.addEvent("click",function(){this.loadMenu()}.bind(this))},loadShowDesktop:function(){this.showDesktopAction=new Element("div",{styles:this.layout.css.showDesktopAction}).inject(this.node);this.showDesktopAction.addEvents({mouseover:function(){this.showDesktopAction.setStyles(this.layout.css.showDesktopAction_over)}.bind(this),mouseout:function(){this.showDesktopAction.setStyles(this.layout.css.showDesktopAction)}.bind(this),click:function(){var t=true;Object.each(this.layout.apps,function(e,i){if(!e.window.isHide){t=false;e.minSize()}}.bind(this));if(t){Object.each(this.layout.apps,function(t,e){t.setCurrent()}.bind(this))}}.bind(this)})},loadMenu:function(){this.createApplicationMenuArea();this.getApplicationsCatalogue(function(t){var e=this.layout.session.user.name;t.each(function(t,i){var s=true;if(t.allowList)s=t.allowList.length?t.allowList.indexOf(e)!=-1:true;var n=false;if(t.denyList)n=t.denyList.length?t.denyList.indexOf(e)!=-1:false;if(!n&&s||MWF.AC.isAdministrator()){this.createApplicationMenu(t,i)}}.bind(this));this.getComponentList(function(t){t.data.each(function(t,i){if(t.visible){var s=t.allowList.length?t.allowList.indexOf(e)!=-1:true;var n=t.denyList.length?t.denyList.indexOf(e)!=-1:false;if(!n&&s||MWF.AC.isAdministrator()){this.createApplicationMenu(t,i)}}}.bind(this))}.bind(this));this.showApplicationMenu()}.bind(this));this.getProcessApplications(function(t){t.data.each(function(t){if(t.isCMSApp){this.createCMSAppMenu(t)}else{this.createProcessAppMenu(t)}}.bind(this))}.bind(this))},showApplicationMenu:function(){this.applicationMenuAreaMark.fade(.8);this.applicationMenuArea.fade("in")},closeApplicationMenu:function(){if(!this.isApplicationMenuScroll){this.applicationMenuAreaMark.destroy();this.applicationMenuArea.destroy();this.applicationMenuFxScroll=null;this.layout.removeEvent("resize",this.resizeApplicationMenuSizeFun)}this.isApplicationMenuScroll=false},createCMSAppMenu:function(t){var e=new Element("div",{styles:this.layout.css.applicationMenuNode,title:t.appName}).inject(this.applicationMenuProcessArea);var i=new Element("div",{styles:this.layout.css.applicationMenuIconNode}).inject(e);var s="";if(t.appIcon){s="url(data:image/png;base64,"+t.appIcon+")"}else{s="url(/x_component_cms_Index/$Main/default/icon/column.png)"}i.setStyle("background-image",s);new Element("div",{styles:this.layout.css.applicationMenuTextNode,text:t.appName}).inject(e);e.addEvent("click",function(e){this.layout.openCMSApp(e,t);this.closeApplicationMenu()}.bind(this));e.makeLnk({par:{icon:s,title:t.name,par:'cms.Module#{"columnId": "'+t.id+'", "appId": "cms.Module'+t.id+'"}'},onStart:function(){this.applicationMenuAreaMark.fade("out");this.applicationMenuArea.fade("out")}.bind(this),onComplete:function(){this.showApplicationMenu()}.bind(this)})},createProcessAppMenu:function(t){var e=new Element("div",{styles:this.layout.css.applicationMenuNode,title:t.name}).inject(this.applicationMenuProcessArea);var i=new Element("div",{styles:this.layout.css.applicationMenuIconNode}).inject(e);var s="";if(t.icon){s="url(data:image/png;base64,"+t.icon+")"}else{s="url(/x_component_process_ApplicationExplorer/$Main/default/icon/application.png)"}i.setStyle("background-image",s);new Element("div",{styles:this.layout.css.applicationMenuTextNode,text:t.name}).inject(e);e.addEvent("click",function(e){this.layout.openProcessApp(e,t);this.closeApplicationMenu()}.bind(this));e.makeLnk({par:{icon:s,title:t.name,par:'process.Application#{"id": "'+t.id+'", "appId": "process.Application'+t.id+'"}'},onStart:function(){this.applicationMenuAreaMark.fade("out");this.applicationMenuArea.fade("out")}.bind(this),onComplete:function(){this.showApplicationMenu()}.bind(this)})},createApplicationMenu:function(t,e){var i=new Element("div",{styles:this.layout.css.applicationMenuNode,title:t.title}).inject(this.applicationMenuAppIconArea);var s=new Element("div",{styles:this.layout.css.applicationMenuIconNode}).inject(i);var n="/x_component_"+t.path.replace(/\./g,"_")+"/$Main/"+t.iconPath;s.setStyle("background-image","url("+n+")");new Element("div",{styles:this.layout.css.applicationMenuTextNode,text:t.title}).inject(i);i.addEvent("click",function(e){this.layout.openApplication(e,t.path);this.closeApplicationMenu()}.bind(this));i.makeLnk({par:{icon:n,title:t.title,par:t.path},onStart:function(){this.applicationMenuAreaMark.fade("out");this.applicationMenuArea.fade("out")}.bind(this),onComplete:function(){this.showApplicationMenu()}.bind(this)});var o=t.path;if(t.widgetName){if(!(t.widgetVisible===false)){this.createApplicationWidgetMenu(t.widgetName,t.widgetTitle,t.widgetIconPath,o)}}},createApplicationWidgetMenu:function(t,e,i,s){var n=new Element("div",{styles:this.layout.css.widgetMenuNode,title:e}).inject(this.applicationMenuWidgetArea);var o=new Element("div",{styles:this.layout.css.widgetMenuIconNode}).inject(n);var i="/x_component_"+s.replace(/\./g,"_")+"/$"+t+"/"+i;o.setStyle("background-image","url("+i+")");new Element("div",{styles:this.layout.css.applicationMenuTextNode,text:e}).inject(n);n.addEvent("click",function(e){this.layout.openWidget(e,t,s);this.closeApplicationMenu()}.bind(this))},createApplicationMenuArea:function(){var t=MWF.xDesktop.zIndexPool.zIndex;this.applicationMenuAreaMark=new Element("div",{styles:this.layout.css.applicationMenuAreaMark}).inject(this.layout.node);this.applicationMenuAreaMark.setStyle("z-index",t);this.applicationMenuArea=new Element("div",{styles:this.layout.css.applicationMenuArea}).inject(this.layout.node);this.applicationMenuArea.setStyle("z-index",t+1);this.applicationMenuLeftAction=new Element("div",{styles:this.layout.css.applicationMenuLeftAction}).inject(this.applicationMenuArea);this.applicationMenuRightAction=new Element("div",{styles:this.layout.css.applicationMenuRightAction}).inject(this.applicationMenuArea);this.applicationMenuScrollArea=new Element("div",{styles:this.layout.css.applicationMenuScrollArea}).inject(this.applicationMenuArea);this.applicationMenuContentArea=new Element("div",{styles:this.layout.css.applicationMenuContentArea}).inject(this.applicationMenuScrollArea);this.applicationMemuAppContent=new Element("div",{styles:this.layout.css.applicationMemuAppContent}).inject(this.applicationMenuContentArea);this.applicationMenuAppTitleArea=new Element("div",{styles:this.layout.css.applicationMenuAppTitleArea,text:MWF.LP.desktop.application}).inject(this.applicationMemuAppContent);this.applicationMenuAppIconScrollArea=new Element("div",{styles:this.layout.css.applicationMenuAppIconScrollArea}).inject(this.applicationMemuAppContent);this.applicationMenuAppIconArea=new Element("div",{styles:this.layout.css.applicationMenuAppIconArea}).inject(this.applicationMenuAppIconScrollArea);this.applicationMemuWidgetContent=new Element("div",{styles:this.layout.css.applicationMemuWidgetContent}).inject(this.applicationMenuContentArea);this.applicationMenuWidgetTitleArea=new Element("div",{styles:this.layout.css.applicationMenuWidgetTitleArea,text:MWF.LP.desktop.widget}).inject(this.applicationMemuWidgetContent);this.applicationMenuWidgetScrollArea=new Element("div",{styles:this.layout.css.applicationMenuWidgetScrollArea}).inject(this.applicationMemuWidgetContent);this.applicationMenuWidgetArea=new Element("div",{styles:this.layout.css.applicationMenuWidgetArea}).inject(this.applicationMenuWidgetScrollArea);this.applicationMemuProcessContent=new Element("div",{styles:this.layout.css.applicationMemuProcessContent}).inject(this.applicationMenuContentArea);this.applicationMenuProcessTitleArea=new Element("div",{styles:this.layout.css.applicationMenuProcessTitleArea,text:MWF.LP.desktop.process}).inject(this.applicationMemuProcessContent);this.applicationMenuProcessScrollArea=new Element("div",{styles:this.layout.css.applicationMenuProcessScrollArea}).inject(this.applicationMemuProcessContent);this.applicationMenuProcessArea=new Element("div",{styles:this.layout.css.applicationMenuProcessArea}).inject(this.applicationMenuProcessScrollArea);this.setApplicationMenuSize();this.setApplicationMenuEvent()},setApplicationMenuSize:function(){this.resizeApplicationMenuSize();this.resizeApplicationMenuSizeFun=this.resizeApplicationMenuSize.bind(this);this.layout.addEvent("resize",this.resizeApplicationMenuSizeFun)},resizeApplicationMenuSize:function(){var t=this.applicationMenuScrollArea.getSize();this.applicationMemuAppContent.setStyle("width",""+t.x+"px");this.applicationMemuWidgetContent.setStyle("width",""+t.x+"px");this.applicationMemuProcessContent.setStyle("width",""+t.x+"px");var e=t.x*3;this.applicationMenuContentArea.setStyle("width",""+e+"px");var i=this.applicationMenuArea.getSize();var s=this.applicationMenuAppTitleArea.getSize();var n=this.applicationMenuAppTitleArea.getStyle("margin-top").toInt();var o=this.applicationMenuAppTitleArea.getStyle("margin-bottom").toInt();var a=this.applicationMenuAppIconScrollArea.getStyle("margin-top").toInt();var l=this.applicationMenuAppIconScrollArea.getStyle("margin-bottom").toInt();var c=i.y-s.y-n-o-a-l;this.applicationMenuAppIconScrollArea.setStyle("height",""+c+"px");s=this.applicationMenuWidgetTitleArea.getSize();n=this.applicationMenuWidgetTitleArea.getStyle("margin-top").toInt();o=this.applicationMenuWidgetTitleArea.getStyle("margin-bottom").toInt();a=this.applicationMenuWidgetScrollArea.getStyle("margin-top").toInt();l=this.applicationMenuWidgetScrollArea.getStyle("margin-bottom").toInt();c=i.y-s.y-n-o-a-l;this.applicationMenuWidgetScrollArea.setStyle("height",""+c+"px");s=this.applicationMenuProcessTitleArea.getSize();n=this.applicationMenuProcessTitleArea.getStyle("margin-top").toInt();o=this.applicationMenuProcessTitleArea.getStyle("margin-bottom").toInt();a=this.applicationMenuProcessScrollArea.getStyle("margin-top").toInt();l=this.applicationMenuProcessScrollArea.getStyle("margin-bottom").toInt();c=i.y-s.y-n-o-a-l;this.applicationMenuProcessScrollArea.setStyle("height",""+c+"px")},setApplicationMenuEvent:function(){MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.applicationMenuAppIconScrollArea,{style:"xDesktop_Menu",where:"after",distance:30,friction:4,axis:{x:false,y:true},onScrollStart:function(){this.isApplicationMenuScroll=true}.bind(this)});new MWF.widget.ScrollBar(this.applicationMenuWidgetScrollArea,{style:"xDesktop_Menu",where:"after",distance:30,friction:4,axis:{x:false,y:true},onScrollStart:function(){this.isApplicationMenuScroll=true}.bind(this)});new MWF.widget.ScrollBar(this.applicationMenuProcessScrollArea,{
style:"xDesktop_Menu",where:"after",distance:30,friction:4,axis:{x:false,y:true},onScrollStart:function(){this.isApplicationMenuScroll=true}.bind(this)})}.bind(this));this.applicationMenuRightAction.addEvent("click",function(t){if(!this.currentApplicationMenuContent)this.currentApplicationMenuContent="app";var e="";var i=null;var s=null;if(this.currentApplicationMenuContent=="app"){i=this.applicationMemuWidgetContent;e="widget";s=this.applicationMemuAppContent}if(this.currentApplicationMenuContent=="widget"){i=this.applicationMemuProcessContent;e="process";s=this.applicationMemuWidgetContent}if(this.currentApplicationMenuContent=="process"){i=this.applicationMemuAppContent;e="app";s=this.applicationMemuProcessContent}if(!this.applicationMenuFxScroll)this.applicationMenuFxScroll=new Fx.Scroll(this.applicationMenuScrollArea,{wheelStops:false});this.applicationMenuFxScroll.toElement(i,"x");this.currentApplicationMenuContent=e;t.stopPropagation()}.bind(this));this.applicationMenuLeftAction.addEvent("click",function(t){if(!this.currentApplicationMenuContent)this.currentApplicationMenuContent="app";var e="";var i=null;var s=null;if(this.currentApplicationMenuContent=="app"){i=this.applicationMemuProcessContent;e="process";s=this.applicationMemuAppContent}if(this.currentApplicationMenuContent=="widget"){i=this.applicationMemuAppContent;e="app";s=this.applicationMemuWidgetContent}if(this.currentApplicationMenuContent=="process"){i=this.applicationMemuWidgetContent;e="widget";s=this.applicationMemuProcessContent}if(!this.applicationMenuFxScroll)this.applicationMenuFxScroll=new Fx.Scroll(this.applicationMenuScrollArea,{wheelStops:false});this.applicationMenuFxScroll.toElement(i);this.currentApplicationMenuContent=e;t.stopPropagation()}.bind(this));this.applicationMenuArea.addEvent("click",function(){this.closeApplicationMenu()}.bind(this))},getApplicationsCatalogue:function(t){var e=MWF.defaultPath+"/xDesktop/$Layout/applications.json";MWF.getJSON(e,function(e){if(t)t(e)}.bind(this))},getProcessApplications:function(t){var e=new MWF.xDesktop.Actions.RestActions("/xDesktop/Actions/action.json","x_processplatform_assemble_surface");e.invoke({name:"listApplication",success:function(e){var i=new MWF.xDesktop.Actions.RestActions("/xDesktop/Actions/action.json","x_cms_assemble_control");i.invoke({name:"listCMSApplication",success:function(i){var s=i.data||[];s.each(function(t){t.isCMSApp=true;t.name=t.appName;t.icon=t.appIcon;e.data.push(t)});if(t)t(e)}})}.bind(this)})},getComponentList:function(t){var e=new MWF.xDesktop.Actions.RestActions("/xDesktop/Actions/action.json","x_component_assemble_control");e.invoke({name:"listComponent",success:function(e){if(t)t(e)}.bind(this)})},loadConfigAction:function(){this.configActionNode=new Element("div",{styles:this.layout.css.configActionNode,title:MWF.LP.desktop.configAction}).inject(this.node);this.configActionNode.addEvent("click",function(){alert("show config")})},loadSeparate:function(t){var e=new Element("div.separateNode",{styles:this.layout.css.separateNode}).inject(this.node);if(t)e.setStyle("float",t)},loadTaskbar:function(){this.taskbar=new Element("div",{styles:this.layout.css.taskbar}).inject(this.node)},loadUserChat:function(){this.userChatNode=new Element("div",{styles:this.layout.css.userChatNode,title:MWF.LP.desktop.userChat}).inject(this.node);this.userChatNode.addEvent("click",function(t){if(!this.socket||this.layout.socket.webSocket.readyState!=1){this.layout.socket=new MWF.xDesktop.WebSocket}this.layout.openApplication(t,"IM");var e=this.layout.widgets["IMIMWidget"];if(e){if(e.unreadNode){var i=this.layout.apps["Chat"];if(i){Object.each(e.unShowMessage,function(t,s){if(t.length){var n=i.dialogues[s];if(!n){e.getPerson(t[0].from,function(){n=i.addDialogue(e.owner,[e.users[t[0].from]])}.bind(this))}}}.bind(this))}var s=this;layout.desktop.openApplication(t,"Chat",{onPostLoad:function(){Object.each(e.unShowMessage,function(t,i){if(t.length){e.getPerson(t[0].from,function(){dialogue=this.addDialogue(e.owner,[e.users[t[0].from]])}.bind(this))}}.bind(this))}})}}}.bind(this))},userConfig:function(t){this.layout.openApplication(t,"Profile")},logout:function(){this.layout.isLogout=true;if(!this.notRecordStatus){this.layout.recordDesktopStatus(function(){this.authentication.logout()}.bind(this.layout))}else{this.authentication.logout()}},loadStyleAction:function(){this.styleActionNode=new Element("div",{styles:this.layout.css.styleActionNode,title:MWF.LP.desktop.styleAction}).inject(this.node);this.setChangeStyle()},setChangeStyle:function(){if(!this.styleMenu){this.styleMenu=new MWF.xDesktop.Menu(this.styleActionNode,{event:"click",style:"desktopStyle",offsetX:-60,offsetY:10,container:this.layout.node,onQueryShow:function(){this.styleMenu.items.each(function(t){if(this.layout.options.style==t.styleName){t.setDisable(true)}else{t.setDisable(false)}}.bind(this))}.bind(this)});this.styleMenu.load();MWF.getJSON(this.layout.path+"styles.json",function(t){t.each(function(t){var e=MWF.defaultPath+"/xDesktop/$Layout/"+t.style+"/preview.jpg";var i=this.styleMenu.addMenuItem(t.title,"click",function(){this.changeLayoutStyle(t.style)}.bind(this),e);i.styleName=t.style}.bind(this))}.bind(this))}},changeLayoutStyle:function(t){this.layout.changStyle(t)},loadMessageAction:function(){this.messageActionNode=new Element("div",{styles:this.layout.css.messageActionNode,title:MWF.LP.desktop.showMessage}).inject(this.node);this.layout.message=new MWF.xDesktop.Message(this.layout);this.layout.message.load();this.messageActionNode.addEvent("click",function(){this.showDesktopMessage()}.bind(this))},showDesktopMessage:function(){if(!this.layout.message.isShow){this.layout.message.show()}},loadUserMenu:function(){this.userMenuNode=new Element("div",{styles:this.layout.css.userMenuNode,title:MWF.LP.desktop.userMenu}).inject(this.node);this.userMenu=new MWF.xDesktop.Menu(this.userMenuNode,{event:"click",style:"desktopUser",offsetX:-10,offsetY:10,container:this.layout.node});this.userMenu.load();var t=MWF.defaultPath+"/xDesktop/$Layout/"+this.layout.options.style+"/usermenu/config.png";this.userMenu.addMenuItem(MWF.LP.desktop.userConfig,"click",function(t){this.userConfig(t)}.bind(this),t);this.userMenu.addMenuLine();t=MWF.defaultPath+"/xDesktop/$Layout/"+this.layout.options.style+"/usermenu/logout.png";this.userMenu.addMenuItem(MWF.LP.desktop.logout,"click",function(){this.logout()}.bind(this),t)},loadClock:function(){this.clockNode=new Element("div",{styles:this.layout.css.clockNode}).inject(this.node);this.setTime()},setTime:function(){var t=new Date;var e=1e3-t.getMilliseconds();var i=60-t.getSeconds();var s=t.format("%Y/%m/%d#%H:%M");dl=s.split("#");this.clockNode.set("html",dl[1]+"<br/>"+dl[0]);window.setTimeout(this.setTime.bind(this),i*1e3+e)},changStyle:function(){if(this.loadMenuAction)this.loadMenuAction.setStyles(this.layout.css.loadMenuAction);if(this.configActionNode)this.configActionNode.setStyles(this.layout.css.configActionNode);var t=this.layout.css.separateNode;delete t.float;this.node.getElements(".separateNode").setStyles(t);if(this.userChatNode)this.userChatNode.setStyles(this.layout.css.userChatNode);if(this.styleActionNode)this.styleActionNode.setStyles(this.layout.css.styleActionNode);if(this.messageActionNode)this.messageActionNode.setStyles(this.layout.css.messageActionNode);if(this.clockNode)this.clockNode.setStyles(this.layout.css.clockNode);if(this.userMenuNode)this.userMenuNode.setStyles(this.layout.css.userMenuNode);if(this.styleActionNode)this.styleActionNode.setStyles(this.layout.css.styleActionNode);if(this.userActionNode)this.userActionNode.setStyles(this.layout.css.userActionNode);if(this.taskbar)this.taskbar.setStyles(this.layout.css.taskbar);if(this.userPanel)this.userPanel.changStyle(this.layout.options.style)}});MWF.xDesktop.Layout.Navi=new Class({initialize:function(t,e){this.layout=e;this.node=$(t);this.navis=[]},load:function(){this.createNaviArea();this.loadNavis()},createNaviArea:function(){this.naviNodeBottomArea=new Element("div",{styles:this.layout.css.naviNodeBottomArea}).inject(this.node);this.naviNodeArea=new Element("div",{styles:this.layout.css.naviNodeArea}).inject(this.node)},editQuickNavi:function(){},loadNavis:function(){MWF.getJSON(this.layout.path+"quickStart.json",function(t){t.navi.each(function(t){this.navis.push(this.createNaviNode(t))}.bind(this))}.bind(this))},createNaviNode:function(t){var e=new Element("div",{styles:this.layout.css.mainNaviNode}).inject(this.naviNodeArea);e.store("navi",t);var i=new Element("div",{styles:this.layout.css.mainNaviIconNode}).inject(e);i.setStyle("background-image","url("+MWF.defaultPath+"/xDesktop/$Layout/"+this.layout.options.style+"/navi/"+t.icon+")");new Element("div",{styles:this.layout.css.mainNaviTextNode,text:t.title}).inject(e);var s=this;e.addEvents({mouseover:function(){var t=this.retrieve("navi");this.setStyle("background","#CCC");var e=t.icon.replace(".","_over.");this.getFirst("div").setStyle("background-image","url("+MWF.defaultPath+"/xDesktop/$Layout/"+s.layout.options.style+"/navi/"+e+")");this.getLast("div").setStyle("color","#444")},mouseout:function(){this.setStyle("background","transparent");var t=this.retrieve("navi");this.setStyle("background","transparent");this.getFirst("div").setStyle("background-image","url("+MWF.defaultPath+"/xDesktop/$Layout/"+s.layout.options.style+"/navi/"+t.icon+")");this.getLast("div").setStyle("color","#FFF")},mousedown:function(){this.setStyle("background","#FFF")},mouseup:function(){this.setStyle("background","#CCC")},click:function(t){var e=this.retrieve("navi");s.layout.openApplication(t,e.action)}});return e},changStyle:function(){if(this.naviNodeBottomArea)this.naviNodeBottomArea.setStyles(this.layout.css.naviNodeBottomArea);if(this.naviNodeArea)this.naviNodeArea.setStyles(this.layout.css.naviNodeArea);this.navis.each(function(t){t.setStyles(this.layout.css.mainNaviNode);t.getFirst("div").setStyles(this.layout.css.mainNaviIconNode);t.getLast("div").setStyles(this.layout.css.mainNaviTextNode)}.bind(this))}});MWF.xDesktop.zIndexPool={zIndex:100,applyZindex:function(){var t=this.zIndex;this.zIndex=this.zIndex+2;return t}};