MWF.xDesktop.Actions=MWF.xDesktop.Actions||{};MWF.xDesktop.Actions.RestActions=new Class({Implements:[Events],initialize:function(e,t,s){this.actionPath=e;this.serviceName=t;this.root=s;this.getAddress()},listApplicationAddress:function(e,t){var s=this.actions.listAddress;s=this.actions.slotHost+s;var a=new MWF.xApplication.Common.Actions.RestActions.Callback(e,t);MWF.getJSON(s,a)},getAddress:function(e,t){var s=layout.desktop.serviceAddressList[this.serviceName];if(s){this.address="http://"+s.host+(s.port==80?"":":"+s.port)+s.context}else{var a=layout.desktop.centerServer.host||window.location.hostname;var i=layout.desktop.centerServer.port;this.address="http://"+a+(i=="80"?"":":"+i)+"/x_program_center"}if(e)e.apply()},getActions:function(e){if(!this.actions){var t=this.root?"/"+this.root+this.actionPath:MWF.defaultPath+this.actionPath;MWF.getJSON(t,function(t){this.actions=t;if(e)e()}.bind(this),false,false,false)}else{if(e)e()}},invoke:function(e){this.getActions(function(){var t=this.actions[e.name];var s=t.method||"GET";var a=t.uri;if(e.parameter){Object.each(e.parameter,function(t,s){var i=new RegExp("{"+s+"}","g");if(e.urlEncode===false){a=a.replace(i,t)}else{a=a.replace(i,encodeURIComponent(t))}})}a=this.address+a;var i=e.async===false?false:true;var n=new MWF.xDesktop.Actions.RestActions.Callback(e.success,e.failure);if(t.enctype&&t.enctype.toLowerCase()=="formdata"){this.invokeFormData(s,a,e.data,e.file,n,i)}else{var o=e.data?JSON.encode(e.data):"";var r=true;if(e.withCredentials===false){r=false}MWF.restful(s,a,o,n,i,r)}}.bind(this))},formDataUpdateProgress:function(){},invokeFormDataWithProgress:function(e,t,s,a,i,n,o){var r=null;var d=new Date;e.upload.addEventListener("progress",function(t){this.updateProgress(t,e,r,d)}.bind(this),false);e.upload.addEventListener("load",function(t){this.transferComplete(t,e,r,d,i)}.bind(this),false);e.upload.addEventListener("loadstart",function(t){this.transferStart(t,e,r)}.bind(this),false);e.upload.addEventListener("error",function(t){this.transferFailed(t,e,r)}.bind(this),false);e.upload.addEventListener("abort",function(t){this.transferCanceled(t,e,r)}.bind(this),false);e.upload.addEventListener("timeout",function(t){this.transferCanceled(t,e,r)}.bind(this),false);e.addEventListener("readystatechange",function(t){this.xhrStateChange(t,e,r,n)}.bind(this),false);e.open(t,s,true);e.withCredentials=true;r=this.addFormDataMessage(i,false,e);e.send(a)},setMessageText:function(e,t){var s=e.contentNode.getFirst("div").getFirst("div");var a=s.getFirst("div");var i=e.contentNode.getFirst("div").getLast("div");i.set("text",t);e.dateNode.set("text",(new Date).format("db"))},setMessageTitle:function(e,t){e.subjectNode.set("text",t)},clearMessageProgress:function(e){var t=e.contentNode.getFirst("div").getFirst("div");t.destroy()},transferStart:function(e,t,s){this.setMessageText(s,MWF.LP.desktop.action.sendStart);s.status="progress";this.fireEvent("loadstart")},transferFailed:function(e,t,s){this.setMessageText(s,MWF.LP.desktop.action.sendError);this.setMessageTitle(s,MWF.LP.desktop.action.sendError);this.clearMessageProgress(s);s.status="failed";this.fireEvent("error")},transferCanceled:function(e,t,s){this.setMessageText(s,MWF.LP.desktop.action.sendAbort);this.setMessageTitle(s,MWF.LP.desktop.action.sendAbort);this.clearMessageProgress(s);s.status="cancel";this.fireEvent("abort")},transferComplete:function(e,t,s,a,i){var n=new Date;var o=n.getTime()-a.getTime();var r=i.size/o;var d="K/S";if(r>1024){d="M/S";r=r/1024}if(r>1024){d="G/S";r=r/1024}r=r.round(2);var c="";if(o>36e5){var l=o/36e5;var u=o%36e5;var f=u/6e4;var h=u%6e4;var p=h/1e3;c=""+l.toInt()+MWF.LP.desktop.action.hour+f.toInt()+MWF.LP.desktop.action.minute+p.toInt()+MWF.LP.desktop.action.second}else if(o>6e4){var f=o/6e4;var h=o%6e4;var p=h/1e3;c=""+f.toInt()+MWF.LP.desktop.action.minute+p.toInt()+MWF.LP.desktop.action.second}else{var p=o/1e3;c=""+p.toInt()+MWF.LP.desktop.action.second}this.setMessageText(s,MWF.LP.desktop.action.uploadComplete+"  "+MWF.LP.desktop.action.speed+": "+r+d+"  "+MWF.LP.desktop.action.time+": "+c,MWF.LP.desktop.action.uploadComplete);this.setMessageTitle(s,MWF.LP.desktop.action.uploadComplete);this.clearMessageProgress(s);s.status="completed";this.fireEvent("load")},updateProgress:function(e,t,s,a){var i=100*(e.loaded/e.total);var n=new Date;var o=n.getTime()-a.getTime();var r=e.loaded/o;var d="K/S";if(r>1024){d="M/S";r=r/1024}if(r>1024){d="G/S";r=r/1024}r=r.round(2);if(s.contentNode){var c=s.contentNode.getFirst("div").getFirst("div");var l=c.getFirst("div");var u=s.contentNode.getFirst("div").getLast("div");l.setStyle("width",""+i+"%");u.set("text",MWF.LP.desktop.action.sendStart+": "+r+d)}this.fireEvent("progress")},xhrStateChange:function(e,t,s,a){if(t.readyState!=4)return;var i=t.status;i=i==1223?204:i;if(i>=200&&i<300){var n=JSON.decode(t.responseText);if(n){switch(n.type){case"success":var o="";var r=typeOf(n.data);if(r=="array"){o=n.data[0].id}if(r=="object"){o=n.data.id}MWF.runCallback(a,"onSuccess",[{type:"success",id:o},t.responseText]);break;case"warn":MWF.xDesktop.notice("info",{x:"right",y:"top"},n.errorMessage.join("\n"));var o="";var r=typeOf(n.data);if(r=="array"){o=n.data[0].id}if(r=="object"){o=n.data.id}MWF.runCallback(a,"onSuccess",[{type:"success",id:o},t.responseText]);break;case"error":MWF.runCallback(a,"onFailure",[t]);break}}else{MWF.runCallback(a,"onFailure",[t])}}else{MWF.runCallback(a,"onFailure",[t])}},invokeFormDataWithoutProgress:function(e,t,s,a,i,n,o){var r=null;var d=new Date;e.addEventListener("readystatechange",function(t){if(e.readyState==4){this.transferComplete(t,e,r,d,i);this.xhrStateChange(t,e,r,n)}}.bind(this),false);e.open(t,s,true);e.withCredentials=true;r=this.addFormDataMessage(i,true);e.send(a);this.setMessageText(r,MWF.LP.desktop.action.sendStart)},invokeFormData:function(e,t,s,a,i,n){var o=new COMMON.Browser.Request;if(o.upload){this.invokeFormDataWithProgress(o,e,t,s,a,i,n)}else{this.invokeFormDataWithoutProgress(o,e,t,s,a,i,n)}},addFormDataMessage:function(e,t,s){var a="";if(t){a='<div style="height: 20px; line-height: 20px">'+MWF.LP.desktop.action.sendReady+"</div></div>"}else{a='<div style="overflow: hidden"><div style="height: 3px; border:1px solid #999; margin: 3px 0px">'+'<div style="height: 3px; background-color: #acdab9; width: 0px;"></div></div>'+'<div style="height: 20px; line-height: 20px">'+MWF.LP.desktop.action.sendReady+"</div></div>"}var i={subject:MWF.LP.desktop.action.uploadTitle,content:e.name+"<br/>"+a};var n=layout.desktop.message.addMessage(i);n.close=function(t,a){if(this.status=="progress"){flag=false;var i=MWF.LP.desktop.action.cancelUpload.replace(/{name}/g,e.name);MWF.xDesktop.confirm("wram",a,MWF.LP.desktop.action.cancelUploadTitle,i,"400","140",function(){debugger;s.abort();this.close()},function(){this.close()})}else{n.closeItem(t,a)}};window.setTimeout(function(){if(!layout.desktop.message.isShow)layout.desktop.message.show()}.bind(this),300);return n},getAuthentication:function(e,t){this.invoke({name:"authentication",async:true,success:function(s,a){if(s.data.tokenType!="anonymous"){if(e)e(s)}else{if(t)t(null,a,s.message)}},failure:t})},login:function(e,t,s){var a="login";this.invoke({name:a,async:true,data:e,success:function(e,a){if(e.data.tokenType!="anonymous"){if(t)t(e)}else{if(s)s(null,a,e.message)}},failure:s})},logout:function(e,t){this.invoke({name:"logout",async:false,success:e,failure:t})}});MWF.xDesktop.Actions.RestActions.Callback=new Class({initialize:function(e,t,s,a){this.success=e;this.failure=t;this.appendSuccess=s;this.appendFailure=a},onSuccess:function(e,t){if(e){switch(e.type){case"success":if(this.appendSuccess)this.appendSuccess(e);if(this.success)this.success(e,t);break;case"warn":MWF.xDesktop.notice("info",{x:"right",y:"top"},e.errorMessage.join("\n"));if(this.appendSuccess)this.appendSuccess(e);if(this.success)this.success(e);break;case"error":this.doError(null,t,e.message);break}}else{this.doError(null,t,"")}},onRequestFailure:function(e){this.doError(e,"","")},onFailure:function(e){this.doError(e,"","")},onError:function(e,t){this.doError(null,e,t)},doError:function(e,t,s){if(this.appendFailure)this.appendFailure(e,t,s);if(this.failure)this.failure(e,t,s);if(!this.failure&&!this.appendFailure){if(e.status!=0){var a=s+":"+t;if(e)a=e.responseText;MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+a)}}}});