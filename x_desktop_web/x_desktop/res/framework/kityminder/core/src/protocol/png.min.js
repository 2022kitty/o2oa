define(function(e,t,r){var n=e("../core/kity");var i=e("../core/data");var a=e("../core/promise");var o=window.URL||window.webkitURL||window;function d(e,t){return new a(function(t,r){var n=document.createElement("img");n.onload=function(){t({element:this,x:e.x,y:e.y,width:e.width,height:e.height})};n.onerror=function(e){r(e)};n.crossOrigin="";n.src=e.url})}function l(e){var t=e.getPaper(),r,n=t.container,i,a,d,l=e.getRenderContainer(),g=l.getRenderBox(),h=g.width+1,u=g.height+1,c,s,m;r=t.shapeNode.getAttribute("transform");t.shapeNode.setAttribute("transform","translate(0.5, 0.5)");l.translate(-g.x,-g.y);i=t.container.innerHTML;l.translate(g.x,g.y);t.shapeNode.setAttribute("transform",r);a=document.createElement("div");a.innerHTML=i;d=a.querySelector("svg");d.setAttribute("width",g.width+1);d.setAttribute("height",g.height+1);d.setAttribute("style",'font-family: Arial, "Microsoft Yahei","Heiti SC";');a=document.createElement("div");a.appendChild(d);i=a.innerHTML;i=i.replace(' xmlns="http://www.w3.org/2000/svg" '+'xmlns:NS1="" NS1:ns1:xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:NS2="" NS2:xmlns:ns1=""',"");i=i.replace(/&nbsp;/g,"&#xa0;");c=new Blob([i],{type:"image/svg+xml"});s=o.createObjectURL(c);var v=e.getAllNode();var f=[];for(var w=0;w<v.length;w++){var p=v[w].data;if(p.image){e.renderNode(v[w]);var x=p.image;var y=p.imageSize;var b=v[w].getRenderBox("ImageRenderer",e.getRenderContainer());var R={url:x,width:y.width,height:y.height,x:-l.getBoundaryBox().x+b.x+20,y:-l.getBoundaryBox().y+b.y+20};f.push(R)}}return{width:h,height:u,dataUrl:s,xml:i,imagesInfo:f}}function g(e,t){var r;var i=kityminder.Promise;var a=document.createElement("canvas");var g=a.getContext("2d");var h=t.getStyle("background").toString();var u=/url\(\"(.+)\"\)/.exec(h);var c=n.Color.parse(h);var s=l(t);var m=s.width;var v=s.height;var f=s.dataUrl;var w=s.imagesInfo;var p=20;a.width=m+p*2;a.height=v+p*2;function x(e,t){e.save();e.fillStyle=t;e.fillRect(0,0,a.width,a.height);e.restore()}function y(e,t,r,n,i,a){if(i&&a){e.drawImage(t,r,n,i,a)}else{e.drawImage(t,r,n)}}function b(e){return e.toDataURL("image/png")}function R(e){var t=e.map(function(e){return d(e)});return i.all(t)}function S(){var e={url:f};return d(e).then(function(e){y(g,e.element,p,p);return R(w)}).then(function(e){for(var t=0;t<e.length;t++){y(g,e[t].element,e[t].x,e[t].y,e[t].width,e[t].height)}o.revokeObjectURL(f);document.body.appendChild(a);return b(a)},function(e){alert("脑图的节点中包含跨域图片，导出的 png 中节点图片不显示，你可以替换掉这些跨域的图片并重试。");o.revokeObjectURL(f);document.body.appendChild(a);return b(a)})}if(u){var N={url:u[1]};return d(N).then(function(e){x(g,g.createPattern(e.element,"repeat"));return S()})}else{x(g,c.toString());return S()}}i.registerProtocol("png",r.exports={fileDescription:"PNG 图片",fileExtension:".png",mineType:"image/png",dataType:"base64",encode:g})});