define(function(r,e,n){var t=r("../core/data");var i=r("../core/kity").Browser;var o="\r",a=/\r\n|\r|\n/,u=function(r){if(r.gecko){return{REGEXP:new RegExp("^(\t|"+String.fromCharCode(160,160,32,160)+")"),DELETE:new RegExp("^(\t|"+String.fromCharCode(160,160,32,160)+")+")}}else if(r.ie||r.edge){return{REGEXP:new RegExp("^("+String.fromCharCode(32)+"|"+String.fromCharCode(160)+")"),DELETE:new RegExp("^("+String.fromCharCode(32)+"|"+String.fromCharCode(160)+")+")}}else{return{REGEXP:/^(\t|\x20{4})/,DELETE:/^(\t|\x20{4})+/}}}(i);function f(r,e){var n="";while(e--)n+=r;return n}function c(r){if(!r){return""}var e=[],n=["\\","n"];for(var t=0,i=0,o=r.length;t<o;t++){if(r[t]==="\n"||r[t]==="\r"){e.push("\\n");i=0;continue}if(r[t]===n[i]){i++;if(i===2){i=0;e.push("\\\\n")}continue}switch(i){case 0:{e.push(r[t]);break}case 1:{e.push(r[t-1],r[t])}}i=0}return e.join("")}function h(r){if(!r){return""}var e=[],n=["\\","\\","n"];for(var t=0,i=0,o=r.length;t<o;t++){if(r[t]===n[i]){i++;if(i===3){i=0;e.push("\\n")}continue}switch(i){case 0:{e.push(r[t]);i=0;break}case 1:{if(r[t]==="n"){e.push("\n")}else{e.push(r[t-1],r[t])}i=0;break}case 2:{e.push(r[t-2]);if(r[t]!=="\\"){i=0;e.push(r[t-1],r[t])}break}}}return e.join("")}function s(r,e){var n="";e=e||0;n+=f("\t",e);n+=c(r.data.text)+o;if(r.children){r.children.forEach(function(r){n+=s(r,e+1)})}return n}function l(r){return!/\S/.test(r)}function E(r){var e=0;while(u.REGEXP.test(r)){r=r.replace(u.REGEXP,"");e++}return e}function d(r){return{data:{text:h(r.replace(u.DELETE,""))}}}function p(r){var e,n={},t=r.split(a),i,o,u;function f(r,e){var n=r.children||(r.children=[]);n.push(e)}for(var c=0;c<t.length;c++){i=t[c];if(l(i))continue;o=E(i);u=d(i);if(o===0){if(e){throw new Error("Invalid local format")}e=u}else{if(!n[o-1]){throw new Error("Invalid local format")}f(n[o-1],u)}n[o]=u}return e}function g(r){function e(r){var n={};n.data=r.getData();var t=r.getChildren();n.children=[];for(var i=0;i<t.length;i++){n.children.push(e(t[i]))}return n}if(!r)return;if(/^\s*$/.test(r.data.text)){r.data.text="分支主题"}return s(e(r))}t.registerProtocol("text",n.exports={fileDescription:"大纲文本",fileExtension:".txt",dataType:"text",mineType:"text/plain",encode:function(r){return s(r.root,0)},decode:function(r){return p(r)},Node2Text:function(r){return g(r)}})});