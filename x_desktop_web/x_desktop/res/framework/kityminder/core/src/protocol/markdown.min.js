define(function(e,t,n){var r=e("../core/data");var o=/\r\n|\r|\n/;var i="";var a="<!--Note-->";var c="<!--/Note-->";function l(e){return u(e,1).join("\n")}function u(e,t){var n=[];t=t||1;var r=f(t);n.push(r+" "+e.data.text);n.push(i);var o=e.data.note;if(o){var l=/^#/.test(o);if(l){n.push(a);o=o.replace(/^#+/gm,function(e){return r+e})}n.push(o);if(l){n.push(c)}n.push(i)}if(e.children)e.children.forEach(function(e){n=n.concat(u(e,t+1))});return n}function f(e){var t="";while(e--)t+="#";return t}function d(e){var t,n={},r,i,a,c,l,u,f,d;e=e.replace(/^(.+)\n={3,}/,function(e,t){return"# "+t});r=e.split(o);for(var v=0;v<r.length;v++){i=r[v];a=p(i);if(a.noteClose){f=false;continue}else if(a.noteStart){f=true;continue}d=a.codeBlock?!d:d;if(f||d||!a.level||a.level>c+1){if(l)h(l,i);continue}c=a.level;l=s(a.content,n[c-1]);n[c]=l}g(n[1]);return n[1]}function s(e,t){var n={data:{text:e,note:""}};if(t){if(t.children)t.children.push(n);else t.children=[n]}return n}function h(e,t){e.data.note+=t+"\n"}function v(e){return!/\S/.test(e)}function p(e){var t=/^(#+)?\s*(.*)$/.exec(e);return{level:t[1]&&t[1].length||null,content:t[2],noteStart:e==a,noteClose:e==c,codeBlock:/^\s*```/.test(e)}}function g(e){if(!/\S/.test(e.data.note)){e.data.note=null;delete e.data.note}else{var t=e.data.note.split("\n");while(t.length&&!/\S/.test(t[0]))t.shift();while(t.length&&!/\S/.test(t[t.length-1]))t.pop();e.data.note=t.join("\n")}if(e.children)e.children.forEach(g)}r.registerProtocol("markdown",n.exports={fileDescription:"Markdown/GFM 格式",fileExtension:".md",mineType:"text/markdown",dataType:"text",encode:function(e){return l(e.root)},decode:function(e){return d(e)}})});