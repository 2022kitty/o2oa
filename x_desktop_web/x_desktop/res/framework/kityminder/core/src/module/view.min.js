define(function(e,t,i){var n=e("../core/kity");var r=e("../core/utils");var o=e("../core/minder");var a=e("../core/node");var s=e("../core/command");var h=e("../core/module");var u=e("../core/render");var l=n.createClass("ViewDragger",{constructor:function(e){this._minder=e;this._enabled=false;this._bind();var t=this;this._minder.getViewDragger=function(){return t};this.setEnabled(false)},isEnabled:function(){return this._enabled},setEnabled:function(e){var t=this._minder.getPaper();t.setStyle("cursor",e?"pointer":"default");t.setStyle("cursor",e?"-webkit-grab":"default");this._enabled=e},timeline:function(){return this._moveTimeline},move:function(e,t){var i=this._minder;var n=this.getMovement().offset(e);this.moveTo(n,t)},moveTo:function(e,t){if(t){var i=this;if(this._moveTimeline)this._moveTimeline.stop();this._moveTimeline=this._minder.getRenderContainer().animate(new n.Animator(this.getMovement(),e,function(e,t){i.moveTo(t)}),t,"easeOutCubic").timeline();this._moveTimeline.on("finish",function(){i._moveTimeline=null});return this}this._minder.getRenderContainer().setTranslate(e.round());this._minder.fire("viewchange")},getMovement:function(){var e=this._minder.getRenderContainer().transform.translate;return e?e[0]:new n.Point},getView:function(){var e=this._minder;var t=e._lastClientSize||{width:e.getRenderTarget().clientWidth,height:e.getRenderTarget().clientHeight};var i=this.getMovement();var r=new n.Box(0,0,t.width,t.height);var o=e.getPaper().getViewPortMatrix();return o.inverse().translate(-i.x,-i.y).transformBox(r)},_bind:function(){var e=this,t=false,i=null,r=null;function o(n){if(!i)return;i=null;n.stopPropagation();if(t){e.setEnabled(false);t=false;if(e._minder.getStatus()=="hand")e._minder.rollbackStatus()}var r=e._minder.getPaper();r.setStyle("cursor",e._minder.getStatus()=="hand"?"-webkit-grab":"default");e._minder.fire("viewchanged")}this._minder.on("normal.mousedown normal.touchstart "+"inputready.mousedown inputready.touchstart "+"readonly.mousedown readonly.touchstart",function(e){if(e.originEvent.button==2){e.originEvent.preventDefault()}if(e.getTargetNode()==this.getRoot()||e.originEvent.button==2||e.originEvent.altKey){i=e.getPosition("view");t=true}}).on("normal.mousemove normal.touchmove "+"readonly.mousemove readonly.touchmove "+"inputready.mousemove inputready.touchmove",function(r){if(r.type=="touchmove"){r.preventDefault()}if(!t)return;var o=n.Vector.fromPoints(i,r.getPosition("view"));if(o.length()>10){this.setStatus("hand",true);var a=e._minder.getPaper();a.setStyle("cursor","-webkit-grabbing")}}).on("hand.beforemousedown hand.beforetouchstart",function(t){if(e.isEnabled()){i=t.getPosition("view");t.stopPropagation();var n=e._minder.getPaper();n.setStyle("cursor","-webkit-grabbing")}}).on("hand.beforemousemove hand.beforetouchmove",function(t){if(i){r=t.getPosition("view");var o=n.Vector.fromPoints(i,r);e.move(o);t.stopPropagation();t.preventDefault();t.originEvent.preventDefault();i=r}}).on("mouseup touchend",o);window.addEventListener("mouseup",o);this._minder.on("contextmenu",function(e){e.preventDefault()})}});h.register("View",function(){var e=this;var t=n.createClass("ToggleHandCommand",{base:s,execute:function(e){if(e.getStatus()!="hand"){e.setStatus("hand",true)}else{e.rollbackStatus()}this.setContentChanged(false)},queryState:function(e){return e.getStatus()=="hand"?1:0},enableReadOnly:true});var i=n.createClass("CameraCommand",{base:s,execute:function(e,t){t=t||e.getRoot();var i=e.getPaper().getViewPort();var r=t.getRenderContainer().getRenderBox("view");var o=i.center.x-r.x-r.width/2,a=i.center.y-r.y;var s=e._viewDragger;var h=e.getOption("viewAnimationDuration");s.move(new n.Point(o,a),h);this.setContentChanged(false)},enableReadOnly:true});var r=n.createClass("MoveCommand",{base:s,execute:function(e,t){var i=e._viewDragger;var r=e._lastClientSize;var o=e.getOption("viewAnimationDuration");switch(t){case"up":i.move(new n.Point(0,r.height/2),o);break;case"down":i.move(new n.Point(0,-r.height/2),o);break;case"left":i.move(new n.Point(r.width/2,0),o);break;case"right":i.move(new n.Point(-r.width/2,0),o);break}},enableReadOnly:true});return{init:function(){this._viewDragger=new l(this)},commands:{hand:t,camera:i,move:r},events:{statuschange:function(e){this._viewDragger.setEnabled(e.currentStatus=="hand")},mousewheel:function(e){var t,i;e=e.originEvent;if(e.ctrlKey||e.shiftKey)return;if("wheelDeltaX"in e){t=e.wheelDeltaX||0;i=e.wheelDeltaY||0}else{t=0;i=e.wheelDelta}this._viewDragger.move({x:t/2.5,y:i/2.5});var n=this;clearTimeout(this._mousewheeltimer);this._mousewheeltimer=setTimeout(function(){n.fire("viewchanged")},100);e.preventDefault()},"normal.dblclick readonly.dblclick":function(e){if(e.kityEvent.targetShape instanceof n.Paper){this.execCommand("camera",this.getRoot(),800)}},"paperrender finishInitHook":function(){if(!this.getRenderTarget()){return}this.execCommand("camera",null,0);this._lastClientSize={width:this.getRenderTarget().clientWidth,height:this.getRenderTarget().clientHeight}},resize:function(e){var t={width:this.getRenderTarget().clientWidth,height:this.getRenderTarget().clientHeight},i=this._lastClientSize;this._viewDragger.move(new n.Point((t.width-i.width)/2|0,(t.height-i.height)/2|0));this._lastClientSize=t},"selectionchange layoutallfinish":function(e){var t=this.getSelectedNode();var i=this;if(n.Browser.edge){this.fire("paperrender")}if(!t)return;var r=this._viewDragger;var o=r.timeline();if(o){o.on("finish",function(){i.fire("selectionchange")});return}var a=r.getView();var s=t.getLayoutBox();var h=50;var u=0,l=0;if(s.right>a.right){u+=a.right-s.right-h}else if(s.left<a.left){u+=a.left-s.left+h}if(s.bottom>a.bottom){l+=a.bottom-s.bottom-h}if(s.top<a.top){l+=a.top-s.top+h}if(u||l)r.move(new n.Point(u,l),100)}}}})});