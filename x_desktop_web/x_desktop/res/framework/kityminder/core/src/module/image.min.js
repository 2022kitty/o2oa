define(function(e,t,a){var r=e("../core/kity");var i=e("../core/utils");var n=e("../core/minder");var o=e("../core/node");var g=e("../core/command");var c=e("../core/module");var u=e("../core/render");c.register("image",function(){function e(e,t){var a=document.createElement("img");a.onload=function(){t(a.width,a.height)};a.onerror=function(){t(null)};a.src=e}function t(e,t,a,r){var i=e/t,n=a/r;if(e>a&&i>n){e=a;t=e/i}else if(t>r){t=r;e=t*i}return{width:e|0,height:t|0}}var a=r.createClass("ImageCommand",{base:g,execute:function(a,r,i){var n=a.getSelectedNodes();e(r,function(e,o){n.forEach(function(n){var g=t(e,o,a.getOption("maxImageWidth"),a.getOption("maxImageHeight"));n.setData("image",r);n.setData("imageTitle",r&&i);n.setData("imageSize",r&&g);n.render()});a.fire("saveScene");a.layout(300)})},queryState:function(e){var t=e.getSelectedNodes(),a=0;if(t.length===0){return-1}t.forEach(function(e){if(e&&e.getData("image")){a=0;return false}});return a},queryValue:function(e){var t=e.getSelectedNode();return{url:t.getData("image"),title:t.getData("imageTitle")}}});var i=r.createClass("ImageRenderer",{base:u,create:function(e){return new r.Image(e.getData("image"))},shouldRender:function(e){return e.getData("image")},update:function(e,t,a){var i=t.getData("image");var n=t.getData("imageTitle");var o=t.getData("imageSize");var g=t.getStyle("space-top");if(!o)return;if(n){e.node.setAttributeNS("http://www.w3.org/1999/xlink","title",n)}var c=a.cx-o.width/2;var u=a.y-o.height-g;e.setUrl(i).setX(c|0).setY(u|0).setWidth(o.width|0).setHeight(o.height|0);return new r.Box(c|0,u|0,o.width|0,o.height|0)}});return{defaultOptions:{maxImageWidth:200,maxImageHeight:200},commands:{image:a},renderers:{top:i}}})});