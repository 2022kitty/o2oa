define(function(e,a,t){var r=e("../core/kity");var i=e("../core/utils");var n=e("../core/minder");var s=e("../core/node");var o=e("../core/command");var c=e("../core/module");var l=e("../core/render");var m={safari:{"微软雅黑,Microsoft YaHei":-.17,"楷体,楷体_GB2312,SimKai":-.1,"隶书, SimLi":-.1,"comic sans ms":-.23,"impact,chicago":-.15,"times new roman":-.1,"arial black,avant garde":-.17,default:0},ie:{10:{"微软雅黑,Microsoft YaHei":-.17,"comic sans ms":-.17,"impact,chicago":-.08,"times new roman":.04,"arial black,avant garde":-.17,default:-.15},11:{"微软雅黑,Microsoft YaHei":-.17,"arial,helvetica,sans-serif":-.17,"comic sans ms":-.17,"impact,chicago":-.08,"times new roman":.04,"sans-serif":-.16,"arial black,avant garde":-.17,default:-.15}},edge:{"微软雅黑,Microsoft YaHei":-.15,"arial,helvetica,sans-serif":-.17,"comic sans ms":-.17,"impact,chicago":-.08,"sans-serif":-.16,"arial black,avant garde":-.17,default:-.15},sg:{"微软雅黑,Microsoft YaHei":-.15,"arial,helvetica,sans-serif":-.05,"comic sans ms":-.22,"impact,chicago":-.16,"times new roman":-.03,"arial black,avant garde":-.22,default:-.15},chrome:{Mac:{"andale mono":-.05,"comic sans ms":-.3,"impact,chicago":-.13,"times new roman":-.1,"arial black,avant garde":-.17,default:0},Win:{"微软雅黑,Microsoft YaHei":-.15,"arial,helvetica,sans-serif":-.02,"arial black,avant garde":-.2,"comic sans ms":-.2,"impact,chicago":-.12,"times new roman":-.02,default:-.15},Lux:{"andale mono":-.05,"comic sans ms":-.3,"impact,chicago":-.13,"times new roman":-.1,"arial black,avant garde":-.17,default:0}},firefox:{Mac:{"微软雅黑,Microsoft YaHei":-.2,"宋体,SimSun":.05,"comic sans ms":-.2,"impact,chicago":-.15,"arial black,avant garde":-.17,"times new roman":-.1,default:.05},Win:{"微软雅黑,Microsoft YaHei":-.16,"andale mono":-.17,"arial,helvetica,sans-serif":-.17,"comic sans ms":-.22,"impact,chicago":-.23,"times new roman":-.22,"sans-serif":-.22,"arial black,avant garde":-.17,default:-.16},Lux:{"宋体,SimSun":-.2,"微软雅黑,Microsoft YaHei":-.2,"黑体, SimHei":-.2,"隶书, SimLi":-.2,"楷体,楷体_GB2312,SimKai":-.2,"andale mono":-.2,"arial,helvetica,sans-serif":-.2,"comic sans ms":-.2,"impact,chicago":-.2,"times new roman":-.2,"sans-serif":-.2,"arial black,avant garde":-.2,default:-.16}}};var f=r.createClass("TextRenderer",{base:l,create:function(){return(new r.Group).setId(i.uuid("node_text"))},update:function(e,a){function t(e){return a.getData(e)||a.getStyle(e)}var i=a.getText();var n=i?i.split("\n"):[" "];var s=a.getStyle("line-height");var o=t("font-size");var c=t("font-family")||"default";var l=s*o*n.length-(s-1)*o;var f=-l/2;var d=r.Browser;var g;if(d.chrome||d.opera||d.bd||d.lb==="chrome"){g=m["chrome"][d.platform][c]}else if(d.gecko){g=m["firefox"][d.platform][c]}else if(d.sg){g=m["sg"][c]}else if(d.safari){g=m["safari"][c]}else if(d.ie){g=m["ie"][d.version][c]}else if(d.edge){g=m["edge"][c]}else if(d.lb){g=.9}e.setTranslate(0,(g||0)*o);var u=new r.Box,v=Math.round;this.setTextStyle(a,e);var h=n.length;var x=e.getItems().length;var p,w,S,b;if(h<x){for(p=h,w;w=e.getItem(p);){e.removeItem(p)}}else if(h>x){var k=h-x;while(k--){S=(new r.Text).setAttr("text-rendering","inherit");if(r.Browser.ie||r.Browser.edge){S.setVerticalAlign("top")}else{S.setAttr("dominant-baseline","text-before-edge")}e.addItem(S)}}for(p=0,b,S;b=n[p],S=e.getItem(p);p++){S.setContent(b);if(r.Browser.ie||r.Browser.edge){S.fixPosition()}}this.setTextStyle(a,e);var y=a.getText()+["font-size","font-name","font-weight","font-style"].map(t).join("/");if(a._currentTextHash==y&&a._currentTextGroupBox)return a._currentTextGroupBox;a._currentTextHash=y;return function(){e.eachItem(function(e,a){var t=f+e*o*s;a.setY(t);var i=a.getBoundaryBox();u=u.merge(new r.Box(0,t,i.height&&i.width||1,o))});var t=new r.Box(v(u.x),v(u.y),v(u.width),v(u.height));a._currentTextGroupBox=t;return t}},setTextStyle:function(e,a){var t=f._styleHooks;t.forEach(function(t){t(e,a)})}});var d=r.createClass({base:o,execute:function(e,a){var t=e.getSelectedNode();if(t){t.setText(a);t.render();e.layout()}},queryState:function(e){return e.getSelectedNodes().length==1?0:-1},queryValue:function(e){var a=e.getSelectedNode();return a?a.getText():null}});i.extend(f,{_styleHooks:[],registerStyleHook:function(e){f._styleHooks.push(e)}});r.extendClass(s,{getTextGroup:function(){return this.getRenderer("TextRenderer").getRenderShape()}});c.register("text",{commands:{text:d},renderers:{center:f}});t.exports=f});