define(function(t,e,r){var i=t("../core/kity");var n=t("../core/utils");var o=t("../core/node");var s=t("../core/command");var a=t("../core/module");var d=i.createClass("MoveToParentCommand",{base:s,execute:function(t,e,r){var i;for(var n=e.length-1;n>=0;n--){i=e[n];if(i.parent){i.parent.removeChild(i);r.appendChild(i);i.render()}}r.expand();t.select(e,true)}});var h=i.createClass("DropHinter",{base:i.Group,constructor:function(){this.callBase();this.rect=new i.Rect;this.addShape(this.rect)},render:function(t){this.setVisible(!!t);if(t){this.rect.setBox(t.getLayoutBox()).setRadius(t.getStyle("radius")||0).stroke(t.getStyle("drop-hint-color")||"yellow",t.getStyle("drop-hint-width")||2);this.bringTop()}}});var u=i.createClass("OrderHinter",{base:i.Group,constructor:function(){this.callBase();this.area=new i.Rect;this.path=new i.Path;this.addShapes([this.area,this.path])},render:function(t){this.setVisible(!!t);if(t){this.area.setBox(t.area);this.area.fill(t.node.getStyle("order-hint-area-color")||"rgba(0, 255, 0, .5)");this.path.setPathData(t.path);this.path.stroke(t.node.getStyle("order-hint-path-color")||"#0f0",t.node.getStyle("order-hint-path-width")||1)}}});var c=i.createClass("TreeDragger",{constructor:function(t){this._minder=t;this._dropHinter=new h;this._orderHinter=new u;t.getRenderContainer().addShapes([this._dropHinter,this._orderHinter])},dragStart:function(t){this._startPosition=t},dragMove:function(t){var e=10;if(!this._startPosition)return;var r=i.Vector.fromPoints(this._dragPosition||this._startPosition,t);var n=this._minder;this._dragPosition=t;if(!this._dragMode){if(i.Vector.fromPoints(this._dragPosition,this._startPosition).length()<e){return}if(!this._enterDragMode()){return}}for(var o=0;o<this._dragSources.length;o++){this._dragSources[o].setLayoutOffset(this._dragSources[o].getLayoutOffset().offset(r));n.applyLayoutResult(this._dragSources[o])}if(!this._dropTest()){this._orderTest()}else{this._renderOrderHint(this._orderSucceedHint=null)}},dragEnd:function(){this._startPosition=null;this._dragPosition=null;if(!this._dragMode){return}this._fadeDragSources(1);if(this._dropSucceedTarget){this._dragSources.forEach(function(t){t.setLayoutOffset(null)});this._minder.layout(-1);this._minder.execCommand("movetoparent",this._dragSources,this._dropSucceedTarget)}else if(this._orderSucceedHint){var t=this._orderSucceedHint;var e=t.node.getIndex();var r=this._dragSources.map(function(t){t.setLayoutOffset(null);return t.getIndex()});var i=Math.max.apply(Math,r);var n=Math.min.apply(Math,r);if(e<n&&t.type=="down")e++;if(e>i&&t.type=="up")e--;t.node.setLayoutOffset(null);this._minder.execCommand("arrange",e);this._renderOrderHint(null)}else{this._minder.fire("savescene")}this._minder.layout(300);this._leaveDragMode();this._minder.fire("contentchange")},_enterDragMode:function(){this._calcDragSources();if(!this._dragSources.length){this._startPosition=null;return false}this._fadeDragSources(.5);this._calcDropTargets();this._calcOrderHints();this._dragMode=true;this._minder.setStatus("dragtree");return true},_calcDragSources:function(){this._dragSources=this._minder.getSelectedAncestors()},_fadeDragSources:function(t){var e=this._minder;this._dragSources.forEach(function(r){r.getRenderContainer().setOpacity(t,200);r.traverse(function(r){if(t<1){e.detachNode(r)}else{e.attachNode(r)}},true)})},_calcDropTargets:function(){function t(e,r){var i=[],n;i.push(r);r.getChildren().forEach(function(r){for(n=0;n<e.length;n++){if(e[n]==r)return}i=i.concat(t(e,r))});return i}this._dropTargets=t(this._dragSources,this._minder.getRoot());this._dropTargetBoxes=this._dropTargets.map(function(t){return t.getLayoutBox()})},_calcOrderHints:function(){var t=this._dragSources;var e=o.getCommonAncestor(t);if(e==t[0])e=t[0].parent;if(t.length===0||e!=t[0].parent){this._orderHints=[];return}var r=e.children;this._orderHints=r.reduce(function(e,r){if(t.indexOf(r)==-1){e=e.concat(r.getOrderHint())}return e},[])},_leaveDragMode:function(){this._dragMode=false;this._dropSucceedTarget=null;this._orderSucceedHint=null;this._renderDropHint(null);this._renderOrderHint(null);this._minder.rollbackStatus()},_drawForDragMode:function(){this._text.setContent(this._dragSources.length+" items");this._text.setPosition(this._startPosition.x,this._startPosition.y+5);this._minder.getRenderContainer().addShape(this)},_boxTest:function(t,e,r){var i=this._dragSources.map(function(t){return t.getLayoutBox()});var n,o,s,a,d;r=r||function(t,e,r){return t&&!t.isEmpty()};for(n=0;n<t.length;n++){s=t[n];d=e.call(this,s,n);for(o=0;o<i.length;o++){a=i[o];var h=a.intersect(d);if(r(h,a,d)){return s}}}return null},_dropTest:function(){this._dropSucceedTarget=this._boxTest(this._dropTargets,function(t,e){return this._dropTargetBoxes[e]},function(t,e,r){function i(t){return t.width*t.height}if(!t)return false;if(!i(t))return false;if(i(t)>.5*Math.min(i(e),i(r)))return true;if(t.width+1>=Math.min(e.width,r.width))return true;if(t.height+1>=Math.min(e.height,r.height))return true;return false});this._renderDropHint(this._dropSucceedTarget);return!!this._dropSucceedTarget},_orderTest:function(){this._orderSucceedHint=this._boxTest(this._orderHints,function(t){return t.area});this._renderOrderHint(this._orderSucceedHint);return!!this._orderSucceedHint},_renderDropHint:function(t){this._dropHinter.render(t)},_renderOrderHint:function(t){this._orderHinter.render(t)},preventDragMove:function(){this._startPosition=null}});a.register("DragTree",function(){var t;return{init:function(){t=new c(this);window.addEventListener("mouseup",function(){t.dragEnd()})},events:{"normal.mousedown inputready.mousedown":function(e){if(e.originEvent.button)return;if(e.getTargetNode()&&e.getTargetNode()!=this.getRoot()){t.dragStart(e.getPosition())}},"normal.mousemove dragtree.mousemove":function(e){t.dragMove(e.getPosition())},"normal.mouseup dragtree.beforemouseup":function(e){t.dragEnd();e.preventDefault()},statuschange:function(e){if(e.lastStatus=="textedit"&&e.currentStatus=="normal"){t.preventDragMove()}}},commands:{movetoparent:d}}})});