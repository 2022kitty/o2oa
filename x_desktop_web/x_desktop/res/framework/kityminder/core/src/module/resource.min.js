define(function(e,r,t){var n=e("../core/kity");var o=e("../core/utils");var a=e("../core/minder");var i=e("../core/node");var s=e("../core/command");var u=e("../core/module");var c=e("../core/render");u.register("Resource",function(){var e=function(){var e,r,t,n,o,a,i,s,u,c,h;h=4*(1<<30);e=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];o=[608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479];c=function(e){if(e<0){e+=h}return("00000000"+e.toString(16)).slice(-8)};a=[[16,50,84,118,152,186,220,254],[174,132,249,109,193,32,123,53],[139,12,37,223,234,99,23,73],[151,19,205,235,98,165,4,143],[9,117,66,250,30,203,134,211],[194,166,176,56,212,87,239,145],[92,241,222,164,112,54,41,184],[189,231,28,147,5,79,104,162],[246,158,59,128,44,125,65,90],[42,72,103,81,191,233,195,13]];i=function(e,r,t){var n=s[e]^s[r];s[e]=n>>>t|n<<32-t};r=function(e,r,c,h,l){var f=n+a[t][e]%16,d=n+(a[t][e]>>4);r%=4;c=4+c%4;h=8+h%4;l=12+l%4;s[r]+=s[c]+(u[f]^o[d%16]);i(l,r,16);s[h]+=s[l];i(c,h,12);s[r]+=s[c]+(u[d]^o[f%16]);i(l,r,8);s[h]+=s[l];i(c,h,7)};return function(a,i){if(!(i instanceof Array&&i.length===4)){i=[0,0,0,0]}var h,l,f,d,g,v,p,C;l=e.slice(0);h=o.slice(0,8);for(t=0;t<4;t+=1){h[t]^=i[t]}f=a.length*16;g=f%512>446||f%512===0?0:f;if(f%512===432){a+="老"}else{a+="耀";while(a.length%32!==27){a+="\0"}a+=""}u=[];for(C=0;C<a.length;C+=2){u.push(a.charCodeAt(C)*65536+a.charCodeAt(C+1))}u.push(0);u.push(f);v=u.length-16;p=0;for(n=0;n<u.length;n+=16){p+=512;d=n===v?g:Math.min(f,p);s=l.concat(h);s[12]^=d;s[13]^=d;for(t=0;t<10;t+=1){for(C=0;C<8;C+=1){if(C<4){r(C,C,C,C,C)}else{r(C,C,C+1,C+2,C+3)}}}for(C=0;C<8;C+=1){l[C]^=i[C%4]^s[C]^s[C+8]}}return l.map(c).join("")}}();var r=[51,303,75,200,157,0,26,254].map(function(e){return n.Color.createHSL(e,100,85)});n.extendClass(a,{getHashCode:function(r){r=e(r);var t=1315423911,n,o;for(n=r.length-1;n>=0;n--){o=r.charCodeAt(n);t^=(t<<5)+o+(t>>2)}return t&2147483647},getResourceColor:function(e){var t=this._getResourceColorIndexMapping();var o;if(!t.hasOwnProperty(e)){o=this._getNextResourceColorIndex();t[e]=o}return r[t[e]]||n.Color.createHSL(Math.floor(this.getHashCode(e)/2147483647*359),100,85)},getUsedResource:function(){var e=this._getResourceColorIndexMapping();var r=[],t;for(t in e){if(e.hasOwnProperty(t)){r.push(t)}}return r},_getNextResourceColorIndex:function(){var e=this._getResourceColorIndexMapping();var t,n,o;n=[];for(t in e){if(e.hasOwnProperty(t)){n.push(e[t])}}for(o=0;o<r.length;o++){if(!~n.indexOf(o))return o}return-1},_getResourceColorIndexMapping:function(){return this._resourceColorMapping||(this._resourceColorMapping={})}});var t=n.createClass("ResourceCommand",{base:s,execute:function(e,r){var t=e.getSelectedNodes();if(typeof r=="string"){r=[r]}t.forEach(function(e){e.setData("resource",r).render()});e.layout(200)},queryValue:function(e){var r=e.getSelectedNodes();var t=[];r.forEach(function(e){var r=e.getData("resource");if(!r)return;r.forEach(function(e){if(!~t.indexOf(e)){t.push(e)}})});return t},queryState:function(e){return e.getSelectedNode()?0:-1}});var o=n.createClass("ResourceOverlay",{base:n.Group,constructor:function(){this.callBase();var e,r;r=this.rect=(new n.Rect).setRadius(4);e=this.text=(new n.Text).setFontSize(12).setVerticalAlign("middle");this.addShapes([r,e])},setValue:function(e,r){var t=8,n=4,o=4;var a,i,s;a=this.text;if(e==this.lastResourceName){i=this.lastBox}else{a.setContent(e);i=a.getBoundaryBox();this.lastResourceName=e;this.lastBox=i}a.setX(t).fill(r.dec("l",70));s=this.rect;s.setPosition(0,i.y-n);this.width=Math.round(i.width+t*2);this.height=Math.round(i.height+n*2);s.setSize(this.width,this.height);s.fill(r)}});var i=n.createClass("ResourceRenderer",{base:c,create:function(e){this.overlays=[];return new n.Group},shouldRender:function(e){return e.getData("resource")&&e.getData("resource").length},update:function(e,r,t){var a=r.getStyle("space-right");var i=this.overlays;var s=r.getData("resource").filter(function(e){return e!==null});if(s.length===0){return}var u=r.getMinder();var c,h,l;l=0;for(c=0;c<s.length;c++){l+=a;h=i[c];if(!h){h=new o;i.push(h);e.addShape(h)}h.setVisible(true);h.setValue(s[c],u.getResourceColor(s[c]));h.setTranslate(l,-1);l+=h.width}while(h=i[c++])h.setVisible(false);e.setTranslate(t.right,0);return new n.Box({x:t.right,y:Math.round(-i[0].height/2),width:l,height:i[0].height})}});return{commands:{resource:t},renderers:{right:i}}})});