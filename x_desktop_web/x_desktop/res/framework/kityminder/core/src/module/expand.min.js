define(function(e,t,n){var r=e("../core/kity");var a=e("../core/utils");var i=e("../core/keymap");var o=e("../core/node");var s=e("../core/command");var d=e("../core/module");var u=e("../core/render");d.register("Expand",function(){var e=this;var t="expandState",n="expand",d="collapse";r.extendClass(o,{expand:function(){this.setData(t,n);return this},collapse:function(){this.setData(t,d);return this},isExpanded:function(){var e=this.getData(t)!==d;return e&&(this.isRoot()||this.parent.isExpanded())},isCollapsed:function(){return!this.isExpanded()}});var l=r.createClass("ExpandCommand",{base:s,execute:function(e,t){var n=e.getSelectedNode();if(!n)return;if(t){n=n.parent}while(n.parent){n.expand();n=n.parent}n.renderTree();e.layout(100)},queryState:function(e){var t=e.getSelectedNode();return t&&!t.isRoot()&&!t.isExpanded()?0:-1}});var c=r.createClass("ExpandToLevelCommand",{base:s,execute:function(e,t){e.getRoot().traverse(function(e){if(e.getLevel()<t)e.expand();if(e.getLevel()==t&&!e.isLeaf())e.collapse()});e.refresh(100)},enableReadOnly:true});var p=r.createClass("CollapseCommand",{base:s,execute:function(e){var t=e.getSelectedNode();if(!t)return;t.collapse();t.renderTree();e.layout()},queryState:function(e){var t=e.getSelectedNode();return t&&!t.isRoot()&&t.isExpanded()?0:-1}});var f=r.createClass("Expander",{base:r.Group,constructor:function(e){this.callBase();this.radius=6;this.outline=new r.Circle(this.radius).stroke("gray").fill("white");this.sign=(new r.Path).stroke("gray");this.addShapes([this.outline,this.sign]);this.initEvent(e);this.setId(a.uuid("node_expander"));this.setStyle("cursor","pointer")},initEvent:function(t){this.on("mousedown",function(n){e.select([t],true);if(t.isExpanded()){t.collapse()}else{t.expand()}t.renderTree().getMinder().layout(100);t.getMinder().fire("contentchange");n.stopPropagation();n.preventDefault()});this.on("dblclick click mouseup",function(e){e.stopPropagation();e.preventDefault()})},setState:function(e){if(e=="hide"){this.setVisible(false);return}this.setVisible(true);var t=["M",1.5-this.radius,0,"L",this.radius-1.5,0];if(e==d){t.push(["M",0,1.5-this.radius,"L",0,this.radius-1.5])}this.sign.setPathData(t)}});var h=r.createClass("ExpanderRenderer",{base:u,create:function(e){if(e.isRoot())return;this.expander=new f(e);e.getRenderContainer().prependShape(this.expander);e.expanderRenderer=this;this.node=e;return this.expander},shouldRender:function(e){return!e.isRoot()},update:function(e,n,r){if(!n.parent)return;var a=n.parent.isExpanded();e.setState(a&&n.children.length?n.getData(t):"hide");var i=n.getLayoutVectorIn().normalize(e.radius+n.getStyle("stroke-width"));var o=n.getVertexIn().offset(i.reverse());this.expander.setTranslate(o)}});return{commands:{expand:l,expandtolevel:c,collapse:p},events:{layoutapply:function(e){var t=e.node.getRenderer("ExpanderRenderer");if(t.getRenderShape()){t.update(t.getRenderShape(),e.node)}},beforerender:function(e){var t=e.node;var n=!t.parent||t.parent.isExpanded();var r=this;t.getRenderContainer().setVisible(n);if(!n)e.stopPropagation()},"normal.keydown":function(e){if(this.getStatus()=="textedit")return;if(e.originEvent.keyCode==i["/"]){var t=this.getSelectedNode();if(!t||t==this.getRoot())return;var n=t.isExpanded();this.getSelectedNodes().forEach(function(e){if(n)e.collapse();else e.expand();e.renderTree()});this.layout(100);this.fire("contentchange");e.preventDefault();e.stopPropagationImmediately()}if(e.isShortcutKey("Alt+`")){this.execCommand("expandtolevel",9999)}for(var r=1;r<6;r++){if(e.isShortcutKey("Alt+"+r)){this.execCommand("expandtolevel",r)}}}},renderers:{outside:h},contextmenu:[{command:"expandtoleaf",query:function(){return!e.getSelectedNode()},fn:function(e){e.execCommand("expandtolevel",9999)}},{command:"expandtolevel1",query:function(){return!e.getSelectedNode()},fn:function(e){e.execCommand("expandtolevel",1)}},{command:"expandtolevel2",query:function(){return!e.getSelectedNode()},fn:function(e){e.execCommand("expandtolevel",2)}},{command:"expandtolevel3",query:function(){return!e.getSelectedNode()},fn:function(e){e.execCommand("expandtolevel",3)}},{divider:true}]}})});