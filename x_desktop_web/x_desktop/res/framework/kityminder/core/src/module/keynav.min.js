define(function(t,e,o){var n=t("../core/kity");var i=t("../core/utils");var r=t("../core/keymap");var d=t("../core/minder");var a=t("../core/node");var f=t("../core/command");var h=t("../core/module");var l=t("../core/render");h.register("KeyboardModule",function(){var t=Math.min,e=Math.max,o=Math.abs,n=Math.sqrt,i=Math.exp;function r(t){var e=[],o;t.traverse(function(t){o=t.getLayoutBox();if(o.width&&o.height){e.push({left:o.x,top:o.y,right:o.x+o.width,bottom:o.y+o.height,width:o.width,height:o.height,node:t})}});for(var n=0;n<e.length;n++){a(e,n)}}function d(o,i){var r,d,a,f,h,l,s,u,g;r=t(o.left,i.left);d=e(o.right,i.right);a=t(o.top,i.top);f=e(o.bottom,i.bottom);h=d-r-o.width-i.width;l=f-a-o.height-i.height;if(h<0)s=l;else if(l<0)s=h;else s=n(h*h+l*l);var v=o.node;var c=i.node;if(v.parent==c.parent){s/=10}if(c.parent==v){s/=5}return s}function a(t,e){var o=t[e];var n={},i;var r,a;for(var f=0;f<t.length;f++){if(f==e)continue;r=t[f];a=d(r,o);if(r.right<o.left){if(!n.left||a<n.left.dist){n.left={dist:a,node:r.node}}}if(r.left>o.right){if(!n.right||a<n.right.dist){n.right={dist:a,node:r.node}}}if(r.bottom<o.top){if(!n.top||a<n.top.dist){n.top={dist:a,node:r.node}}}if(r.top>o.bottom){if(!n.down||a<n.down.dist){n.down={dist:a,node:r.node}}}}o.node._nearestNodes={right:n.right&&n.right.node||null,top:n.top&&n.top.node||null,left:n.left&&n.left.node||null,down:n.down&&n.down.node||null}}function f(t,e){var o=t.getSelectedNode();if(!o){t.select(t.getRoot());r(t.getRoot());return}if(!o._nearestNodes){r(t.getRoot())}var n=o._nearestNodes[e];if(n){t.select(n,true)}}var h;return{events:{layoutallfinish:function(){var t=this.getRoot();r(t)},"normal.keydown readonly.keydown":function(t){var e=this;["left","right","up","down"].forEach(function(o){if(t.isShortcutKey(o)){f(e,o=="up"?"top":o);t.preventDefault()}})}}}})});