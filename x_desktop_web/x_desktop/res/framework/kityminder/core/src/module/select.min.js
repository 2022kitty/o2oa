define(function(e,t,r){var o=e("../core/kity");var n=e("../core/utils");var i=e("../core/minder");var s=e("../core/node");var l=e("../core/command");var a=e("../core/module");var u=e("../core/render");a.register("Select",function(){var e=this;var t=e.getRenderContainer();var r=function(){var r=null;var n=new o.Path;var i=false;var s=10;return{selectStart:function(e){if(e.originEvent.button||e.originEvent.altKey)return;if(r){return this.selectEnd()}r=e.getPosition(t).round()},selectMove:function(l){if(e.getStatus()=="textedit"){return}if(!r)return;var a=r,u=l.getPosition(t);if(!i){if(o.Vector.fromPoints(a,u).length()<s){return}i=true;t.addShape(n);n.fill(e.getStyle("marquee-background")).stroke(e.getStyle("marquee-stroke")).setOpacity(.8).getDrawer().clear()}var c=new o.Box(a.x,a.y,u.x-a.x,u.y-a.y),f=[];c.left=Math.round(c.left);c.top=Math.round(c.top);c.right=Math.round(c.right);c.bottom=Math.round(c.bottom);n.getDrawer().pipe(function(){this.clear();this.moveTo(c.left,c.top);this.lineTo(c.right,c.top);this.lineTo(c.right,c.bottom);this.lineTo(c.left,c.bottom);this.close()});e.getRoot().traverse(function(e){var t=e.getLayoutBox();if(!t.intersect(c).isEmpty()){f.push(e)}});e.select(f,true);window.getSelection().removeAllRanges()},selectEnd:function(e){if(r){r=null}if(i){n.fadeOut(200,"ease",0,function(){if(n.remove)n.remove()});i=false}}}}();var n=null,i=null;return{init:function(){window.addEventListener("mouseup",function(){r.selectEnd()})},events:{mousedown:function(e){var t=e.getTargetNode();if(!t){this.removeAllSelectedNodes();r.selectStart(e);this.setStatus("normal")}else if(e.isShortcutKey("Ctrl")){this.toggleSelect(t)}else if(!t.isSelected()){this.select(t,true)}else if(!this.isSingleSelect()){n=t;i=e.getPosition()}},mousemove:r.selectMove,mouseup:function(e){var t=e.getTargetNode();if(t&&t==n){var s=e.getPosition();var l=o.Vector.fromPoints(i,s);if(l.length()<1)this.select(n,true);n=null}r.selectEnd(e)},"normal.keydown":function(e){if(e.isShortcutKey("ctrl+a")){var t=[];this.getRoot().traverse(function(e){t.push(e)});this.select(t,true);e.preventDefault()}}}}})});