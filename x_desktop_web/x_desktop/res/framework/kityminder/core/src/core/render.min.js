define(function(e,n,r){var t=e("./kity");var o=e("./minder");var i=e("./node");var a=t.createClass("Renderer",{constructor:function(e){this.node=e},create:function(e){throw new Error("Not implement: Renderer.create()")},shouldRender:function(e){return true},watchChange:function(e){var n;if(this.watchingData===undefined){n=true}else if(this.watchingData!=e){n=true}else{n=false}this.watchingData=e},shouldDraw:function(e){return true},update:function(e,n,r){if(this.shouldDraw())this.draw(e,n);return this.place(e,n,r)},draw:function(e,n){throw new Error("Not implement: Renderer.draw()")},place:function(e,n,r){throw new Error("Not implement: Renderer.place()")},getRenderShape:function(){return this._renderShape||null},setRenderShape:function(e){this._renderShape=e}});function d(){function e(e,n){var r=[];["center","left","right","top","bottom","outline","outside"].forEach(function(e){var t="before"+e;var o="after"+e;if(n[t]){r=r.concat(n[t])}if(n[e]){r=r.concat(n[e])}if(n[o]){r=r.concat(n[o])}});e._renderers=r.map(function(n){return new n(e)})}return{renderNodeBatch:function(n){var r=this._rendererClasses;var o=[];var i=0;var a,d,s,h;if(!n.length)return;for(d=0;d<n.length;d++){h=n[d];if(!h._renderers){e(h,r)}h._contentBox=new t.Box;this.fire("beforerender",{node:h})}i=n[0]._renderers.length;for(a=0;a<i;a++){for(d=0;d<n.length;d++){if(typeof o[d]=="function"){o[d]=o[d]()}if(!(o[d]instanceof t.Box)){o[d]=new t.Box(o[d])}}for(d=0;d<n.length;d++){h=n[d];s=h._renderers[a];if(o[d]){h._contentBox=h._contentBox.merge(o[d]);s.contentBox=o[d]}if(s.shouldRender(h)){if(!s.getRenderShape()){s.setRenderShape(s.create(h));if(s.bringToBack){h.getRenderContainer().prependShape(s.getRenderShape())}else{h.getRenderContainer().appendShape(s.getRenderShape())}}s.getRenderShape().setVisible(true);o[d]=s.update(s.getRenderShape(),h,h._contentBox)}else if(s.getRenderShape()){s.getRenderShape().setVisible(false);o[d]=null}}}for(d=0;d<n.length;d++){this.fire("noderender",{node:n[d]})}},renderNode:function(n){var r=this._rendererClasses;var o,i,a;if(!n._renderers){e(n,r)}this.fire("beforerender",{node:n});n._contentBox=new t.Box;n._renderers.forEach(function(e){if(e.shouldRender(n)){if(!e.getRenderShape()){e.setRenderShape(e.create(n));if(e.bringToBack){n.getRenderContainer().prependShape(e.getRenderShape())}else{n.getRenderContainer().appendShape(e.getRenderShape())}}e.getRenderShape().setVisible(true);i=e.update(e.getRenderShape(),n,n._contentBox);if(typeof i=="function")i=i();if(i){n._contentBox=n._contentBox.merge(i);e.contentBox=i}}else if(e.getRenderShape()){e.getRenderShape().setVisible(false)}});this.fire("noderender",{node:n})}}}t.extendClass(o,d());t.extendClass(i,{render:function(){if(!this.attached)return;this.getMinder().renderNode(this);return this},renderTree:function(){if(!this.attached)return;var e=[];this.traverse(function(n){e.push(n)});this.getMinder().renderNodeBatch(e);return this},getRenderer:function(e){var n=this._renderers;if(!n)return null;for(var r=0;r<n.length;r++){if(n[r].getType()==e)return n[r]}return null},getContentBox:function(){return this.parent&&this.parent.isCollapsed()?new t.Box:this._contentBox||new t.Box},getRenderBox:function(e,n){var r=e&&this.getRenderer(e);var o=r?r.contentBox:this.getContentBox();var i=t.Matrix.getCTM(this.getRenderContainer(),n||"paper");return i.transformBox(o)}});r.exports=a});