define(function(e,t,r){var o=e("./kity");var n=e("./utils");var i=e("./minder");var a=e("./node");var s=e("./event");var l=e("./compatibility");var h=e("./promise");var c={};function u(e,t){c[e]=t;for(var r in c){if(c.hasOwnProperty(r)){c[r]=c[r];c[r].name=r}}}function f(e){return e===undefined?c:c[e]||null}t.registerProtocol=u;t.getRegisterProtocol=f;o.extendClass(i,{setup:function(e){if(typeof e=="string"){e=document.querySelector(e)}if(!e)return;var t=e.getAttribute("minder-data-type");if(t in c){var r=e.textContent;e.textContent=null;this.renderTo(e);this.importData(t,r)}return this},exportJson:function(){function e(t){var r={};r.data=t.getData();var o=t.getChildren();r.children=[];for(var n=0;n<o.length;n++){r.children.push(e(o[n]))}return r}var t={root:e(this.getRoot())};t.template=this.getTemplate();t.theme=this.getTheme();t.version=i.version;return JSON.parse(JSON.stringify(t))},Text2Children:function(e,t){if(!(e instanceof kityminder.Node)){return}var r=[],o={},n=0;var i=/\r|\n|\r\n/,a=/^(\t|\x20{4})/;var s=t.split(i),l="",h,c=0;var u=this;function f(e){return e===""&&!/\S/.test(e)}function d(e){return{data:{text:e.replace(/^(\t|\x20{4})+/,"").replace(/(\t|\x20{4})+$/,"")},children:[]}}function p(e){var t=0;while(a.test(e)){e=e.replace(a,"");t++}return t}function v(e,t){e.children.push(t)}function m(e,t){for(var r=0,o=t.length;r<o;r++){var n=u.createNode(null,e);n.setData("text",t[r].data.text||"");m(n,t[r].children)}}while((l=s[c++])!==undefined){l=l.replace(/&nbsp;/g,"");if(f(l))continue;n=p(l);h=d(l);if(n===0){o={};r.push(h);o[0]=r[r.length-1]}else{if(!o[n-1]){throw new Error("Invalid local format")}v(o[n-1],h);o[n]=h}}m(e,r);u.refresh()},exportNode:function(e){var t={};t.data=e.getData();var r=e.getChildren();t.children=[];for(var o=0;o<r.length;o++){t.children.push(this.exportNode(r[o]))}return t},importNode:function(e,t){var r=t.data;e.data={};for(var o in r){e.setData(o,r[o])}var n=t.children||[];for(var i=0;i<n.length;i++){var a=this.createNode(null,e);this.importNode(a,n[i])}return e},importJson:function(e){if(!e)return;this._fire(new s("preimport",null,false));while(this._root.getChildren().length){this.removeNode(this._root.getChildren()[0])}e=l(e);this.importNode(this._root,e.root);this.setTemplate(e.template||"default");this.setTheme(e.theme||null);this.refresh();this.fire("import");this._firePharse({type:"contentchange"});this._interactChange();return this},exportData:function(e,t){var r,o;r=this.exportJson();if(e){o=c[e];if(!o||!o.encode){return h.reject(new Error("Not supported protocol:"+e))}}this._fire(new s("beforeexport",{json:r,protocolName:e,protocol:o}));return h.resolve(o.encode(r,this,t))},importData:function(e,t,r){var o,n;var i=this;if(e){n=c[e];if(!n||!n.decode){return h.reject(new Error("Not supported protocol:"+e))}}var a={local:t,protocolName:e,protocol:n};this._fire(new s("beforeimport",a));return h.resolve(n.decode(t,this,r)).then(function(e){i.importJson(e);return e})},decodeData:function(e,t,r){var o,n;var i=this;if(e){n=c[e];if(!n||!n.decode){return h.reject(new Error("Not supported protocol:"+e))}}var a={local:t,protocolName:e,protocol:n};this._fire(new s("beforeimport",a));return h.resolve(n.decode(t,this,r))}})});