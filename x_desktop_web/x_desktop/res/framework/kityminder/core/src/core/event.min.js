define(function(t,e,i){var n=t("./kity");var r=t("./utils");var o=t("./minder");var s=n.createClass("MindEvent",{constructor:function(t,e,i){e=e||{};if(e.getType&&e.getType()=="ShapeEvent"){this.kityEvent=e;this.originEvent=e.originEvent}else if(e.target&&e.preventDefault){this.originEvent=e}else{n.Utils.extend(this,e)}this.type=t;this._canstop=i||false},getPosition:function(t){if(!this.kityEvent)return;if(!t||t=="minder"){return this.kityEvent.getPosition(this.minder.getRenderContainer())}return this.kityEvent.getPosition.call(this.kityEvent,t)},getTargetNode:function(){var t=this.kityEvent&&this.kityEvent.targetShape;if(!t)return null;while(!t.minderNode&&t.container){t=t.container}var e=t.minderNode;if(e&&t.getOpacity()<1)return null;return e||null},stopPropagation:function(){this._stoped=true},stopPropagationImmediately:function(){this._immediatelyStoped=true;this._stoped=true},shouldStopPropagation:function(){return this._canstop&&this._stoped},shouldStopPropagationImmediately:function(){return this._canstop&&this._immediatelyStoped},preventDefault:function(){this.originEvent.preventDefault()},isRightMB:function(){var t=false;if(!this.originEvent){return false}if("which"in this.originEvent)t=this.originEvent.which==3;else if("button"in this.originEvent)t=this.originEvent.button==2;return t},getKeyCode:function(){var t=this.originEvent;return t.keyCode||t.which}});o.registerInitHook(function(t){this._initEvents()});n.extendClass(o,{_initEvents:function(){this._eventCallbacks={}},_resetEvents:function(){this._initEvents();this._bindEvents()},_bindEvents:function(){this._paper.on("click dblclick mousedown contextmenu mouseup mousemove mouseover mousewheel DOMMouseScroll touchstart touchmove touchend dragenter dragleave drop",this._firePharse.bind(this));if(window){window.addEventListener("resize",this._firePharse.bind(this))}},dispatchKeyEvent:function(t){this._firePharse(t)},_firePharse:function(t){var e,i,n;if(t.type=="DOMMouseScroll"){t.type="mousewheel";t.wheelDelta=t.originEvent.wheelDelta=t.originEvent.detail*-10;t.wheelDeltaX=t.originEvent.mozMovementX;t.wheelDeltaY=t.originEvent.mozMovementY}e=new s("before"+t.type,t,true);if(this._fire(e)){return}i=new s("pre"+t.type,t,true);n=new s(t.type,t,true);if(this._fire(i)||this._fire(n))this._fire(new s("after"+t.type,t,false))},_interactChange:function(t){var e=this;if(e._interactScheduled)return;setTimeout(function(){e._fire(new s("interactchange"));e._interactScheduled=false},100);e._interactScheduled=true},_listen:function(t,e){var i=this._eventCallbacks[t]||(this._eventCallbacks[t]=[]);i.push(e)},_fire:function(t){t.minder=this;var e=this.getStatus();var i=this._eventCallbacks[t.type.toLowerCase()]||[];if(e){i=i.concat(this._eventCallbacks[e+"."+t.type.toLowerCase()]||[])}if(i.length===0){return}var n=this.getStatus();for(var r=0;r<i.length;r++){i[r].call(this,t);if(t.shouldStopPropagationImmediately()){break}}return t.shouldStopPropagation()},on:function(t,e){var i=this;t.split(/\s+/).forEach(function(t){i._listen(t.toLowerCase(),e)});return this},off:function(t,e){var i=t.split(/\s+/);var n,r,o,s;for(n=0;n<i.length;n++){o=this._eventCallbacks[i[n].toLowerCase()];if(o){s=null;for(r=0;r<o.length;r++){if(o[r]==e){s=r}}if(s!==null){o.splice(s,1)}}}},fire:function(t,e){var i=new s(t,e);this._fire(i);return this}});i.exports=s});