define(function(t,e,n){var r=t("./kity");var o=t("./utils");var a=t("./minder");var i=t("./node");var u=t("./event");var s=t("./command");var f={};var h;function l(t,e){f[t]=e;h=h||t}var y=r.createClass("Layout",{doLayout:function(t,e){throw new Error("Not Implement: Layout.doLayout()")},align:function(t,e,n){var r=this;n=n||0;t.forEach(function(t){var o=r.getTreeBox([t]);var a=t.getLayoutTransform();switch(e){case"left":return a.translate(n-o.left,0);case"right":return a.translate(n-o.right,0);case"top":return a.translate(0,n-o.top);case"bottom":return a.translate(0,n-o.bottom)}})},stack:function(t,e,n){var r=this;var o=0;n=n||function(t,e,n){return t.getStyle({x:"margin-right",y:"margin-bottom"}[n])+e.getStyle({x:"margin-left",y:"margin-top"}[n])};t.forEach(function(t,a,i){var u=r.getTreeBox([t]);var s={x:u.width,y:u.height}[e];var f={x:u.left,y:u.top}[e];var h=t.getLayoutTransform();if(e=="x"){h.translate(o-f,0)}else{h.translate(0,o-f)}o+=s;if(i[a+1])o+=n(t,i[a+1],e)});return o},move:function(t,e,n){t.forEach(function(t){t.getLayoutTransform().translate(e,n)})},getBranchBox:function(t){var e=new r.Box;var n,o,a,i;for(n=0;n<t.length;n++){o=t[n];a=o.getLayoutTransform();i=o.getContentBox();e=e.merge(a.transformBox(i))}return e},getTreeBox:function(t){var e,n,o,a;var i=new r.Box;if(!(t instanceof Array))t=[t];for(e=0;e<t.length;e++){n=t[e];o=n.getLayoutTransform();a=n.getContentBox();if(n.isExpanded()&&n.children.length){a=a.merge(this.getTreeBox(n.children))}i=i.merge(o.transformBox(a))}return i},getOrderHint:function(t){return[]}});y.register=l;a.registerInitHook(function(t){this.refresh()});o.extend(a,{getLayoutList:function(){return f},getLayoutInstance:function(t){var e=f[t];if(!e)throw new Error("Missing Layout: "+t);var n=new e;return n}});r.extendClass(i,{getLayout:function(){var t=this.getData("layout");t=t||(this.isRoot()?h:this.parent.getLayout());return t},setLayout:function(t){if(t){if(t=="inherit"){this.setData("layout")}else{this.setData("layout",t)}}return this},layout:function(t){this.setLayout(t).getMinder().layout();return this},getLayoutInstance:function(){return a.getLayoutInstance(this.getLayout())},getOrderHint:function(t){return this.parent.getLayoutInstance().getOrderHint(this)},getLayoutTransform:function(){return this._layoutTransform||new r.Matrix},getGlobalLayoutTransformPreview:function(){var t=this.parent?this.parent.getLayoutTransform():new r.Matrix;var e=this.getLayoutTransform();var n=this.getLayoutOffset();if(n){e=e.clone().translate(n.x,n.y)}return t.merge(e)},getLayoutPointPreview:function(){return this.getGlobalLayoutTransformPreview().transformPoint(new r.Point)},getGlobalLayoutTransform:function(){if(this._globalLayoutTransform){return this._globalLayoutTransform}else if(this.parent){return this.parent.getGlobalLayoutTransform()}else{return new r.Matrix}},setLayoutTransform:function(t){this._layoutTransform=t;return this},setGlobalLayoutTransform:function(t){this.getRenderContainer().setMatrix(this._globalLayoutTransform=t);return this},setVertexIn:function(t){this._vertexIn=t},setVertexOut:function(t){this._vertexOut=t},getVertexIn:function(){return this._vertexIn||new r.Point},getVertexOut:function(){return this._vertexOut||new r.Point},getLayoutVertexIn:function(){return this.getGlobalLayoutTransform().transformPoint(this.getVertexIn())},getLayoutVertexOut:function(){return this.getGlobalLayoutTransform().transformPoint(this.getVertexOut())},setLayoutVectorIn:function(t){this._layoutVectorIn=t;return this},setLayoutVectorOut:function(t){this._layoutVectorOut=t;return this},getLayoutVectorIn:function(){return this._layoutVectorIn||new r.Vector},getLayoutVectorOut:function(){return this._layoutVectorOut||new r.Vector},getLayoutBox:function(){var t=this.getGlobalLayoutTransform();return t.transformBox(this.getContentBox())},getLayoutPoint:function(){var t=this.getGlobalLayoutTransform();return t.transformPoint(new r.Point)},getLayoutOffset:function(){if(!this.parent)return new r.Point;var t=this.getData("layout_"+this.parent.getLayout()+"_offset");if(t)return new r.Point(t.x,t.y);return new r.Point},setLayoutOffset:function(t){if(!this.parent)return this;this.setData("layout_"+this.parent.getLayout()+"_offset",t?{x:t.x,y:t.y}:undefined);return this},hasLayoutOffset:function(){return!!this.getData("layout_"+this.parent.getLayout()+"_offset")},resetLayoutOffset:function(){return this.setLayoutOffset(null)},getLayoutRoot:function(){if(this.isLayoutRoot()){return this}return this.parent.getLayoutRoot()},isLayoutRoot:function(){return this.getData("layout")||this.isRoot()}});r.extendClass(a,{layout:function(){var t=this.getOption("layoutAnimationDuration");this.getRoot().traverse(function(t){t.setLayoutTransform(null)});function e(t,n){if(t.isExpanded()||true){t.children.forEach(function(t){e(t,n)})}var r=t.getLayoutInstance();r.doLayout(t,t.getChildren(),n)}e(this.getRoot(),1);e(this.getRoot(),2);var n=this;this.applyLayoutResult(this.getRoot(),t,function(){setTimeout(function(){n.fire("layoutallfinish")},0)});return this.fire("layout")},refresh:function(){this.getRoot().renderTree();this.layout().fire("contentchange")._interactChange();return this},applyLayoutResult:function(t,e,n){t=t||this.getRoot();var o=this;var a=t.getComplex();function i(){if(!--a){if(n){n()}}}if(a>200)e=0;function u(t,e){t.setGlobalLayoutTransform(e);o.fire("layoutapply",{node:t,matrix:e})}function s(t,n){var a=t.getLayoutTransform().merge(n.clone());var f=t.getGlobalLayoutTransform()||new r.Matrix;var h=t.getLayoutOffset();a.translate(h.x,h.y);a.m.e=Math.round(a.m.e);a.m.f=Math.round(a.m.f);if(t._layoutTimeline){t._layoutTimeline.stop();t._layoutTimeline=null}if(e){t._layoutTimeline=new r.Animator(f,a,u).start(t,e,"ease").on("finish",function(){setTimeout(function(){u(t,a);o.fire("layoutfinish",{node:t,matrix:a});i()},150)})}else{u(t,a);o.fire("layoutfinish",{node:t,matrix:a});i()}for(var l=0;l<t.children.length;l++){s(t.children[l],a)}}s(t,t.parent?t.parent.getGlobalLayoutTransform():new r.Matrix);return this}});n.exports=y});