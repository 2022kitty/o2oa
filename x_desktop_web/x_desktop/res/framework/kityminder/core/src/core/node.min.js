define(function(t,e,n){var r=t("./kity");var i=t("./utils");var o=t("./minder");var s=r.createClass("MinderNode",{constructor:function(t){this.parent=null;this.root=this;this.children=[];this.data={id:i.guid(),created:+new Date};this.initContainers();if(i.isString(t)){this.setText(t)}else if(i.isObject(t)){i.extend(this.data,t)}},initContainers:function(){this.rc=(new r.Group).setId(i.uuid("minder_node"));this.rc.minderNode=this},isRoot:function(){return this.root===this},isLeaf:function(){return this.children.length===0},getRoot:function(){return this.root||this},getParent:function(){return this.parent},getSiblings:function(){var t=this.parent.children;var e=[];var n=this;t.forEach(function(t){if(t!=n)e.push(t)});return e},getLevel:function(){var t=0,e=this.parent;while(e){t++;e=e.parent}return t},getComplex:function(){var t=0;this.traverse(function(){t++});return t},getType:function(t){this.type=["root","main","sub"][Math.min(this.getLevel(),2)];return this.type},isAncestorOf:function(t){var e=t.parent;while(e){if(e==this)return true;e=e.parent}return false},getData:function(t){return t?this.data[t]:this.data},setData:function(t,e){if(typeof t=="object"){var n=t;for(t in n)if(n.hasOwnProperty(t)){this.data[t]=n[t]}}else{this.data[t]=e}return this},setText:function(t){return this.data.text=t},getText:function(){return this.data.text||null},preTraverse:function(t,e){var n=this.getChildren();if(!e)t(this);for(var r=0;r<n.length;r++){n[r].preTraverse(t)}},postTraverse:function(t,e){var n=this.getChildren();for(var r=0;r<n.length;r++){n[r].postTraverse(t)}if(!e)t(this)},traverse:function(t,e){return this.postTraverse(t,e)},getChildren:function(){return this.children},getIndex:function(){return this.parent?this.parent.children.indexOf(this):-1},insertChild:function(t,e){if(e===undefined){e=this.children.length}if(t.parent){t.parent.removeChild(t)}t.parent=this;t.root=this.root;this.children.splice(e,0,t)},appendChild:function(t){return this.insertChild(t)},prependChild:function(t){return this.insertChild(t,0)},removeChild:function(t){var e=t,n;if(t instanceof s){e=this.children.indexOf(t)}if(e>=0){n=this.children.splice(e,1)[0];n.parent=null;n.root=n}},clearChildren:function(){this.children=[]},getChild:function(t){return this.children[t]},getRenderContainer:function(){return this.rc},getCommonAncestor:function(t){return s.getNodeCommonAncestor(this,t)},contains:function(t){return this==t||this.isAncestorOf(t)},clone:function(){var t=new s;t.data=i.clone(this.data);this.children.forEach(function(e){t.appendChild(e.clone())});return t},compareTo:function(t){if(!i.comparePlainObject(this.data,t.data))return false;if(!i.comparePlainObject(this.temp,t.temp))return false;if(this.children.length!=t.children.length)return false;var e=0;while(this.children[e]){if(!this.children[e].compareTo(t.children[e]))return false;e++}return true},getMinder:function(){return this.getRoot().minder}});s.getCommonAncestor=function(t,e){if(t instanceof Array){return s.getCommonAncestor.apply(this,t)}switch(arguments.length){case 1:return t.parent||t;case 2:if(t.isAncestorOf(e)){return t}if(e.isAncestorOf(t)){return e}var n=t.parent;while(n&&!n.isAncestorOf(e)){n=n.parent}return n;default:return Array.prototype.reduce.call(arguments,function(t,e){return s.getCommonAncestor(t,e)},t)}};r.extendClass(o,{getRoot:function(){return this._root},setRoot:function(t){this._root=t;t.minder=this},getAllNode:function(){var t=[];this.getRoot().traverse(function(e){t.push(e)});return t},getNodeById:function(t){return this.getNodesById([t])[0]},getNodesById:function(t){var e=this.getAllNode();var n=[];e.forEach(function(e){if(t.indexOf(e.getData("id"))!=-1){n.push(e)}});return n},createNode:function(t,e,n){var r=new s(t);this.fire("nodecreate",{node:r,parent:e,index:n});this.appendNode(r,e,n);return r},appendNode:function(t,e,n){if(e)e.insertChild(t,n);this.attachNode(t);return this},removeNode:function(t){if(t.parent){t.parent.removeChild(t);this.detachNode(t);this.fire("noderemove",{node:t})}},attachNode:function(t){var e=this.getRenderContainer();t.traverse(function(t){t.attached=true;e.addShape(t.getRenderContainer())});e.addShape(t.getRenderContainer());this.fire("nodeattach",{node:t})},detachNode:function(t){var e=this.getRenderContainer();t.traverse(function(t){t.attached=false;e.removeShape(t.getRenderContainer())});this.fire("nodedetach",{node:t})},getMinderTitle:function(){return this.getRoot().getText()}});n.exports=s});