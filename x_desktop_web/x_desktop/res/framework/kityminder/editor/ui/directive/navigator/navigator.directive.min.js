angular.module("kityminderEditor").directive("navigator",["memory","config",function(e,t){return{restrict:"A",templateUrl:"ui/directive/navigator/navigator.html",scope:{minder:"="},link:function(n){minder.setDefaultOptions({zoom:t.getConfig("zoom")});n.isNavOpen=!e.get("navigator-hidden");n.getZoomRadio=function(e){var t=minder.getOption("zoom");var n=t[0];var i=t[t.length-1];var o=i-n;return 1-(e-n)/o};n.getHeight=function(e){var t=$(".zoom-pan").height();return n.getZoomRadio(e)*t};n.zoom=100;minder.on("zoom",function(e){n.zoom=e.zoom});n.toggleNavOpen=function(){n.isNavOpen=!n.isNavOpen;e.set("navigator-hidden",!n.isNavOpen);if(n.isNavOpen){i();h();l()}else{o()}};setTimeout(function(){if(n.isNavOpen){i();h();l()}else{o()}},0);function i(){minder.on("layout layoutallfinish",h);minder.on("viewchange",l)}function o(){minder.off("layout layoutallfinish",h);minder.off("viewchange",l)}var a=$(".nav-previewer");var r=new kity.Paper(a[0]);var g=r.put(new kity.Path);var u=r.put(new kity.Path);var s=r.put(new kity.Rect(100,100).stroke("red","1%"));var m=new kity.Box,d=new kity.Box;var v=c(minder.getTheme());minder.on("themechange",function(e){v=c(e.theme)});function c(e){switch(e){case"tianpan":case"tianpan-compact":return function(e,t,n,i,o){var a=i>>1;e.push("M",t,n+a,"a",a,a,0,1,1,0,.01,"z")};default:{return function(e,t,n,i,o){e.push("M",t,n,"h",i,"v",o,"h",-i,"z")}}}}f();function f(){function e(e,t){var n=d;e.x=-e.x;e.y=-e.y;var i=minder.getPaper().getViewPortMatrix();n=i.transformBox(n);var o=e.offset(n.width/2,n.height/2);minder.getViewDragger().moveTo(o,t)}var t=false;r.on("mousedown",function(n){t=true;e(n.getPosition("top"),200);a.addClass("grab")});r.on("mousemove",function(n){if(t){e(n.getPosition("top"))}});$(window).on("mouseup",function(){t=false;a.removeClass("grab")})}function h(){var e=minder.getRenderContainer().getBoundaryBox();m=e;var t=30;r.setViewBox(e.x-t-.5,e.y-t-.5,e.width+t*2+1,e.height+t*2+1);var n=[];var i=[];minder.getRoot().traverse(function(e){var t=e.getLayoutBox();v(n,t.x,t.y,t.width,t.height);if(e.getConnection()&&e.parent&&e.parent.isExpanded()){i.push(e.getConnection().getPathData())}});r.setStyle("background",minder.getStyle("background"));if(n.length){g.fill(minder.getStyle("root-background")).setPathData(n)}else{g.setPathData(null)}if(i.length){u.stroke(minder.getStyle("connect-color"),"0.5%").setPathData(i)}else{u.setPathData(null)}l()}function l(){d=minder.getViewDragger().getView();s.setBox(d.intersect(m))}}}}]);