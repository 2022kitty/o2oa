angular.module("kityminderEditor").directive("searchBox",function(){return{restrict:"A",templateUrl:"ui/directive/searchBox/searchBox.html",scope:{minder:"="},replace:true,controller:function(e){var t=e.minder;var n=window.editor;e.handleKeyDown=r;e.doSearch=d;e.exitSearch=o;e.showTip=false;e.showSearch=false;function r(t){if(t.keyCode==13){var n=t.shiftKey?"prev":"next";d(e.keyword,n)}if(t.keyCode==27){o()}}function o(){$("#search-input").blur();e.showSearch=false;t.fire("hidenoterequest");n.receiver.selectAll()}function i(){e.showSearch=true;setTimeout(function(){$("#search-input").focus()},10);if(e.keyword){$("#search-input")[0].setSelectionRange(0,e.keyword.length)}}$("body").on("keydown",function(t){if(t.keyCode==70&&(t.ctrlKey||t.metaKey)&&!t.shiftKey){i();e.$apply();t.preventDefault()}});t.on("searchNode",function(){i()});var a=[];var c=[];t.on("contentchange",s);s();function s(){a=[];t.getRoot().traverse(function(e){a.push(e)})}function u(e){c=[];for(var t=0;t<a.length;t++){var n=a[t];var r=n.getText().toLowerCase();if(r.indexOf(e)!=-1){c.push({node:n})}var o=n.getData("note");if(o&&o.toLowerCase().indexOf(e)!=-1){c.push({node:n,keyword:e})}}}function d(n,r){e.showTip=false;t.fire("hidenoterequest");if(!n||!/\S/.exec(n)){$("#search-input").focus();return}e.showTip=true;e.curIndex=0;e.resultNum=0;n=n.toLowerCase();var o=d.lastKeyword!=n;d.lastKeyword=n;if(o){u(n)}e.resultNum=c.length;if(c.length){var i=o?0:(r==="next"?d.lastIndex+1:d.lastIndex-1)||0;i=(c.length+i)%c.length;a(c[i].node,c[i].keyword);d.lastIndex=i;e.curIndex=i+1;function a(e,n){t.execCommand("camera",e,50);setTimeout(function(){t.select(e,true);if(!e.isExpanded())t.execCommand("expand",true);if(n){t.fire("shownoterequest",{node:e,keyword:n})}},60)}}}}}});