angular.module("kityminderEditor").directive("notePreviewer",["$sce","valueTransfer",function(e,t){return{restrict:"A",templateUrl:"ui/directive/notePreviewer/notePreviewer.html",link:function(t,r){var o=t.minder;var n=r.parent();var i=r.children();t.showNotePreviewer=false;marked.setOptions({gfm:true,tables:true,breaks:true,pedantic:false,sanitize:true,smartLists:true,smartypants:false});var a;o.on("shownoterequest",function(e){a=setTimeout(function(){l(e.node,e.keyword)},300)});o.on("hidenoterequest",function(){clearTimeout(a);t.showNotePreviewer=false});var s=false;$(document).on("mousedown mousewheel DOMMouseScroll",function(){if(!s)return;t.showNotePreviewer=false;t.$apply()});r.on("mousedown mousewheel DOMMouseScroll",function(e){e.stopPropagation()});function l(r,o){var a=r.getRenderer("NoteIconRenderer").getRenderShape();var l=a.getRenderBox("screen");var u=r.getData("note");i[0].scrollTop=0;var f=marked(u);if(o){f=f.replace(new RegExp("("+o+")","ig"),'<span class="highlight">$1</span>')}t.noteContent=e.trustAsHtml(f);t.$apply();var v=$(n[0]).width();var c=$(n[0]).height();var p=$(i).outerWidth();var d=$(i).outerHeight();var h=l.cx-p/2-n[0].offsetLeft;var w=l.bottom+10-n[0].offsetTop;if(h<0)h=10;if(h+p>v)h=l.left-p-10-n[0].offsetLeft;if(w+d>c)w=l.top-d-10-n[0].offsetTop;t.previewerStyle={left:Math.round(h)+"px",top:Math.round(w)+"px"};t.showNotePreviewer=true;var m=i[0].querySelector(".highlight");if(m){m.scrollIntoView()}s=true;t.$apply()}}}}]);