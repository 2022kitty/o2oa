define(function(e,n,t){var r=e("../tool/debug");var i=new r("fsm");function f(e,n,t,r){if(e.when!=n)return false;if(e.enter!="*"&&e.enter!=r)return false;if(e.exit!="*"&&e.exit!=t)return;return true}function o(e){var n=e;var t=" - ";var r=" -> ";var o=[];this.jump=function(e,t){if(!t)throw new Error("Please tell fsm the reason to jump");var r=n;var l=[r,e].concat([].slice.call(arguments,1));var a,u;for(a=0;a<o.length;a++){u=o[a];if(f(u.condition,"before",r,e)){if(u.apply(null,l))return}}n=e;i.log("[{0}] {1} -> {2}",t,r,e);for(a=0;a<o.length;a++){u=o[a];if(f(u.condition,"after",r,e)){u.apply(null,l)}}return n};this.state=function(){return n};this.when=function(e,n){if(arguments.length==1){n=e;e="* -> *"}var i,f,l,a;f=e.split(t);if(f.length==2){i="before"}else{f=e.split(r);if(f.length==2){i="after"}}if(!i)throw new Error("Illegal fsm condition: "+e);l=f[0];a=f[1];n.condition={when:i,exit:l,enter:a};o.push(n)}}function l(){this.fsm=new o("normal")}return t.exports=l});