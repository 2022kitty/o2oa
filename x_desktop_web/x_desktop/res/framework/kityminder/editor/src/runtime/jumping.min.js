define(function(e,t,n){var r=e("../hotbox");function i(e){if(e.ctrlKey||e.metaKey||e.altKey)return false;if(e.keyCode>=65&&e.keyCode<=90)return true;if(e.keyCode>=48&&e.keyCode<=57)return true;if(e.keyCode!=108&&e.keyCode>=96&&e.keyCode<=111)return true;if(e.keyCode!=108&&e.keyCode>=96&&e.keyCode<=111)return true;if(e.keyCode==229||e.keyCode===0)return true;return false}function o(){var e=this.fsm;var t=this.minder;var n=this.receiver;var o=this.container;var u=n.element;var a=this.hotbox;n.listen("normal",function(r){n.enable();if(r.is("Space")){r.preventDefault();if(kity.Browser.safari){u.innerHTML=""}return e.jump("hotbox","space-trigger")}switch(r.type){case"keydown":{if(t.getSelectedNode()){if(i(r)){return e.jump("input","user-input")}}else{u.innerHTML=""}e.jump("normal","shortcut-handle",r);break}case"keyup":{break}default:{}}});n.listen("hotbox",function(t){n.disable();t.preventDefault();var i=a.dispatch(t);if(a.state()==r.STATE_IDLE&&e.state()=="hotbox"){return e.jump("normal","hotbox-idle")}});n.listen("input",function(t){n.enable();if(t.type=="keydown"){if(t.is("Enter")){t.preventDefault();return e.jump("normal","input-commit")}if(t.is("Esc")){t.preventDefault();return e.jump("normal","input-cancel")}if(t.is("Tab")||t.is("Shift + Tab")){t.preventDefault()}}else if(t.type=="keyup"&&t.is("Esc")){t.preventDefault();return e.jump("normal","input-cancel")}});var s,f;var l=2;o.addEventListener("mousedown",function(t){if(t.button==l){t.preventDefault()}if(e.state()=="hotbox"){a.active(r.STATE_IDLE);e.jump("normal","blur")}else if(e.state()=="normal"&&t.button==l){s=t.clientX;f=t.clientY}},false);o.addEventListener("mousewheel",function(t){if(e.state()=="hotbox"){a.active(r.STATE_IDLE);e.jump("normal","mousemove-blur")}},false);o.addEventListener("contextmenu",function(e){e.preventDefault()});o.addEventListener("mouseup",function(n){if(e.state()!="normal"){return}if(n.button!=l||n.clientX!=s||n.clientY!=f){return}if(!t.getSelectedNode()){return}e.jump("hotbox","content-menu")},false);a.$element.addEventListener("mousedown",function(e){e.stopPropagation()})}return n.exports=o});