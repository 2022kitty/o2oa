define(function(e,t,r){function a(){var e=this.minder;var t=window.kityminder.data;if(!e.supportClipboardEvent||kity.Browser.gecko){return}var r=this.fsm;var a=this.receiver;var n=this.MimeType;var i=n.getMimeTypeProtocol("application/km"),o=t.getRegisterProtocol("json").decode;var c=[];function l(r){var a=[];for(var n=0,o=r.length;n<o;n++){a.push(e.exportNode(r[n]))}return i(t.getRegisterProtocol("json").encode(a))}var v=function(t){if(document.activeElement==a.element){var n=t;var i=r.state();switch(i){case"input":{break}case"normal":{var o=[].concat(e.getSelectedNodes());if(o.length){if(o.length>1){var c;o.sort(function(e,t){return e.getLevel()-t.getLevel()});c=o[0].getLevel();if(c!==o[o.length-1].getLevel()){var v,s,u=0,d=o.length,f=d-1;s=o[f];while(s.getLevel()!==c){u=0;while(u<d&&o[u].getLevel()===c){if(o[u].isAncestorOf(s)){o.splice(f,1);break}u++}f--;s=o[f]}}}var p=l(o);n.clipboardData.setData("text/plain",p)}t.preventDefault();break}}}};var s=function(t){if(document.activeElement==a.element){if(e.getStatus()!=="normal"){t.preventDefault();return}var n=t;var i=r.state();switch(i){case"input":{break}case"normal":{var o=e.getSelectedNodes();if(o.length){n.clipboardData.setData("text/plain",l(o));e.execCommand("removenode")}t.preventDefault();break}}}};var u=function(t){if(document.activeElement==a.element){if(e.getStatus()!=="normal"){t.preventDefault();return}var i=t;var l=r.state();var v=i.clipboardData.getData("text/plain");switch(l){case"input":{if(!n.isPureText(v)){t.preventDefault();return}break}case"normal":{var s=e.getSelectedNodes();if(n.whichMimeType(v)==="application/km"){var u=o(n.getPureText(v));var d;s.forEach(function(t){for(var r=u.length-1;r>=0;r--){d=e.createNode(null,t);e.importNode(d,u[r]);c.push(d);t.appendChild(d)}});e.select(c,true);c=[];e.refresh()}else{s.forEach(function(t){e.Text2Children(t,v)})}t.preventDefault();break}}}};document.addEventListener("copy",v);document.addEventListener("cut",s);document.addEventListener("paste",u)}return r.exports=a});