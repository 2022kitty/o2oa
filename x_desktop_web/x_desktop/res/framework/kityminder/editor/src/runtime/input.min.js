define(function(e,t,n){e("../tool/innertext");var a=e("../tool/debug");var i=new a("input");function o(){var e=this.fsm;var t=this.minder;var n=this.hotbox;var a=this.receiver;var o=a.element;var r=window.kity.Browser.gecko;l();c();s();this.editText=d;function c(){e.when("* -> input",u);e.when("input -> *",function(e,t,n){switch(n){case"input-cancel":return p();case"input-commit":default:return h()}});a.onblur(function(t){if(e.state()=="input"){e.jump("normal","input-commit")}});t.on("beforemousedown",function(){if(e.state()=="input"){e.jump("normal","input-commit")}});t.on("dblclick",function(){if(t.getSelectedNode()){d()}})}function l(){if(i.flaged){o.classList.add("debug")}o.onmousedown=function(e){e.stopPropagation()};t.on("layoutallfinish viewchange viewchanged selectionchange",function(t){if(t.type=="viewchange"&&e.state()!="input")return;g()});g()}function s(){n.state("main").button({position:"center",label:"编辑",key:"F2",enable:function(){return t.queryCommandState("text")!=-1},action:d})}function d(){var n=t.getSelectedNode();if(!n){return}var i=o;o.innerText="";if(n.getData("font-weight")==="bold"){var c=document.createElement("b");i.appendChild(c);i=c}if(n.getData("font-style")==="italic"){var l=document.createElement("i");i.appendChild(l);i=l}i.innerText=t.queryCommandValue("text");if(r){a.fixFFCaretDisappeared()}e.jump("input","input-request");a.selectAll()}function u(){var e=t.getSelectedNode();if(e){var n=e.getData("font-size")||e.getStyle("font-size");o.style.fontSize=n+"px";o.style.minWidth=0;o.style.minWidth=o.clientWidth+"px";o.style.fontWeight=e.getData("font-weight")||"";o.style.fontStyle=e.getData("font-style")||"";o.classList.add("input");o.focus()}}function f(e){var n="";var a="\t",i="\n",o=/\S/,r=" ",c=new RegExp("( |"+String.fromCharCode(160)+")"),l=document.createElement("br");var s=false,d=false;for(var u,f,m,h,g,v=0,b=e.length;v<b;v++){u=e[v];switch(Object.prototype.toString.call(u)){case"[object HTMLBRElement]":{n+=i;break}case"[object Text]":{u=u.textContent.replace("&nbsp;"," ");if(!o.test(u)){m=u.length;while(m--){if(c.test(u[m])){n+=r}else if(u[m]===a){n+=a}}}else{n+=u}break}case"[object HTMLElement]":{switch(u.nodeName){case"B":{s=true;break}case"I":{d=true;break}default:{}}[].splice.apply(e,[v,1].concat([].slice.call(u.childNodes)));b=e.length;v--;break}case"[object HTMLSpanElement]":{[].splice.apply(e,[v,1].concat([].slice.call(u.childNodes)));b=e.length;v--;break}case"[object HTMLImageElement]":{if(u.src){if(/http(|s):\/\//.test(u.src)){t.execCommand("Image",u.src,u.alt)}else{}}break}case"[object HTMLDivElement]":{f=[];for(var x=0,b=u.childNodes.length;x<b;x++){f.push(u.childNodes[x])}f.push(l);[].splice.apply(e,[v,1].concat(f));b=e.length;v--;break}default:{if(u&&u.childNodes.length){f=[];for(var x=0,b=u.childNodes.length;x<b;x++){f.push(u.childNodes[x])}f.push(l);[].splice.apply(e,[v,1].concat(f));b=e.length;v--}else{if(u&&u.textContent!==undefined){n+=u.textContent}else{n+=""}}}}}n=n.replace(/^\n*|\n*$/g,"");n=n.replace(new RegExp("(\n|\r|\n\r)( |"+String.fromCharCode(160)+"){4}","g"),"$1\t");t.getSelectedNode().setText(n);if(s){t.queryCommandState("bold")||t.execCommand("bold")}else{t.queryCommandState("bold")&&t.execCommand("bold")}if(d){t.queryCommandState("italic")||t.execCommand("italic")}else{t.queryCommandState("italic")&&t.execCommand("italic")}p();return n}function m(e,n){try{t.decodeData("text",n).then(function(n){function a(e,t,n){var i=t.data;e.setText(i.text||"");var o=t.children||[];for(var r=0;r<o.length;r++){var c=n.createNode(null,e);a(c,o[r],n)}return e}a(e,n,t);t.fire("contentchange");t.getRoot().renderTree();t.layout(300)})}catch(e){t.fire("contentchange");t.getRoot().renderTree();if(e.toString()!=="Error: Invalid local format"){throw e}}}function h(){var e=[].slice.call(o.childNodes);setTimeout(function(){o.innerHTML=""},0);var n=t.getSelectedNode();e=f(e);m(n,e);if(n.type=="root"){var a=t.getRoot().getText();t.fire("initChangeRoot",{text:a})}}function p(){o.classList.remove("input");a.selectAll()}function g(){var e=g;var n=t.getSelectedNode();if(!n)return;if(!e.timer){e.timer=setTimeout(function(){var t=n.getRenderBox("TextRenderer");o.style.left=Math.round(t.x)+"px";o.style.top=(i.flaged?Math.round(t.bottom+30):Math.round(t.y))+"px";e.timer=0})}}}return n.exports=o});