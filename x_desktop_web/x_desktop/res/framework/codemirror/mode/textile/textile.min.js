(function(t){if(typeof exports=="object"&&typeof module=="object"){t(require("../../lib/codemirror"))}else if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],t)}else{t(CodeMirror)}})(function(t){"use strict";var e={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};function i(t,i,s){this.regExpFactory=t;this.state=i;this.stream=s;this.styles=e;this.state.specialChar=null}i.prototype.eat=function(t){return this.stream.match(this.regExpFactory.pattern(t),true)};i.prototype.check=function(t){return this.stream.match(this.regExpFactory.pattern(t),false)};i.prototype.setModeForNextToken=function(t){return this.state.mode=t};i.prototype.execMode=function(t){return this.setModeForNextToken(t).call(this)};i.prototype.startNewLine=function(){this.setModeForNextToken(r.newLayout);this.state.tableHeading=false;if(this.state.layoutType==="definitionList"&&this.state.spanningLayout){if(this.check("definitionListEnd")){this.state.spanningLayout=false}}};i.prototype.nextToken=function(){return this.state.mode.call(this)};i.prototype.styleFor=function(t){if(this.styles.hasOwnProperty(t)){return this.styles[t]}throw"unknown token"};i.prototype.handlePhraseModifier=function(t){if(t==="_"){if(this.stream.eat("_")){return this.togglePhraseModifier("italic",/^.*__/)}return this.togglePhraseModifier("em",/^.*_/)}if(t==="*"){if(this.stream.eat("*")){return this.togglePhraseModifier("bold",/^.*\*\*/)}return this.togglePhraseModifier("strong",/^.*\*/)}if(t==="["){if(this.stream.match(/\d+\]/)){this.state.footCite=true}return this.tokenStyles()}if(t==="("){if(this.stream.match("r)")){this.state.specialChar="r"}else if(this.stream.match("tm)")){this.state.specialChar="tm"}else if(this.stream.match("c)")){this.state.specialChar="c"}return this.tokenStyles()}if(t==="<"){if(this.stream.match(/(\w+)[^>]+>[^<]+<\/\1>/)){return this.tokenStylesWith(this.styleFor("html"))}}if(t==="?"&&this.stream.eat("?")){return this.togglePhraseModifier("cite",/^.*\?\?/)}if(t==="="&&this.stream.eat("=")){return this.togglePhraseModifier("notextile",/^.*==/)}if(t==="-"){return this.togglePhraseModifier("deletion",/^.*-/)}if(t==="+"){return this.togglePhraseModifier("addition",/^.*\+/)}if(t==="~"){return this.togglePhraseModifier("sub",/^.*~/)}if(t==="^"){return this.togglePhraseModifier("sup",/^.*\^/)}if(t==="%"){return this.togglePhraseModifier("span",/^.*%/)}if(t==="@"){return this.togglePhraseModifier("code",/^.*@/)}if(t==="!"){var e=this.togglePhraseModifier("image",/^.*(?:\([^\)]+\))?!/);this.stream.match(/^:\S+/);return e}return this.tokenStyles()};i.prototype.togglePhraseModifier=function(t,e){if(this.state[t]){var i=this.tokenStyles();this.state[t]=false;return i}if(this.stream.match(e,false)){this.state[t]=true;this.setModeForNextToken(r.attributes)}return this.tokenStyles()};i.prototype.tokenStyles=function(){var t=this.textileDisabled(),e=[];if(t)return t;if(this.state.layoutType){e.push(this.styleFor(this.state.layoutType))}e=e.concat(this.activeStyles("addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","specialChar","strong","sub","sup","table","tableHeading"));if(this.state.layoutType==="header"){e.push(this.styleFor("header")+"-"+this.state.header)}return e.length?e.join(" "):null};i.prototype.textileDisabled=function(){var t=this.state.layoutType;switch(t){case"notextile":case"code":case"pre":return this.styleFor(t);default:if(this.state.notextile){return this.styleFor("notextile")+(t?" "+this.styleFor(t):"")}return null}};i.prototype.tokenStylesWith=function(t){var e=this.textileDisabled(),i;if(e)return e;i=this.tokenStyles();if(t){return i?i+" "+t:t}return i};i.prototype.activeStyles=function(){var t=[],e;for(e=0;e<arguments.length;++e){if(this.state[arguments[e]]){t.push(this.styleFor(arguments[e]))}}return t};i.prototype.blankLine=function(){var t=this.state.spanningLayout,e=this.state.layoutType,i;for(i in this.state){if(this.state.hasOwnProperty(i)){delete this.state[i]}}this.setModeForNextToken(r.newLayout);if(t){this.state.layoutType=e;this.state.spanningLayout=true}};function s(){this.cache={};this.single={bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/};this.attributes={align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/}}s.prototype.pattern=function(t){return this.cache[t]||this.createRe(t)};s.prototype.createRe=function(t){switch(t){case"drawTable":return this.makeRe("^",this.single.drawTable,"$");case"html":return this.makeRe("^",this.single.html,"(?:",this.single.html,")*","$");case"linkDefinition":return this.makeRe("^",this.single.linkDefinition,"$");case"listLayout":return this.makeRe("^",this.single.list,this.pattern("allAttributes"),"*\\s+");case"tableCellAttributes":return this.makeRe("^",this.choiceRe(this.single.tableCellAttributes,this.pattern("allAttributes")),"+\\.");case"type":return this.makeRe("^",this.pattern("allTypes"));case"typeLayout":return this.makeRe("^",this.pattern("allTypes"),this.pattern("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return this.makeRe("^",this.pattern("allAttributes"),"+");case"allTypes":return this.choiceRe(this.single.div,this.single.foot,this.single.header,this.single.bc,this.single.bq,this.single.notextile,this.single.pre,this.single.table,this.single.para);case"allAttributes":return this.choiceRe(this.attributes.selector,this.attributes.css,this.attributes.lang,this.attributes.align,this.attributes.pad);default:return this.makeRe("^",this.single[t])}};s.prototype.makeRe=function(){var t="",e,i;for(e=0;e<arguments.length;++e){i=arguments[e];t+=typeof i==="string"?i:i.source}return new RegExp(t)};s.prototype.choiceRe=function(){var t=[arguments[0]],e;for(e=1;e<arguments.length;++e){t[e*2-1]="|";t[e*2]=arguments[e]}t.unshift("(?:");t.push(")");return this.makeRe.apply(this,t)};var r={newLayout:function(){if(this.check("typeLayout")){this.state.spanningLayout=false;return this.execMode(r.blockType)}if(!this.textileDisabled()){if(this.check("listLayout")){return this.execMode(r.list)}else if(this.check("drawTable")){return this.execMode(r.table)}else if(this.check("linkDefinition")){return this.execMode(r.linkDefinition)}else if(this.check("definitionList")){return this.execMode(r.definitionList)}else if(this.check("html")){return this.execMode(r.html)}}return this.execMode(r.text)},blockType:function(){var t,e;this.state.layoutType=null;if(t=this.eat("type")){e=t[0]}else{return this.execMode(r.text)}if(t=e.match(this.regExpFactory.pattern("header"))){this.state.layoutType="header";this.state.header=parseInt(t[0][1])}else if(e.match(this.regExpFactory.pattern("bq"))){this.state.layoutType="quote"}else if(e.match(this.regExpFactory.pattern("bc"))){this.state.layoutType="code"}else if(e.match(this.regExpFactory.pattern("foot"))){this.state.layoutType="footnote"}else if(e.match(this.regExpFactory.pattern("notextile"))){this.state.layoutType="notextile"}else if(e.match(this.regExpFactory.pattern("pre"))){this.state.layoutType="pre"}else if(e.match(this.regExpFactory.pattern("div"))){this.state.layoutType="div"}else if(e.match(this.regExpFactory.pattern("table"))){this.state.layoutType="table"}this.setModeForNextToken(r.attributes);return this.tokenStyles()},text:function(){if(this.eat("text")){return this.tokenStyles()}var t=this.stream.next();if(t==='"'){return this.execMode(r.link)}return this.handlePhraseModifier(t)},attributes:function(){this.setModeForNextToken(r.layoutLength);if(this.eat("attributes")){return this.tokenStylesWith(this.styleFor("attributes"))}return this.tokenStyles()},layoutLength:function(){if(this.stream.eat(".")&&this.stream.eat(".")){this.state.spanningLayout=true}this.setModeForNextToken(r.text);return this.tokenStyles()},list:function(){var t=this.eat("list"),e;this.state.listDepth=t[0].length;e=(this.state.listDepth-1)%3;if(!e){this.state.layoutType="list1"}else if(e===1){this.state.layoutType="list2"}else{this.state.layoutType="list3"}this.setModeForNextToken(r.attributes);return this.tokenStyles()},link:function(){this.setModeForNextToken(r.text);if(this.eat("link")){this.stream.match(/\S+/);return this.tokenStylesWith(this.styleFor("link"))}return this.tokenStyles()},linkDefinition:function(){this.stream.skipToEnd();return this.tokenStylesWith(this.styleFor("linkDefinition"))},definitionList:function(){this.eat("definitionList");this.state.layoutType="definitionList";if(this.stream.match(/\s*$/)){this.state.spanningLayout=true}else{this.setModeForNextToken(r.attributes)}return this.tokenStyles()},html:function(){this.stream.skipToEnd();return this.tokenStylesWith(this.styleFor("html"))},table:function(){this.state.layoutType="table";return this.execMode(r.tableCell)},tableCell:function(){if(this.eat("tableHeading")){this.state.tableHeading=true}else{this.stream.eat("|")}this.setModeForNextToken(r.tableCellAttributes);return this.tokenStyles()},tableCellAttributes:function(){this.setModeForNextToken(r.tableText);if(this.eat("tableCellAttributes")){return this.tokenStylesWith(this.styleFor("attributes"))}return this.tokenStyles()},tableText:function(){if(this.eat("tableText")){return this.tokenStyles()}if(this.stream.peek()==="|"){this.setModeForNextToken(r.tableCell);return this.tokenStyles()}return this.handlePhraseModifier(this.stream.next())}};t.defineMode("textile",function(){var t=new s;return{startState:function(){return{mode:r.newLayout}},token:function(e,s){var r=new i(t,s,e);if(e.sol()){r.startNewLine()}return r.nextToken()},blankLine:function(e){new i(t,e).blankLine()}}});t.defineMIME("text/x-textile","textile")});