(function(t){if(typeof exports=="object"&&typeof module=="object")t(require("../../lib/codemirror",require("../xml/xml"),require("../meta")));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror","../xml/xml","../meta"],t);else t(CodeMirror)})(function(t){"use strict";t.defineMode("markdown",function(e,i){var n=t.modes.hasOwnProperty("xml");var r=t.getMode(e,n?{name:"xml",htmlMode:true}:"text/plain");function a(i){if(t.findModeByName){var n=t.findModeByName(i);if(n)i=n.mime||n.mimes[0]}var r=t.getMode(e,i);return r.name=="null"?null:r}if(i.highlightFormatting===undefined)i.highlightFormatting=false;if(i.maxBlockquoteDepth===undefined)i.maxBlockquoteDepth=0;if(i.underscoresBreakWords===undefined)i.underscoresBreakWords=true;if(i.fencedCodeBlocks===undefined)i.fencedCodeBlocks=false;if(i.taskLists===undefined)i.taskLists=false;if(i.strikethrough===undefined)i.strikethrough=false;var l=0;var f="header",o="comment",s="quote",u="variable-2",h="variable-3",g="keyword",m="hr",c="tag",d="formatting",k="link",p="link",v="link",x="string",S="em",L="strong",F="strikethrough";var b=/^([*\-=_])(?:\s*\1){2,}\s*$/,q=/^[*\-+]\s+/,M=/^[0-9]+\.\s+/,w=/^\[(x| )\](?=\s)/,C=/^#+/,D=/^(?:\={1,}|-{1,})$/,H=/^[^#!\[\]*_\\<>` "'(~]+/;function T(t,e,i){e.f=e.inline=i;return i(t,e)}function B(t,e,i){e.f=e.block=i;return i(t,e)}function y(t){t.linkTitle=false;t.em=false;t.strong=false;t.strikethrough=false;t.quote=0;if(!n&&t.f==$){t.f=W;t.block=_}t.trailingSpace=0;t.trailingSpaceNewLine=false;t.thisLineHasContent=false;return null}function _(t,e){var n=t.sol();var r=e.list!==false;if(e.list!==false&&e.indentationDiff>=0){if(e.indentationDiff<4){e.indentation-=e.indentationDiff}e.list=null}else if(e.list!==false&&e.indentation>0){e.list=null;e.listDepth=Math.floor(e.indentation/4)}else if(e.list!==false){e.list=false;e.listDepth=0}var l=null;if(e.indentationDiff>=4){e.indentation-=4;t.skipToEnd();return o}else if(t.eatSpace()){return null}else if(l=t.match(C)){e.header=l[0].length<=6?l[0].length:6;if(i.highlightFormatting)e.formatting="header";e.f=e.inline;return j(e)}else if(e.prevLineHasContent&&(l=t.match(D))){e.header=l[0].charAt(0)=="="?1:2;if(i.highlightFormatting)e.formatting="header";e.f=e.inline;return j(e)}else if(t.eat(">")){e.indentation++;e.quote=n?1:e.quote+1;if(i.highlightFormatting)e.formatting="quote";t.eatSpace();return j(e)}else if(t.peek()==="["){return T(t,e,I)}else if(t.match(b,true)){return m}else if((!e.prevLineHasContent||r)&&(t.match(q,false)||t.match(M,false))){var f=null;if(t.match(q,true)){f="ul"}else{t.match(M,true);f="ol"}e.indentation+=4;e.list=true;e.listDepth++;if(i.taskLists&&t.match(w,false)){e.taskList=true}e.f=e.inline;if(i.highlightFormatting)e.formatting=["list","list-"+f];return j(e)}else if(i.fencedCodeBlocks&&t.match(/^```[ \t]*([\w+#]*)/,true)){e.localMode=a(RegExp.$1);if(e.localMode)e.localState=e.localMode.startState();e.f=e.block=N;if(i.highlightFormatting)e.formatting="code-block";e.code=true;return j(e)}return T(t,e,e.inline)}function $(t,e){var i=r.token(t,e.htmlState);if(n&&e.htmlState.tagStart===null&&!e.htmlState.context||e.md_inside&&t.current().indexOf(">")>-1){e.f=W;e.block=_;e.htmlState=null}return i}function N(t,e){if(t.sol()&&t.match("```",false)){e.localMode=e.localState=null;e.f=e.block=O;return null}else if(e.localMode){return e.localMode.token(t,e.localState)}else{t.skipToEnd();return o}}function O(t,e){t.match("```");e.block=_;e.f=W;if(i.highlightFormatting)e.formatting="code-block";e.code=true;var n=j(e);e.code=false;return n}function j(t){var e=[];if(t.formatting){e.push(d);if(typeof t.formatting==="string")t.formatting=[t.formatting];for(var n=0;n<t.formatting.length;n++){e.push(d+"-"+t.formatting[n]);if(t.formatting[n]==="header"){e.push(d+"-"+t.formatting[n]+"-"+t.header)}if(t.formatting[n]==="quote"){if(!i.maxBlockquoteDepth||i.maxBlockquoteDepth>=t.quote){e.push(d+"-"+t.formatting[n]+"-"+t.quote)}else{e.push("error")}}}}if(t.taskOpen){e.push("meta");return e.length?e.join(" "):null}if(t.taskClosed){e.push("property");return e.length?e.join(" "):null}if(t.linkHref){e.push(x);return e.length?e.join(" "):null}if(t.strong){e.push(L)}if(t.em){e.push(S)}if(t.strikethrough){e.push(F)}if(t.linkText){e.push(v)}if(t.code){e.push(o)}if(t.header){e.push(f);e.push(f+"-"+t.header)}if(t.quote){e.push(s);if(!i.maxBlockquoteDepth||i.maxBlockquoteDepth>=t.quote){e.push(s+"-"+t.quote)}else{e.push(s+"-"+i.maxBlockquoteDepth)}}if(t.list!==false){var r=(t.listDepth-1)%3;if(!r){e.push(u)}else if(r===1){e.push(h)}else{e.push(g)}}if(t.trailingSpaceNewLine){e.push("trailing-space-new-line")}else if(t.trailingSpace){e.push("trailing-space-"+(t.trailingSpace%2?"a":"b"))}return e.length?e.join(" "):null}function E(t,e){if(t.match(H,true)){return j(e)}return undefined}function W(e,n){var a=n.text(e,n);if(typeof a!=="undefined")return a;if(n.list){n.list=null;return j(n)}if(n.taskList){var f=e.match(w,true)[1]!=="x";if(f)n.taskOpen=true;else n.taskClosed=true;if(i.highlightFormatting)n.formatting="task";n.taskList=false;return j(n)}n.taskOpen=false;n.taskClosed=false;if(n.header&&e.match(/^#+$/,true)){if(i.highlightFormatting)n.formatting="header";return j(n)}var o=e.sol();var s=e.next();if(s==="\\"){e.next();if(i.highlightFormatting){var u=j(n);return u?u+" formatting-escape":"formatting-escape"}}if(n.linkTitle){n.linkTitle=false;var h=s;if(s==="("){h=")"}h=(h+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var g="^\\s*(?:[^"+h+"\\\\]+|\\\\\\\\|\\\\.)"+h;if(e.match(new RegExp(g),true)){return x}}if(s==="`"){var m=n.formatting;if(i.highlightFormatting)n.formatting="code";var d=j(n);var v=e.pos;e.eatWhile("`");var S=1+e.pos-v;if(!n.code){l=S;n.code=true;return j(n)}else{if(S===l){n.code=false;return d}n.formatting=m;return j(n)}}else if(n.code){return j(n)}if(s==="!"&&e.match(/\[[^\]]*\] ?(?:\(|\[)/,false)){e.match(/\[[^\]]*\]/);n.inline=n.f=R;return c}if(s==="["&&e.match(/.*\](\(| ?\[)/,false)){n.linkText=true;if(i.highlightFormatting)n.formatting="link";return j(n)}if(s==="]"&&n.linkText){if(i.highlightFormatting)n.formatting="link";var u=j(n);n.linkText=false;n.inline=n.f=R;return u}if(s==="<"&&e.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,false)){n.f=n.inline=U;if(i.highlightFormatting)n.formatting="link";var u=j(n);if(u){u+=" "}else{u=""}return u+k}if(s==="<"&&e.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,false)){n.f=n.inline=U;if(i.highlightFormatting)n.formatting="link";var u=j(n);if(u){u+=" "}else{u=""}return u+p}if(s==="<"&&e.match(/^\w/,false)){if(e.string.indexOf(">")!=-1){var L=e.string.substring(1,e.string.indexOf(">"));if(/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(L)){n.md_inside=true}}e.backUp(1);n.htmlState=t.startState(r);return B(e,n,$)}if(s==="<"&&e.match(/^\/\w*?>/)){n.md_inside=false;return"tag"}var F=false;if(!i.underscoresBreakWords){if(s==="_"&&e.peek()!=="_"&&e.match(/(\w)/,false)){var b=e.pos-2;if(b>=0){var q=e.string.charAt(b);if(q!=="_"&&q.match(/(\w)/,false)){F=true}}}}if(s==="*"||s==="_"&&!F){if(o&&e.peek()===" "){}else if(n.strong===s&&e.eat(s)){if(i.highlightFormatting)n.formatting="strong";var d=j(n);n.strong=false;return d}else if(!n.strong&&e.eat(s)){n.strong=s;if(i.highlightFormatting)n.formatting="strong";return j(n)}else if(n.em===s){if(i.highlightFormatting)n.formatting="em";var d=j(n);n.em=false;return d}else if(!n.em){n.em=s;if(i.highlightFormatting)n.formatting="em";return j(n)}}else if(s===" "){if(e.eat("*")||e.eat("_")){if(e.peek()===" "){return j(n)}else{e.backUp(1)}}}if(i.strikethrough){if(s==="~"&&e.eatWhile(s)){if(n.strikethrough){if(i.highlightFormatting)n.formatting="strikethrough";var d=j(n);n.strikethrough=false;return d}else if(e.match(/^[^\s]/,false)){n.strikethrough=true;if(i.highlightFormatting)n.formatting="strikethrough";return j(n)}}else if(s===" "){if(e.match(/^~~/,true)){if(e.peek()===" "){return j(n)}else{e.backUp(2)}}}}if(s===" "){if(e.match(/ +$/,false)){n.trailingSpace++}else if(n.trailingSpace){n.trailingSpaceNewLine=true}}return j(n)}function U(t,e){var n=t.next();if(n===">"){e.f=e.inline=W;if(i.highlightFormatting)e.formatting="link";var r=j(e);if(r){r+=" "}else{r=""}return r+k}t.match(/^[^>]+/,true);return k}function R(t,e){if(t.eatSpace()){return null}var n=t.next();if(n==="("||n==="["){e.f=e.inline=A(n==="("?")":"]");if(i.highlightFormatting)e.formatting="link-string";e.linkHref=true;return j(e)}return"error"}function A(t){return function(e,n){var r=e.next();if(r===t){n.f=n.inline=W;if(i.highlightFormatting)n.formatting="link-string";var a=j(n);n.linkHref=false;return a}if(e.match(J(t),true)){e.backUp(1)}n.linkHref=true;return j(n)}}function I(t,e){if(t.match(/^[^\]]*\]:/,false)){e.f=P;t.next();if(i.highlightFormatting)e.formatting="link";e.linkText=true;return j(e)}return T(t,e,W)}function P(t,e){if(t.match(/^\]:/,true)){e.f=e.inline=z;if(i.highlightFormatting)e.formatting="link";var n=j(e);e.linkText=false;return n}t.match(/^[^\]]+/,true);return v}function z(t,e){if(t.eatSpace()){return null}t.match(/^[^\s]+/,true);if(t.peek()===undefined){e.linkTitle=true}else{t.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,true)}e.f=e.inline=W;return x}var G=[];function J(t){if(!G[t]){t=(t+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");G[t]=new RegExp("^(?:[^\\\\]|\\\\.)*?("+t+")")}return G[t]}var K={startState:function(){return{f:_,prevLineHasContent:false,thisLineHasContent:false,block:_,htmlState:null,indentation:0,inline:W,text:E,formatting:false,linkText:false,linkHref:false,linkTitle:false,em:false,strong:false,header:0,taskList:false,list:false,listDepth:0,quote:0,trailingSpace:0,trailingSpaceNewLine:false,strikethrough:false}},copyState:function(e){return{f:e.f,prevLineHasContent:e.prevLineHasContent,thisLineHasContent:e.thisLineHasContent,block:e.block,htmlState:e.htmlState&&t.copyState(r,e.htmlState),indentation:e.indentation,localMode:e.localMode,localState:e.localMode?t.copyState(e.localMode,e.localState):null,inline:e.inline,text:e.text,formatting:false,linkTitle:e.linkTitle,em:e.em,strong:e.strong,strikethrough:e.strikethrough,header:e.header,taskList:e.taskList,list:e.list,listDepth:e.listDepth,quote:e.quote,trailingSpace:e.trailingSpace,trailingSpaceNewLine:e.trailingSpaceNewLine,md_inside:e.md_inside}},token:function(t,e){e.formatting=false;if(t.sol()){var i=!!e.header;e.header=0;if(t.match(/^\s*$/,true)||i){e.prevLineHasContent=false;y(e);return i?this.token(t,e):null}else{e.prevLineHasContent=e.thisLineHasContent;e.thisLineHasContent=true}e.taskList=false;e.code=false;e.trailingSpace=0;e.trailingSpaceNewLine=false;e.f=e.block;var n=t.match(/^\s*/,true)[0].replace(/\t/g,"    ").length;var r=Math.floor((n-e.indentation)/4)*4;if(r>4)r=4;var a=e.indentation+r;e.indentationDiff=a-e.indentation;e.indentation=a;if(n>0)return null}return e.f(t,e)},innerMode:function(t){if(t.block==$)return{state:t.htmlState,mode:r};if(t.localState)return{state:t.localState,mode:t.localMode};return{state:t,mode:K}},blankLine:y,getType:j,fold:"markdown"};return K},"xml");t.defineMIME("text/x-markdown","markdown")});