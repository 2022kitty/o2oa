define("tinymce/html/DomParser",["tinymce/html/Node","tinymce/html/Schema","tinymce/html/SaxParser","tinymce/util/Tools"],function(e,t,n,i){var a=i.makeMap,l=i.each,r=i.explode,f=i.extend;return function(i,o){var p=this,m={},s=[],d={},u={};i=i||{};i.validate="validate"in i?i.validate:true;i.root_name=i.root_name||"body";p.schema=o=o||new t;function c(t){var n,i,l,r,f,m,s,d,u;var c,h,v,y,g;h=a("tr,td,th,tbody,thead,tfoot,table");c=o.getNonEmptyElements();v=o.getTextBlockElements();for(n=0;n<t.length;n++){i=t[n];if(!i.parent||i.fixed){continue}if(v[i.name]&&i.parent.name=="li"){y=i.next;while(y){if(v[y.name]){y.name="li";y.fixed=true;i.parent.insert(y,i.parent)}else{break}y=y.next}i.unwrap(i);continue}r=[i];for(l=i.parent;l&&!o.isValidChild(l.name,i.name)&&!h[l.name];l=l.parent){r.push(l)}if(l&&r.length>1){r.reverse();f=m=p.filterNode(r[0].clone());for(u=0;u<r.length-1;u++){if(o.isValidChild(m.name,r[u].name)){s=p.filterNode(r[u].clone());m.append(s)}else{s=m}for(d=r[u].firstChild;d&&d!=r[u+1];){g=d.next;s.append(d);d=g}m=s}if(!f.isEmpty(c)){l.insert(f,r[0],true);l.insert(i,f)}else{l.insert(i,r[0],true)}l=r[0];if(l.isEmpty(c)||l.firstChild===l.lastChild&&l.firstChild.name==="br"){l.empty().remove()}}else if(i.parent){if(i.name==="li"){y=i.prev;if(y&&(y.name==="ul"||y.name==="ul")){y.append(i);continue}y=i.next;if(y&&(y.name==="ul"||y.name==="ul")){y.insert(i,y.firstChild,true);continue}i.wrap(p.filterNode(new e("ul",1)));continue}if(o.isValidChild(i.parent.name,"div")&&o.isValidChild("div",i.name)){i.wrap(p.filterNode(new e("div",1)))}else{if(i.name==="style"||i.name==="script"){i.empty().remove()}else{i.unwrap()}}}}}p.filterNode=function(e){var t,n,i;if(n in m){i=d[n];if(i){i.push(e)}else{d[n]=[e]}}t=s.length;while(t--){n=s[t].name;if(n in e.attributes.map){i=u[n];if(i){i.push(e)}else{u[n]=[e]}}}return e};p.addNodeFilter=function(e,t){l(r(e),function(e){var n=m[e];if(!n){m[e]=n=[]}n.push(t)})};p.addAttributeFilter=function(e,t){l(r(e),function(e){var n;for(n=0;n<s.length;n++){if(s[n].name===e){s[n].callbacks.push(t);return}}s.push({name:e,callbacks:[t]})})};p.parse=function(t,l){var r,p,h,v,y,g,w,b,_,C,E;var x,k,N=[],V;var F,R,S,B;var A,P,T;l=l||{};d={};u={};x=f(a("script,style,head,html,body,title,meta,param"),o.getBlockElements());P=o.getNonEmptyElements();A=o.children;E=i.validate;T="forced_root_block"in l?l.forced_root_block:i.forced_root_block;B=o.getWhiteSpaceElements();k=/^[ \t\r\n]+/;F=/[ \t\r\n]+$/;R=/[ \t\r\n]+/g;S=/^[ \t\r\n]+$/;function $(){var e=p.firstChild,t,n;function a(t){if(t){e=t.firstChild;if(e&&e.type==3){e.value=e.value.replace(k,"")}e=t.lastChild;if(e&&e.type==3){e.value=e.value.replace(F,"")}}}if(!o.isValidChild(p.name,T.toLowerCase())){return}while(e){t=e.next;if(e.type==3||e.type==1&&e.name!=="p"&&!x[e.name]&&!e.attr("data-mce-type")){if(!n){n=D(T,1);n.attr(i.forced_root_block_attrs);p.insert(n,e);n.append(e)}else{n.append(e)}}else{a(n);n=null}e=t}a(n)}function D(t,n){var i=new e(t,n),a;if(t in m){a=d[t];if(a){a.push(i)}else{d[t]=[i]}}return i}function L(e){var t,n,i;for(t=e.prev;t&&t.type===3;){n=t.value.replace(F,"");if(n.length>0){t.value=n;t=t.prev}else{i=t.prev;t.remove();t=i}}}function M(e){var t,n={};for(t in e){if(t!=="li"&&t!="p"){n[t]=e[t]}}return n}r=new n({validate:E,allow_script_urls:i.allow_script_urls,allow_conditional_comments:i.allow_conditional_comments,self_closing_elements:M(o.getSelfClosingElements()),cdata:function(e){h.append(D("#cdata",4)).value=e},text:function(e,t){var n;if(!V){e=e.replace(R," ");if(h.lastChild&&x[h.lastChild.name]){e=e.replace(k,"")}}if(e.length!==0){n=D("#text",3);n.raw=!!t;h.append(n).value=e}},comment:function(e){h.append(D("#comment",8)).value=e},pi:function(e,t){h.append(D(e,7)).value=t;L(h)},doctype:function(e){var t;t=h.append(D("#doctype",10));t.value=e;L(h)},start:function(e,t,n){var i,a,l,r,f;l=E?o.getElementRule(e):{};if(l){i=D(l.outputName||e,1);i.attributes=t;i.shortEnded=n;h.append(i);f=A[h.name];if(f&&A[i.name]&&!f[i.name]){N.push(i)}a=s.length;while(a--){r=s[a].name;if(r in t.map){_=u[r];if(_){_.push(i)}else{u[r]=[i]}}}if(x[e]){L(i)}if(!n){h=i}if(!V&&B[e]){V=true}}},end:function(t){var n,i,a,l,r;i=E?o.getElementRule(t):{};if(i){if(x[t]){if(!V){n=h.firstChild;if(n&&n.type===3){a=n.value.replace(k,"");if(a.length>0){n.value=a;n=n.next}else{l=n.next;n.remove();n=l;while(n&&n.type===3){a=n.value;l=n.next;if(a.length===0||S.test(a)){n.remove();n=l}n=l}}}n=h.lastChild;if(n&&n.type===3){a=n.value.replace(F,"");if(a.length>0){n.value=a;n=n.prev}else{l=n.prev;n.remove();n=l;while(n&&n.type===3){a=n.value;l=n.prev;if(a.length===0||S.test(a)){n.remove();n=l}n=l}}}}}if(V&&B[t]){V=false}if(i.removeEmpty||i.paddEmpty){if(h.isEmpty(P)){if(i.paddEmpty){h.empty().append(new e("#text","3")).value=" "}else{if(!h.attributes.map.name&&!h.attributes.map.id){r=h.parent;h.empty().remove();h=r;return}}}}h=h.parent}}},o);p=h=new e(l.context||i.root_name,11);r.parse(t);if(E&&N.length){if(!l.context){c(N)}else{l.invalid=true}}if(T&&(p.name=="body"||l.isRootContent)){$()}if(!l.invalid){for(C in d){_=m[C];v=d[C];w=v.length;while(w--){if(!v[w].parent){v.splice(w,1)}}for(y=0,g=_.length;y<g;y++){_[y](v,C,l)}}for(y=0,g=s.length;y<g;y++){_=s[y];if(_.name in u){v=u[_.name];w=v.length;while(w--){if(!v[w].parent){v.splice(w,1)}}for(w=0,b=_.callbacks.length;w<b;w++){_.callbacks[w](v,_.name,l)}}}}return p};if(i.remove_trailing_brs){p.addNodeFilter("br",function(t){var n,i=t.length,a,l=f({},o.getBlockElements());var r=o.getNonEmptyElements(),p,m,s,d;var u,c;l.body=1;for(n=0;n<i;n++){a=t[n];p=a.parent;if(l[a.parent.name]&&a===p.lastChild){s=a.prev;while(s){d=s.name;if(d!=="span"||s.attr("data-mce-type")!=="bookmark"){if(d!=="br"){break}if(d==="br"){a=null;break}}s=s.prev}if(a){a.remove();if(p.isEmpty(r)){u=o.getElementRule(p.name);if(u){if(u.removeEmpty){p.remove()}else if(u.paddEmpty){p.empty().append(new e("#text",3)).value=" "}}}}}else{m=a;while(p&&p.firstChild===m&&p.lastChild===m){m=p;if(l[p.name]){break}p=p.parent}if(m===p){c=new e("#text",3);c.value=" ";a.replace(c)}}}})}if(!i.allow_html_in_named_anchor){p.addAttributeFilter("id,name",function(e){var t=e.length,n,i,a,l;while(t--){l=e[t];if(l.name==="a"&&l.firstChild&&!l.attr("href")){a=l.parent;n=l.lastChild;do{i=n.prev;a.insert(n,l);n=i}while(n)}}})}}});