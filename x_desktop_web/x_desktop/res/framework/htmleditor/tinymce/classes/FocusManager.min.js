define("tinymce/FocusManager",["tinymce/dom/DOMUtils","tinymce/Env"],function(t,n){var e,o,i,r=t.DOM;function c(t){function u(){try{return document.activeElement}catch(t){return document.body}}function s(t,n){if(n&&n.startContainer){if(!t.isChildOf(n.startContainer,t.getRoot())||!t.isChildOf(n.endContainer,t.getRoot())){return}return{startContainer:n.startContainer,startOffset:n.startOffset,endContainer:n.endContainer,endOffset:n.endOffset}}return n}function d(t,n){var e;if(n.startContainer){e=t.getDoc().createRange();e.setStart(n.startContainer,n.startOffset);e.setEnd(n.endContainer,n.endOffset)}else{e=n}return e}function f(t){return!!r.getParent(t,c.isEditorUIElement)}function a(c){var a=c.editor;a.on("init",function(){if(a.inline||n.ie){a.on("nodechange keyup",function(){var t=document.activeElement;if(t&&t.id==a.id+"_ifr"){t=a.getBody()}if(a.dom.isChildOf(t,a.getBody())){a.lastRng=a.selection.getRng()}});if(n.webkit&&!e){e=function(){var n=t.activeEditor;if(n&&n.selection){var e=n.selection.getRng();if(e&&!e.collapsed){a.lastRng=e}}};r.bind(document,"selectionchange",e)}}});a.on("setcontent",function(){a.lastRng=null});a.on("mousedown",function(){a.selection.lastFocusBookmark=null});a.on("focusin",function(){var n=t.focusedEditor;if(a.selection.lastFocusBookmark){a.selection.setRng(d(a,a.selection.lastFocusBookmark));a.selection.lastFocusBookmark=null}if(n!=a){if(n){n.fire("blur",{focusedEditor:a})}t.activeEditor=a;t.focusedEditor=a;a.fire("focus",{blurredEditor:n});a.focus(true)}a.lastRng=null});a.on("focusout",function(){window.setTimeout(function(){var n=t.focusedEditor;if(!f(u())&&n==a){a.fire("blur",{focusedEditor:null});t.focusedEditor=null;if(a.selection){a.selection.lastFocusBookmark=null}}},0)});if(!o){o=function(n){var e=t.activeEditor;if(e&&n.target.ownerDocument==document){if(e.selection){e.selection.lastFocusBookmark=s(e.dom,e.lastRng)}if(!f(n.target)&&t.focusedEditor==e){e.fire("blur",{focusedEditor:null});t.focusedEditor=null}}};r.bind(document,"focusin",o)}if(a.inline&&!i){i=function(n){var e=t.activeEditor;if(e.inline&&!e.dom.isChildOf(n.target,e.getBody())){var o=e.selection.getRng();if(!o.collapsed){e.lastRng=o}}};r.bind(document,"mouseup",i)}}function l(n){if(t.focusedEditor==n.editor){t.focusedEditor=null}if(!t.activeEditor){r.unbind(document,"selectionchange",e);r.unbind(document,"focusin",o);r.unbind(document,"mouseup",i);e=o=i=null}}t.on("AddEditor",a);t.on("RemoveEditor",l)}c.isEditorUIElement=function(t){return t.className.toString().indexOf("mce-")!==-1};return c});