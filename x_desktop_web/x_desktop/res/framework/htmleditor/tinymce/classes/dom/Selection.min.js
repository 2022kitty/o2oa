define("tinymce/dom/Selection",["tinymce/dom/TreeWalker","tinymce/dom/TridentSelection","tinymce/dom/ControlSelection","tinymce/dom/RangeUtils","tinymce/Env","tinymce/util/Tools"],function(e,t,n,r,o,i){var a=i.each,s=i.grep,l=i.trim;var d=o.ie,f=o.opera;function c(e,r,o,i){var a=this;a.dom=e;a.win=r;a.serializer=o;a.editor=i;a.controlSelection=new n(a,i);if(!a.win.getSelection){a.tridentSel=new t(a)}}c.prototype={setCursorLocation:function(e,t){var n=this,r=n.dom.createRng();if(!e){n._moveEndPoint(r,n.editor.getBody(),true);n.setRng(r)}else{r.setStart(e,t);r.setEnd(e,t);n.setRng(r);n.collapse(false)}},getContent:function(e){var t=this,n=t.getRng(),r=t.dom.create("body");var o=t.getSel(),i,a,s;e=e||{};i=a="";e.get=true;e.format=e.format||"html";e.selection=true;t.editor.fire("BeforeGetContent",e);if(e.format=="text"){return t.isCollapsed()?"":n.text||(o.toString?o.toString():"")}if(n.cloneContents){s=n.cloneContents();if(s){r.appendChild(s)}}else if(n.item!==undefined||n.htmlText!==undefined){r.innerHTML="<br>"+(n.item?n.item(0).outerHTML:n.htmlText);r.removeChild(r.firstChild)}else{r.innerHTML=n.toString()}if(/^\s/.test(r.innerHTML)){i=" "}if(/\s+$/.test(r.innerHTML)){a=" "}e.getInner=true;e.content=t.isCollapsed()?"":i+t.serializer.serialize(r,e)+a;t.editor.fire("GetContent",e);return e.content},setContent:function(e,t){var n=this,r=n.getRng(),o,i=n.win.document,a,s;t=t||{format:"html"};t.set=true;t.selection=true;e=t.content=e;if(!t.no_events){n.editor.fire("BeforeSetContent",t)}e=t.content;if(r.insertNode){e+='<span id="__caret">_</span>';if(r.startContainer==i&&r.endContainer==i){i.body.innerHTML=e}else{r.deleteContents();if(i.body.childNodes.length===0){i.body.innerHTML=e}else{if(r.createContextualFragment){r.insertNode(r.createContextualFragment(e))}else{a=i.createDocumentFragment();s=i.createElement("div");a.appendChild(s);s.outerHTML=e;r.insertNode(a)}}}o=n.dom.get("__caret");r=i.createRange();r.setStartBefore(o);r.setEndBefore(o);n.setRng(r);n.dom.remove("__caret");try{n.setRng(r)}catch(e){}}else{if(r.item){i.execCommand("Delete",false,null);r=n.getRng()}if(/^\s+/.test(e)){r.pasteHTML('<span id="__mce_tmp">_</span>'+e);n.dom.remove("__mce_tmp")}else{r.pasteHTML(e)}}if(!t.no_events){n.editor.fire("SetContent",t)}},getStart:function(){var e=this,t=e.getRng(),n,r,o,i;if(t.duplicate||t.item){if(t.item){return t.item(0)}o=t.duplicate();o.collapse(1);n=o.parentElement();if(n.ownerDocument!==e.dom.doc){n=e.dom.getRoot()}r=i=t.parentElement();while(i=i.parentNode){if(i==n){n=r;break}}return n}else{n=t.startContainer;if(n.nodeType==1&&n.hasChildNodes()){n=n.childNodes[Math.min(n.childNodes.length-1,t.startOffset)]}if(n&&n.nodeType==3){return n.parentNode}return n}},getEnd:function(){var e=this,t=e.getRng(),n,r;if(t.duplicate||t.item){if(t.item){return t.item(0)}t=t.duplicate();t.collapse(0);n=t.parentElement();if(n.ownerDocument!==e.dom.doc){n=e.dom.getRoot()}if(n&&n.nodeName=="BODY"){return n.lastChild||n}return n}else{n=t.endContainer;r=t.endOffset;if(n.nodeType==1&&n.hasChildNodes()){n=n.childNodes[r>0?r-1:r]}if(n&&n.nodeType==3){return n.parentNode}return n}},getBookmark:function(e,t){var n=this,r=n.dom,o,i,s,l,d,f,c="&#xFEFF;",u;function g(e,t){var n=0;a(r.select(e),function(e,r){if(e==t){n=r}});return n}function m(e){function t(t){var n,r,o,i=t?"start":"end";n=e[i+"Container"];r=e[i+"Offset"];if(n.nodeType==1&&n.nodeName=="TR"){o=n.childNodes;n=o[Math.min(t?r:r-1,o.length-1)];if(n){r=t?0:n.childNodes.length;e["set"+(t?"Start":"End")](n,r)}}}t(true);t();return e}function p(){var e=n.getRng(true),o=r.getRoot(),i={};function a(e,r){var i=e[r?"startContainer":"endContainer"],a=e[r?"startOffset":"endOffset"],s=[],l,d,f=0;if(i.nodeType==3){if(t){for(l=i.previousSibling;l&&l.nodeType==3;l=l.previousSibling){a+=l.nodeValue.length}}s.push(a)}else{d=i.childNodes;if(a>=d.length&&d.length){f=1;a=Math.max(0,d.length-1)}s.push(n.dom.nodeIndex(d[a],t)+f)}for(;i&&i!=o;i=i.parentNode){s.push(n.dom.nodeIndex(i,t))}return s}i.start=a(e,true);if(!n.isCollapsed()){i.end=a(e)}return i}if(e==2){f=n.getNode();d=f?f.nodeName:null;if(d=="IMG"){return{name:d,index:g(d,f)}}if(n.tridentSel){return n.tridentSel.getBookmark(e)}return p()}if(e){return{rng:n.getRng()}}o=n.getRng();s=r.uniqueId();l=n.isCollapsed();u="overflow:hidden;line-height:0px";if(o.duplicate||o.item){if(!o.item){i=o.duplicate();try{o.collapse();o.pasteHTML('<span data-mce-type="bookmark" id="'+s+'_start" style="'+u+'">'+c+"</span>");if(!l){i.collapse(false);o.moveToElementText(i.parentElement());if(o.compareEndPoints("StartToEnd",i)===0){i.move("character",-1)}i.pasteHTML('<span data-mce-type="bookmark" id="'+s+'_end" style="'+u+'">'+c+"</span>")}}catch(e){return null}}else{f=o.item(0);d=f.nodeName;return{name:d,index:g(d,f)}}}else{f=n.getNode();d=f.nodeName;if(d=="IMG"){return{name:d,index:g(d,f)}}i=m(o.cloneRange());if(!l){i.collapse(false);i.insertNode(r.create("span",{"data-mce-type":"bookmark",id:s+"_end",style:u},c))}o=m(o);o.collapse(true);o.insertNode(r.create("span",{"data-mce-type":"bookmark",id:s+"_start",style:u},c))}n.moveToBookmark({id:s,keep:1});return{id:s}},moveToBookmark:function(e){var t=this,n=t.dom,r,o,i,l,c,u;function g(t){var n=e[t?"start":"end"],i,a,s,l;if(n){s=n[0];for(a=o,i=n.length-1;i>=1;i--){l=a.childNodes;if(n[i]>l.length-1){return}a=l[n[i]]}if(a.nodeType===3){s=Math.min(n[0],a.nodeValue.length)}if(a.nodeType===1){s=Math.min(n[0],a.childNodes.length)}if(t){r.setStart(a,s)}else{r.setEnd(a,s)}}return true}function m(t){var r=n.get(e.id+"_"+t),o,d,g,m,p=e.keep;if(r){o=r.parentNode;if(t=="start"){if(!p){d=n.nodeIndex(r)}else{o=r.firstChild;d=1}i=l=o;c=u=d}else{if(!p){d=n.nodeIndex(r)}else{o=r.firstChild;d=1}l=o;u=d}if(!p){m=r.previousSibling;g=r.nextSibling;a(s(r.childNodes),function(e){if(e.nodeType==3){e.nodeValue=e.nodeValue.replace(/\uFEFF/g,"")}});while(r=n.get(e.id+"_"+t)){n.remove(r,1)}if(m&&g&&m.nodeType==g.nodeType&&m.nodeType==3&&!f){d=m.nodeValue.length;m.appendData(g.nodeValue);n.remove(g);if(t=="start"){i=l=m;c=u=d}else{l=m;u=d}}}}}function p(e){if(n.isBlock(e)&&!e.innerHTML&&!d){e.innerHTML='<br data-mce-bogus="1" />'}return e}if(e){if(e.start){r=n.createRng();o=n.getRoot();if(t.tridentSel){return t.tridentSel.moveToBookmark(e)}if(g(true)&&g()){t.setRng(r)}}else if(e.id){m("start");m("end");if(i){r=n.createRng();r.setStart(p(i),c);r.setEnd(p(l),u);t.setRng(r)}}else if(e.name){t.select(n.select(e.name)[e.index])}else if(e.rng){t.setRng(e.rng)}}},select:function(e,t){var n=this,r=n.dom,o=r.createRng(),i;n.lastFocusBookmark=null;if(e){if(!t&&n.controlSelection.controlSelect(e)){return}i=r.nodeIndex(e);o.setStart(e.parentNode,i);o.setEnd(e.parentNode,i+1);if(t){n._moveEndPoint(o,e,true);n._moveEndPoint(o,e)}n.setRng(o)}return e},isCollapsed:function(){var e=this,t=e.getRng(),n=e.getSel();if(!t||t.item){return false}if(t.compareEndPoints){return t.compareEndPoints("StartToEnd",t)===0}return!n||t.collapsed},collapse:function(e){var t=this,n=t.getRng(),r;if(n.item){r=n.item(0);n=t.win.document.body.createTextRange();n.moveToElementText(r)}n.collapse(!!e);t.setRng(n)},getSel:function(){var e=this.win;return e.getSelection?e.getSelection():e.document.selection},getRng:function(e){var t=this,n,r,o,i=t.win.document,a;function s(e,t,n){try{return t.compareBoundaryPoints(e,n)}catch(e){return-1}}if(!e&&t.lastFocusBookmark){var l=t.lastFocusBookmark;if(l.startContainer){r=i.createRange();r.setStart(l.startContainer,l.startOffset);r.setEnd(l.endContainer,l.endOffset)}else{r=l}return r}if(e&&t.tridentSel){return t.tridentSel.getRangeAt(0)}try{if(n=t.getSel()){if(n.rangeCount>0){r=n.getRangeAt(0)}else{r=n.createRange?n.createRange():i.createRange()}}}catch(e){}if(d&&r&&r.setStart&&i.selection){try{a=i.selection.createRange()}catch(e){}if(a&&a.item){o=a.item(0);r=i.createRange();r.setStartBefore(o);r.setEndAfter(o)}}if(!r){r=i.createRange?i.createRange():i.body.createTextRange()}if(r.setStart&&r.startContainer.nodeType===9&&r.collapsed){o=t.dom.getRoot();r.setStart(o,0);r.setEnd(o,0)}if(t.selectedRange&&t.explicitRange){if(s(r.START_TO_START,r,t.selectedRange)===0&&s(r.END_TO_END,r,t.selectedRange)===0){r=t.explicitRange}else{t.selectedRange=null;t.explicitRange=null}}return r},setRng:function(e,t){var n=this,r;if(e.select){try{e.select()}catch(e){}return}if(!n.tridentSel){r=n.getSel();if(r){n.explicitRange=e;try{r.removeAllRanges();r.addRange(e)}catch(e){}if(t===false&&r.extend){r.collapse(e.endContainer,e.endOffset);r.extend(e.startContainer,e.startOffset)}n.selectedRange=r.rangeCount>0?r.getRangeAt(0):null}}else{if(e.cloneRange){try{n.tridentSel.addRange(e);return}catch(e){}}}},setNode:function(e){var t=this;t.setContent(t.dom.getOuterHTML(e));return e},getNode:function(){var e=this,t=e.getRng(),n;var r=t.startContainer,o=t.endContainer;var i=t.startOffset,a=t.endOffset,s=e.dom.getRoot();function l(e,t){var n=e;while(e&&e.nodeType===3&&e.length===0){e=t?e.nextSibling:e.previousSibling}return e||n}if(!t){return s}if(t.setStart){n=t.commonAncestorContainer;if(!t.collapsed){if(r==o){if(a-i<2){if(r.hasChildNodes()){n=r.childNodes[i]}}}if(r.nodeType===3&&o.nodeType===3){if(r.length===i){r=l(r.nextSibling,true)}else{r=r.parentNode}if(a===0){o=l(o.previousSibling,false)}else{o=o.parentNode}if(r&&r===o){return r}}}if(n&&n.nodeType==3){return n.parentNode}return n}n=t.item?t.item(0):t.parentElement();if(n.ownerDocument!==e.win.document){n=s}return n},getSelectedBlocks:function(t,n){var r=this,o=r.dom,i,a,s=[];a=o.getRoot();t=o.getParent(t||r.getStart(),o.isBlock);n=o.getParent(n||r.getEnd(),o.isBlock);if(t&&t!=a){s.push(t)}if(t&&n&&t!=n){i=t;var l=new e(t,a);while((i=l.next())&&i!=n){if(o.isBlock(i)){s.push(i)}}}if(n&&t!=n&&n!=a){s.push(n)}return s},isForward:function(){var e=this.dom,t=this.getSel(),n,r;if(!t||!t.anchorNode||!t.focusNode){return true}n=e.createRng();n.setStart(t.anchorNode,t.anchorOffset);n.collapse(true);r=e.createRng();r.setStart(t.focusNode,t.focusOffset);r.collapse(true);return n.compareBoundaryPoints(n.START_TO_START,r)<=0},normalize:function(){var e=this,t=e.getRng();if(!d&&new r(e.dom).normalize(t)){e.setRng(t,e.isForward())}return t},selectorChanged:function(e,t){var n=this,r;if(!n.selectorChangedData){n.selectorChangedData={};r={};n.editor.on("NodeChange",function(e){var t=e.element,o=n.dom,i=o.getParents(t,null,o.getRoot()),s={};a(n.selectorChangedData,function(e,t){a(i,function(n){if(o.is(n,t)){if(!r[t]){a(e,function(e){e(true,{node:n,selector:t,parents:i})});r[t]=e}s[t]=e;return false}})});a(r,function(e,n){if(!s[n]){delete r[n];a(e,function(e){e(false,{node:t,selector:n,parents:i})})}})})}if(!n.selectorChangedData[e]){n.selectorChangedData[e]=[]}n.selectorChangedData[e].push(t);return n},getScrollContainer:function(){var e,t=this.dom.getRoot();while(t&&t.nodeName!="BODY"){if(t.scrollHeight>t.clientHeight){e=t;break}t=t.parentNode}return e},scrollIntoView:function(e){var t,n,r=this,o=r.dom,i=o.getRoot(),a,s;function l(e){var t=0,n=0;var r=e;while(r&&r.nodeType){t+=r.offsetLeft||0;n+=r.offsetTop||0;r=r.offsetParent}return{x:t,y:n}}if(i.nodeName!="BODY"){var d=r.getScrollContainer();if(d){t=l(e).y-l(d).y;s=d.clientHeight;a=d.scrollTop;if(t<a||t+25>a+s){d.scrollTop=t<a?t:t-s+25}return}}n=o.getViewPort(r.editor.getWin());t=o.getPos(e).y;a=n.y;s=n.h;if(t<n.y||t+25>a+s){r.editor.getWin().scrollTo(0,t<a?t:t-s+25)}},_moveEndPoint:function(t,n,r){var i=n,a=new e(n,i);var s=this.dom.schema.getNonEmptyElements();do{if(n.nodeType==3&&l(n.nodeValue).length!==0){if(r){t.setStart(n,0)}else{t.setEnd(n,n.nodeValue.length)}return}if(s[n.nodeName]){if(r){t.setStartBefore(n)}else{if(n.nodeName=="BR"){t.setEndBefore(n)}else{t.setEndAfter(n)}}return}if(o.ie&&o.ie<11&&this.dom.isBlock(n)&&this.dom.isEmpty(n)){if(r){t.setStart(n,0)}else{t.setEnd(n,0)}return}}while(n=r?a.next():a.prev());if(i.nodeName=="BODY"){if(r){t.setStart(i,0)}else{t.setEnd(i,i.childNodes.length)}}},destroy:function(){this.win=null;this.controlSelection.destroy()}};return c});