define("tinymce/UndoManager",["tinymce/Env","tinymce/util/Tools"],function(e,n){var t=n.trim,o;o=new RegExp(["<span[^>]+data-mce-bogus[^>]+>[â€‹\ufeff]+<\\/span>","<div[^>]+data-mce-bogus[^>]+><\\/div>",'\\s?data-mce-selected="[^"]+"'].join("|"),"gi");return function(n){var i=this,r=0,a=[],f,d,l=0;function c(){return t(n.getContent({format:"raw",no_events:1}).replace(o,""))}function u(e){i.typing=false;i.add({},e)}n.on("init",function(){i.add()});n.on("BeforeExecCommand",function(e){var n=e.command;if(n!="Undo"&&n!="Redo"&&n!="mceRepaint"){i.beforeChange()}});n.on("ExecCommand",function(e){var n=e.command;if(n!="Undo"&&n!="Redo"&&n!="mceRepaint"){u(e)}});n.on("ObjectResizeStart",function(){i.beforeChange()});n.on("SaveContent ObjectResized blur",u);n.dom.bind(n.dom.getRoot(),"dragend",u);n.on("KeyUp",function(t){var o=t.keyCode;if(o>=33&&o<=36||o>=37&&o<=40||o==45||o==13||t.ctrlKey){u();n.nodeChanged()}if(o==46||o==8||e.mac&&(o==91||o==93)){n.nodeChanged()}if(d&&i.typing){if(!n.isDirty()){n.isNotDirty=!a[0]||c()==a[0].content;if(!n.isNotDirty){n.fire("change",{level:a[0],lastLevel:null})}}n.fire("TypingUndo");d=false;n.nodeChanged()}});n.on("KeyDown",function(e){var n=e.keyCode;if(n>=33&&n<=36||n>=37&&n<=40||n==45){if(i.typing){u(e)}return}if((n<16||n>20)&&n!=224&&n!=91&&!i.typing){i.beforeChange();i.typing=true;i.add({},e);d=true}});n.on("MouseDown",function(e){if(i.typing){u(e)}});n.addShortcut("ctrl+z","","Undo");n.addShortcut("ctrl+y,ctrl+shift+z","","Redo");n.on("AddUndo Undo Redo ClearUndos MouseUp",function(e){if(!e.isDefaultPrevented()){n.nodeChanged()}});i={data:a,typing:false,beforeChange:function(){if(!l){f=n.selection.getBookmark(2,true)}},add:function(e,t){var o,i=n.settings,d;e=e||{};e.content=c();if(l||n.removed){return null}d=a[r];if(n.fire("BeforeAddUndo",{level:e,lastLevel:d,originalEvent:t}).isDefaultPrevented()){return null}if(d&&d.content==e.content){return null}if(a[r]){a[r].beforeBookmark=f}if(i.custom_undo_redo_levels){if(a.length>i.custom_undo_redo_levels){for(o=0;o<a.length-1;o++){a[o]=a[o+1]}a.length--;r=a.length}}e.bookmark=n.selection.getBookmark(2,true);if(r<a.length-1){a.length=r+1}a.push(e);r=a.length-1;var u={level:e,lastLevel:d,originalEvent:t};n.fire("AddUndo",u);if(r>0){n.isNotDirty=false;n.fire("change",u)}return e},undo:function(){var e;if(i.typing){i.add();i.typing=false}if(r>0){e=a[--r];if(r===0){n.isNotDirty=true}n.setContent(e.content,{format:"raw"});n.selection.moveToBookmark(e.beforeBookmark);n.fire("undo",{level:e})}return e},redo:function(){var e;if(r<a.length-1){e=a[++r];n.setContent(e.content,{format:"raw"});n.selection.moveToBookmark(e.bookmark);n.fire("redo",{level:e})}return e},clear:function(){a=[];r=0;i.typing=false;n.fire("ClearUndos")},hasUndo:function(){return r>0||i.typing&&a[0]&&c()!=a[0].content},hasRedo:function(){return r<a.length-1&&!this.typing},transact:function(e){i.beforeChange();try{l++;e()}finally{l--}i.add()}};return i}});