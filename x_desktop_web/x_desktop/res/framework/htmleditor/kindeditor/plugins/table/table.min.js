KindEditor.plugin("table",function(e){var l=this,t="table",n=l.lang(t+"."),o="ke-zeroborder";function i(e,l){l=l.toUpperCase();e.css("background-color",l);e.css("color",l==="#000000"?"#FFFFFF":"#000000");e.html(l)}var a=[];function r(t,n){n.bind("click,mousedown",function(e){e.stopPropagation()});function o(){e.each(a,function(){this.remove()});a=[];e(document).unbind("click,mousedown",o);t.unbind("click,mousedown",o)}n.click(function(n){o();var r=e(this),d=r.pos();var c=e.colorpicker({x:d.x,y:d.y+r.height(),z:811214,selectedColor:e(this).html(),colors:l.colorTable,noColor:l.lang("noColor"),shadowMode:l.shadowMode,click:function(e){i(r,e);o()}});a.push(c);e(document).bind("click,mousedown",o);t.bind("click,mousedown",o)})}function d(e,l,t){var n=0;for(var o=0,i=l.cells.length;o<i;o++){if(l.cells[o]==t){break}n+=l.cells[o].rowSpan-1}return t.cellIndex-n}l.plugin.table={prop:function(a){var d=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+n.cells+"</label>",n.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',n.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+n.size+"</label>",n.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+n.percent+"</option>",'<option value="px">'+n.px+"</option>","</select> &nbsp; ",n.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+n.percent+"</option>",'<option value="px">'+n.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+n.space+"</label>",n.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',n.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+n.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+n.alignDefault+"</option>",'<option value="left">'+n.alignLeft+"</option>",'<option value="center">'+n.alignCenter+"</option>",'<option value="right">'+n.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+n.border+"</label>",n.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',n.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+n.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var c=l.cmd.range.createBookmark();var s=l.createDialog({name:t,width:500,title:l.lang(t),body:d,beforeRemove:function(){S.unbind()},yesBtn:{name:l.lang("yes"),click:function(t){var n=g.val(),i=u.val(),a=v.val(),r=f.val(),d=m.val(),s=h.val(),p=b.val(),C=k.val(),B=w.val(),T=x.val(),A=e(S[0]).html()||"",I=e(S[1]).html()||"";if(n==0||!/^\d+$/.test(n)){alert(l.lang("invalidRows"));g[0].focus();return}if(i==0||!/^\d+$/.test(i)){alert(l.lang("invalidRows"));u[0].focus();return}if(!/^\d*$/.test(a)){alert(l.lang("invalidWidth"));v[0].focus();return}if(!/^\d*$/.test(r)){alert(l.lang("invalidHeight"));f[0].focus();return}if(!/^\d*$/.test(p)){alert(l.lang("invalidPadding"));b[0].focus();return}if(!/^\d*$/.test(C)){alert(l.lang("invalidSpacing"));k[0].focus();return}if(!/^\d*$/.test(T)){alert(l.lang("invalidBorder"));x[0].focus();return}if(y){if(a!==""){y.width(a+d)}else{y.css("width","")}if(y[0].width!==undefined){y.removeAttr("width")}if(r!==""){y.height(r+s)}else{y.css("height","")}if(y[0].height!==undefined){y.removeAttr("height")}y.css("background-color",I);if(y[0].bgColor!==undefined){y.removeAttr("bgColor")}if(p!==""){y[0].cellPadding=p}else{y.removeAttr("cellPadding")}if(C!==""){y[0].cellSpacing=C}else{y.removeAttr("cellSpacing")}if(B!==""){y[0].align=B}else{y.removeAttr("align")}if(T!==""){y.attr("border",T)}else{y.removeAttr("border")}if(T===""||T==="0"){y.addClass(o)}else{y.removeClass(o)}if(A!==""){y.attr("borderColor",A)}else{y.removeAttr("borderColor")}l.hideDialog().focus();l.cmd.range.moveToBookmark(c);l.cmd.select();l.addBookmark();return}var R="";if(a!==""){R+="width:"+a+d+";"}if(r!==""){R+="height:"+r+s+";"}if(I!==""){R+="background-color:"+I+";"}var $="<table";if(R!==""){$+=' style="'+R+'"'}if(p!==""){$+=' cellpadding="'+p+'"'}if(C!==""){$+=' cellspacing="'+C+'"'}if(B!==""){$+=' align="'+B+'"'}if(T!==""){$+=' border="'+T+'"'}if(T===""||T==="0"){$+=' class="'+o+'"'}if(A!==""){$+=' bordercolor="'+A+'"'}$+=">";for(var q=0;q<n;q++){$+="<tr>";for(var H=0;H<i;H++){$+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>"}$+="</tr>"}$+="</table>";if(!e.IE){$+="<br />"}l.insertHtml($);l.select().hideDialog().focus();l.addBookmark()}}}),p=s.div,g=e('[name="rows"]',p).val(3),u=e('[name="cols"]',p).val(2),v=e('[name="width"]',p).val(100),f=e('[name="height"]',p),m=e('[name="widthType"]',p),h=e('[name="heightType"]',p),b=e('[name="padding"]',p).val(2),k=e('[name="spacing"]',p).val(0),w=e('[name="align"]',p),x=e('[name="border"]',p).val(1),S=e(".ke-input-color",p);r(p,S.eq(0));r(p,S.eq(1));i(S.eq(0),"#000000");i(S.eq(1),"");g[0].focus();g[0].select();var y;if(a){return}y=l.plugin.getSelectedTable();if(y){g.val(y[0].rows.length);u.val(y[0].rows.length>0?y[0].rows[0].cells.length:0);g.attr("disabled",true);u.attr("disabled",true);var C,B=y[0].style.width||y[0].width,T=y[0].style.height||y[0].height;if(B!==undefined&&(C=/^(\d+)((?:px|%)*)$/.exec(B))){v.val(C[1]);m.val(C[2])}else{v.val("")}if(T!==undefined&&(C=/^(\d+)((?:px|%)*)$/.exec(T))){f.val(C[1]);h.val(C[2])}b.val(y[0].cellPadding||"");k.val(y[0].cellSpacing||"");w.val(y[0].align||"");x.val(y[0].border===undefined?"":y[0].border);i(S.eq(0),e.toHex(y.attr("borderColor")||""));i(S.eq(1),e.toHex(y[0].style.backgroundColor||y[0].bgColor||""));v[0].focus();v[0].select()}},cellprop:function(){var o=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+n.size+"</label>",n.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+n.percent+"</option>",'<option value="px">'+n.px+"</option>","</select> &nbsp; ",n.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+n.percent+"</option>",'<option value="px">'+n.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+n.align+"</label>",n.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+n.alignDefault+"</option>",'<option value="left">'+n.alignLeft+"</option>",'<option value="center">'+n.alignCenter+"</option>",'<option value="right">'+n.alignRight+"</option>","</select> ",n.verticalAlign+' <select name="verticalAlign">','<option value="">'+n.alignDefault+"</option>",'<option value="top">'+n.alignTop+"</option>",'<option value="middle">'+n.alignMiddle+"</option>",'<option value="bottom">'+n.alignBottom+"</option>",'<option value="baseline">'+n.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+n.border+"</label>",n.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',n.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+n.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var a=l.cmd.range.createBookmark();var d=l.createDialog({name:t,width:500,title:l.lang("tablecell"),body:o,beforeRemove:function(){k.unbind()},yesBtn:{name:l.lang("yes"),click:function(t){var n=s.val(),o=p.val(),i=g.val(),r=u.val(),d=v.val(),c=f.val(),x=m.val(),S=h.val(),y=b.val(),C=e(k[0]).html()||"",B=e(k[1]).html()||"";if(!/^\d*$/.test(n)){alert(l.lang("invalidWidth"));s[0].focus();return}if(!/^\d*$/.test(o)){alert(l.lang("invalidHeight"));p[0].focus();return}if(!/^\d*$/.test(y)){alert(l.lang("invalidBorder"));b[0].focus();return}w.css({width:n!==""?n+i:"",height:o!==""?o+r:"","background-color":B,"text-align":x,"vertical-align":S,"border-width":y,"border-style":y!==""?"solid":"","border-color":C});l.hideDialog().focus();l.cmd.range.moveToBookmark(a);l.cmd.select();l.addBookmark()}}}),c=d.div,s=e('[name="width"]',c).val(100),p=e('[name="height"]',c),g=e('[name="widthType"]',c),u=e('[name="heightType"]',c),v=e('[name="padding"]',c).val(2),f=e('[name="spacing"]',c).val(0),m=e('[name="textAlign"]',c),h=e('[name="verticalAlign"]',c),b=e('[name="border"]',c).val(1),k=e(".ke-input-color",c);r(c,k.eq(0));r(c,k.eq(1));i(k.eq(0),"#000000");i(k.eq(1),"");s[0].focus();s[0].select();var w=l.plugin.getSelectedCell();var x,S=w[0].style.width||w[0].width||"",y=w[0].style.height||w[0].height||"";if(x=/^(\d+)((?:px|%)*)$/.exec(S)){s.val(x[1]);g.val(x[2])}else{s.val("")}if(x=/^(\d+)((?:px|%)*)$/.exec(y)){p.val(x[1]);u.val(x[2])}m.val(w[0].style.textAlign||"");h.val(w[0].style.verticalAlign||"");var C=w[0].style.borderWidth||"";if(C){C=parseInt(C)}b.val(C);i(k.eq(0),e.toHex(w[0].style.borderColor||""));i(k.eq(1),e.toHex(w[0].style.backgroundColor||""));s[0].focus();s[0].select()},insert:function(){this.prop(true)},delete:function(){var e=l.plugin.getSelectedTable();l.cmd.range.setStartBefore(e[0]).collapse(true);l.cmd.select();e.remove();l.addBookmark()},colinsert:function(t){var n=l.plugin.getSelectedTable()[0],o=l.plugin.getSelectedRow()[0],i=l.plugin.getSelectedCell()[0],a=i.cellIndex+t;a+=n.rows[0].cells.length-o.cells.length;for(var r=0,c=n.rows.length;r<c;r++){var s=n.rows[r],p=s.insertCell(a);p.innerHTML=e.IE?"":"<br />";a=d(n,s,p)}l.cmd.range.selectNodeContents(i).collapse(true);l.cmd.select();l.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(t){var n=l.plugin.getSelectedTable()[0],o=l.plugin.getSelectedRow()[0],i=l.plugin.getSelectedCell()[0];var a=o.rowIndex;if(t===1){a=o.rowIndex+(i.rowSpan-1)+t}var r=n.insertRow(a);for(var d=0,c=o.cells.length;d<c;d++){if(o.cells[d].rowSpan>1){c-=o.cells[d].rowSpan-1}var s=r.insertCell(d);if(t===1&&o.cells[d].colSpan>1){s.colSpan=o.cells[d].colSpan}s.innerHTML=e.IE?"":"<br />"}for(var p=a;p>=0;p--){var g=n.rows[p].cells;if(g.length>d){for(var u=i.cellIndex;u>=0;u--){if(g[u].rowSpan>1){g[u].rowSpan+=1}}break}}l.cmd.range.selectNodeContents(i).collapse(true);l.cmd.select();l.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=l.plugin.getSelectedTable()[0],t=l.plugin.getSelectedRow()[0],n=l.plugin.getSelectedCell()[0],o=t.rowIndex,i=o+n.rowSpan,a=e.rows[i];if(e.rows.length<=i){return}var r=n.cellIndex;if(a.cells.length<=r){return}var d=a.cells[r];if(n.colSpan!==d.colSpan){return}n.rowSpan+=d.rowSpan;a.deleteCell(r);l.cmd.range.selectNodeContents(n).collapse(true);l.cmd.select();l.addBookmark()},colmerge:function(){var e=l.plugin.getSelectedTable()[0],t=l.plugin.getSelectedRow()[0],n=l.plugin.getSelectedCell()[0],o=t.rowIndex,i=n.cellIndex,a=i+1;if(t.cells.length<=a){return}var r=t.cells[a];if(n.rowSpan!==r.rowSpan){return}n.colSpan+=r.colSpan;t.deleteCell(a);l.cmd.range.selectNodeContents(n).collapse(true);l.cmd.select();l.addBookmark()},rowsplit:function(){var t=l.plugin.getSelectedTable()[0],n=l.plugin.getSelectedRow()[0],o=l.plugin.getSelectedCell()[0],i=n.rowIndex;if(o.rowSpan===1){return}var a=d(t,n,o);for(var r=1,c=o.rowSpan;r<c;r++){var s=t.rows[i+r],p=s.insertCell(a);if(o.colSpan>1){p.colSpan=o.colSpan}p.innerHTML=e.IE?"":"<br />";a=d(t,s,p)}e(o).removeAttr("rowSpan");l.cmd.range.selectNodeContents(o).collapse(true);l.cmd.select();l.addBookmark()},colsplit:function(){var t=l.plugin.getSelectedTable()[0],n=l.plugin.getSelectedRow()[0],o=l.plugin.getSelectedCell()[0],i=o.cellIndex;if(o.colSpan===1){return}for(var a=1,r=o.colSpan;a<r;a++){var d=n.insertCell(i+a);if(o.rowSpan>1){d.rowSpan=o.rowSpan}d.innerHTML=e.IE?"":"<br />"}e(o).removeAttr("colSpan");l.cmd.range.selectNodeContents(o).collapse(true);l.cmd.select();l.addBookmark()},coldelete:function(){var t=l.plugin.getSelectedTable()[0],n=l.plugin.getSelectedRow()[0],o=l.plugin.getSelectedCell()[0],i=o.cellIndex;for(var a=0,r=t.rows.length;a<r;a++){var d=t.rows[a],c=d.cells[i];if(c.colSpan>1){c.colSpan-=1;if(c.colSpan===1){e(c).removeAttr("colSpan")}}else{d.deleteCell(i)}if(c.rowSpan>1){a+=c.rowSpan-1}}if(n.cells.length===0){l.cmd.range.setStartBefore(t).collapse(true);l.cmd.select();e(t).remove()}else{l.cmd.selection(true)}l.addBookmark()},rowdelete:function(){var t=l.plugin.getSelectedTable()[0],n=l.plugin.getSelectedRow()[0],o=l.plugin.getSelectedCell()[0],i=n.rowIndex;for(var a=o.rowSpan-1;a>=0;a--){t.deleteRow(i+a)}if(t.rows.length===0){l.cmd.range.setStartBefore(t).collapse(true);l.cmd.select();e(t).remove()}else{l.cmd.selection(true)}l.addBookmark()}};l.clickToolbar(t,l.plugin.table.prop)});