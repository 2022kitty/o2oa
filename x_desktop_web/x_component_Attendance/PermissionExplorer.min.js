MWF.xDesktop.requireApp("Attendance","Explorer",null,false);MWF.xDesktop.requireApp("Template","MDomItem",null,false);MWF.xDesktop.requireApp("Organization","Selector.package",null,false);MWF.xApplication.Attendance.PermissionExplorer=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(e,t,i,s){this.setOptions(s);this.app=t;this.path="/x_component_Attendance/$PermissionExplorer/";this.cssPath="/x_component_Attendance/$PermissionExplorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=i;this.node=$(e);this.initData();if(!this.personActions)this.personActions=new MWF.xAction.org.express.RestActions},loadView:function(){this.view=new MWF.xApplication.Attendance.PermissionExplorer.View(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey);this.view.load();this.setContentSize()},createDocument:function(){if(this.view)this.view._createDocument()}});MWF.xApplication.Attendance.PermissionExplorer.View=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(e){return new MWF.xApplication.Attendance.PermissionExplorer.Document(this.table,e,this.explorer,this)},_getCurrentPageData:function(e,t){this.actions.listPermission(function(t){if(e)e(t)})},_removeDocument:function(e,t){this.actions.deletePermission(e.id,function(e){this.explorer.view.reload();this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_createDocument:function(){var e=new MWF.xApplication.Attendance.PermissionExplorer.Permission(this.explorer);e.create()},_openDocument:function(e){var t=new MWF.xApplication.Attendance.PermissionExplorer.Permission(this.explorer,e);t.edit()}});MWF.xApplication.Attendance.PermissionExplorer.Document=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document});MWF.xApplication.Attendance.PermissionExplorer.Permission=new Class({Extends:MWF.widget.Common,options:{width:"500",height:"400"},initialize:function(e,t){this.explorer=e;this.app=e.app;this.data=t||{};this.css=this.explorer.css;this.load()},load:function(){if(this.data.organizationName)this.data.department=this.data.organizationName;if(this.data.adminName)this.data.personName=this.data.adminName;if(this.data.adminLevel)this.data.role=this.data.adminLevel},open:function(e){this.isNew=false;this.isEdited=false},create:function(){this.isNew=true;this._open()},edit:function(){this.isEdited=true;this._open()},_open:function(){this.createMarkNode=new Element("div",{styles:this.css.createMarkNode,events:{mouseover:function(e){e.stopPropagation()},mouseout:function(e){e.stopPropagation()}}}).inject(this.app.content,"after");this.createAreaNode=new Element("div",{styles:this.css.createAreaNode});this.createNode();this.createAreaNode.inject(this.createMarkNode,"after");this.createAreaNode.fade("in");this.personName.focus();this.setCreateNodeSize();this.setCreateNodeSizeFun=this.setCreateNodeSize.bind(this);this.addEvent("resize",this.setCreateNodeSizeFun)},createNode:function(){var e=this;this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.createAreaNode);this.createIconNode=new Element("div",{styles:this.isNew?this.css.createNewNode:this.css.createIconNode}).inject(this.createNode);this.createFormNode=new Element("div",{styles:this.css.createFormNode}).inject(this.createNode);var t=this.app.lp.permission;var i="width: 99%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC;height: 26px;";var s="width: 99%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC;height: 26px;"+"background : url(/x_component_Attendance/$PermissionExplorer/default/icon/selectperson.png) 98% center no-repeat";var n="<table width='100%' height='200' border='0' cellPadding='0' cellSpacing='0'>"+"<tr>"+"<td colspan='2' style='height: 50px; line-height: 50px; text-align: center; min-width: 80px; font-size:18px;font-weight: bold;'>"+t.setAttendancer+"</td>"+"</tr>"+"<tr>"+"<td style='height: 30px; line-height: 30px; text-align: left; min-width: 80px; width:25%'>"+t.role+":</td>"+"<td style='; text-align: left;' id='roleArea'></td>"+"</tr>"+"<tr id='departmentArea'>"+"<td style='height: 30px; line-height: 30px;  text-align: left' >"+t.department+":</td>"+"<td style='; text-align: right;'>"+(!this.isNew&&!this.isEdited?"":"<input type='text' id='department' "+"style='"+s+"'"+" value='"+(this.data&&this.data.department?this.data.department:"")+"'/>")+"</td>"+"</tr>"+"<tr>"+"<td style='height: 30px; line-height: 30px; text-align: left'>"+t.personName+":</td>"+"<td style='text-align: right;'>"+(!this.isNew&&!this.isEdited?"":"<input type='text' id='personName' "+"style='"+s+"'"+" value='"+(this.data&&this.data.personName?this.data.personName:"")+"'/>")+"</td>"+"</tr>"+"</table>";this.createFormNode.set("html",n);this.personName=this.createFormNode.getElement("#personName");this.department=this.createFormNode.getElement("#department");this.roleArea=this.createFormNode.getElement("#roleArea");this.role=new MDomItem(this.roleArea,{name:"role",type:"select",value:this.data.role||"DEPT",selectText:["公司管理员","部门管理员"],selectValue:["COMPANY","DEPT"],style:{"text-align":"left"}},true,this.app);this.role.load();this.personName.addEvent("click",function(){this.selecePerson()}.bind(this));this.department.addEvent("click",function(){this.selectDepartment(this.role.get("value"))}.bind(this));this.cancelActionNode=new Element("div",{styles:this.css.createCancelActionNode,text:this.app.lp.cancel}).inject(this.createFormNode);this.createOkActionNode=new Element("div",{styles:this.css.createOkActionNode,text:this.app.lp.ok}).inject(this.createFormNode);this.cancelActionNode.addEvent("click",function(e){this.cancelCreate(e)}.bind(this));this.createOkActionNode.addEvent("click",function(e){this.okCreate(e)}.bind(this))},setCreateNodeSize:function(e,t,i,s){if(!e)e=this.options&&this.options.width?this.options.width:"50%";if(!t)t=this.options&&this.options.height?this.options.height:"50%";if(!i)i=this.options&&this.options.top?this.options.top:0;if(!s)s=this.options&&this.options.left?this.options.left:0;var n=this.app.content.getSize();var a=n.x;var o=n.y;"string"==typeof e&&(1<e.length&&"%"==e.substr(e.length-1,1))&&(e=parseInt(a*parseInt(e,10)/100,10));"string"==typeof t&&(1<t.length&&"%"==t.substr(t.length-1,1))&&(t=parseInt(o*parseInt(t,10)/100,10));300>e&&(e=300);220>t&&(t=220);i=i||parseInt((o-t)/2,10);s=s||parseInt((a-e)/2,10);this.createAreaNode.setStyles({width:""+e+"px",height:""+t+"px",top:""+i+"px",left:""+s+"px"});this.createNode.setStyles({width:""+e+"px",height:""+t+"px"});var r=this.createIconNode?this.createIconNode.getSize():{x:0,y:0};var h=this.formTopNode?this.formTopNode.getSize():{x:0,y:0};var p=this.formBottomNode?this.formBottomNode.getSize():{x:0,y:0};var c=t-r.y-h.y-p.y;this.createFormNode.setStyles({height:""+c+"px"})},cancelCreate:function(e){var t=this;if(this.isNew&&this.personName.get("value")){this.app.confirm("warn",e,this.app.lp.create_cancel_title,this.app.lp.create_cancel,"320px","100px",function(){t.createMarkNode.destroy();t.createAreaNode.destroy();this.close()},function(){this.close()})}else{this.createMarkNode.destroy();this.createAreaNode.destroy();delete t}},okCreate:function(e){var t={id:this.data.id||null,organizationName:this.department.get("value"),adminName:this.personName.get("value"),adminLevel:this.role.getValue()};if(t.adminName){this.app.restActions.savePermission(t,function(e){if(e.type=="ERROR"){this.app.notice(e.message,"error")}else{this.createMarkNode.destroy();this.createAreaNode.destroy();if(this.explorer.view)this.explorer.view.reload();this.app.notice(this.isNew?this.app.lp.createSuccess:this.app.lp.updateSuccess,"success")}}.bind(this))}else{this.adminName.setStyle("border-color","red");this.adminName.focus();this.app.notice(this.app.lp.inputName,"error")}},selecePerson:function(){var e={type:"person",title:"设置管理员",count:"1",names:[this.data.personName]||[],onComplete:function(e){this.data.personName=[];e.each(function(e){this.data.personName.push(e.data.name)}.bind(this));this.personName.set("value",this.data.personName)}.bind(this)};var t=new MWF.OrgSelector(this.app.content,e)},selectDepartment:function(e){var t={type:e=="COMPANY"?"company":"department",title:e=="COMPANY"?"选择公司":"选择部门",count:"1",names:[this.data.department]||[],onComplete:function(e){this.data.department=[];e.each(function(e){this.data.department.push(e.data.name)}.bind(this));this.department.set("value",this.data.department)}.bind(this)};var i=new MWF.OrgSelector(this.app.content,t)}});