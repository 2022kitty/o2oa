MWF.xApplication.Attendance=MWF.xApplication.Attendance||{};MWF.require("MWF.xAction.org.express.RestActions",null,false);MWF.xDesktop.requireApp("Attendance","lp."+MWF.language,null,false);MWF.xDesktop.requireApp("Attendance","Common",null,false);MWF.xApplication.Attendance.DepartmentIndex=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},statusColor:{normal:"#9acd32",levelAsked:"#4f94cd",late:"#fede03",noSign:"#ee807f",lackOfTime:"#dec674",abNormalDuty:"#fedcbd"},initialize:function(t,e,i,s){this.setOptions(s);this.app=e;this.lp=e.lp;this.path="/x_component_Attendance/$DepartmentIndex/";this.cssPath="/x_component_Attendance/$DepartmentIndex/"+this.options.style+"/css.wcss";this._loadCss();this.actions=i;this.node=$(t);this.setDate();this.today=new Date;this.userName=layout.desktop.session.user.name;this.data={}},setDate:function(t){this.date=t||new Date;this.year=this.date.getFullYear().toString();var e=this.date.getMonth()+1;this.month=e.toString().length==2?e:"0"+e},reload:function(){this.node.empty();this.load()},load:function(){this.loadTitleNode();this.loadContent()},loadTitleNode:function(){var t=this.date.format(this.app.lp.dateFormatMonth);this.titleNode=new Element("div.titleNode",{styles:this.css.titleNode}).inject(this.node);this.titleLeftArrowNode=new Element("div",{styles:this.css.titleLeftArrowNode}).inject(this.titleNode);this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:t}).inject(this.titleNode);this.titleRightArrowNode=new Element("div",{styles:this.css.titleRightArrowNode}).inject(this.titleNode);this.titleLeftArrowNode.addEvents({mouseover:function(){this.titleLeftArrowNode.setStyles(this.css.titleLeftArrowNode_over)}.bind(this),mouseout:function(){this.titleLeftArrowNode.setStyles(this.css.titleLeftArrowNode)}.bind(this),mousedown:function(){this.titleLeftArrowNode.setStyles(this.css.titleLeftArrowNode_down)}.bind(this),mouseup:function(){this.titleLeftArrowNode.setStyles(this.css.titleLeftArrowNode_over)}.bind(this),click:function(){this.changeMonthPrev()}.bind(this)});this.titleRightArrowNode.addEvents({mouseover:function(){this.titleRightArrowNode.setStyles(this.css.titleRightArrowNode_over)}.bind(this),mouseout:function(){this.titleRightArrowNode.setStyles(this.css.titleRightArrowNode)}.bind(this),mousedown:function(){this.titleRightArrowNode.setStyles(this.css.titleRightArrowNode_down)}.bind(this),mouseup:function(){this.titleRightArrowNode.setStyles(this.css.titleRightArrowNode_over)}.bind(this),click:function(){this.changeMonthNext()}.bind(this)});this.titleTextNode.addEvents({mouseover:function(){this.titleTextNode.setStyles(this.css.titleTextNode_over)}.bind(this),mouseout:function(){this.titleTextNode.setStyles(this.css.titleTextNode)}.bind(this),mousedown:function(){this.titleTextNode.setStyles(this.css.titleTextNode_down)}.bind(this),mouseup:function(){this.titleTextNode.setStyles(this.css.titleTextNode_over)}.bind(this),click:function(){this.changeMonthSelect()}.bind(this)});this.loadDepartmentNode()},changeMonthPrev:function(){this.date.decrement("month",1);this.setDate(this.date);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",t);this.reloadContent()},changeMonthNext:function(){this.date.increment("month",1);this.setDate(this.date);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",t);this.reloadContent()},changeMonthSelect:function(){if(!this.monthSelector)this.createMonthSelector();this.monthSelector.show()},createMonthSelector:function(){this.monthSelector=new MWF.xApplication.Attendance.MonthSelector(this.date,this)},changeMonthTo:function(t){this.setDate(t);var e=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",e);this.reloadContent()},changeDepartmentTo:function(t){this.department=t;this.titleDepartmentActionTextNode.set("text",t);this.reloadContent()},loadDepartmentNode:function(){this.getDepartmentByPerson(function(t){this.department=t.name;this.departments=[];var e=true;if(this.app.isCompanyManager()){this.app.manageCompanys.each(function(t){this.actions.listDepartmentByCompany(function(t){t.data.each(function(t){this.departments.push(t.name)}.bind(this))}.bind(this),null,t,false)}.bind(this))}else if(this.app.isDepartmentManager()){this.departments=this.app.manageDepartments}this.department=this.departments[0]||this.department;if(this.departments.length>1){this.titleDepartmentAreaNode=new Element("div.titleDepartmentAreaNode",{styles:this.css.titleDepartmentAreaNode}).inject(this.titleNode);this.titleDepartmentActionNode=new Element("div",{styles:this.css.titleDepartmentActionNode}).inject(this.titleDepartmentAreaNode);this.titleDepartmentActionTextNode=new Element("div",{styles:this.css.titleDepartmentActionTextNode,text:this.department}).inject(this.titleDepartmentActionNode);this.titleDepartmentActionIconNode=new Element("div",{styles:this.css.titleDepartmentActionIconNode}).inject(this.titleDepartmentActionNode);this.titleDepartmentActionNode.addEvents({mouseover:function(){this.titleDepartmentActionTextNode.setStyles(this.css.titleDepartmentActionTextNode_over);this.titleDepartmentActionIconNode.setStyles(this.css.titleDepartmentActionIconNode_over)}.bind(this),mouseout:function(){this.titleDepartmentActionTextNode.setStyles(this.css.titleDepartmentActionTextNode);this.titleDepartmentActionIconNode.setStyles(this.css.titleDepartmentActionIconNode)}.bind(this),click:function(t){this.switchDepartment(t.target);t.stopPropagation()}.bind(this)})}else{this.titleDepartmentNode=new Element("div",{styles:this.css.titleDepartmentNode,text:this.department}).inject(this.titleNode)}}.bind(this))},getDepartmentByPerson:function(t){this.actions.listDepartmentByPerson(function(e){if(e.data.length>0){if(t)t(e.data[0])}else{if(t)t()}}.bind(this),null,this.userName,false)},switchDepartment:function(t){var e=this;var i=this.titleDepartmentListNode;var s=t.getParent();if(i){if(i.getStyle("display")=="block"){i.setStyle("display","none")}else{i.setStyle("display","block");i.position({relativeTo:this.titleDepartmentActionNode,position:"bottomCenter",edge:"upperCenter"})}}else{i=this.titleDepartmentListNode=new Element("div",{styles:this.css.titleDepartmentListNode}).inject(this.node);this.app.content.addEvent("click",function(){e.titleDepartmentListNode.setStyle("display","none")});this.departments.each(function(t){var s=new Element("div",{text:t,styles:this.css.titleDepartmentSelectNode}).inject(i);s.store("department",t);s.addEvents({mouseover:function(){this.setStyles(e.css.titleDepartmentSelectNode_over)},mouseout:function(){this.setStyles(e.css.titleDepartmentSelectNode)},click:function(t){e.titleDepartmentListNode.setStyle("display","none");this.setStyles(e.css.titleDepartmentSelectNode);e.changeDepartmentTo(this.retrieve("department"));t.stopPropagation()}})}.bind(this));i.position({relativeTo:this.titleDepartmentActionNode,position:"bottomCenter",edge:"upperCenter"})}},reloadContent:function(){this.pieChartArea.empty();this.barChartArea.empty();this.lineChartArea.empty();this.loadData(function(){this.loadStatusColorNode();this.loadPieChart();this.loadBarChart()}.bind(this));this.loadDetail()},loadContent:function(){this.loadContentNode();this.loadData(function(){this.loadStatusColorNode();this.loadPieChart();this.loadBarChart()}.bind(this));this.loadDetail();this.setNodeScroll();this.setContentSize()},reloadChart:function(){this.pieChartArea.empty();this.barChartArea.empty();this.lineChartArea.empty();this.loadPieChart();this.loadBarChart()},loadContentNode:function(){this.elementContentNode=new Element("div.elementContentNode",{styles:this.css.elementContentNode}).inject(this.node);this.app.addEvent("resize",function(){this.setContentSize();this.reloadChart()}.bind(this));this.elementContentListNode=new Element("div.elementContentListNode",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);this.topContentArea=new Element("div.topContentArea",{styles:this.css.topContentArea}).inject(this.elementContentListNode);this.pieChartArea=new Element("div.pieChartArea",{styles:this.css.pieChartArea}).inject(this.topContentArea);this.statusColorArea=new Element("div.statusColorArea",{styles:this.css.statusColorArea}).inject(this.topContentArea);this.barChartArea=new Element("div.barChartArea",{styles:this.css.barChartArea}).inject(this.topContentArea);this.middleContentArea=new Element("div.middleContentArea",{styles:this.css.middleContentArea}).inject(this.elementContentListNode);this.lineChartArea=new Element("div.lineChartArea",{styles:this.css.lineChartArea}).inject(this.middleContentArea);this.bottomContentArea=new Element("div.middleContentArea",{styles:this.css.bottomContentArea}).inject(this.elementContentListNode);this.detailArea=new Element("div.lineChartArea",{styles:this.css.detailArea}).inject(this.bottomContentArea)},loadData:function(t,e,i,s,n){if(!e)e=this.department;if(!i)i=this.year;if(!s)s=this.month;if(this.data[e+i+s]){if(t)t()}else{this.actions.listStaticMonthDepartmentSum(e,i,s,function(n){var a=n.data||{};var o=this.data[e+i+s]={};var l=o.totalData={levelAsked:a.onSelfHolidayCount||0,noSign:a.absenceDayCount||0,lackOfTime:a.lackOfTimeCount||0,abNormalDuty:a.abNormalDutyCount||0,late:a.lateCount?a.lateCount:0,normal:a.onDutyEmployeeCount||0};var h=0;for(var r in l){h+=l[r]}o.rateData={levelAsked:!l.levelAsked||!h?0:(l.levelAsked/h*100).toFixed(2)+"%",noSign:!l.noSign||!h?0:(l.noSign/h*100).toFixed(2)+"%",lackOfTime:!l.lackOfTime||!h?0:(l.lackOfTime/h*100).toFixed(2)+"%",abNormalDuty:!l.abNormalDuty||!h?0:(l.abNormalDuty/h*100).toFixed(2)+"%",late:!l.late||!h?0:(l.late/h*100).toFixed(2)+"%",normal:!l.normal||!h?0:(l.normal/h*100).toFixed(2)+"%"};if(t)t()}.bind(this),null,n)}},loadStatusColorNode:function(){this.statusColorArea.empty();this.statusColorTable=new Element("table",{styles:this.css.statusColorTable}).inject(this.statusColorArea);var t=this.data[this.department+this.year+this.month].totalData;var e=this.data[this.department+this.year+this.month].rateData;for(var i in this.statusColor){var s=new Element("tr",{styles:this.css.statusColorTr}).inject(this.statusColorTable);var n=new Element("td",{styles:this.css.statusColorTd}).inject(s);n.setStyle("background-color",this.statusColor[i]);var s=new Element("tr",{styles:this.css.statusTextTr}).inject(this.statusColorTable);var n=new Element("td",{styles:this.css.statusTextTd,text:this.lp[i]+t[i]+this.lp.day+"("+e[i]+")"}).inject(s)}},loadPieChart:function(){this.pieChartNode=new Element("div.pieChartNode",{styles:this.css.pieChartNode}).inject(this.pieChartArea);var t=this.data[this.department+this.year+this.month].totalData;this.pieChart=new MWF.xApplication.Attendance.Echarts(this.pieChartNode,this,t);this.pieChart.loadDepartmentPieChart()},loadBarChart:function(){this.barChartNode=new Element("div.barChartNode",{styles:this.css.barChartNode}).inject(this.barChartArea);var t=new Date(this.date.getFullYear(),this.date.getMonth(),this.date.getDate());t.decrement("month",1);var e=t.getFullYear().toString();var i=t.format(this.lp.dateFormatOnlyMonth);var s=this.data[this.department+e+i];t.decrement("month",1);var n=t.getFullYear().toString();var a=t.format(this.lp.dateFormatOnlyMonth);var o=this.data[this.department+n+a];if(!s){this.loadData(null,this.department,e,i,false)}if(!o){this.loadData(null,this.department,n,a,false)}var l=[{year:n,month:a,data:this.data[this.department+n+a].totalData},{year:e,month:i,data:this.data[this.department+e+i].totalData},{year:this.year,month:this.month,data:this.data[this.department+this.year+this.month].totalData}];this.barChart=new MWF.xApplication.Attendance.Echarts(this.barChartNode,this,l);this.barChart.loadDepartmentBarChart()},loadDetail:function(){this.detailArea.empty();this.detailNode=new Element("div",{styles:this.css.detailNode}).inject(this.detailArea);this.detailTitleNode=new Element("div",{styles:this.css.detailTitleNode,text:this.lp.attendanceStatisic}).inject(this.detailNode);var t=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.table,class:"editTable"}).inject(this.detailNode);var e=new Element("tr",{styles:this.css.listHeadNode}).inject(t);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.name}).inject(e);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.onDutyTimes}).inject(e);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.offDutyTimes}).inject(e);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.onDutyDayCount}).inject(e);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.onSelfHolidayCount}).inject(e);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.absenceDayCount}).inject(e);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.lateTimes}).inject(e);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.lackOfTimeCount}).inject(e);var i=new Element("td",{styles:this.css.tableTitle,text:this.lp.abNormalDutyCount}).inject(e);this.actions.listStaticMonthPersonByDepartmentNested(this.department,this.year,this.month,function(e){var i=e.data||[];i.sort(function(t,e){return e.onDutyDayCount-t.onDutyDayCount});i.each(function(e){var i=new Element("tr").inject(t);var s=new Element("td",{styles:this.css.tableValue,text:e.employeeName}).inject(i);var s=new Element("td",{styles:this.css.tableValue,text:e.onDutyTimes}).inject(i);var s=new Element("td",{styles:this.css.tableValue,text:e.offDutyTimes}).inject(i);var s=new Element("td",{styles:this.css.tableValue,text:e.onDutyDayCount}).inject(i);var s=new Element("td",{styles:this.css.tableValue,text:e.onSelfHolidayCount}).inject(i);var s=new Element("td",{styles:this.css.tableValue,text:e.absenceDayCount}).inject(i);var s=new Element("td",{styles:this.css.tableValue,text:e.lateTimes}).inject(i);var s=new Element("td",{styles:this.css.tableValue,text:e.lackOfTimeCount}).inject(i);var s=new Element("td",{styles:this.css.tableValue,text:e.abNormalDutyCount}).inject(i)}.bind(this))}.bind(this))},listDetailFilterUser:function(t,e,i,s){var n={};if(e)n.q_empName=e;if(i)n.q_year=i;if(s)n.q_month=s.toString().length==2?s:"0"+s;this.actions.listDetailFilterUser(n,function(e){if(t)t(e.data)}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0};var e=this.titleNode?this.titleNode.getSize():{x:0,y:0};var i=this.node.getSize();var s=this.elementContentNode.getStyle("padding-top").toFloat();var n=this.elementContentNode.getStyle("padding-bottom").toFloat();var a=this.filterConditionNode?this.filterConditionNode.getSize():{x:0,y:0};var o=i.y-t.y-s-n-a.y-e.y-10;this.elementContentNode.setStyle("height",""+o+"px")},setNodeScroll:function(){var t=this;MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.elementContentNode,{indent:false,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:false,y:true},onScroll:function(t){}})}.bind(this))}});