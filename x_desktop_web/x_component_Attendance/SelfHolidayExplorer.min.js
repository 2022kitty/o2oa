MWF.xDesktop.requireApp("Attendance","Explorer",null,false);MWF.xDesktop.requireApp("Organization","Selector.package",null,false);MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.xApplication.Attendance.SelfHolidayExplorer=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(e,t,i,s){this.setOptions(s);this.app=t;this.path="/x_component_Attendance/$SelfHolidayExplorer/";this.cssPath="/x_component_Attendance/$SelfHolidayExplorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=i;this.node=$(e);this.initData();if(!this.personActions)this.personActions=new MWF.xAction.org.express.RestActions},load:function(){this.loadToolbar();this.loadFilter();this.loadContentNode();this.loadView();this.setNodeScroll()},loadFilter:function(){this.fileterNode=new Element("div.fileterNode",{styles:this.css.fileterNode}).inject(this.node);this._loadFilterContent()},exportExcel:function(){var e=new MWF.xApplication.Attendance.SelfHolidayExplorer.ExportExcelForm(this);e.edit()},_loadFilterContent:function(){var e=this;var t="<table bordr='0' cellpadding='5' cellspacing='0' styles='formTable' width='950'>"+"<tr>"+"    <td styles='formTableTitle' lable='q_companyName'></td>"+"    <td styles='formTableValue' item='q_companyName'></td>"+"    <td styles='formTableTitle' lable='q_departmentName'></td>"+"    <td styles='formTableValue' item='q_departmentName'></td>"+"    <td styles='formTableTitle' lable='q_empName'></td>"+"    <td styles='formTableValue' item='q_empName'></td>"+"    <td styles='formTableValue' item='action'></td>"+"</tr>"+"</table>";this.fileterNode.set("html",t);MWF.xDesktop.requireApp("Template","MForm",function(){this.filter=new MForm(this.fileterNode,{},{style:"filter",isEdited:true,itemTemplate:{q_companyName:{text:"选择公司",tType:"company"},q_departmentName:{text:"选择部门",tType:"department"},q_empName:{text:"选择人员",tType:"person"},action:{type:"button",value:"查询",event:{click:function(){var t=e.filter.getResult(true,",",true,true,true);this.loadView(t)}.bind(this)}}}},this.app,this.css);this.filter.load()}.bind(this),true)},loadView:function(e){this.elementContentNode.empty();this.view=new MWF.xApplication.Attendance.SelfHolidayExplorer.View(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey);this.view.filterData=e;this.view.load();this.setContentSize()},createDocument:function(){if(this.view)this.view._createDocument()}});MWF.xApplication.Attendance.SelfHolidayExplorer.View=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(e){return new MWF.xApplication.Attendance.SelfHolidayExplorer.Document(this.table,e,this.explorer,this)},_getCurrentPageData:function(e,t){if(!t)t=20;var i=this.items.length?this.items[this.items.length-1].data.id:"(0)";var s=this.filterData||{};this.actions.listSelfHolidayFilterNext(i,t,s,function(t){if(e)e(t)})},_removeDocument:function(e,t){this.actions.deleteSelfHoliday(e.id,function(e){this.explorer.view.reload();this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_createDocument:function(){var e=new MWF.xApplication.Attendance.SelfHolidayExplorer.SelfHoliday(this.explorer);e.create()},_openDocument:function(e){var t=new MWF.xApplication.Attendance.SelfHolidayExplorer.SelfHoliday(this.explorer,e);t.open()}});MWF.xApplication.Attendance.SelfHolidayExplorer.Document=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document});MWF.xApplication.Attendance.SelfHolidayExplorer.ExportExcelForm=new Class({Extends:MWF.xApplication.Attendance.Explorer.PopupForm,_createTableContent:function(){var e="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr><td colspan='2' styles='formTableHead'>导出员工休假记录</td></tr>"+"<tr>"+"    <td styles='formTableTitle' lable='startDate'></td>"+"    <td styles='formTableValue' item='startDate'></td>"+"</tr>"+"<tr>"+"    <td styles='formTableTitle' lable='endDate'></td>"+"    <td styles='formTableValue' item='endDate'></td>"+"</tr>"+"</table>";this.formTableArea.set("html",e);MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,{q_empName:layout.desktop.session.user.name},{isEdited:true,itemTemplate:{startDate:{text:"开始日期",tType:"date"},endDate:{text:"结束日期",tType:"date"}}},this.app);this.form.load()}.bind(this),true)},_ok:function(e,t){this.app.restActions.exportSelfHoliday(e.startDate,e.endDate,function(e){if(t)t(e)}.bind(this));this.close()}});MWF.xApplication.Attendance.SelfHolidayExplorer.SelfHoliday=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{width:"500",height:"400"},initialize:function(e,t){this.explorer=e;this.app=e.app;this.data=t||{};this.css=this.explorer.css;this.load()},load:function(){},open:function(){this.isNew=false;this.isEdited=false;this._open()},create:function(){this.isNew=true;this._open()},edit:function(){this.isEdited=true;this._open()},_open:function(){this.createMarkNode=new Element("div",{styles:this.css.createMarkNode,events:{mouseover:function(e){e.stopPropagation()},mouseout:function(e){e.stopPropagation()}}}).inject(this.app.content,"after");this.createAreaNode=new Element("div",{styles:this.css.createAreaNode});this.createNode();this.createAreaNode.inject(this.createMarkNode,"after");this.createAreaNode.fade("in");this.setCreateNodeSize();this.setCreateNodeSizeFun=this.setCreateNodeSize.bind(this);this.addEvent("resize",this.setCreateNodeSizeFun)},createNode:function(){var e=this;var t=this.data;this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.createAreaNode);this.createIconNode=new Element("div",{styles:this.isNew?this.css.createNewNode:this.css.createIconNode}).inject(this.createNode);this.createFormNode=new Element("div",{styles:this.css.createFormNode}).inject(this.createNode);var i=new Element("table",{width:"100%",border:"0",cellpadding:"0",cellspacing:"0"}).inject(this.createFormNode);var s=new Element("tr").inject(i);var a=new Element("td",{colspan:"2",styles:this.css.editTableHead,text:"员工休假记录"}).inject(s);var s=new Element("tr").inject(i);var a=new Element("td",{styles:this.css.editTableTitle,text:"部门："}).inject(s);var a=new Element("td",{styles:this.css.editTableValue}).inject(s);if(!this.isNew&&!this.isEdited){a.set("text",t.organizationName)}else{this.organizationName=new MDomItem(a,{name:"organizationName",value:t.organizationName,style:this.css.inputPersonStyle,event:{click:function(t){e.selectPeople(this,"department",t.get("value").split(","))}}},true,this.app);this.organizationName.load()}var s=new Element("tr").inject(i);var a=new Element("td",{styles:this.css.editTableTitle,text:"员工姓名："}).inject(s);var a=new Element("td",{styles:this.css.editTableValue}).inject(s);if(!this.isNew&&!this.isEdited){a.set("text",t.employeeName)}else{this.employeeName=new MDomItem(a,{name:"employeeName",value:t.employeeName,style:this.css.inputPersonStyle,event:{click:function(t){e.selectPeople(this,"person",t.get("value").split(","))}}},true,this.app);this.employeeName.load()}var s=new Element("tr").inject(i);var a=new Element("td",{styles:this.css.editTableTitle,text:"休假类型："}).inject(s);var a=new Element("td",{styles:this.css.editTableValue}).inject(s);if(!this.isNew&&!this.isEdited){a.set("text",t.leaveType)}else{this.leaveType=new MDomItem(a,{name:"leaveType",type:"select",value:t.leaveType,selectValue:"带薪年休假,带薪病假,带薪福利假,扣薪事假,其他".split(",")},true,this.app);this.leaveType.load()}var s=new Element("tr").inject(i);var a=new Element("td",{styles:this.css.editTableTitle,text:"开始时间："}).inject(s);var a=new Element("td",{styles:this.css.editTableValue}).inject(s);if(!this.isNew&&!this.isEdited){a.set("text",t.startTime)}else{this.startTime=new MDomItem(a,{name:"startTime",value:t.startTime,style:this.css.inputTimeStyle,event:{click:function(t){e.selectDateTime(this,false,true)}}},true,this.app);this.startTime.load()}var s=new Element("tr").inject(i);var a=new Element("td",{styles:this.css.editTableTitle,text:"结束时间："}).inject(s);var a=new Element("td",{styles:this.css.editTableValue}).inject(s);if(!this.isNew&&!this.isEdited){a.set("text",t.endTime)}else{this.endTime=new MDomItem(a,{name:"endTime",value:t.endTime,style:this.css.inputTimeStyle,event:{click:function(t){e.selectDateTime(this,false,true)}}},true,this.app);this.endTime.load()}var s=new Element("tr").inject(i);var a=new Element("td",{styles:this.css.editTableTitle,text:"休假天数："}).inject(s);var a=new Element("td",{styles:this.css.editTableValue}).inject(s);if(!this.isNew&&!this.isEdited){a.set("text",t.leaveDayNumber)}else{this.leaveDayNumber=new MDomItem(a,{name:"leaveDayNumber",value:t.leaveDayNumber,style:this.css.inputStyle,event:{keyup:function(){this.value=this.value.replace(/[^\d.]/g,"")}}},true,this.app);this.leaveDayNumber.load()}if(this.isNew||this.isEdited){this.createOkActionNode=new Element("div",{styles:this.css.createOkActionNode,text:this.app.lp.ok}).inject(this.createFormNode);this.createOkActionNode.addEvent("click",function(e){this.okCreate(e)}.bind(this))}this.cancelActionNode=new Element("div",{styles:this.css.createCancelActionNode,text:this.app.lp.cancel}).inject(this.createFormNode);this.cancelActionNode.addEvent("click",function(e){this.cancelCreate(e)}.bind(this))},setCreateNodeSize:function(e,t,i,s){if(!e)e=this.options&&this.options.width?this.options.width:"50%";if(!t)t=this.options&&this.options.height?this.options.height:"50%";if(!i)i=this.options&&this.options.top?this.options.top:0;if(!s)s=this.options&&this.options.left?this.options.left:0;var a=this.app.content.getSize();var n=a.x;var l=a.y;"string"==typeof e&&(1<e.length&&"%"==e.substr(e.length-1,1))&&(e=parseInt(n*parseInt(e,10)/100,10));"string"==typeof t&&(1<t.length&&"%"==t.substr(t.length-1,1))&&(t=parseInt(l*parseInt(t,10)/100,10));300>e&&(e=300);220>t&&(t=220);i=i||parseInt((l-t)/2,10);s=s||parseInt((n-e)/2,10);this.createAreaNode.setStyles({width:""+e+"px",height:""+t+"px",top:""+i+"px",left:""+s+"px"});this.createNode.setStyles({width:""+e+"px",height:""+t+"px"});var o=this.createIconNode?this.createIconNode.getSize():{x:0,y:0};var r=this.formTopNode?this.formTopNode.getSize():{x:0,y:0};var c=this.formBottomNode?this.formBottomNode.getSize():{x:0,y:0};var d=t-o.y-r.y-c.y;this.createFormNode.setStyles({height:""+d+"px"})},cancelCreate:function(e){var t=this;if(this.organizationName)var i=this.organizationName.get("value");if(this.isNew&&i!=""&&i!="default"){this.app.confirm("warn",e,this.app.lp.create_cancel_title,this.app.lp.create_cancel,"320px","100px",function(){t.createMarkNode.destroy();t.createAreaNode.destroy();this.close()},function(){this.close()})}else{this.createMarkNode.destroy();this.createAreaNode.destroy();delete t}},okCreate:function(e){var t={id:this.data&&this.data.id?this.data.id:null,organizationName:this.organizationName.get("value"),employeeName:this.employeeName.get("value"),leaveType:this.leaveType.get("value"),startTime:this.startTime.get("value"),endTime:this.endTime.get("value"),leaveDayNumber:this.leaveDayNumber.get("value")};if(t.organizationName&&t.employeeName&&t.leaveType&&t.startTime&&t.endTime&&t.leaveDayNumber){this.app.restActions.saveSelfHoliday(t,function(e){if(e.type=="ERROR"){this.app.notice(e.userMessage,"error")}else{this.createMarkNode.destroy();this.createAreaNode.destroy();if(this.explorer.view)this.explorer.view.reload();this.app.notice(this.isNew?this.app.lp.createSuccess:this.app.lp.updateSuccess,"success")}}.bind(this))}else{this.app.notice(this.app.lp.selfHoliday.inputVaild,"error")}},selectDateTime:function(e,t,i){MWF.require("MWF.widget.Calendar",function(){var s=new MWF.widget.Calendar(e,{style:"xform",timeOnly:t,isTime:i,target:this.app.content});s.show()}.bind(this))},selectPeople:function(e,t,i){var s;if(t=="department"){s="选择部门"}else if(t=="company"){s="选择公司"}else{s="选择个人"}var a={type:t,title:s,count:"1",names:i||[],onComplete:function(t){var i=[];t.each(function(e){i.push(e.data.name)}.bind(this));e.set("value",i.join(","))}.bind(this)};var n=new MWF.OrgSelector(this.app.content,a)}});