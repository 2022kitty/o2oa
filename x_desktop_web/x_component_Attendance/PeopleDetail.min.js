MWF.xDesktop.requireApp("Attendance","Explorer",null,false);MWF.xDesktop.requireApp("Organization","Selector.package",null,false);MWF.xApplication.Attendance.PeopleDetail=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(e,t,i,n){this.setOptions(n);this.app=t;this.path="/x_component_Attendance/$PeopleDetail/";this.cssPath="/x_component_Attendance/$PeopleDetail/"+this.options.style+"/css.wcss";this._loadCss();this.actions=i;this.node=$(e)},load:function(){this.loadTab()},loadTab:function(){this.tabNode=new Element("div",{styles:this.css.tabNode}).inject(this.node);this.detailArea=new Element("div",{styles:this.css.tabPageContainer}).inject(this.tabNode);this.detailStaticArea=new Element("div",{styles:this.css.tabPageContainer}).inject(this.tabNode);MWF.require("MWF.widget.Tab",function(){this.tabs=new MWF.widget.Tab(this.tabNode,{style:"attendance"});this.tabs.load();this.detailPage=this.tabs.addTab(this.detailArea,"个人出勤明细",false);this.detailPage.contentNodeArea.set("class","detailPage");this.detailPage.addEvent("show",function(){if(!this.detailExplorer){this.detailExplorer=new MWF.xApplication.Attendance.PeopleDetail.Explorer(this.detailArea,this);this.detailExplorer.load()}}.bind(this));this.detailStaticPage=this.tabs.addTab(this.detailStaticArea,"个人出勤率统计",false);this.detailStaticPage.contentNodeArea.set("class","detailStaticPage");this.detailStaticPage.addEvent("show",function(){if(!this.detailStaticExplorer){this.detailStaticExplorer=new MWF.xApplication.Attendance.PeopleDetail.DetailStaticExplorer(this.detailStaticArea,this);this.detailStaticExplorer.load()}}.bind(this));this.tabs.pages[0].showTab()}.bind(this))}});MWF.xApplication.Attendance.PeopleDetail.Explorer=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(e,t,i){this.setOptions(i);this.parent=t;this.app=t.app;this.css=t.css;this.path=t.path;this.actions=t.actions;this.node=$(e);this.initData();if(!this.peopleActions)this.peopleActions=new MWF.xAction.org.express.RestActions},initData:function(){this.toolItemNodes=[]},reload:function(){this.node.empty();this.load()},load:function(){this.loadFilter();this.loadContentNode();this.setNodeScroll()},loadFilter:function(){this.fileterNode=new Element("div.fileterNode",{styles:this.css.fileterNode}).inject(this.node);var e=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.filterTable,class:"filterTable"}).inject(this.fileterNode);e.setStyle("width","1000px");var t=new Element("tr").inject(e);this.createPersonTd(t);this.createYearSelectTd(t);this.createMonthSelectTd(t);this.createDateSelectTd(t);this.createIsAbsent(t);this.createIsLate(t);this.createLackOfTimeCount(t);this.createActionTd(t)},createPersonTd:function(e){var t=this;var i=new Element("td",{styles:this.css.filterTableTitle,text:"人员"}).inject(e);var i=new Element("td",{styles:this.css.filterTableValue}).inject(e);this.q_empName=new MDomItem(i,{name:"q_empName",event:{click:function(e){t.selecePerson()}}},true,this.app);this.q_empName.load()},createYearSelectTd:function(e){var t=this;var i=new Element("td",{styles:this.css.filterTableTitle,text:"年度"}).inject(e);var i=new Element("td",{styles:this.css.filterTableValue}).inject(e);this.cycleYear=new MDomItem(i,{name:"cycleYear",type:"select",selectValue:function(){var e=[];var t=(new Date).getFullYear();for(var i=0;i<6;i++){e.push(t--)}return e},event:{change:function(){if(t.dateSelecterTd)t.createDateSelectTd()}}},true,this.app);this.cycleYear.load()},createMonthSelectTd:function(e){var t=this;var i=new Element("td",{styles:this.css.filterTableTitle,text:"月份"}).inject(e);var i=new Element("td",{styles:this.css.filterTableValue}).inject(e);this.cycleMonth=new MDomItem(i,{name:"cycleMonth",type:"select",defaultValue:function(){var e=((new Date).getMonth()+1).toString();return e.length==1?"0"+e:e},selectValue:["","01","02","03","04","05","06","07","08","09","10","11","12"],event:{change:function(){if(t.dateSelecterTd)t.createDateSelectTd()}}},true,this.app);this.cycleMonth.load()},createDateSelectTd:function(e){var t=this;if(e){var i=new Element("td",{styles:this.css.filterTableTitle,text:"日期"}).inject(e);this.dateSelecterTd=new Element("td",{styles:this.css.filterTableValue}).inject(e)}if(this.q_date){this.dateSelecterTd.empty()}this.q_date=new MDomItem(this.dateSelecterTd,{name:"q_date",type:"select",selectValue:function(){var e=parseInt(t.cycleYear.getValue());var i=parseInt(t.cycleMonth.getValue())-1;var n=new Date(e,i,1);var a=[];a.push("");while(n.getMonth()===i){var s=n.getDate().toString();if(s.length==1)s="0"+s;a.push(s);n.setDate(n.getDate()+1)}return a}},true,this.app);this.q_date.load()},createIsAbsent:function(e){var t=new Element("td",{styles:this.css.filterTableTitle,text:"缺勤"}).inject(e);var t=new Element("td",{styles:this.css.filterTableValue}).inject(e);this.isAbsent=new MDomItem(t,{name:"isAbsent",type:"select",selectValue:["","true","false"],selectText:["","缺勤","未缺勤"]},true,this.app);this.isAbsent.load()},createLackOfTimeCount:function(e){var t=new Element("td",{styles:this.css.filterTableTitle,text:"工时不足"}).inject(e);var t=new Element("td",{styles:this.css.filterTableValue}).inject(e);this.isLackOfTime=new MDomItem(t,{name:"isLackOfTime",type:"select",selectValue:["","true","false"],selectText:["","是","否"]},true,this.app);this.isLackOfTime.load()},createIsLate:function(e){var t=new Element("td",{styles:this.css.filterTableTitle,text:"迟到"}).inject(e);var t=new Element("td",{styles:this.css.filterTableValue}).inject(e);this.isLate=new MDomItem(t,{name:"isLate",type:"select",selectValue:["","true","false"],selectText:["","迟到","未迟到"]},true,this.app);this.isLate.load()},createActionTd:function(e){var t=new Element("td",{styles:this.css.filterTableValue}).inject(e);var i=new Element("button",{text:"查询",styles:this.css.filterButton}).inject(t);i.addEvent("click",function(){if(this.q_empName.getValue().trim()==""){this.app.notice("请先选择员工","error");return}var e={q_empName:this.q_empName.getValue(),cycleYear:this.cycleYear.getValue(),cycleMonth:this.cycleMonth.getValue()};if(this.isAbsent&&this.isAbsent.getValue()!=""){e.isAbsent=this.getBoolean(this.isAbsent.getValue())}if(this.isLeaveEarlier&&this.isLeaveEarlier.getValue()!=""){e.isLeaveEarlier=this.getBoolean(this.isLeaveEarlier.getValue())}if(this.isLate&&this.isLate.getValue()!=""){e.isLate=this.getBoolean(this.isLate.getValue())}if(this.isLackOfTime&&this.isLackOfTime.getValue()!=""){e.isLackOfTime=this.getBoolean(this.isLackOfTime.getValue())}if(this.q_date&&this.q_date.getValue()!=""){e.q_date=this.cycleYear.getValue()+"-"+this.cycleMonth.getValue()+"-"+this.q_date.getValue()}this.loadView(e)}.bind(this))},getBoolean:function(e){if(e==="true")return true;if(e==="false")return false;return e},selecePerson:function(){var e={type:"person",title:"选择人员",count:"1",onComplete:function(e){var t=[];e.each(function(e){t.push(e.data.name)}.bind(this));this.q_empName.setValue(t.join(","))}.bind(this)};if(!this.app.isAdmin()&&this.app.isDepartmentManager()){e.departments=this.app.manageDepartments}var t=new MWF.OrgSelector(this.app.content,e)},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node);this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},loadView:function(e){this.elementContentNode.empty();if(this.view)delete this.view;this.view=new MWF.xApplication.Attendance.PeopleDetail.View(this.elementContentNode,this.app,this);this.view.filterData=e;this.view.load();this.setContentSize()},setContentSize:function(){var e=this.parent.tabs?this.parent.tabs.tabNodeContainer.getSize():{x:0,y:0};var t=this.fileterNode?this.fileterNode.getSize():{x:0,y:0};var i=this.parent.node.getSize();var n=this.elementContentNode.getStyle("padding-top").toFloat();var a=this.elementContentNode.getStyle("padding-bottom").toFloat();var s=i.y-e.y-n-a-t.y-20;this.elementContentNode.setStyle("height",""+s+"px");this.pageCount=(s/40).toInt()+5;if(this.view&&this.view.items.length<this.pageCount){this.view.loadElementList(this.pageCount-this.view.items.length)}}});MWF.xApplication.Attendance.PeopleDetail.SelfHolidayExplorer=new Class({Extends:MWF.xApplication.Attendance.PeopleDetail.Explorer,loadView:function(e){this.elementContentNode.empty();if(this.view)delete this.view;this.view=new MWF.xApplication.Attendance.PeopleDetail.SelfHolidayView(this.elementContentNode,this.app,this);this.view.filterData=e;this.view.load();this.setContentSize()}});MWF.xApplication.Attendance.PeopleDetail.DetailStaticExplorer=new Class({Extends:MWF.xApplication.Attendance.PeopleDetail.Explorer,loadFilter:function(){this.fileterNode=new Element("div.fileterNode",{styles:this.css.fileterNode}).inject(this.node);var e=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.filterTable,class:"filterTable"}).inject(this.fileterNode);e.setStyle("width","460px");var t=new Element("tr").inject(e);this.createPersonTd(t);this.createYearSelectTd(t);this.createMonthSelectTd(t);this.createActionTd(t)},createMonthSelectTd:function(e){var t=this;var i=new Element("td",{styles:this.css.filterTableTitle,text:"月份"}).inject(e);var i=new Element("td",{styles:this.css.filterTableValue}).inject(e);this.cycleMonth=new MDomItem(i,{name:"cycleMonth",type:"select",selectValue:["","01","02","03","04","05","06","07","08","09","10","11","12"],event:{change:function(){if(t.dateSelecterTd)t.createDateSelectTd()}}},true,this.app);this.cycleMonth.load()},createActionTd:function(e){var t=new Element("td",{styles:this.css.filterTableValue}).inject(e);var i=new Element("button",{text:"查询",styles:this.css.filterButton}).inject(t);i.addEvent("click",function(){if(this.q_empName.getValue().trim()==""){this.app.notice("请先选择员工","error");return}var e={q_empName:this.q_empName.getValue(),cycleYear:this.cycleYear.getValue(),cycleMonth:this.cycleMonth.getValue()};if(this.isAbsent&&this.isAbsent.getValue()!=""){e.isAbsent=this.isAbsent.getValue()}if(this.isLeaveEarlier&&this.isLeaveEarlier.getValue()!=""){e.isLeaveEarlier=this.isLeaveEarlier.getValue()}if(this.isLate&&this.isLate.getValue()!=""){e.isLate=this.isLate.getValue()}if(this.q_date&&this.q_date.getValue()!=""){e.q_date=this.cycleYear.getValue()+"-"+this.cycleMonth.getValue()+"-"+this.q_date.getValue()}this.loadView(e)}.bind(this))},loadView:function(e){this.elementContentNode.empty();if(this.view)delete this.view;this.view=new MWF.xApplication.Attendance.PeopleDetail.DetailStaticView(this.elementContentNode,this.app,this);this.view.filterData=e;this.view.listItemUrl=this.path+"listItem_detailStatic.json";this.view.load();this.setContentSize()}});MWF.xApplication.Attendance.PeopleDetail.SelfHolidayStaticExplorer=new Class({Extends:MWF.xApplication.Attendance.PeopleDetail.Explorer,loadView:function(e){this.elementContentNode.empty();if(this.view)delete this.view;this.view=new MWF.xApplication.Attendance.PeopleDetail.SelfHolidayStaticView(this.elementContentNode,this.app,this);this.view.filterData=e;this.view.load();this.setContentSize()}});MWF.xApplication.Attendance.PeopleDetail.View=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(e){return new MWF.xApplication.Attendance.PeopleDetail.Document(this.table,e,this.explorer,this)},_getCurrentPageData:function(e,t){if(!t)t=20;var i=this.items.length?this.items[this.items.length-1].data.id:"(0)";var n=this.filterData||{};n.key=this.sortField||this.sortFieldDefault||"";n.order=this.sortType||this.sortTypeDefault||"";this.actions.listDetailFilterNext(i,t,n,function(t){if(e)e(t)}.bind(this))},_removeDocument:function(e,t){},_createDocument:function(){},_openDocument:function(e){}});MWF.xApplication.Attendance.PeopleDetail.SelfHolidayView=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(e){return new MWF.xApplication.Attendance.PeopleDetail.SelfHolidayDocument(this.table,e,this.explorer,this)},_getCurrentPageData:function(e,t){var i=this.filterData||{};this.actions.listDetailFilter(i,function(t){if(e)e(t)}.bind(this))},_removeDocument:function(e,t){},_createDocument:function(){},_openDocument:function(e){}});MWF.xApplication.Attendance.PeopleDetail.DetailStaticView=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(e){return new MWF.xApplication.Attendance.PeopleDetail.DetailStaticDocument(this.table,e,this.explorer,this)},_getCurrentPageData:function(e,t){var i=this.filterData||{};if(i.cycleMonth=="")i.cycleMonth="(0)";this.actions.listStaticMonthPerson(i.q_empName,i.cycleYear,i.cycleMonth,function(t){var i=t.data;i.sort(function(e,t){return parseInt(t.statisticYear+t.statisticMonth)-parseInt(e.statisticYear+e.statisticMonth)});t.data=i;if(e)e(t)}.bind(this))},_removeDocument:function(e,t){},_createDocument:function(){},_openDocument:function(e){}});MWF.xApplication.Attendance.PeopleDetail.SelfHolidayStaticView=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(e){return new MWF.xApplication.Attendance.PeopleDetail.SelfHolidayStaticDocument(this.table,e,this.explorer,this)},_getCurrentPageData:function(e,t){var i=this.filterData||{};this.actions.listPeopleDetailFilter(i,function(t){if(e)e(t)}.bind(this))},_removeDocument:function(e,t){},_createDocument:function(){},_openDocument:function(e){}});MWF.xApplication.Attendance.PeopleDetail.Document=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document});MWF.xApplication.Attendance.PeopleDetail.SelfHolidayDocument=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document});MWF.xApplication.Attendance.PeopleDetail.DetailStaticDocument=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document});MWF.xApplication.Attendance.PeopleDetail.SelfHolidayStaticDocument=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document});