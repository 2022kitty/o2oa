MWF.xApplication.cms=MWF.xApplication.cms||{};MWF.CMSE=MWF.xApplication.cms.Index=MWF.xApplication.cms.Index||{};MWF.require("MWF.widget.Identity",null,false);MWF.xDesktop.requireApp("cms.Index","Actions.RestActions",null,false);MWF.xApplication.cms.Index.options={multitask:false,executable:true};MWF.xApplication.cms.Index.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"cms.Index",icon:"icon.png",width:"1160",height:"700",isResize:false,isMax:true,title:MWF.CMSE.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.cms.Index.LP},loadApplication:function(t){this.columns=[];this.restActions=new MWF.xApplication.cms.Index.Actions.RestActions;this.createNode();this.loadApplicationContent()},reload:function(){this.contentContainerNode.destroy();this.loadContent()},createNode:function(){this.content.setStyle("overflow","hidden");this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},loadApplicationContent:function(){this.loadTitle();this.loadContent()},loadTitle:function(){this.loadTitleBar();this.loadCreateDocumentActionNode();this.loadTitleTextNode();this.loadRefreshNode();this.loadSearchNode()},loadTitleBar:function(){this.titleBar=new Element("div",{styles:this.css.titleBar}).inject(this.node)},loadCreateDocumentActionNode:function(){this.createDocumentAction=new Element("div",{styles:this.css.createDocumentAction}).inject(this.titleBar);this.createDocumentAction.addEvents({click:function(t){if(this.creater){this.creater.load()}else{MWF.xDesktop.requireApp("cms.Index","Creater",function(){this.creater=new MWF.xApplication.cms.Index.Creater(this,null,this);this.creater.load()}.bind(this))}}.bind(this)})},loadTitleTextNode:function(){this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.lp.title}).inject(this.titleBar)},loadSearchNode:function(){this.searchBarAreaNode=new Element("div",{styles:this.css.searchBarAreaNode}).inject(this.titleBar);this.searchBarNode=new Element("div",{styles:this.css.searchBarNode}).inject(this.searchBarAreaNode);this.searchBarActionNode=new Element("div",{styles:this.css.searchBarActionNode}).inject(this.searchBarNode);this.searchBarResetActionNode=new Element("div",{styles:this.css.searchBarResetActionNode}).inject(this.searchBarNode);this.searchBarResetActionNode.setStyle("display","none");this.searchBarInputBoxNode=new Element("div",{styles:this.css.searchBarInputBoxNode}).inject(this.searchBarNode);this.searchBarInputNode=new Element("input",{type:"text",value:this.lp.searchKey,styles:this.css.searchBarInputNode}).inject(this.searchBarInputBoxNode);var t=this;this.searchBarActionNode.addEvent("click",function(){this.search()}.bind(this));this.searchBarResetActionNode.addEvent("click",function(){this.reset()}.bind(this));this.searchBarInputNode.addEvents({focus:function(){if(this.value==t.lp.searchKey)this.set("value","")},blur:function(){if(!this.value)this.set("value",t.lp.searchKey)},keydown:function(t){if(t.code==13){this.search();t.preventDefault()}}.bind(this),selectstart:function(t){t.preventDefault()}})},loadRefreshNode:function(){this.refreshAreaNode=new Element("div",{styles:this.css.refreshAreaNode}).inject(this.titleBar);this.refreshActionNode=new Element("div",{styles:this.css.refreshActionNode,title:this.lp.refresh}).inject(this.refreshAreaNode);this.refreshActionNode.addEvent("click",function(){this.reload()}.bind(this))},loadContent:function(t){this.contentContainerNode=new Element("div",{styles:this.css.contentContainerNode}).inject(this.node);this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.contentContainerNode);this.createColumnNodes();MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.contentContainerNode,{indent:false,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:false,y:true},onScroll:function(t){}})}.bind(this));this.setContentSize();this.addEvent("resize",function(){this.setContentSize()}.bind(this))},createColumnNodes:function(){this.restActions.listColumn(function(t){if(typeOf(t.data)!="array")return;var e=t.data;e.sort(function(t,e){return parseFloat(t.appInfoSeq)-parseFloat(e.appInfoSeq)});t.data=e;var s=0;t.data.each(function(t){var t=new MWF.xApplication.cms.Index.Column(this,t,{index:s++});t.load();this.columns.push(t)}.bind(this))}.bind(this))},search:function(t){if(!t)t=this.searchBarInputNode.get("value");if(t==this.lp.searchKey)t="";if(t!=""){this.searchBarResetActionNode.setStyle("display","block");this.searchBarActionNode.setStyle("display","none")}this.columns.each(function(e){e.search(t)}.bind(this))},reset:function(){this.searchBarInputNode.set("value",this.lp.searchKey);this.searchBarResetActionNode.setStyle("display","none");this.searchBarActionNode.setStyle("display","block");this.columns.each(function(t){t.loadList()}.bind(this))},clearContent:function(){},openManager:function(){var t="cms.Column";if(this.desktop.apps[t]){this.desktop.apps[t].setCurrent()}else{this.desktop.openApplication(null,"cms.Column",{appId:t,onQueryLoad:function(){}})}},recordStatus:function(){},setContentSize:function(){var t=this.titleBar?this.titleBar.getSize():{x:0,y:0};var e=this.node.getSize();var s=this.contentContainerNode.getStyle("padding-top").toFloat();var i=this.contentContainerNode.getStyle("padding-bottom").toFloat();var o=e.y-s-i-t.y;this.contentContainerNode.setStyle("height",""+o+"px")}});MWF.xApplication.cms.Index.Column=new Class({Implements:[Options,Events],options:{where:"bottom",index:0},initialize:function(t,e,s){this.setOptions(s);this.app=t;this.container=this.app.contentNode;this.data=e;this.isNew=false;this.backgroundColors=["#cde6fe","#e6f3ff","#f5f6f7","#fcfcfc"];this.defaultColumnIcon="/x_component_cms_Index/$Main/"+this.app.options.style+"/icon/column.png"},load:function(){this.loadNode();this.loadTop();this.loadCategory();this.loadList()},loadNode:function(){this.node=new Element("div.columnItem",{styles:this.app.css.columnItemNode}).inject(this.container,this.options.where);var t=this.topNode=new Element("div.columnItemTopNode",{styles:this.app.css.columnItemTopNode}).inject(this.node);var e=this.options.index%this.backgroundColors.length;this.color=this.backgroundColors[e];t.setStyle("background-color",this.color);this.categoryContainer=new Element("div.categoryContainer",{styles:this.app.css.categoryContainer}).inject(this.node);this.categoryList=new Element("div.categoryList",{styles:this.app.css.categoryList}).inject(this.categoryContainer);this.documentList=new Element("div",{styles:this.app.css.documentList}).inject(this.node)},loadTop:function(){this.data.name=this.data.appName;var t=this.data.appName;var e=this.data.appAlias;var s=this.data.description;var i=this.data.appInfoSeq;var o=this.data.creatorUid;var n=this.data.createTime;var a=this.topNode;var c=this.iconAreaNode=new Element("div",{styles:this.app.css.columnItemIconAreaNode}).inject(a);var r=this.iconNode=new Element("img",{styles:this.app.css.columnItemIconNode}).inject(c);if(this.data.appIcon){this.iconNode.set("src","data:image/png;base64,"+this.data.appIcon+"")}else{this.iconNode.set("src",this.defaultColumnIcon)}r.makeLnk({par:this._getLnkPar()});var d=new Element("div",{styles:this.app.css.columnItemTextNode}).inject(a);var h=new Element("div",{styles:this.app.css.columnItemTitleNode,text:t,title:e?t+" ("+e+") ":t}).inject(d);var l=s&&s!=""?s:this.app.lp.noDescription;var p=new Element("div",{styles:this.app.css.columnItemDescriptionNode,text:l,title:l}).inject(d);var u=this;a.addEvents({click:function(t){u.clickColumnNode(u,this,t)}})},_getLnkPar:function(){var t=this.defaultColumnIcon;if(this.data.appIcon)t="data:image/png;base64,"+this.data.appIcon;var e="cms.Module"+this.data.id;return{icon:t,title:this.data.appName,par:'cms.Module#{"columnId": "'+this.data.id+'", "appId": "'+e+'"}'}},clickColumnNode:function(t,e,s){this.openModule("all",s)},clickMoreLink:function(t){var e=this.app.searchBarInputNode.get("value");if(e==this.app.lp.searchKey)e="";this.openModule("all",t,e)},openModule:function(t,e,s,i){var o="cms.Module"+this.data.id;if(this.app.desktop.apps[o]){if(s){this.app.desktop.apps[o].close()}else{this.app.desktop.apps[o].setCurrent();return}}this.app.desktop.openApplication(e,"cms.Module",{columnData:this.data,appId:o,categoryId:t,isCategory:i||false,searchKey:s})},loadCategory:function(){var t=this;if(typeOf(this.data.wrapOutCategoryList)!="array")return;var e=this.data.wrapOutCategoryList;e.sort(function(t,e){return parseFloat(t.categorySeq)-parseFloat(e.categorySeq)});this.data.wrapOutCategoryList=e;this.data.wrapOutCategoryList.each(function(e){var s=new Element("div.categoryItem",{text:e.categoryName,styles:this.app.css.categoryItem}).inject(this.categoryList);s.store("category",e);s.addEvents({mouseover:function(){this.setStyles(t.app.css.categoryItem_over)},mouseout:function(){this.setStyles(t.app.css.categoryItem)},click:function(e){t.openModule(this.retrieve("category").id,e,"",true)}})}.bind(this));if(this.categoryList.getScrollSize().y>this.categoryContainer.getSize().y){this.categoryArrowNode=new Element("div.categoryArrowNode",{styles:this.app.css.categoryArrowNode}).inject(this.categoryContainer);this.categoryArrowNode.addEvents({mouseover:function(){this.categoryArrowNode.setStyles(this.categoryArrow!="down"?this.app.css.categoryArrowNode_over:this.app.css.categoryArrowNode_down_over)}.bind(this),mouseout:function(){this.categoryArrowNode.setStyles(this.categoryArrow!="down"?this.app.css.categoryArrowNode:this.app.css.categoryArrowNode_down)}.bind(this),click:function(t){if(this.categoryArrow!="down"){this.openCategoryList(t)}else{this.closeCategoryList(t)}}.bind(this)})}},openCategoryList:function(t){this.categoryArrow="down";this.categoryArrowNode.setStyles(this.app.css.categoryArrowNode_down_over);this.categoryList.setStyles(this.app.css.categoryList_all);window.closeCategoryList=this.closeCategoryList.bind(this);this.app.content.addEvent("click",window.closeCategoryList);t.stopPropagation()},closeCategoryList:function(t){this.categoryArrow="up";this.categoryArrowNode.setStyles(this.app.css.categoryArrowNode);this.categoryList.setStyles(this.app.css.categoryList);this.app.content.removeEvent("click",window.closeCategoryList);t.stopPropagation()},destroy:function(){this.node.destroy();MWF.release(this);delete this},search:function(t){if(!t||t==""){this.loadList();return}if(this.documentList)this.documentList.empty();if(this.moreArea)this.moreArea.destroy();var e={titleList:[t],appIdList:[this.data.id],statusList:["published"]};this.getDocumentData(function(t){if(t.count>t.size){this.loadMoreItem(t.count,t.size)}t.data.each(function(t){this.listDocument(t)}.bind(this))}.bind(this),null,e)},loadList:function(){if(this.documentList)this.documentList.empty();if(this.moreArea)this.moreArea.destroy();this.getDocumentData(function(t){if(t.count>t.size){this.loadMoreItem(t.count,t.size)}t.data.each(function(t){this.listDocument(t)}.bind(this))}.bind(this))},listDocument:function(t){var e=this;var s=new Element("div",{text:t.title,styles:this.app.css.documentItem}).inject(this.documentList);s.store("documentId",t.id);s.addEvents({mouseover:function(){this.setStyles(e.app.css.documentItem_over)},mouseout:function(){this.setStyles(e.app.css.documentItem)},click:function(){var t=this.retrieve("documentId");var s="cms.Document"+t;if(e.app.desktop.apps[s]){e.app.desktop.apps[s].setCurrent()}else{var i={documentId:t,appId:s,readonly:true};e.app.desktop.openApplication(null,"cms.Document",i)}}})},getDocumentData:function(t,e,s){if(!e)e=7;var i="(0)";if(!s){s={appIdList:[this.data.id],statusList:["published"]}}this.app.restActions.listDocumentFilterNext(i,e,s,function(e){if(t)t(e)})},loadMoreItem:function(t,e){var s=this;this.moreArea=new Element("div",{styles:this.app.css.moreArea}).inject(this.node);this.moreLink=new Element("div",{styles:this.app.css.moreLink,text:"查看其余"+(t-e)+"份信息"}).inject(this.moreArea);this.moreLink.addEvents({mouseover:function(){this.setStyles(s.app.css.moreLink_over)},mouseout:function(){this.setStyles(s.app.css.moreLink)},click:function(t){s.clickMoreLink(t)}});this.moreArea.setStyle("background-color",this.color)}});