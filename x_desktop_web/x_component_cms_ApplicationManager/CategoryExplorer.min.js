MWF.xDesktop.requireApp("cms.ApplicationManager","Explorer",null,false);MWF.xDesktop.requireApp("cms.ApplicationManager","FormExplorer",null,false);MWF.xDesktop.requireApp("cms.ApplicationManager","ViewExplorer",null,false);MWF.xApplication.cms.ApplicationManager.CategoryExplorer=new Class({Extends:MWF.xApplication.cms.ApplicationManager.Explorer,Implements:[Options,Events],initialize:function(t,e,i,s){this.setOptions(s);this.setTooltip();this.path="/x_component_cms_ApplicationManager/$CategoryExplorer/";this.cssPath="/x_component_cms_ApplicationManager/$CategoryExplorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=i;this.node=$(t);this.naviNode=e;this.initData()},load:function(){this.loadContentNode()},reload:function(){if(!this.node)return;this.initData();this.node.empty();this.naviNode.empty();this.load()},refresh:function(){this.setContentSize();this.viewExplorer.reload();this.formExplorer.reload()},loadContentNode:function(){this.elementContentNode=new Element("div.elementContentNode",{styles:this.css.elementContentNode}).inject(this.node);this.elementContentListNode=new Element("div.elementContentListNode",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);this.naviContainerNode=this.naviNode;this.loadContentNodes();this.setContentSize();this.app.addEvent("resize",function(){this.setContentSize()}.bind(this));this.loadCategoryList();this.loadForm();this.loadView()},loadContentNodes:function(){this.rightContent=new Element("div.rightContent",{styles:this.css.rightContent}).inject(this.elementContentListNode);this.createFormNode();this.rightContentResizeNode=new Element("div.rightContentResizeNode",{styles:this.css.rightContentResizeNode}).inject(this.rightContent);this.createViewNode();this.formPercent=.5},setNodeScroll:function(){MWF.require("MWF.widget.DragScroll",function(){new MWF.widget.DragScroll(this.naviArea)}.bind(this));MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.naviArea,{indent:false})}.bind(this))},loadCategoryList:function(t){this.categoryList=new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.CategoryList(this,this.naviNode,{columnId:this.app.options.column.id,onPostLoad:function(){this.fireEvent("postLoadCategoryList",this.categoryList)}.bind(this)})},_createElement:function(){this.categoryList.newCategory()},createFormNode:function(){this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}).inject(this.rightContent);this.formTitleNode=new Element("div.formTitleNode",{styles:this.css.formTitleNode}).inject(this.formAreaNode);this.formCreateNode=new Element("div.formCreateNode",{styles:this.css.formCreateNode}).inject(this.formTitleNode);this.formCreateNode.addEvent("click",function(t){this.formExplorer._createElement(t)}.bind(this));this.formCreateNode.addEvent("mouseover",function(t){this.formCreateNode.setStyles(this.css.formCreateNode_over)}.bind(this));this.formCreateNode.addEvent("mouseout",function(t){this.formCreateNode.setStyles(this.css.formCreateNode)}.bind(this));this.formTitleTextNode=new Element("div.formTitleTextNode",{styles:this.css.formTitleTextNode,text:"选择分类表单"}).inject(this.formTitleNode);this.formNode=new Element("div.formNode",{styles:this.css.formNode}).inject(this.formAreaNode)},loadForm:function(){this.formExplorer=new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.FormExplorer(this.formNode,this.app.restActions,{style:"full"});this.formExplorer.app=this.app;this.formExplorer.explorer=this;this.formExplorer.load()},createViewNode:function(){this.viewAreaNode=new Element("div.viewAreaNode",{styles:this.css.viewAreaNode}).inject(this.rightContent);this.viewTitleNode=new Element("div.viewTitleNode",{styles:this.css.viewTitleNode}).inject(this.viewAreaNode);this.viewCreateNode=new Element("div.viewCreateNode",{styles:this.css.viewCreateNode}).inject(this.viewTitleNode);this.viewCreateNode.addEvent("click",function(t){this.viewExplorer._createView(t)}.bind(this));this.viewCreateNode.addEvent("mouseover",function(t){this.viewCreateNode.setStyles(this.css.viewCreateNode_over)}.bind(this));this.viewCreateNode.addEvent("mouseout",function(t){this.viewCreateNode.setStyles(this.css.viewCreateNode)}.bind(this));this.viewTitleTextNode=new Element("div.viewTitleTextNode",{styles:this.css.viewTitleTextNode,text:"选择分类列表"}).inject(this.viewTitleNode);this.viewNode=new Element("div.viewNode",{styles:this.css.viewNode}).inject(this.viewAreaNode)},loadView:function(){this.viewExplorer=new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.ViewExplorer(this.viewNode,this.app.restActions,{style:"full"});this.viewExplorer.app=this.app;this.viewExplorer.explorer=this;this.viewExplorer.load()},loadCategoryListResize:function(){this.categoryistResize=new Drag(this.categoryListResizeNode,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var s=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:s});var o=this.naviContainerNode.getSize();t.store("initialWidth",o.x)}.bind(this),onDrag:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var s=this.elementContentNode.getSize();var o=t.retrieve("position");var n=t.retrieve("initialWidth").toFloat();var r=i.toFloat()-o.x.toFloat();var a=n+r;if(a>s.x/2)a=s.x/2;if(a<130)a=130;this.naviContainerNode.setStyle("width",a);this.rightContent.setStyle("margin-left",a+1);var c=s.x-a;this.rightContent.setStyle("width",c);this.formNode.setStyle("width",""+(c-15)+"px");this.viewNode.setStyle("width",""+(c-15)+"px");if(this.formExplorer)this.formExplorer.setContentSize();if(this.viewExplorer)this.viewExplorer.setContentSize()}.bind(this)})},loadRightContentResize:function(){this.rightContentResize=new Drag(this.rightContentResizeNode,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var s=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:s});var o=this.formNode.getSize();t.store("initialHeight",o.y)}.bind(this),onDrag:function(t,e){var i=this.rightContent.getSize();var s=Browser.name=="firefox"?e.event.clientY:e.event.y;var o=t.retrieve("position");var n=s.toFloat()-o.y.toFloat();var r=t.retrieve("initialHeight").toFloat();var a=r+n;if(a<40)a=40;if(a>i.y-40)a=i.y-40;this.formPercent=a/i.y;this.setRightContentResize()}.bind(this)})},setRightContentResize:function(){var t=this.rightContent.getSize();var e=this.rightContentResizeNode.getSize();var i=this.formTitleNode.getSize();var s=this.viewTitleNode.getSize();var o=t.y-e.y-i.y-s.y;var n=this.formPercent*o;var r=o-n;this.formNode.setStyle("height",""+n+"px");this.viewNode.setStyle("height",""+r+"px");if(this.formExplorer)this.formExplorer.setContentSize();if(this.viewExplorer)this.viewExplorer.setContentSize()},setContentSize:function(){var t=this.node.getSize();var e=this.elementContentNode.getStyle("padding-top").toFloat();var i=this.elementContentNode.getStyle("padding-bottom").toFloat();var s=this.naviContainerNode.getSize();var o=t.y;this.elementContentListNode.setStyle("height",""+o+"px");this.rightContent.setStyle("height",""+o+"px");this.formNode.setStyle("height",""+(o-30)+"px");this.viewNode.setStyle("height",""+(o-30)+"px");var n=t.x;this.elementContentListNode.setStyles({width:""+n+"px"});this.rightContent.setStyle("width",""+n+"px");var r=this.rightContentResizeNode.getSize();var a=n-r.x;this.formNode.setStyle("width",""+a*this.formPercent+"px");this.viewNode.setStyle("width",""+(a-a*this.formPercent)+"px")}});MWF.xApplication.cms.ApplicationManager.CategoryExplorer.CategoryList=new Class({Implements:[Options,Events],options:{columnId:""},initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.app=t.app;this.node=$(e);this.css=t.css;this.categoryArr=[];this.categoryObj={};this.currentCategory=null;this.currentView=null;this.load()},load:function(){var t=this;this.app.restActions.listCategory(this.options.columnId,function(t){t.data.each(function(t){this.loadCategoryByData(t)}.bind(this));this.fireEvent("postLoad")}.bind(this),function(){this.fireEvent("postLoad")}.bind(this),true)},getCurrentNode:function(){return this.currentNode},getCategoryNodes:function(){var t=[];this.categoryArr.each(function(e){t.push(e.node)}.bind(this));return t},cancelCurrentNode:function(){if(this.currentNode){if(this.currentNodeType=="category"){this.currentNode.setStyles(this.css.categoryNaviNode);this.currentCategory._hideActions()}else{this.currentNode.setStyles(this.css.viewNaviNode)}}},setCurrentCategory:function(t){this.cancelCurrentNode();this.currentCategory=t;this.currentNodeType="category";this.currentNode=t.node;t.node.setStyles(this.css.categoryNaviNode_selected);this.currentTimeout=setTimeout(function(){t._showActions();this.currentTimeout=null}.bind(this),100);this.explorer.formExplorer.refreshByCategory(t);this.explorer.viewExplorer.refreshByCategory(t)},setCurrentView:function(t){this.cancelCurrentNode();this.currentView=t;this.currentNodeType="view";this.currentNode=t.node;t.node.setStyles(this.css.viewNaviNode_selected)},destroyCategory:function(t){if(t.options.isNew){}else{var e=t.data.id;delete this.categoryObj[e];var i=this.categoryArr.indexOf(t);if(i>-1){this.categoryArr.splice(i,1)}}t.destroy()},loadCategoryByData:function(t,e,i,s){var o=new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.Category(this,this.node,t,{relativeNode:e,relativePosition:i});this.categoryObj[t.id]=o;this.categoryArr.push(o);if(s)s(o)},loadCategoryById:function(t,e,i,s){this.app.restActions.getCategory(t,function(t){var o=t.data;var n=new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.Category(this,this.node,o,{relativeNode:e,relativePosition:i});this.categoryObj[o.id]=n;this.categoryArr.push(n);if(s)s(n)}.bind(this))},adjustSeq:function(t){var e=this.node.getElements(".categoryNaviNode");var i=this.app.restActions;e.each(function(s,o){var n=s.retrieve("category");if(!n.options.isNew){var r=n.data;var a="000"+(e.length-o);r.catagorySeq=a.substr(a.length-3,3);i.saveCategory(r,null,null,t===false?false:true)}})},newCategory:function(t,e){var i=new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.Category(this,this.node,{},{isNew:true,relativeNode:t,relativePosition:e})}});MWF.xApplication.cms.ApplicationManager.CategoryExplorer.Category=new Class({Implements:[Options,Events],options:{style:"default",isNew:false,relativeNode:null,relativePosition:"bottom",actions_edit:[{name:"saveCategory",icon:"save.png",icon_over:"save_over.png",event:"click",action:"saveCategory",title:MWF.xApplication.cms.ApplicationManager.LP.category.saveCategory},{name:"cancel",icon:"cancel.png",icon_over:"cancel_over.png",event:"click",action:"cancel",title:MWF.xApplication.cms.ApplicationManager.LP.category.cancelEdit}],actions_read:[{name:"editCategory",icon:"edit.png",icon_over:"edit_over.png",event:"click",action:"editCategory",title:MWF.xApplication.cms.ApplicationManager.LP.category.editCategory},{name:"insertCateogryBefore",icon:"insertBefore.png",icon_over:"insertBefore_over.png",event:"click",action:"insertCateogryBefore",title:MWF.xApplication.cms.ApplicationManager.LP.category.insertCateogryBefore},{name:"insertCateogryAfter",icon:"insertAfter.png",icon_over:"insertAfter_over.png",event:"click",action:"insertCateogryAfter",title:MWF.xApplication.cms.ApplicationManager.LP.category.insertCateogryAfter},{name:"deleteCategory",icon:"trash.png",icon_over:"trash_over.png",event:"click",action:"deleteCategory",title:MWF.xApplication.cms.ApplicationManager.LP.category.deleteCategory},{name:"moveCategory",icon:"turn.png",icon_over:"turn_over.png",event:"click",action:"moveCategory",title:MWF.xApplication.cms.ApplicationManager.LP.category.moveCategory}]},initialize:function(t,e,i,s){this.setOptions(s);this.list=t;this.explorer=t.explorer;this.app=t.app;this.css=t.css;this.container=$(e);this.data=i;this.lp=this.app.lp.category;this.categoryViewArr=[];this.categoryViewObj={};this.load()},load:function(){var t=this;this.node=new Element("div.categoryNaviNode",{styles:this.css.categoryNaviNode}).inject(this.options.relativeNode||this.container,this.options.relativePosition||"bottom");this.node.store("category",this);this.textNode=new Element("div.categoryNaviTextNode",{styles:this.css.categoryNaviTextNode,text:this.data.name}).inject(this.node);this.node.addEvents({mouseover:function(){if(t.list.getCurrentNode()!=this&&!t.list.isOnDragging)this.setStyles(t.css.categoryNaviNode_over)},mouseout:function(){if(t.list.getCurrentNode()!=this)this.setStyles(t.css.categoryNaviNode)},click:function(){if(!t.list.isOnDragging){t.setCurrentNode(this)}}});this.loadViewNode();this.createIconAction();if(this.options.isNew){this.editCategory()}},loadViewNode:function(){var t=this.viewNaviListNode=new Element("div.viewNaviListNode",{styles:this.css.viewNaviListNode}).inject(this.node,"after")},destroy:function(){this.node.destroy();this.viewNaviListNode.destroy();delete this},setCategoryView:function(t,e){var i={catagoryId:this.data.id,viewId:t};this.app.restActions.addCategoryView(i,function(e){this.app.restActions.getView(t,function(t){this.app.notice("设置分类列表成功")}.bind(this))}.bind(this),null,false)},setDefaultCategoryView:function(t,e){var i=this.data;i.defaultViewName=t;this.app.restActions.saveCategory(i,function(t){this.app.notice("设置默认视图成功")}.bind(this))},cancelCategoryView:function(t,e){this.app.restActions.listCategoryViewByCatagory(this.data.id,function(e){e.data.each(function(e){if(e.viewId==t){this.app.restActions.deleteCategoryView(e.id,function(e){var i=this.categoryViewObj[t];delete this.categoryViewObj[t];this.categoryViewArr.erase(i);i.destroy();this.app.notice("取消分类列表成功")}.bind(this),null,false)}}.bind(this))}.bind(this),null,false)},setEditForm:function(t,e){var i=this.data;i.formId=t;i.formName=e;this.app.restActions.saveCategory(i,function(t){this.app.notice("设置编辑表单成功")}.bind(this))},setReadForm:function(t,e){var i=this.data;i.readFormId=t;i.readFormName=e;this.app.restActions.saveCategory(i,function(t){this.app.notice("设置阅读表单成功")}.bind(this))},saveCategory:function(){var t=this.data||{};if(this.options.isNew){t.isNew=this.options.isNew;t.appId=this.app.options.column.id}if(this.editMode&&this.input){var e=this.input.get("value");if(e==""||e=="请输入分类名称"){this.app.notice("请输入分类名称","error");return}else{t.catagoryName=e;t.name=e}}this.app.restActions.saveCategory(t,function(t){this.list.loadCategoryById(t.data.id,this.node,"before",function(t){this.list.setCurrentCategory(t);this.list.adjustSeq(false);this.list.destroyCategory(this)}.bind(this))}.bind(this))},cancel:function(){if(this.options.isNew){this.destroy()}else{this.editMode=false;this.input.destroy();this.textNode.setStyle("display","");this._showActions()}},editCategory:function(){this.textNode.setStyle("display","none");this.editMode=true;this.input=new Element("input",{type:"text",value:this.options.isNew?"请输入分类名称":this.data.name,styles:this.css.categoryInput}).inject(this.node,"top");this.input.addEvents({click:function(t){this._showActions(true);t.stopPropagation()}.bind(this),focus:function(t){if(t.target.value=="请输入分类名称"){t.target.value=""}}.bind(this),blur:function(t){if(t.target.value==""){t.target.value="请输入分类名称"}}.bind(this)});this._showActions(true)},setCurrentNode:function(){this.list.setCurrentCategory(this)},createViewsNode:function(t,e){var i=new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.CategoryView(this,t,e);var s=e.isDefault?"default":e.id;this.categoryViewObj[s]=i;this.categoryViewArr.push(i)},_showActions:function(){if(this.editMode){if(this.actionArea_edit){this.actionArea_edit.setStyle("display","")}if(this.actionArea_read){this.actionArea_read.setStyle("display","none")}}else{if(this.actionArea_edit){this.actionArea_edit.setStyle("display","none")}if(this.actionArea_read){this.actionArea_read.setStyle("display","")}}},_hideActions:function(){if(this.actionArea_read)this.actionArea_read.setStyle("display","none");if(this.actionArea_edit){this.actionArea_edit.setStyle("display","none")}},createIconAction:function(){this.actionNodes=this.actionNodes||{};if(!this.actionArea_read){this.actionArea_read=new Element("div",{styles:this.css.actionArea}).inject(this.node);this.options.actions_read.each(function(t){var e=this.actionNodes[t.name]=new Element("div",{styles:this.css.actionNodeStyles,title:t.title}).inject(this.actionArea_read);e.setStyle("background","url("+this.explorer.path+this.options.style+"/icon/"+t.icon+") no-repeat left center");e.addEvent(t.event,function(e){this[t.action](e);e.stopPropagation()}.bind(this));e.addEvents({mouseover:function(t){t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.icon_over+") no-repeat left center")}.bind({obj:this,action:t}),mouseout:function(t){t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.icon+") no-repeat left center")}.bind({obj:this,action:t})})}.bind(this))}if(!this.actionArea_edit){this.actionArea_edit=new Element("div",{styles:this.css.actionArea}).inject(this.node);this.options.actions_edit.each(function(t){var e=this.actionNodes[t.name]=new Element("div",{styles:this.css.actionNodeStyles,title:t.title}).inject(this.actionArea_edit);e.setStyle("background","url("+this.explorer.path+this.options.style+"/icon/"+t.icon+") no-repeat left center");e.addEvent(t.event,function(e){this[t.action](e);e.stopPropagation()}.bind(this));e.addEvents({mouseover:function(t){t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.icon_over+") no-repeat left center")}.bind({obj:this,action:t}),mouseout:function(t){t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.icon+") no-repeat left center")}.bind({obj:this,action:t})})}.bind(this))}},insertCateogryBefore:function(t){this.list.newCategory(this.node,"before")},insertCateogryAfter:function(t){this.list.newCategory(this.viewNaviListNode,"after")},deleteCategory:function(t){var e=this;this.app.confirm("warn",this.actionNodes.deleteCategory,this.lp.deleteCategoryTitle,this.lp.deleteCategoryConfirm,300,120,function(){e._deleteCategory();this.close()},function(){this.close()})},_deleteCategory:function(t){this.app.restActions.removeCategory(this.data.id,function(){this.node.destroy();this.viewNaviListNode.destroy();if(t)t()}.bind(this),function(t,e,i){var s=i;if(t)s=t.responseText;if(s.indexOf("referenced")>-1){var o=this.explorer.app.lp.category;var e=o.deleteFailAsHasDocument.replace(/{title}/g,this.data.name);this.app.notice(e,"error")}}.bind(this))},moveCategory:function(t){this._createMoveNode();this._setNodeMove(t)},_createMoveNode:function(){this.moveNode=new Element("div",{styles:this.css.moduleNodeMove,text:this.node.get("text"),events:{selectstart:function(){return false}}}).inject(this.container)},_setNodeMove:function(t){this._setMoveNodePosition(t);var e=this.list.getCategoryNodes();var i=new Drag.Move(this.moveNode,{droppables:e,onEnter:function(t,e){var i=e.retrieve("category");if(i)i._dragIn(this)}.bind(this),onLeave:function(t,e){var i=e.retrieve("category");if(i)i._dragOut(this)}.bind(this),onDrag:function(t){this.list.isOnDragging=true}.bind(this),onDrop:function(t,e,i){if(e){var s=e.retrieve("category");if(s){this._dragComplete(s);s._dragDrop(this)}else{this._dragCancel(t)}}else{this._dragCancel(t)}if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}setTimeout(function(){this.list.isOnDragging=false}.bind(this),100);i.stopPropagation()}.bind(this),onCancel:function(t){if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}setTimeout(function(){this.list.isOnDragging=false}.bind(this),100)}.bind(this)});i.start(t)},_dragIn:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode_dragIn)},_dragOut:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode)},_dragDrop:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode)},_dragComplete:function(t){this.node.inject(t.viewNaviListNode,"after");this.viewNaviListNode.inject(this.node,"after");this.setCurrentNode();if(this.moveNode)this.moveNode.destroy();this.moveNode=null;this.list.adjustSeq()},_dragCancel:function(){if(this.moveNode)this.moveNode.destroy();this.moveNode=null},_setScroll:function(){var t=this.explorer.categoryScrollWrapNode||this.explorer.naviArea;var e=t.getCoordinates();var i=e.top;var s=i+e.height;var o=this.explorer.categoryScrollContentNode||this.explorer.naviNode;var n=this.moveNode.getCoordinates();if(n.top<i&&n.bottom>i){if(!this.dragInterval){this.dragInterval=setInterval(function(){if(t.getScroll().y-15>0){t.scrollTo(0,t.getScroll().y-15)}else{t.scrollTo(0,0)}}.bind(this),100)}}else if(n.top<s&&n.bottom>s){if(!this.dragInterval){this.dragInterval=setInterval(function(){if(t.getScroll().y+15<o.getSize().y){t.scrollTo(0,t.getScroll().y+15)}else{t.scrollTo(0,o.getSize().y)}}.bind(this),100)}}else{if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}}},_setMoveNodePosition:function(t){var e=t.page.x+2;var i=t.page.y+2;this.moveNode.positionTo(e,i)}});MWF.xApplication.cms.ApplicationManager.CategoryExplorer.CategoryView=new Class({Implements:[Options,Events],initialize:function(t,e,i,s){this.setOptions(s);this.category=t;this.list=t.list;this.explorer=t.explorer;this.app=t.app;this.css=t.css;this.container=$(e);this.data=i;this.load()},destroy:function(){this.node.destroy();delete this},load:function(){var t=this;this.node=new Element("div.viewNaviNode",{styles:this.css.viewNaviNode,text:this.data.isDefault?this.app.lp.defaultView:this.data.name}).inject(this.container);this.node.addEvents({mouseover:function(){if(t.list.getCurrentNode()!=this)this.setStyles(t.css.viewNaviNode_over)},mouseout:function(){if(t.list.getCurrentNode()!=this)this.setStyles(t.css.viewNaviNode)},click:function(e){t.setCurrentNode(this)}})},setCurrentNode:function(){this.list.setCurrentView(this)}});MWF.xApplication.cms.ApplicationManager.CategoryExplorer.FormExplorer=new Class({Extends:MWF.xApplication.cms.ApplicationManager.FormExplorer,Implements:[Options,Events],load:function(){this.loadContentNode();this.setNodeScroll();this.refresh()},reload:function(){if(!this.node)return;this.initData();this.node.empty();this.loadContentNode();this.setNodeScroll();if(this.currentCategory){this.refreshByCategory(this.currentCategory)}else{this.refresh()}},refreshByCategory:function(t){this.currentCategory=t;var e=t.data.formId;var i=t.data.formName;var s=t.data.readFormId;if(this.currentEditForm){this.currentEditForm.isEditForm=false;this.currentEditForm.setStyle();this.currentEditForm=null}if(this.currentReadForm){this.currentReadForm.isReadForm=false;this.currentReadForm.setStyle();this.currentReadForm=null}this.refresh(t,function(){this.itemArray.each(function(t){var i=t.data;if(i.id==e){this.currentEditForm=t;t.isEditForm=true}if(i.id==s){this.currentReadForm=t;t.isReadForm=true}t.setStyle()}.bind(this))}.bind(this))},refresh:function(t,e){if(this.noElementNode)this.noElementNode.destroy();if(!t){this.itemArray.each(function(t){t.node.setStyle("display","none")});this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:"请先新建或选择分类"}).inject(this.elementContentListNode)}else if(t.options.isNew){this.itemArray.each(function(t){t.node.setStyle("display","none")});this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:"请先保存分类"}).inject(this.elementContentListNode)}else{if(this.itemArray&&this.itemArray.length){this.itemArray.each(function(t){t.node.setStyle("display","")});if(e)e()}else{this.loadElementList(e)}}},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node);this.elementContentListNode=new Element("div",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);this.setContentSize();this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0};var e=this.node.getSize();var i=this.elementContentNode.getStyle("padding-top").toFloat();var s=this.elementContentNode.getStyle("padding-bottom").toFloat();var o=e.y-t.y-i-s;var n=e.x;this.elementContentNode.setStyle("height",""+o+"px");this.elementContentListNode.setStyles({width:""+n+"px"})},loadElementList:function(t){this._loadItemDataList(function(e){if(e.data.length){e.data.each(function(t){var e=this._getItemObject(t,this.itemArray.length+1);e.load();this.itemObject[t.id]=e;this.itemArray.push(e)}.bind(this));if(t)t()}else{var i=this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:this.options.tooltip.noElement}).inject(this.elementContentListNode);i.addEvent("click",function(t){this._createElement(t)}.bind(this))}}.bind(this))},_getItemObject:function(t,e){return new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.Form(this,t,{index:e})},_loadItemDataList:function(t){this.app.restActions.listForm(this.app.options.column.id,t,null,false)}});MWF.xApplication.cms.ApplicationManager.CategoryExplorer.Form=new Class({Extends:MWF.xApplication.cms.ApplicationManager.FormExplorer.Form,options:{where:"bottom",index:1},initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.app=t.app;this.css=this.explorer.css;this.lp=this.app.lp.form;this.data=e;this.container=this.explorer.elementContentListNode;this.icon=this._getIcon()},load:function(){this.node=new Element("div",{styles:this.css.itemNode,events:{mouseover:function(){if(!this.isEditForm)this.node.setStyle("background-color","#f0f0f0")}.bind(this),mouseout:function(){var t=this.options.index%2==0?"#f7f7f7":"#fff";if(!this.isEditForm)this.node.setStyle("background-color",t)}.bind(this)}}).inject(this.container);this.itemStatusNode=new Element("div",{styles:this.css.itemStatusNode}).inject(this.node);this.itemStatusTopNode=new Element("div",{styles:this.css.itemStatusTopNode}).inject(this.itemStatusNode);this.itemStatusBottomNode=new Element("div",{styles:this.css.itemStatusBottomNode}).inject(this.itemStatusNode);if(this.data.name.icon)this.icon=this.data.name.icon;var t=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon;var e=new Element("div",{styles:this.css.itemIconNode,title:"可以拖动到桌面"}).inject(this.node);e.setStyle("background","url("+t+") center center no-repeat");e.makeLnk({par:this._getLnkPar()});this.actionsArea=new Element("div.actionsArea",{styles:this.css.actionsArea}).inject(this.node);this.setEditAction=new Element("div.setEditAction",{styles:this.css.setEditAction,title:"设为编辑表单"}).inject(this.actionsArea);this.setEditAction.addEvents({click:function(t){this.setEditForm()}.bind(this),mouseover:function(t){if(!this.isEditForm)this.setEditAction.setStyles(this.css.setEditAction_selected)}.bind(this),mouseout:function(t){if(!this.isEditForm)this.setEditAction.setStyles(this.css.setEditAction)}.bind(this)});this.setReadAction=new Element("div.setReadAction",{styles:this.css.setReadAction,title:"设为阅读表单"}).inject(this.actionsArea);this.setReadAction.addEvents({click:function(t){this.setReadForm()}.bind(this),mouseover:function(t){if(!this.isReadForm)this.setReadAction.setStyles(this.css.setReadAction_selected)}.bind(this),mouseout:function(t){if(!this.isReadForm)this.setReadAction.setStyles(this.css.setReadAction)}.bind(this)});if(!this.explorer.options.noDelete){this.deleteActionNode=new Element("div.deleteAction",{styles:this.css.deleteAction,title:"删除"}).inject(this.actionsArea);this.deleteActionNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this));this.deleteActionNode.addEvents({mouseover:function(t){this.deleteActionNode.setStyles(this.css.deleteAction_over)}.bind(this),mouseout:function(t){this.deleteActionNode.setStyles(this.css.deleteAction)}.bind(this)})}var i=new Element("div.itemInforNode",{styles:this.css.itemInforNode}).inject(this.node);var s=new Element("div.itemInforBaseNode",{styles:this.css.itemInforBaseNode}).inject(i);this.itemTextTitleNode=new Element("div.itemTextTitleNode",{styles:this.css.itemTextTitleNode,text:this.data.name,title:this.data.name,events:{click:function(t){this._open(t);t.stopPropagation()}.bind(this)}}).inject(s);new Element("div.itemTextDateNode",{styles:this.css.itemTextDateNode,text:this.data.updateTime||""}).inject(s)},setEditForm:function(){if(this.explorer.currentEditForm){this.explorer.currentEditForm.isEditForm=false;this.explorer.currentEditForm.setStyle()}this.explorer.currentEditForm=this;this.isEditForm=true;this.setStyle();this.explorer.currentCategory.setEditForm(this.data.id,this.data.name);this.explorer.explorer.viewExplorer.refreshByForm(this.data.id,this.data.name)},setReadForm:function(){if(this.explorer.currentReadForm){this.explorer.currentReadForm.isReadForm=false;this.explorer.currentReadForm.setStyle()}this.isReadForm=true;this.setStyle();this.explorer.currentCategory.setReadForm(this.data.id,this.data.name);this.explorer.currentReadForm=this},setStyle:function(){if(this.isEditForm&&this.isReadForm){this.itemStatusTopNode.setStyles({"background-color":"#3c76b7"});this.itemStatusBottomNode.setStyles({"background-color":"#50e3c2"});this.node.setStyles({"background-color":"#f2f8ff"});this.itemTextTitleNode.setStyles({color:"#447bbb"});this.setEditAction.setStyles(this.css.setEditAction_selected);this.setReadAction.setStyles(this.css.setReadAction_selected)}else if(this.isEditForm){this.itemStatusTopNode.setStyles({"background-color":"#3c76b7"});this.itemStatusBottomNode.setStyles({"background-color":"#3c76b7"});this.node.setStyles({"background-color":"#f2f8ff"});this.itemTextTitleNode.setStyles({color:"#447bbb"});this.setEditAction.setStyles(this.css.setEditAction_selected);this.setReadAction.setStyles(this.css.setReadAction)}else if(this.isReadForm){this.itemStatusTopNode.setStyles({"background-color":"#50e3c2"});this.itemStatusBottomNode.setStyles({"background-color":"#50e3c2"});var t=this.options.index%2==0?"#f7f7f7":"#fff";this.node.setStyles({"background-color":t});this.itemTextTitleNode.setStyles({color:"#888"});this.setEditAction.setStyles(this.css.setEditAction);this.setReadAction.setStyles(this.css.setReadAction_selected)}else{var t=this.options.index%2==0?"#f7f7f7":"#fff";this.itemStatusTopNode.setStyles({"background-color":t});this.itemStatusBottomNode.setStyles({"background-color":t});this.node.setStyles({"background-color":t});this.itemTextTitleNode.setStyles({color:"#888"});this.setEditAction.setStyles(this.css.setEditAction);this.setReadAction.setStyles(this.css.setReadAction)}},_deleteItem:function(t){this.explorer.app.restActions.deleteForm(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))}});MWF.xApplication.cms.ApplicationManager.CategoryExplorer.ViewExplorer=new Class({Extends:MWF.xApplication.cms.ApplicationManager.ViewExplorer,Implements:[Options,Events],initialize:function(t,e,i){this.setOptions(i);this.setTooltip();this.path="/x_component_cms_ApplicationManager/$Explorer/";this.cssPath="/x_component_cms_ApplicationManager/$Explorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=e;this.node=$(t);this.initData()},load:function(){this.loadContentNode();this.setNodeScroll();this.loadElementList()},refreshByCategory:function(t){this.category=t;this.options.categoryId=t.data.id;this.options.defaultViewId=t.data.defaultViewName;this.options.formId=t.data.formId;this.options.formName=t.data.formName;this.reload()},refreshByForm:function(t,e){this.options.formId=t;this.options.formName=e;this.reload()},loadElementList:function(){if(!this.category){var t=new Element("div",{styles:this.css.noElementNode,text:"请先新建或选择分类"}).inject(this.elementContentListNode)}else if(this.category.options.isNew){var t=new Element("div",{styles:this.css.noElementNode,text:"请先保存分类"}).inject(this.elementContentListNode)}else{this._loadItemDataList(function(t){if(t.data.length){t.data.each(function(t){var e=this._getItemObject(t,this.itemArray.length+1);
e.load();this.itemObject[t.id]=e;this.itemArray.push(e)}.bind(this))}else{var e=new Element("div",{styles:this.css.noElementNode,text:"未设置表单“"+(this.options.formName||"")+"”的关联列表，点击创建关联列表"}).inject(this.elementContentListNode);if(!this.options.noCreate){e.addEvent("click",function(t){this._createView(t)}.bind(this))}}}.bind(this))}},_loadItemDataList:function(t){var e=this.options.categoryId;var i=this.options.formId;this.categoryViewData=[];this.categoryViewIds=[];if(i){if(e){this.actions.listViewByCategory(e,function(t){this.categoryViewData=t.data;t.data.each(function(t){this.categoryViewIds.push(t.id)}.bind(this))}.bind(this),null,false)}this.actions.listViewByForm(i,t)}else{var s=new Element("div",{styles:this.css.noElementNode,text:e?"请先设置分类的编辑表单！":"请先选择分类！"}).inject(this.elementContentListNode)}},_createView:function(){if(this.options.formId){this._createElementByForm()}else{this._createElement()}},_createElementByForm:function(t){var e=this;layout.desktop.getFormDesignerStyle(function(){var i={style:layout.desktop.formDesignerStyle,onQueryLoad:function(){this.actions=e.app.restActions;this.column=e.app.options.column;this.application=e.app.options.column;this.relativeForm={name:e.options.formName,id:e.options.formId}},onPostSave:function(){e.reload()}};layout.desktop.openApplication(t,"cms.ViewDesigner",i)}.bind(this))},_getItemObject:function(t,e){var i=this.options.defaultViewId==t.id;var s=new MWF.xApplication.cms.ApplicationManager.CategoryExplorer.View(this,t,{isCategoryView:this.categoryViewIds.indexOf(t.id)>-1,isCategoryDefaultView:i,index:e});if(i)this.defaultView=s;return s},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node);this.elementContentListNode=new Element("div",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);this.setContentSize();this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0};var e=this.node.getSize();var i=this.elementContentNode.getStyle("padding-top").toFloat();var s=this.elementContentNode.getStyle("padding-bottom").toFloat();var o=e.y-t.y-i-s;var n=e.x;this.elementContentNode.setStyle("height",""+o+"px");this.elementContentListNode.setStyles({width:""+n+"px"})}});MWF.xApplication.cms.ApplicationManager.CategoryExplorer.View=new Class({Extends:MWF.xApplication.cms.ApplicationManager.ViewExplorer.View,Implements:[Options],options:{where:"bottom",isCategoryView:false,isCategoryDefaultView:false,index:1},initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.css=this.explorer.css;this.data=e;this.container=this.explorer.elementContentListNode;this.icon=this._getIcon()},load:function(){this.node=new Element("div",{styles:this.css.itemNode,events:{mouseover:function(){this.node.setStyle("background-color","#f0f0f0")}.bind(this),mouseout:function(){var t=this.options.index%2==0?"#f7f7f7":"#fff";this.node.setStyle("background-color",t)}.bind(this)}}).inject(this.container);this.itemStatusNode=new Element("div",{styles:this.css.itemStatusNode}).inject(this.node);this.itemStatusTopNode=new Element("div",{styles:this.css.itemStatusTopNode}).inject(this.itemStatusNode);this.itemStatusBottomNode=new Element("div",{styles:this.css.itemStatusBottomNode}).inject(this.itemStatusNode);if(this.data.name.icon)this.icon=this.data.name.icon;var t=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon;var e=new Element("div",{styles:this.css.itemIconNode}).inject(this.node);e.setStyle("background","url("+t+") center center no-repeat");e.makeLnk({par:this._getLnkPar()});this.actionsArea=new Element("div.actionsArea",{styles:this.css.actionsArea}).inject(this.node);this.cancelCategoryViewAction=new Element("div.cancelCategoryViewAction",{styles:this.css.cancelCategoryViewAction,title:"取消分类列表"}).inject(this.actionsArea);this.cancelCategoryViewAction.addEvents({click:function(t){this.cancelCategoryView()}.bind(this)});this.setCategoryViewAction=new Element("div.setCategoryViewAction",{styles:this.css.setCategoryViewAction,title:"设为分类列表"}).inject(this.actionsArea);this.setCategoryViewAction.addEvents({click:function(t){this.setCategoryView()}.bind(this),mouseover:function(t){this.setCategoryViewAction.setStyles(this.css.setCategoryViewAction_selected)}.bind(this),mouseout:function(t){this.setCategoryViewAction.setStyles(this.css.setCategoryViewAction)}.bind(this)});if(this.options.isCategoryView){this.setCategoryViewAction.setStyle("display","none")}else{this.cancelCategoryViewAction.setStyle("display","none")}this.setDefaultCategoryViewAction=new Element("div.setDefaultCategoryViewAction",{styles:this.css.setDefaultCategoryViewAction,title:"设为分类默认列表"}).inject(this.actionsArea);this.setDefaultCategoryViewAction.addEvents({click:function(t){this.setDefaultCategoryView()}.bind(this),mouseover:function(t){if(!this.options.isCategoryDefaultView)this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction_selected)}.bind(this),mouseout:function(t){if(!this.options.isCategoryDefaultView)this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction)}.bind(this)});if(!this.explorer.options.noDelete){this.deleteActionNode=new Element("div.deleteAction",{styles:this.css.deleteAction,title:"删除"}).inject(this.actionsArea);this.deleteActionNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this));this.deleteActionNode.addEvents({mouseover:function(t){this.deleteActionNode.setStyles(this.css.deleteAction_over)}.bind(this),mouseout:function(t){this.deleteActionNode.setStyles(this.css.deleteAction)}.bind(this)})}var i=new Element("div",{styles:this.css.itemInforNode}).inject(this.node);var s=new Element("div",{styles:this.css.itemInforBaseNode}).inject(i);new Element("div",{styles:this.css.itemTextTitleNode,text:this.data.name,title:this.data.name,events:{click:function(t){this._open(t);t.stopPropagation()}.bind(this)}}).inject(s);new Element("div",{styles:this.css.itemTextDateNode,text:this.data.updateTime||""}).inject(s);this.setStyle()},setCategoryView:function(){if(this.options.isCategoryView){return}this.options.isCategoryView=true;this.setCategoryViewAction.setStyle("display","none");this.cancelCategoryViewAction.setStyle("display","");this.explorer.category.setCategoryView(this.data.id,this.data.name);this.setStyle()},cancelCategoryView:function(){if(!this.options.isCategoryView){return}this.options.isCategoryView=false;this.setCategoryViewAction.setStyle("display","");this.cancelCategoryViewAction.setStyle("display","none");this.explorer.category.cancelCategoryView(this.data.id,this.data.name);this.setStyle()},setDefaultCategoryView:function(){if(this.explorer.defaultView){this.explorer.defaultView.cancelDefaultView()}this.explorer.category.setDefaultCategoryView(this.data.id,this.data.name);this.options.isCategoryDefaultView=true;this.explorer.defaultView=this;this.setStyle()},cancelDefaultView:function(){this.options.isCategoryDefaultView=false;this.setStyle()},setStyle:function(){if(this.options.isCategoryDefaultView&&this.options.isCategoryView){this.itemStatusTopNode.setStyles({"background-color":"#3c76b7"});this.itemStatusBottomNode.setStyles({"background-color":"#50e3c2"});this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction_selected);this.setCategoryViewAction.setStyles(this.css.setCategoryViewAction_selected)}else if(this.options.isCategoryView){this.itemStatusTopNode.setStyles({"background-color":"#3c76b7"});this.itemStatusBottomNode.setStyles({"background-color":"#3c76b7"});this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction);this.setCategoryViewAction.setStyles(this.css.setCategoryViewAction_selected)}else if(this.options.isCategoryDefaultView){this.itemStatusTopNode.setStyles({"background-color":"#50e3c2"});this.itemStatusBottomNode.setStyles({"background-color":"#50e3c2"});this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction_selected);this.setCategoryViewAction.setStyles(this.css.setCategoryViewAction)}else{var t=this.options.index%2==0?"#f7f7f7":"#fff";this.node.setStyle("background-color",t);this.itemStatusTopNode.setStyles({"background-color":t});this.itemStatusBottomNode.setStyles({"background-color":t});this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction);this.setCategoryViewAction.setStyles(this.css.setCategoryViewAction)}},_open:function(t){var e=this;var i={onQueryLoad:function(){this.actions=e.explorer.actions;this.category=e;this.options.id=e.data.id;this.column=e.explorer.app.options.column;this.application=e.explorer.app.options.column;this.options.noModifyName=e.explorer.options.noModifyName;this.options.readMode=e.explorer.options.readMode,this.options.formId=e.data.formId}};this.explorer.app.desktop.openApplication(t,"cms.ViewDesigner",i)},_getIcon:function(){var t=(Math.random()*33).toInt();return"process_icon_"+t+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/viewIcon/lnk.png",title:this.data.name,par:'cms.ViewDesigner#{"id": "'+this.data.id+'"}'}},deleteView:function(t){this.explorer.app.restActions.deleteView(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))}});