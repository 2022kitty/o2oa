MWF.xDesktop.requireApp("VsettanMail","Actions.RestActions",null,false);MWF.xApplication.VsettanMail=MWF.xApplication.VsettanMail||{};MWF.xApplication.VsettanMail.MailWidget=new Class({Extends:MWF.xApplication.Common.Widget,Implements:[Options,Events],options:{style:"default",title:MWF.xApplication.VsettanMail.LP.title,appName:"VsettanMail",name:"MailWidget",position:{right:10,bottom:10},width:"400",height:"550"},loadContent:function(t){this.ssoCount=0;this.widget.node.setStyle("display","none");this.action=new MWF.xApplication.VsettanMail.Actions.RestActions;if(this.desktop.session.user.name!="xadmin")this.getUnreadCount();this.widget.close()},setTimeout:function(){window.setTimeout(function(){this.getUnreadCount()}.bind(this),3e4)},getUnreadCount:function(){this.checkUser(function(t){this.getUnreadCountXml(t)}.bind(this))},getUnreadCountXml:function(t){var e=t+"/iNotes/Proxy/?OpenDocument&Form=s_ReadViewEntries_JSONP&PresetFields=FolderName;($Inbox),UnreadCountInfo;1,callback;Request.JSONP.request_map.request_"+Request.JSONP.counter+"&Start=1&Count=0";MWF.getJSONP(e,{onSuccess:function(t){if(t.unreadcount.toInt()>0)this.setFlagText(t.unreadcount);this.setTimeout()}.bind(this)})},checkUser:function(t,e){var i="http://"+layout.config.mail+"/land/xsso.nsf/(getUserMail)?openpage";MWF.getJSONP(i,{onSuccess:function(i){if(i.name==this.desktop.session.user.unique){this.ssoCount=0;if(t)t(i.mail)}else{if(!e){if(this.ssoCount<5){this.ssoMail(i.mail);this.ssoCount++}}}}.bind(this)},true)},ssoMail:function(){this.action.getPassword(function(t){var e="http://"+layout.config.mail+"/names.nsf?login?login&username="+this.desktop.session.user.unique+"&password="+t.data.password+"&RedirectTo=/land/xsso.nsf/(callback)?openpage";var i=new Element("iframe",{styles:{display:"none"}}).inject(this.desktop.desktopNode);i.set("src",e);window.setTimeout(function(){this.setTimeout();i.destroy();this.checkUser(function(t){this.getUnreadCountXml(t)}.bind(this),true)}.bind(this),2e3)}.bind(this))},setFlagText:function(t){this.unreadcount=t;this.desktop.lnks.each(function(e){if(e.par=="VsettanMail"){if(!e.flagNode){var i=this.createFlagNode();i.inject(e.node);e.flagNode=i;var n=e.node.getSize();var s=n.y;i.setStyles({top:"-"+s+"px"})}var o=t;if(t.toInt()>99)o="99+";e.flagNode.set("text",o)}}.bind(this));this.desktop.navi.navis.each(function(e){var i=e.retrieve("navi");if(i){if(i.action=="VsettanMail"){var n=e.retrieve("flagNode");if(!n){var s=this.createFlagNode();s.inject(e);e.store("flagNode",s);n=s;var o=e.getSize();var a=o.y-5;n.setStyles({top:"-"+a+"px","margin-right":"12px"})}var l=t;if(t.toInt()>99)l="99+";n.set("text",l)}}}.bind(this))},createFlagNode:function(t){var e=new Element("div",{styles:t||this.css.flagNode});return e}});