MWF.xApplication.cms.FormDesigner.Module=MWF.xApplication.cms.FormDesigner.Module||{};MWF.xDesktop.requireApp("cms.FormDesigner","Module.$Container",null,false);MWF.xDesktop.requireApp("cms.FormDesigner","Module.$Component",null,false);MWF.xDesktop.requireApp("cms.FormDesigner","Module.Datagrid$Data",null,false);MWF.xDesktop.requireApp("cms.FormDesigner","Module.Datagrid$Title",null,false);MWF.xDesktop.requireApp("cms.FormDesigner","Module.Table$Td",null,false);MWF.xApplication.cms.FormDesigner.Module.Datagrid=MWF.CMSFCDatagrid=new Class({Extends:MWF.CMSFC$Component,Implements:[Options,Events],options:{style:"default",propertyPath:"/x_component_cms_FormDesigner/Module/Datagrid/datagrid.html"},initialize:function(e,t){this.setOptions(t);this.path="/x_component_cms_FormDesigner/Module/Datagrid/";this.cssPath="/x_component_cms_FormDesigner/Module/Datagrid/"+this.options.style+"/css.wcss";this._loadCss();this.moduleType="component";this.moduleName="datagrid";this.form=e;this.container=null;this.containerNode=null;this.containers=[];this.elements=[];this.selectedMultiTds=[]},_createMoveNode:function(){var e='<table border="0" cellpadding="0" cellspacing="2" width="100%" align="center">';e+="<tr><th></th><th></th><th></th></tr>";e+="<tr><td></td><td></td><td></td></tr>";e+="</table>";this.moveNode=new Element("div",{html:e}).inject(this.form.container);this.moveNode.setStyles(this.css.moduleNodeMove);this._setTableStyle()},_setTableStyle:function(){var e=this.moveNode.getElements("td");e.setStyles({border:"1px dashed #999",height:"20px"});var e=this.moveNode.getElements("th");e.setStyles({background:"#C3CEEA",border:"1px dashed #999",height:"20px"})},_getContainers:function(){var e=this.node.getElements("td");this.form.getTemplateData("Datagrid$Data",function(t){e.each(function(e){var i=this.form.getDomjson(e);var s=null;if(!i){var o=Object.clone(t);s=new MWF.CMSFCDatagrid$Data(this.form);s.load(o,e,this)}else{s=new MWF.CMSFCDatagrid$Data(this.form);s.load(i,e,this)}this.containers.push(s)}.bind(this))}.bind(this))},_getElements:function(){var e=this.node.getElements("th");this.form.getTemplateData("Datagrid$Title",function(t){e.each(function(e){var i=this.form.getDomjson(e);var s=null;if(!i){var o=Object.clone(t);s=new MWF.CMSFCDatagrid$Title(this.form);s.load(o,e,this)}else{s=new MWF.CMSFCDatagrid$Title(this.form);s.load(i,e,this)}this.elements.push(s)}.bind(this))}.bind(this))},_createNode:function(e){var t=this;var i=this.path+"datagridCreate.html";MWF.require("MWF.widget.Dialog",function(){var s=$(document.body).getSize();var o=s.x/2-180;var n=s.y/2-130;var r=new MWF.DL({title:"Create Datagrid",style:"property",top:n,left:o-40,fromTop:s.y/2-65,fromLeft:s.x/2,width:360,height:260,url:i,buttonList:[{text:MWF.CMSFD.LP.button.ok,action:function(){t._createTableNode();e();this.close()}}]});r.show()}.bind(this))},_createTableNode:function(){var e=$("MWFNewTableColumn").get("value");var t=$("MWFNewTableWidth").get("value");var i=$("MWFNewTableWidthUnit");var s=i.options[i.selectedIndex].value;var o=$("MWFNewTableBorder").get("value");var n=$("MWFNewTableCellpadding").get("value");var r=$("MWFNewTableCellspacing").get("value");var a="";if(s=="percent"){a=t+"%"}else{a=t+"px"}this.json.properties.width=a;this.json.properties.border=o;this.json.properties.cellpadding=n;this.json.properties.cellspacing=r;var d='<table border="'+o+'" cellpadding="'+n+'" cellspacing="'+r+'" width="'+a+'" align="center">';d+="<tr>";for(var l=0;l<e.toInt();l++){d+="<th></th>"}d+="</tr>";d+="<tr>";for(var l=0;l<e.toInt();l++){d+="<td></td>"}d+="</tr></table>";this.node=new Element("div",{id:this.json.id,MWFType:"datagrid",html:d,styles:this.css.moduleNode,events:{selectstart:function(e){e.preventDefault()}}}).inject(this.form.node)},_dragComplete:function(){if(!this.node){this._createNode(function(){this._dragMoveComplete()}.bind(this))}else{this._dragMoveComplete()}},_dragMoveComplete:function(){this._resetTreeNode();this.node.inject(this.copyNode,"before");this._initModule();var e=this.node.retrieve("thisDisplay");if(e){this.node.setStyle("display",e)}if(this.copyNode)this.copyNode.destroy();if(this.moveNode)this.moveNode.destroy();this.moveNode=null;this.copyNode=null;this.nextModule=null;this.form.moveModule=null;this.form.json.moduleList[this.json.id]=this.json;this.selected()},_initModule:function(){this._getElements();this._getContainers();this._setNodeProperty();this._createIconAction();this._setNodeEvent()},setPropertiesOrStyles:function(e){if(e=="styles"){var t=this.node.getStyle("border");this.node.clearStyles();this.node.setStyles(this.css.moduleNode);this.node.setStyle("border",t);Object.each(this.json.styles,function(e,t){var i=/^border\w*/gi;if(!t.test(i)){this.node.setStyle(t,e)}}.bind(this))}if(e=="properties"){this.node.getFirst().setProperties(this.json.properties)}},_setEditStyle_custom:function(e,t,i){if(e=="id"){if(e!=i){var s=new RegExp("^"+i,"i");this.containers.each(function(e){var t=e.json.id;var i=t.replace(s,this.json.id);e.json.id=i;delete this.form.json.moduleList[t];this.form.json.moduleList[i]=e.json;e._setEditStyle("id")}.bind(this))}}},getContainerNodes:function(){return this.node.getElements("td")},copyComponentJsonData:function(e,t){var i=e.getElements("td");var s=e.getElements("th");i.each(function(e,i){var s=Object.clone(this.containers[i].json);s.id=this.containers[i]._getNewId(t);this.form.json.moduleList[s.id]=s;e.set("id",s.id)}.bind(this));s.each(function(e,i){var s=Object.clone(this.elements[i].json);s.id=this.elements[i]._getNewId(t);this.form.json.moduleList[s.id]=s;e.set("id",s.id)}.bind(this))}});