MWF.xApplication.cms.FormDesigner.Module=MWF.xApplication.cms.FormDesigner.Module||{};MWF.require("MWF.widget.Common",null,false);MWF.xApplication.cms.FormDesigner.Module.Form=MWF.CMSFCForm=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",propertyPath:"/x_component_cms_FormDesigner/Module/Form/form.html",mode:"PC"},initialize:function(e,t,i){this.setOptions(i);this.path="/x_component_cms_FormDesigner/Module/Form/";this.cssPath="/x_component_cms_FormDesigner/Module/Form/"+this.options.style+"/css.wcss";this._loadCss();this.container=null;this.form=this;this.moduleType="form";this.moduleList=[];this.moduleNodeList=[];this.moduleContainerNodeList=[];this.moduleElementNodeList=[];this.moduleComponentNodeList=[];this.dataTemplate={};this.designer=e;this.container=t;this.selectedModules=[]},load:function(e){this.data=e;this.json=e.json;this.html=e.html;this.json.mode=this.options.mode;this.isNewForm=this.json.id?false:true;if(this.isNewForm)this.checkUUID();if(this.designer.column)this.data.json.applicationName=this.designer.column.name;if(this.designer.column)this.data.json.application=this.designer.column.id;this.container.set("html",this.html);this.loadDomModules();this.setNodeEvents();this.selected();this.autoSave();this.designer.addEvent("queryClose",function(){if(this.autoSaveTimerID)window.clearInterval(this.autoSaveTimerID)}.bind(this))},autoSave:function(){this.autoSaveCheckNode=this.designer.formToolbarNode.getElement("#MWFFormAutoSaveCheck");if(this.autoSaveCheckNode){this.autoSaveTimerID=window.setInterval(function(){if(this.autoSaveCheckNode.get("checked")){this.save()}}.bind(this),6e4)}},checkUUID:function(){this.designer.actions.getUUID(function(e){this.json.id=e}.bind(this))},loadDomModules:function(){this.node=this.container.getFirst();this.node.set("id",this.json.id);this.node.setStyles(this.css.formNode);this.node.store("module",this);var e=this.container.getSize().y-2;this.node.setStyle("min-height",""+e+"px");this.designer.addEvent("resize",function(){var e=this.container.getSize().y-2;this.node.setStyle("min-height",""+e+"px")}.bind(this));this.loadDomTree()},loadDomTree:function(){MWF.require("MWF.widget.Tree",function(){this.domTree=new MWF.widget.Tree(this.designer.propertyDomArea,{style:"domtree"});this.domTree.load();this.createFormTreeNode();this.parseModules(this,this.node)}.bind(this))},createFormTreeNode:function(){var e={expand:true,title:this.json.id,text:"<"+this.json.type+"> "+this.json.name+" ["+this.options.mode+"] ",icon:this.options.mode=="Mobile"?"mobile.png":"pc.png"};e.action=function(){if(this.module)this.module.selected()};this.treeNode=this.domTree.appendChild(e);this.treeNode.module=this},parseModules:function(e,t){var i=t.getFirst();while(i){if(i.get("MWFtype")){var s=this.getDomjson(i);module=this.loadModule(s,i,e)}i=i.getNext()}},getDomjson:function(e){var t=e.get("MWFtype");switch(t){case"form":return this.json;case"":return null;default:var i=e.get("id");if(i){return this.json.moduleList[i]}else{return null}}},loadModule:function(e,t,i){var s=new MWF["CMSFC"+e.type](this);s.load(e,t,i);return s},setNodeEvents:function(){this.node.addEvent("click",function(e){this.selected()}.bind(this))},createModule:function(e,t){this.getTemplateData(e,function(i){var s=Object.clone(i);var o=new MWF["CMSFC"+e](this);o.create(s,t)}.bind(this))},getTemplateData:function(e,t){if(this.dataTemplate[e]){if(t)t(this.dataTemplate[e])}else{var i="/x_component_cms_FormDesigner/Module/"+e+"/template.json";MWF.getJSON(i,function(i,s){this.dataTemplate[e]=i;if(t)t(i)}.bind(this))}},selected:function(){if(this.currentSelectedModule){if(this.currentSelectedModule==this){return true}else{this.currentSelectedModule.unSelected()}}if(this.propertyMultiTd){this.propertyMultiTd.hide();this.propertyMultiTd=null}this.unSelectedMulti();this.currentSelectedModule=this;if(this.treeNode){this.treeNode.selectNode()}this.showProperty()},unSelectedMulti:function(){while(this.selectedModules.length){this.selectedModules[0].unSelectedMulti()}if(this.multimoduleActionsArea)this.multimoduleActionsArea.setStyle("display","none")},unSelectAll:function(){},_beginSelectMulti:function(){if(this.currentSelectedModule)this.currentSelectedModule.unSelected();this.unSelectedMulti();this.noSelected=true},_completeSelectMulti:function(){if(this.selectedModules.length<2){this.selectedModules[0].selected()}else{this._showMultiActions()}},createMultimoduleActionsArea:function(){this.multimoduleActionsArea=new Element("div",{styles:{display:"none",position:"absolute","background-color":"#F1F1F1",padding:"1px","padding-right":"0px",border:"1px solid #AAA","box-shadow":"0px 2px 5px #999","z-index":10001}}).inject(this.form.container,"after")},_showMultiActions:function(){if(!this.multimoduleActionsArea)this.createMultimoduleActionsArea();var e=this._getFirstMultiSelectedModule();if(e){var t=e.position.y-25;var i=e.position.x;this.multimoduleActionsArea.setPosition({x:i,y:t});this.multimoduleActionsArea.setStyle("display","block")}},_getFirstMultiSelectedModule:function(){var e=null;this.selectedModules.each(function(t){var i=t.node.getPosition(t.form.node.getOffsetParent());if(!e){e={module:t,position:i}}else{if(i.y<e.position.y){e={module:t,position:i}}else if(i.y==e.position.y){if(i.x<e.position.x){e={module:t,position:i}}}}});return e},showProperty:function(){if(!this.property){this.property=new MWF.xApplication.cms.FormDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)});this.property.load()}else{this.property.show()}},hideProperty:function(){if(this.property)this.property.hide()},unSelected:function(){this.currentSelectedModule=null;this.hideProperty()},_dragIn:function(e){if(!this.Component)e.inContainer=this;e.parentContainer=this;this.node.setStyles({border:"1px solid #ffa200"});var t=e._getCopyNode();t.inject(this.node)},_dragOut:function(e){e.inContainer=null;e.parentContainer=null;this.node.setStyles(this.css.formNode);this.node.setStyles(this.json.styles);var t=e._getCopyNode();t.setStyle("display","none")},_dragDrop:function(e){this.node.setStyles(this.css.formNode);this.node.setStyles(this.json.styles)},_clearNoId:function(e){var t=e.getFirst();while(t){var i=t.getNext();if(t.get("MWFType")){if(!t.get("id")){t.destroy()}else{if(t)this._clearNoId(t)}}else{if(t)this._clearNoId(t)}t=i}},_getFormData:function(){var e=this.node.clone(true,true);e.clearStyles(true);this._clearNoId(e);var t=e.outerHTML;e.destroy();this.data.json.mode=this.options.mode;this.data.html=t;return this.data},preview:function(){MWF.xDesktop.requireApp("cms.FormDesigner","Preview",function(){if(this.options.mode=="Mobile"){this.previewBox=new MWF.xApplication.cms.FormDesigner.Preview(this,{size:{x:"340",y:580}})}else{this.previewBox=new MWF.xApplication.cms.FormDesigner.Preview(this)}this.previewBox.load()}.bind(this))},save:function(e){this.designer.saveForm()},explode:function(){this._getFormData();MWF.require("MWF.widget.Base64",null,false);var e=MWF.widget.Base64.encode(JSON.encode(this.data));MWF.require("MWF.widget.Panel",function(){var e=new Element("div");var t=this.designer.formNode.getSize();var i=this.designer.formNode.getPosition(this.designer.formNode.getOffsetParent());var s=new Element("textarea",{styles:{border:"1px solid #999",width:"770px","margin-left":"14px","margin-top":"14px",height:"580px"},text:JSON.encode(this.data)}).inject(e);this.explodePanel=new MWF.widget.Panel(e,{style:"form",isResize:false,isMax:false,title:"",width:800,height:660,top:i.y,left:i.x+3,isExpand:false,target:this.designer.node});this.explodePanel.load()}.bind(this))},setPropertiesOrStyles:function(e){if(e=="styles"){this.setCustomStyles()}if(e=="properties"){this.node.setProperties(this.json.properties)}},setCustomStyles:function(){var e=this.node.getStyle("border");this.node.clearStyles();this.node.setStyles(this.css.formNode);var t=this.container.getSize().y-2;this.node.setStyle("min-height",""+t+"px");if(this.initialStyles)this.node.setStyles(this.initialStyles);this.node.setStyle("border",e);Object.each(this.json.styles,function(e,t){var i=/^border\w*/gi;if(!t.test(i)){this.node.setStyle(t,e)}}.bind(this))},_setEditStyle:function(e,t,i){if(e=="name"){var s=this.json.name||this.json.id;this.treeNode.setText("<"+this.json.type+"> "+s)}if(e=="id"){if(!this.json.name)this.treeNode.setText("<"+this.json.type+"> "+this.json.id);this.treeNode.setTitle(this.json.id);this.node.set("id",this.json.id)}this._setEditStyle_custom(e,t,i)},_setEditStyle_custom:function(){}});