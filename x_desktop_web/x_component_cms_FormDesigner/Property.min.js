MWF.require("MWF.widget.Common",null,false);MWF.xApplication.cms.FormDesigner.Property=MWF.CMSFCProperty=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",path:"/x_component_cms_FormDesigner/property/property.html"},initialize:function(t,e,i,n){this.setOptions(n);this.module=t;this.form=t.form;this.data=t.json;this.htmlPath=this.options.path;this.designer=i;this.propertyNode=e},load:function(){if(this.fireEvent("queryLoad")){MWF.getRequestText(this.htmlPath,function(t,e){this.htmlString=t;MWF.require("MWF.widget.JsonTemplate",function(){this.fireEvent("postLoad")}.bind(this))}.bind(this))}this.propertyNode.addEvent("keydown",function(t){t.stopPropagation()})},editProperty:function(t){},show:function(){if(!this.propertyContent){if(this.htmlString){this.JsonTemplate=new MWF.widget.JsonTemplate(this.data,this.htmlString);this.propertyContent=new Element("div",{styles:{overflow:"hidden"}}).inject(this.propertyNode);this.propertyContent.set("html",this.JsonTemplate.load());this.setEditNodeEvent();this.setEditNodeStyles(this.propertyContent);this.loadPropertyTab();this.loadMaplist();this.loadScriptArea();this.loadHtmlEditorArea();this.loadTreeData();this.loadArrayList();this.loadEventsEditor();this.loadQueryViewSelect();this.loadActionArea();this.loadHTMLArea();this.loadJSONArea()}}else{this.propertyContent.setStyle("display","block")}},hide:function(){if(this.propertyContent)this.propertyContent.setStyle("display","none")},loadTreeData:function(){var t=this.propertyContent.getElements(".MWFTreeData");t.each(function(t){var e=t.get("title");var i=t.get("name");var n=this.data[i];if(!n)n=[];MWF.require("MWF.widget.TreeEditor",function(){var s=new MWF.widget.TreeEditor(t,{title:e,maxObj:this.propertyNode.parentElement.parentElement.parentElement,onChange:function(){this.data[i]=s.toJson();this.module.json[i]=this.data[i];this.module._refreshTree()}.bind(this)});s.load(n)}.bind(this));t.addEvent("keydown",function(t){t.stopPropagation()})}.bind(this))},loadJSONArea:function(){var t=this.propertyContent.getElement(".MWFJSONArea");if(t){this.propertyTab.pages.each(function(e){if(e.contentNode==t.parentElement){e.setOptions({onShow:function(){MWF.require("MWF.widget.JsonParse",function(){this.json=new MWF.widget.JsonParse(this.module.json,t,null);this.json.load()}.bind(this))}.bind(this)})}}.bind(this))}},loadHTMLArea:function(){var t=this.propertyContent.getElement(".MWFHTMLArea");if(t){var e=this.module.node.clone(true,true);e.clearStyles(true);t.set("text",e.outerHTML);e.destroy();this.propertyTab.pages.each(function(e){if(e.contentNode==t.parentElement){e.setOptions({onShow:function(){var e=this.module.node.clone(true,true);e.clearStyles(true);t.set("text",e.outerHTML);e.destroy()}.bind(this)})}}.bind(this))}},loadQueryViewSelect:function(){var t=this.propertyContent.getElements(".MWFQueryViewSelect");if(t.length){this.getQueryViewList(function(){t.each(function(t){var e=new Element("select").inject(t);e.addEvent("change",function(t){var e=t.target.options[t.target.selectedIndex].value;var i=t.target.options[t.target.selectedIndex].get("text");this.setValue(t.target.getParent("div").get("name"),e);this.setValue(t.target.getParent("div").get("name")+"Name",i)}.bind(this));this.setQueryViewSelectOptions(t,e);var i=new Element("div",{styles:this.form.css.propertyRefreshFormNode}).inject(t);i.addEvent("click",function(i){this.getQueryViewList(function(){this.setQueryViewSelectOptions(t,e)}.bind(this),true)}.bind(this))}.bind(this))}.bind(this))}},setQueryViewSelectOptions:function(t,e){var i=t.get("name");e.empty();var n=new Element("option",{text:"none"}).inject(e);this.queryviews.each(function(t){var n=new Element("option",{text:t.name,value:t.id,selected:this.data[i]==t.id}).inject(e)}.bind(this))},getQueryViewList:function(t,e){if(!this.queryviews||e){this.form.designer.actions.listQueryView(this.form.designer.application.id,function(e){this.queryviews=e.data;if(t)t()}.bind(this))}else{if(t)t()}},loadEventsEditor:function(){var t=this.propertyContent.getElement(".MWFEventsArea");if(t){var e=t.get("name");var i=this.data[e];MWF.xDesktop.requireApp("cms.FormDesigner","widget.EventsEditor",function(){var e=new MWF.xApplication.cms.FormDesigner.widget.EventsEditor(t,this.designer,{maxObj:this.designer.formContentNode});e.load(i)}.bind(this))}},loadArrayList:function(){var t=this.propertyContent.getElements(".MWFArraylist");t.each(function(t){var e=t.get("title");var i=t.get("name");var n=this.data[i];if(!n)n=[];MWF.require("MWF.widget.Arraylist",function(){var s=new MWF.widget.Arraylist(t,{title:e,onChange:function(){this.data[i]=s.toArray()}.bind(this)});s.load(n)}.bind(this));t.addEvent("keydown",function(t){t.stopPropagation()})}.bind(this))},loadHtmlEditorArea:function(){var t=this.propertyContent.getElements(".MWFHtmlEditorArea");t.each(function(t){var e=t.get("title");var i=t.get("name");var n=this.data[i];MWF.require("MWF.widget.HtmlEditorArea",function(){var s=new MWF.widget.HtmlEditorArea(t,{title:e,maxObj:this.designer.formContentNode,onChange:function(){this.data[i]=s.getValue();this.changeData(i)}.bind(this),onSave:function(){this.designer.saveForm()}.bind(this)});s.load({code:n})}.bind(this))}.bind(this))},loadScriptArea:function(){var t=this.propertyContent.getElements(".MWFScriptArea");var e=this.propertyContent.getElements(".MWFFormulaArea");this.loadScriptEditor(t);this.loadScriptEditor(e,"formula")},loadScriptEditor:function(t,e){t.each(function(t){var i=t.get("title");var n=t.get("name");var s=this.data[n];MWF.require("MWF.widget.ScriptArea",function(){var o=new MWF.widget.ScriptArea(t,{title:i,maxObj:this.designer.formContentNode,onChange:function(){this.data[n]=o.toJson()}.bind(this),onSave:function(){this.designer.saveForm()}.bind(this),style:e||"default",helpStyle:"cms"});o.load(s)}.bind(this))}.bind(this))},loadActionArea:function(){var t=this.propertyContent.getElements(".MWFActionArea");t.each(function(t){var e=t.get("name");var i=this.data[e];MWF.xDesktop.requireApp("cms.FormDesigner","widget.ActionsEditor",function(){var n=new MWF.xApplication.cms.FormDesigner.widget.ActionsEditor(t,this.designer,{maxObj:this.propertyNode.parentElement.parentElement.parentElement,onChange:function(){this.data[e]=n.data}.bind(this)});n.load(i)}.bind(this))}.bind(this))},loadMaplist:function(){var t=this.propertyContent.getElements(".MWFMaplist");t.each(function(t){var e=t.get("title");var i=t.get("name");var n=t.get("collapse");var s=this.data[i];if(!s)s={};MWF.require("MWF.widget.Maplist",function(){var o=new MWF.widget.Maplist(t,{title:e,collapse:n?true:false,onChange:function(){this.changeJsonDate(i,o.toJson());this.changeStyle(i);this.changeData(i)}.bind(this)});o.load(s)}.bind(this))}.bind(this))},loadPropertyTab:function(){var t=this.propertyContent.getElements(".MWFTab");if(t.length){var e=this.propertyContent.getFirst();var i=new Element("div",{styles:this.form.css.propertyTabNode}).inject(e,"before");MWF.require("MWF.widget.Tab",function(){var e=new MWF.widget.Tab(i,{style:"formPropertyList"});e.load();var n=[];t.each(function(t){var i=e.addTab(t,t.get("title"),false);n.push(i);this.setScrollBar(i.contentNodeArea,"small",null,null)}.bind(this));n[0].showTab();this.propertyTab=e;this.designer.resizeNode()}.bind(this),false)}},setEditNodeEvent:function(){var t=this;var e=this.propertyContent.getElements("input");e.each(function(e){var i=e.get("name");if(this.module){var n=this.module.json.id;e.set("name",n+i)}if(i){var s=e.get("type").toLowerCase();switch(s){case"radio":e.addEvent("change",function(e){t.setRadioValue(i,this)});e.addEvent("blur",function(e){t.setRadioValue(i,this)});e.addEvent("keydown",function(t){t.stopPropagation()});break;case"checkbox":e.addEvent("change",function(e){t.setCheckboxValue(i,this)});e.addEvent("click",function(e){t.setCheckboxValue(i,this)});e.addEvent("keydown",function(t){t.stopPropagation()});break;default:e.addEvent("change",function(e){t.setValue(i,this.value,this)});e.addEvent("blur",function(e){t.setValue(i,this.value,this)});e.addEvent("keydown",function(e){if(e.code==13){t.setValue(i,this.value,this)}e.stopPropagation()})}}}.bind(this));var i=this.propertyContent.getElements("select");i.each(function(e){var i=e.get("name");if(i){e.addEvent("change",function(e){t.setSelectValue(i,this)})}});var n=this.propertyContent.getElements("textarea");n.each(function(e){var i=e.get("name");if(i){e.addEvent("change",function(e){t.setValue(i,this.value)});e.addEvent("blur",function(e){t.setValue(i,this.value)});e.addEvent("keydown",function(t){t.stopPropagation()})}}.bind(this))},changeStyle:function(t){this.module.setPropertiesOrStyles(t)},changeData:function(t,e,i){this.module._setEditStyle(t,e,i)},changeJsonDate:function(t,e){this.data[t]=e},setRadioValue:function(t,e){if(e.checked){var i=e.value;if(i=="false")i=false;if(i=="true")i=true;var n=this.data[t];this.changeJsonDate(t,i);this.changeData(t,e,n)}},setCheckboxValue:function(t,e){var i=$$("input:[name='"+t+"']");var n=[];i.each(function(t){if(t.get("checked")){n.push(t.value)}});var s=this.data[t];this.changeJsonDate(t,n);this.changeData(t,e,s)},setSelectValue:function(t,e){var i=e.selectedIndex;var n=e.getElements("option");var s="";if(n[i]){s=n[i].get("value")}var o=this.data[t];this.changeJsonDate(t,s);this.changeData(t,e,o)},setValue:function(t,e,i){if(t=="id"){if(e!=this.module.json.id){if(!e){this.designer.notice(MWF.CMSFD.LP.notNullId,"error",this.module.form.designer.propertyContentArea,{x:"right",y:"bottom"});i.focus();return false}else if(this.module.form.json.moduleList[e]){this.designer.notice("error",MWF.CMSFD.LP.repetitionsId,this.module.form.designer.propertyContentArea,{x:"right",y:"bottom"});i.focus();return false}else{var n=this.module.form.json.moduleList[this.module.json.id];this.module.form.json.moduleList[e]=n;delete this.module.form.json.moduleList[this.module.json.id]}}}var s=this.data[t];this.changeJsonDate(t,e);this.changeData(t,i,s)},setEditNodeStyles:function(t){var e=t.getChildren();if(e.length){e.each(function(t){var e=t.get("class");if(e){if(this.form.css[e])t.setStyles(this.form.css[e])}this.setEditNodeStyles(t)}.bind(this))}},loadScriptInput:function(){var t=this.propertyContent.getElements(".MWFScript");t.each(function(t){MWF.require("MWF.widget.ScriptEditor",function(){var e=new MWF.widget.ScriptEditor(t,{onPostSave:function(e){this.saveScriptItem(t,e)}.bind(this),onQueryDelete:function(e){this.deleteScriptItem(t,e)}.bind(this)});this.setScriptItems(e,t)}.bind(this))}.bind(this))},deleteScriptItem:function(t,e){var i=t.get("name");this.data[i].erase(e.data.id);this.cms.scripts[e.data.id]=null;delete this.cms.scripts[e.data.id];this.cms.cms.scriptList.erase(e.data)},saveScriptItem:function(t,e){var i=t.get("name");var n=this.data[i];var s=e.data;var o=this.cms.scripts[e.data.id];if(!o){this.cms.cms.scriptList.push(s);this.cms.scripts[e.data.id]=s}if(n.indexOf(s.id)==-1){this.data[i].push(s.id)}},setScriptItems:function(t,e){var i=e.get("name");var n=this.data[i];n.each(function(e){if(e){var i=this.cms.scripts[e];if(i)t.setScriptItem(i)}}.bind(this))}});MWF.xApplication.cms.FormDesigner.PropertyMulti=new Class({Extends:MWF.xApplication.cms.FormDesigner.Property,Implements:[Options,Events],initialize:function(t,e,i,n,s){this.setOptions(s);this.modules=e;this.form=t;this.data={};this.htmlPath=this.options.path;this.designer=n;this.propertyNode=i},load:function(){if(this.fireEvent("queryLoad")){MWF.getRequestText(this.htmlPath,function(t,e){this.htmlString=t;MWF.require("MWF.widget.JsonTemplate",function(){this.fireEvent("postLoad")}.bind(this))}.bind(this))}},show:function(){if(!this.propertyContent){if(this.htmlString){this.JsonTemplate=new MWF.widget.JsonTemplate({},this.htmlString);this.propertyContent=new Element("div",{styles:{overflow:"hidden"}}).inject(this.propertyNode);this.propertyContent.set("html",this.JsonTemplate.load());this.setEditNodeEvent();this.setEditNodeStyles(this.propertyContent);this.loadPropertyTab();this.loadMaplist();this.loadScriptArea();this.loadTreeData();this.loadArrayList()}}else{this.propertyContent.setStyle("display","block")}},hide:function(){if(this.propertyContent)this.propertyContent.destroy()},changeStyle:function(t){this.modules.each(function(e){e.setPropertiesOrStyles(t)}.bind(this))},changeData:function(t,e,i){this.modules.each(function(n){n._setEditStyle(t,e,i)}.bind(this))},changeJsonDate:function(t,e){this.modules.each(function(i){i.json[t]=e}.bind(this))}});