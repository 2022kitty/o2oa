MWF.xApplication.cms.Document=MWF.xApplication.cms.Document||{};MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.require("MWF.widget.ImageClipper",null,false);MWF.xApplication.cms.Document.ImageClipper=new Class({Extends:MWF.widget.ImageClipper,initialize:function(t,e,i,s){this.node=t;this.setOptions(e);this.parent=i;this.docId=s;this.path=MWF.defaultPath+"/widget/$ImageClipper/";this.cssPath=MWF.defaultPath+"/widget/$ImageClipper/"+this.options.style+"/css.wcss";this._loadCss();this.fireEvent("init")},_createUploadButtom:function(){this.uploadCurrentFile=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:"选择本文档图片"}).inject(this.uploadToolbar);this.uploadCurrentFile.addEvents({click:function(){this.selectDocPicture(function(t,e){this.loadImageAsUrl(t)}.bind(this))}.bind(this)})},selectDocPicture:function(t){MWF.xDesktop.requireApp("cms.Document","Attachment",null,false);this.parent.actions.listAttachment(this.docId,function(e){this.selector_doc=new MWF.xApplication.cms.Document.Attachment(document.body,this.parent,this.parent.actions,this.parent.lp,{isNew:false,isEdited:false,onUpload:function(t){this.attachment.attachmentController.addAttachment(t);this.attachment.attachmentController.checkActions()}.bind(this)});this.selector_doc.data=e.data||[];this.selector_doc.loadAttachmentSelecter({style:"cms",title:"选择本文档图片",listStyle:"preview",toBase64:true,selectType:"images"},function(e,i,s){if(t)t(e,s)}.bind(this))}.bind(this))}});MWF.xApplication.cms.Document.HotLinkForm=new Class({Extends:MWF.xApplication.Template.Explorer.PopupForm,Implements:[Options,Events],options:{style:"default",width:"900",height:"620",hasTop:true,hasIcon:false,hasTopIcon:false,hasTopContent:true,hasBottom:true,title:"设置热点",draggable:true,closeAction:true,toMain:true,documentId:""},_createTableContent:function(){this.actions.getHotPic("CMS",this.options.documentId,function(t){if(t.data&&t.data.length>0){this.isNew=false}else{this.isNew=true}this.hotPicData=t.data&&t.data.length>0?t.data[0]:{};var e="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr>"+"   <td styles='formTableTitle' lable='hotPicture'></td>"+"   <td styles='formTableValue' item='hotPictureArea'></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle'></td>"+"   <td>"+this.lp.hotLinkDescription+"</td>"+"</tr>"+"</table>";this.formTableArea.set("html",e);MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:"cms",isEdited:true,itemTemplate:{hotPicture:{text:this.lp.hotPicture}}},this.app,this.css);this.form.load();this.createIconNode()}.bind(this),true)}.bind(this),null,false)},createIconNode:function(){var t=this.formTableArea.getElements("[item='hotPictureArea']")[0];MWF.require("MWF.widget.ImageClipper",function(){this.clipper=new MWF.xApplication.cms.Document.ImageClipper(t,{aspectRatio:1.5,formFileEnable:true},this,this.options.documentId);this.clipper.load(this.hotPicData.pictureBase64)}.bind(this))},selectDocPicture:function(){MWF.xDesktop.requireApp("cms.Document","Attachment",function(){this.actions.listAttachment(this.options.documentId,function(t){this.selector_doc=new MWF.xApplication.cms.Document.Attachment(document.body,this,this.actions,this.lp,{isNew:false,isEdited:false,onUpload:function(t){this.attachment.attachmentController.addAttachment(t);this.attachment.attachmentController.checkActions()}.bind(this)});this.selector_doc.data=t.data||[];this.selector_doc.loadAttachmentSelecter({style:"cms",title:"选择本文档图片",listStyle:"preview",selectType:"images"},function(t,e,i){this.iconNode.set("src",i||t);this.hotPicData.pictureBase64=i||t}.bind(this))}.bind(this))}.bind(this),true)},selectFilePicture:function(){var t=this;MWF.xDesktop.requireApp("File","FileSelector",function(){t.selector_cloud=new MWF.xApplication.File.FileSelector(document.body,{style:"default",title:"选择云文件图片",listStyle:"preview",toBase64:true,selectType:"images",onPostSelectAttachment:function(e,i){t.iconNode.set("src",i||e);t.hotPicData.pictureBase64=i||e}});t.selector_cloud.load()},true)},_createBottomContent:function(){this.closeActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.close}).inject(this.formBottomNode);this.closeActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this));if(!this.isNew){this.cancelHotActionNode=new Element("div.formOkActionNode",{styles:this.css.cancelHotPicture,text:this.lp.cancelHotPicture}).inject(this.formBottomNode);this.cancelHotActionNode.addEvent("click",function(t){this.cancelHotPic(t)}.bind(this))}this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.setHotPicture}).inject(this.formBottomNode);this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))},cancelHotPic:function(t){var e=this;this.app.confirm("warn",t,this.lp.cancelHotPicComfirmTitle,this.lp.cancelHotPicComfirmContent,350,120,function(){e._cancelHotPic(e.data,false);this.close()},function(){this.close()})},_cancelHotPic:function(){this.actions.removeHotPic(this.hotPicData.id,function(t){if(t.type=="error"){this.app.notice(t.userMessage,"error")}else{this.formMarkNode.destroy();this.formAreaNode.destroy();this.app.notice(this.lp.cancelHotLinkSuccess,"success")}}.bind(this))},ok:function(t){this.fireEvent("queryOk");var e=this.clipper.getBase64Image();if(!e||e==""){this.app.notice(this.lp.unselectHotPic,"error");return}this.hotPicData.pictureBase64=e;this.hotPicData.infoId=this.options.documentId;this.hotPicData.url=this.options.documentId;this.hotPicData.title=this.data.title;this.hotPicData.application="CMS";this.hotPicData.creator=layout.desktop.session.user.name;this._ok(this.hotPicData,function(t){if(t.type=="error"){this.app.notice(t.userMessage,"error")}else{this.formMarkNode.destroy();this.formAreaNode.destroy();this.app.notice(this.lp.setHotLinkSuccess,"success");this.fireEvent("postOk",t.data.id)}}.bind(this))},_ok:function(t,e){this.actions.saveHotPic(t,function(t){if(e)e(t)}.bind(this))},_close:function(){this.clipper.close()}});