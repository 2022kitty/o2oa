MWF.require("MWF.widget.Tree",null,false);MWF.xApplication.Organization.OrgExplorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(i);this.path="/x_component_Organization/$OrgExplorer/";this.cssPath="/x_component_Organization/$OrgExplorer/"+this.options.style+"/css.wcss";this._loadCss();this.deleteElements=[];this.actions=e;this.node=$(t)},load:function(){MWF.AC.getCompanyList();this.loadLayout();this.loadChart()},loadLayout:function(){this.chartAreaNode=new Element("div",{styles:this.css.chartAreaNode}).inject(this.node);this.propertyAreaNode=new Element("div",{styles:this.css.propertyAreaNode}).inject(this.node);this.resizeBarNode=new Element("div",{styles:this.css.resizeBarNode}).inject(this.propertyAreaNode);this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.propertyAreaNode);this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode}).inject(this.propertyNode);this.propertyContentNode=new Element("div",{styles:this.css.propertyContentNode}).inject(this.propertyNode);this.loadToolbar();this.chartScrollNode=new Element("div",{styles:this.css.chartScrollNode}).inject(this.chartAreaNode);this.chartNode=new Element("div",{styles:this.css.chartNode}).inject(this.chartScrollNode);this.resizePropertyContentNode();this.app.addEvent("resize",function(){this.resizePropertyContentNode()}.bind(this));MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.chartScrollNode,{style:"xApp_Organization_Explorer",where:"before",distance:20,friction:4,axis:{x:false,y:true},onScroll:function(t){this.checkDeleteMasks()}.bind(this)});new MWF.widget.ScrollBar(this.propertyContentNode,{style:"xApp_Organization_Explorer",where:"before",distance:20,friction:4,axis:{x:false,y:true}})}.bind(this));this.propertyResize=new Drag(this.resizeBarNode,{snap:1,onStart:function(t,e){var i=e.event.clientX;var s=e.event.clientY;t.store("position",{x:i,y:s});var n=this.chartAreaNode.getSize();t.store("initialWidth",n.x)}.bind(this),onDrag:function(t,e){var i=e.event.clientX;var s=this.node.getSize();var n=t.retrieve("position");var o=t.retrieve("initialWidth").toFloat();var r=n.x.toFloat()-i.toFloat();var a=o-r;if(a>s.x/1.5)a=s.x/1.5;if(a<400)a=400;this.chartAreaNode.setStyle("width",a+1);this.propertyAreaNode.setStyle("margin-left",a)}.bind(this)})},resizePropertyContentNode:function(){var t=this.node.getSize();var e=this.propertyTitleNode.getSize();var i=this.propertyTitleNode.getStyle("margin-top").toFloat();var s=this.propertyTitleNode.getStyle("margin-bottom").toFloat();var n=this.propertyContentNode.getStyle("margin-top").toFloat();var o=this.propertyContentNode.getStyle("margin-bottom").toFloat();var r=t.y-e.y-i-s-n-o;this.propertyContentNode.setStyle("height",r);e=this.toolbarNode.getSize();i=this.toolbarNode.getStyle("margin-top").toFloat();s=this.toolbarNode.getStyle("margin-bottom").toFloat();n=this.toolbarNode.getStyle("margin-top").toFloat();o=this.toolbarNode.getStyle("margin-bottom").toFloat();r=t.y-e.y-i-s-n-o;this.chartScrollNode.setStyle("height",r)},loadToolbar:function(){this.toolbarNode=new Element("div",{styles:this.css.toolbarNode}).inject(this.chartAreaNode);if(MWF.AC.isCompanyCreator()){this.addTopCompanyNode=new Element("div",{styles:this.css.addTopCompanyNode}).inject(this.toolbarNode);this.addTopCompanyNode.addEvent("click",function(){this.addTopCompany()}.bind(this))}},createSearchNode:function(){this.searchNode=new Element("div",{styles:this.css.searchNode}).inject(this.toolbarNode);this.searchButtonNode=new Element("div",{styles:this.css.searchButtonNode,title:this.app.lp.search}).inject(this.searchNode);this.searchInputAreaNode=new Element("div",{styles:this.css.searchInputAreaNode}).inject(this.searchNode);this.searchInputBoxNode=new Element("div",{styles:this.css.searchInputBoxNode}).inject(this.searchInputAreaNode);this.searchInputNode=new Element("input",{type:"text",value:this.app.lp.searchText,styles:this.css.searchInputNode,"x-webkit-speech":"1"}).inject(this.searchInputBoxNode);var t=this;this.searchInputNode.addEvents({focus:function(){if(this.value==t.app.lp.searchText)this.set("value","")},blur:function(){if(!this.value)this.set("value",t.app.lp.searchText)},keydown:function(t){if(t.code==13){this.searchOrg();t.preventDefault()}}.bind(this),selectstart:function(t){t.preventDefault()}});this.searchButtonNode.addEvent("click",function(){this.searchOrg()}.bind(this))},addTopCompany:function(){var t=true;if(this.currentItem)t=this.currentItem.unSelected();if(t){var e=this._getAddCompanyData();var i=this._newElement(e,this);i.load();i.selected();i.editBaseInfor();new Fx.Scroll(this.chartScrollNode).toElementCenter(i.node)}else{this.app.notice(this.app.lp.organizationSave,"error",this.propertyContentNode)}},_newElement:function(t,e){return new MWF.xApplication.Organization.OrgExplorer.Company(t,e)},_getAddCompanyData:function(){return{name:"",superior:""}},_getAddDepartmentData:function(){return{name:"",superior:"",company:""}},searchOrg:function(){alert("--- search ---")},loadChart:function(){this.actions.listTopCompany(function(t){this.loadChartContent(t.data,"Company",null)}.bind(this))},loadChartContent:function(t,e,i){t.each(function(t){var s=new MWF.xApplication.Organization.OrgExplorer[e](t,this);if(i)s.parentItem=i;s.load();if(e=="Company"){this.loadChildCompanyNodes(s);this.loadChildDepartmentNodes(s)}else{this.loadChildSubDepartmentNodes(s)}}.bind(this))},loadChildCompanyNodes:function(t,e){this.actions.listSubCompany(function(e){this.loadChartContent(e.data,"Company",t)}.bind(this),null,t.data.id)},loadChildDepartmentNodes:function(t){this.actions.listDepartment(function(e){this.loadChartContent(e.data,"Department",t)}.bind(this),null,t.data.id)},loadChildSubDepartmentNodes:function(t){this.actions.listSubDepartment(function(e){this.loadChartContent(e.data,"Department",t)}.bind(this),null,t.data.id)},checkDeleteMasks:function(t){this.deleteElements.each(function(t){var e=this.chartScrollNode.getElementById("mask"+t.data.id);if(e){e.position({relativeTo:t.childNode,position:"upperLeft",edge:"upperLeft"})}}.bind(this))},checkDeleteElements:function(){if(this.deleteElements.length){if(!this.deleteElementsNode){this.deleteElementsNode=new Element("div",{styles:this.css.deleteGroupsNode,text:this.app.lp.deleteOrganization}).inject(this.node);this.deleteElementsNode.position({relativeTo:this.chartScrollNode,position:"centerTop",edge:"centerTop"});this.deleteElementsNode.addEvent("click",function(t){this.deleteSelectedElements(t)}.bind(this))}}else{if(this.deleteElementsNode){this.deleteElementsNode.destroy();this.deleteElementsNode=null;delete this.deleteElementsNode}}},checkDeleteElementsConfirm:function(){var t=this.app.lp.deleteOrganizationConfirm;var e={x:300,y:120};for(var i=0;i<this.deleteElements.length;i++){var s=this.deleteElements[i];if(s.childNode.getFirst()){t=this.app.lp.deleteOrganizationSubConfirm;e={x:450,y:230};break}if(s.getDutyCount()>0){t=this.app.lp.deleteOrganizationAllConfirm;e={x:450,y:180};break}if(s.getAttributeCount()>0){t=this.app.lp.deleteOrganizationAllConfirm;e={x:450,y:180};break}if(s.getMemberCount()>0){t=this.app.lp.deleteOrganizationAllConfirm;e={x:450,y:180};break}}return{text:t,size:e}},deleteSelectedElements:function(t){var e=this;confirm=this.checkDeleteElementsConfirm();this.app.confirm("infor",t,this.app.lp.deleteOrganizationTitle,{html:confirm.text},confirm.size.x,confirm.size.y,function(){var t=[];var i=0;var s=e.deleteElements.length;var n="";var o=function(){if(i==s){if(n){e.app.notice(n,"error",e.propertyContentNode,{x:"left",y:"top"})}}};e.deleteElements.each(function(s){s["delete"](function(){t.push(s);i++;if(e.deleteElements.length==i){e.deleteElements=e.deleteElements.filter(function(e,i){return!t.contains(e)});e.checkDeleteElements()}o()},function(s){n=n?n+"<br/><br/>"+s:s;i++;if(e.deleteElements.length==i){e.deleteElements=e.deleteElements.filter(function(e,i){return!t.contains(e)});e.checkDeleteElements()}o()})});this.close()},function(){this.close()})}});MWF.xApplication.Organization.OrgExplorer.Item=new Class({initialize:function(t,e){this.data=t;this.explorer=e;this.chartNode=this.explorer.chartNode;this.prevItem=null;this.nextItem=null;this.parentItem=null;this.children=[];this.selectedDutys=[];this.selectedAttributes=[];this.isEdit=false;this.isEditor=false;this.deleteSelected=false;this.initStyle()},initStyle:function(){this.style=this.explorer.css.companyItem},load:function(){this.node=new Element("div",{styles:this.style.node}).inject(this.chartNode);this.contentNode=new Element("div",{styles:this.style.contentNode}).inject(this.node);this.childNode=new Element("div",{styles:this.style.childNode}).inject(this.node);this.childTween=new Fx.Tween(this.childNode,{duration:200,transition:Fx.Transitions.Quint.easeOut,onComplete:function(){var t=this.childNode.getSize().y;if(t>0)this.childNode.setStyle("height","auto")}.bind(this)});this.flagNode=new Element("div",{styles:this.style.flagNode}).inject(this.contentNode);this.flagIconNode=new Element("div",{styles:this.style.flagIconNode}).inject(this.flagNode);this.iconNode=new Element("div",{styles:this.style.iconNode}).inject(this.contentNode);this.actionNode=new Element("div",{styles:this.style.actionNode}).inject(this.contentNode);this.textNode=new Element("div",{styles:this.style.textNode}).inject(this.contentNode);this.textNode.set({text:this.data.name});this.setNewItem();if(this.parentItem){this.parentItem.children.push(this);this.parentItem.flagIconNode.setStyles(this.style.flagIconNode_e);this.node.inject(this.parentItem.childNode)}else{this.node.inject(this.chartNode)}this.addActions();this.setEvent()},setNewItem:function(){if(!this.created){if(!this.data.id){this.created=false;this.contentNode.setStyles(this.style.contentNodeNew)}else{this.created=true;this.contentNode.setStyles(this.style.contentNode)}}},getIndent:function(){return(this.data.level.toFloat()-1)*20},addActions:function(){MWF.AC.isCompanyEditor({id:this.data.id,yes:function(){this.isEditor=true;this.deleteNode=new Element("div",{styles:this.style.actionDeleteNode}).inject(this.actionNode);this.addDepartmentNode=new Element("div",{styles:this.style.actionAddDepartmentNode,title:this.explorer.app.lp.createSubDepartment}).inject(this.actionNode);this.addCompanyNode=new Element("div",{styles:this.style.actionAddCompanyNode,title:this.explorer.app.lp.createSubCompany}).inject(this.actionNode);this.actionConfigNode=new Element("div",{styles:this.style.actionConfigNode,title:this.explorer.app.lp.configCompany}).inject(this.actionNode);this.deleteNode.addEvent("click",function(t){this.deleteButton();t.stopPropagation()}.bind(this));this.addDepartmentNode.addEvent("click",function(t){if(!this.checkDelete())if(this.data.id)this.addDepartment();t.stopPropagation()}.bind(this));this.addCompanyNode.addEvent("click",function(t){if(!this.checkDelete())if(this.data.id)this.addCompany();t.stopPropagation()}.bind(this));this.actionConfigNode.addEvent("click",function(t){if(!this.checkDelete())if(this.data.id)this.configCompany(t);t.stopPropagation()}.bind(this))}.bind(this)})},deleteButton:function(){if(!this.deleteSelected){this.deleteNode.setStyles(this.style.actionDeleteNode_selected);this.contentNode.setStyles(this.style.contentNode_selected);this.node.setStyles(this.style.node_forDelete);if(this.addDepartmentNode)this.addDepartmentNode.setStyle("display","none");if(this.addCompanyNode)this.addCompanyNode.setStyle("display","none");if(this.actionConfigNode)this.actionConfigNode.setStyle("display","none");var t=[];this.explorer.deleteElements.each(function(e){if(this.childNode.contains(e.node)){e.deleteNode.setStyles(e.style.actionDeleteNode);e.contentNode.setStyles(e.style.contentNode);e.node.setStyles(this.style.node);if(e.addDepartmentNode)e.addDepartmentNode.setStyle("display","block");if(e.addCompanyNode)e.addCompanyNode.setStyle("display","block");if(e.actionConfigNode)e.actionConfigNode.setStyle("display","block");e.actionNode.setStyle("opacity","0");e.deleteSelected=false;t.push(e)}}.bind(this));t.each(function(t){this.explorer.deleteElements.erase(t)}.bind(this));this.explorer.deleteElements.push(this);this.deleteSelected=true;this.explorer.checkDeleteElements()}else{this.deleteNode.setStyles(this.style.actionDeleteNode);this.contentNode.setStyles(this.style.contentNode);this.node.setStyles(this.style.node);if(this.addDepartmentNode)this.addDepartmentNode.setStyle("display","block");if(this.addCompanyNode)this.addCompanyNode.setStyle("display","block");if(this.actionConfigNode)this.actionConfigNode.setStyle("display","block");this.explorer.deleteElements.erase(this);this.deleteSelected=false;this.explorer.checkDeleteElements()}},addCompany:function(){var t=true;if(this.explorer.currentItem)t=this.explorer.currentItem.unSelected();if(t){var e=this.explorer._getAddCompanyData();e.superior=this.data.id;var i=new MWF.xApplication.Organization.OrgExplorer.Company(e,this.explorer);i.parentItem=this;i.load();i.selected();i.editBaseInfor();new Fx.Scroll(this.explorer.chartScrollNode).toElementCenter(i.node)}else{this.app.notice(this.explorer.app.lp.organizationSave,"error",this.propertyContentNode)}},addDepartment:function(){var t=true;if(this.explorer.currentItem)t=this.explorer.currentItem.unSelected();if(t){var e=this.explorer._getAddDepartmentData();e.company=this.data.id;var i=new MWF.xApplication.Organization.OrgExplorer.Department(e,this.explorer);i.parentItem=this;i.load();i.selected();i.editBaseInfor();new Fx.Scroll(this.explorer.chartScrollNode).toElementCenter(i.node)}else{this.app.notice(this.explorer.app.lp.organizationSave,"error",this.propertyContentNode)}},configCompany:function(t){var e=this.data.controllerList||[];var i={title:this.explorer.app.lp.configCompany,type:"person",values:e,onComplete:function(e){var i=[];e.each(function(t){i.push(t.data.id)});if(!i.length){var s=this;this.explorer.app.confirm("warn",t,this.explorer.app.lp.configCompanyNullTitle,{html:this.explorer.app.lp.configCompanyNull},400,160,function(){s.data.controllerList=i;s.explorer.actions.saveCompany(s.data,function(t){this.explorer.app.notice(this.explorer.app.lp.configCompanyOk,"success")}.bind(s));this.close()},function(){this.close()})}else{this.data.controllerList=i;this.explorer.actions.saveCompany(this.data,function(t){this.explorer.app.notice(this.explorer.app.lp.configCompanyOk,"success")}.bind(this))}}.bind(this)};var s=new MWF.OrgSelector(this.explorer.app.content,i)},checkDelete:function(){var t=this;while(t){if(t.deleteSelected)return true;var t=t.parentItem}return false},setEvent:function(){this.contentNode.addEvents({mouseover:function(t){if(this.explorer.currentItem!=this){this.flagNode.setStyles(this.style.flagNodeOver)}if(!this.checkDelete())if(this.data.id)this.actionNode.fade("in")}.bind(this),mouseout:function(t){if(this.explorer.currentItem!=this){this.flagNode.setStyles(this.style.flagNode)}if(!this.checkDelete())if(this.data.id)this.actionNode.fade("out")}.bind(this),click:function(t){this.itemClick()}.bind(this)});this.flagNode.addEvents({click:function(t){if(!this.childTween.isRunning()){var e=this.childNode.retrieve("c-height",0);var i=this.childNode.getSize().y;if(i>0){this.childNode.store("c-height",i);this.childTween.start("height",i,0);this.flagIconNode.setStyles(this.style.flagIconNode_c)}else{this.childTween.start("height",0,e);this.flagIconNode.setStyles(this.style.flagIconNode_e)}}}.bind(this)})},itemClick:function(){if(this.explorer.currentItem){if(this.explorer.currentItem.unSelected()){this.selected()}else{this.explorer.app.notice(this.explorer.app.lp.organizationSave,"error",this.propertyContentNode)}}else{this.selected()}},selected:function(){this.explorer.currentItem=this;this.flagNode.setStyles(this.style.flagNodeSelected);this.showItemProperty()},unSelected:function(){if(this.isEdit)return false;this.explorer.currentItem=null;this.flagNode.setStyles(this.style.flagNode);this.clearItemProperty();return true},showItemProperty:function(){this.explorer.propertyTitleNode.set("text",this.data.name);this.showItemPropertyBase();this.showItemPropertyDuty();this.showItemPropertyAttribute()},showItemPropertyBase:function(){this.propertyBaseNode=new Element("div",{styles:this.style.propertyInforNode}).inject(this.explorer.propertyContentNode);this.baseActionNode=new Element("div",{styles:this.style.propertyInforActionNode}).inject(this.propertyBaseNode);this.propertyBaseTextNode=new Element("div",{styles:this.style.propertyInforTextNode,text:this.explorer.app.lp.companyBaseText}).inject(this.propertyBaseNode);if(this.isEditor)this.createEditBaseNode();this.propertyBaseContentNode=new Element("div",{styles:this.style.propertyInforContentNode}).inject(this.propertyBaseNode);var t="<table cellspacing='0' cellpadding='0' border='0' width='95%' align='center'>";t+="<tr><td class='formTitle'>"+this.explorer.app.lp.companyName+"</td><td id='formCompanyName'></td></tr>";t+="<tr><td class='formTitle'>"+this.explorer.app.lp.companyNumber+"</td><td id='formCompanyNumber'></td></tr>";t+="<tr><td class='formTitle'>"+this.explorer.app.lp.companyAddress+"</td><td id='formCompanyAddress'></td></tr>";t+="<tr><td class='formTitle'>"+this.explorer.app.lp.companyShortname+"</td><td id='formCompanyShortname'></td></tr>";t+="<tr><td class='formTitle'>"+this.explorer.app.lp.orderNumber+"</td><td id='formOrderNumber'></td><tr>";t+="</table>";this.propertyBaseContentNode.set("html",t);this.propertyBaseContentNode.getElements("td.formTitle").setStyles(this.style.propertyBaseContentTdTitle);this.companyNameInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formCompanyName"),this.data.name,this.explorer.css.formInput);this.companyNumberInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formCompanyNumber"),this.data.number,this.explorer.css.formInput);this.companyAddressInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formCompanyAddress"),this.data.address,this.explorer.css.formInput);this.companyShortnameInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formCompanyShortname"),this.data.shortname,this.explorer.css.formInput);this.orderNumberInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formOrderNumber"),this.data.orderNumber,this.explorer.css.formInput)},createEditBaseNode:function(){this.editBaseNode=new Element("button",{styles:this.style.editBaseNode,text:this.explorer.app.lp.edit,events:{click:this.editBaseInfor.bind(this)}}).inject(this.baseActionNode)},createCancelBaseNode:function(){this.cancelBaseNode=new Element("button",{styles:this.style.cancelBaseNode,text:this.explorer.app.lp.cancel,events:{click:this.cancelBaseInfor.bind(this)}}).inject(this.baseActionNode)},createSaveBaseNode:function(){this.saveBaseNode=new Element("button",{styles:this.style.saveBaseNode,text:this.explorer.app.lp.save,events:{click:this.saveBaseInfor.bind(this)}}).inject(this.baseActionNode)},editBaseInfor:function(){this.baseActionNode.empty();this.editBaseNode=null;this.createCancelBaseNode();this.createSaveBaseNode();this.editMode()},cancelBaseInfor:function(){if(this.data.name){this.baseActionNode.empty();this.cancelBaseNode=null;this.saveBaseNode=null;this.createEditBaseNode();this.readMode()}else{this.destroy()}},destroy:function(){if(this.parentItem)this.parentItem.children.erase(this);this.explorer.currentItem=null;this.clearItemProperty();this.node.destroy();delete this},saveBaseInfor:function(t){if(!this.companyNameInput.input.get("value")){this.explorer.app.notice(this.explorer.app.lp.inputOrganizationInfor,"error",this.explorer.propertyContentNode);return false}this.propertyBaseNode.mask({style:{opacity:.7,"background-color":"#999"}});this.save(function(){this.baseActionNode.empty();this.cancelBaseNode=null;this.saveBaseNode=null;this.createEditBaseNode();this.readMode();this.setNewItem();this.propertyBaseNode.unmask();if(t)t()}.bind(this),function(t,e,i){var s=i;if(t)s=t.responseText;this.explorer.app.notice("request json error: "+s,"error");this.propertyBaseNode.unmask()}.bind(this))},clearItemProperty:function(){this.explorer.propertyTitleNode.empty();this.explorer.propertyContentNode.empty()},editMode:function(){this.companyNameInput.editMode();this.companyNumberInput.editMode();this.companyAddressInput.editMode();this.companyShortnameInput.editMode();this.orderNumberInput.editMode();this.isEdit=true},readMode:function(){this.companyNameInput.readMode();this.companyNumberInput.readMode();this.companyAddressInput.readMode();this.companyShortnameInput.readMode();this.orderNumberInput.readMode();this.isEdit=false},save:function(t,e){this.data.name=this.companyNameInput.save();this.data.number=this.companyNumberInput.save();this.data.address=this.companyAddressInput.save();this.data.shortname=this.companyShortnameInput.save();this.data.orderNumber=this.orderNumberInput.save();this.explorer.actions.saveCompany(this.data,function(e){if(!this.data.id)this.data.id=e.data.id;this.textNode.set("text",this.data.name);if(t)t()}.bind(this),function(t,i,s){if(e)e(t,i,s)}.bind(this))},showItemPropertyDuty:function(){this.propertyDutyNode=new Element("div",{styles:this.style.propertyInforNode}).inject(this.explorer.propertyContentNode);this.dutyActionNode=new Element("div",{styles:this.style.propertyInforActionNode}).inject(this.propertyDutyNode);this.propertyDutyTextNode=new Element("div",{styles:this.style.propertyInforTextNode,text:this.explorer.app.lp.companyDutyText}).inject(this.propertyDutyNode);this.propertyDutyContentNode=new Element("div",{styles:this.style.propertyInforContentNode}).inject(this.propertyDutyNode);if(this.isEditor){this.createDeleteDutyNode();this.createAddDutyNode()}this.listDuty()},createAddDutyNode:function(){this.addDutyNode=new Element("button",{styles:this.style.addDutyNode,text:this.explorer.app.lp.add,events:{click:this.addDuty.bind(this)}}).inject(this.dutyActionNode)},createDeleteDutyNode:function(){this.deleteDutyNode=new Element("button",{styles:this.style.deleteDutyNode_desable,text:this.explorer.app.lp["delete"],disable:true}).inject(this.dutyActionNode)},addDuty:function(){var t=this.getNewDutyData();if(!this.created){this.saveBaseInfor(function(){new MWF.xApplication.Organization.CompanyDuty(this.propertyDutyContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}.bind(this))}else{new MWF.xApplication.Organization.CompanyDuty(this.propertyDutyContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}},getNewDutyData:function(){return{company:this.data.id,name:""}},checkDeleteDutyAction:function(){if(this.selectedDutys.length){if(this.deleteDutyNode.get("disable")){this.deleteDutyNode.set({styles:this.style.deleteDutyNode});this.deleteDutyNode.removeProperty("disable");this.deleteDutyNode.addEvent("click",function(t){this.deleteDuty(t)}.bind(this))}}else{if(!this.deleteDutyNode.get("disable")){this.deleteDutyNode.set({styles:this.style.deleteDutyNode_desable,disable:true});this.deleteDutyNode.removeEvents("click")}}},deleteDuty:function(t){var e=this;this.explorer.app.confirm("infor",t,this.explorer.app.lp.deleteDutyTitle,this.explorer.app.lp.deleteDuty,300,120,function(){this.close();e.selectedDutys.each(function(t){t.remove()});delete e.selectedDutys;e.selectedDutys=[];e.checkDeleteDutyAction()},function(){this.close()})},listDuty:function(){var t="<table cellspacing='0' cellpadding='5' border='0' width='95%' align='center' style='line-height:normal'>";t+="<tr><th style='width:20px'></th>";t+="<th style='width: 30%; border-right: 1px solid #FFF'>"+this.explorer.app.lp.dutyName+"</th>";t+="<th>"+this.explorer.app.lp.dutyMember+"</th><th style='width:20px'></th></tr>";t+="</table>";this.propertyDutyContentNode.set("html",t);this.propertyDutyContentNode.getElements("th").setStyles(this.style.propertyDutyContentTdTitle);if(this.data.id){this.explorer.actions.listCompanyDuty(function(t){t.data.each(function(t){new MWF.xApplication.Organization.CompanyDuty(this.propertyDutyContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}.bind(this))}.bind(this),null,this.data.id)}},getDutyCount:function(){if(this.data.id){var t=0;this.explorer.actions.listCompanyDuty(function(e){t=e.data.length}.bind(this),null,this.data.id,false);return t}return 0},showItemPropertyAttribute:function(){this.propertyAttributeNode=new Element("div",{styles:this.style.propertyInforNode}).inject(this.explorer.propertyContentNode);this.attributeActionNode=new Element("div",{styles:this.style.propertyInforActionNode}).inject(this.propertyAttributeNode);this.propertyAttributeTextNode=new Element("div",{styles:this.style.propertyInforTextNode,text:this.explorer.app.lp.companyAttributeText}).inject(this.propertyAttributeNode);this.propertyAttributeContentNode=new Element("div",{styles:this.style.propertyInforContentNode}).inject(this.propertyAttributeNode);if(this.isEditor){this.createDeleteAttributeNode();this.createAddAttributeNode()}this.listAttribute()},createAddAttributeNode:function(){this.addAttributeNode=new Element("button",{styles:this.style.addDutyNode,text:this.explorer.app.lp.add,events:{click:this.addAttribute.bind(this)}}).inject(this.attributeActionNode)},createDeleteAttributeNode:function(){this.deleteAttributeNode=new Element("button",{styles:this.style.deleteDutyNode_desable,text:this.explorer.app.lp["delete"],disable:true}).inject(this.attributeActionNode)},addAttribute:function(){var t=this.getNewAttributeData();if(!this.created){this.saveBaseInfor(function(){new MWF.xApplication.Organization.CompanyAttribute(this.propertyAttributeContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}.bind(this))}else{new MWF.xApplication.Organization.CompanyAttribute(this.propertyAttributeContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}},getNewAttributeData:function(){return{company:this.data.id,name:"",attributeList:[]}},checkDeleteAttributeAction:function(){if(this.selectedAttributes.length){if(this.deleteAttributeNode.get("disable")){this.deleteAttributeNode.set({styles:this.style.deleteDutyNode});this.deleteAttributeNode.removeProperty("disable");this.deleteAttributeNode.addEvent("click",function(t){this.deleteAttribute(t)}.bind(this))}}else{if(!this.deleteAttributeNode.get("disable")){this.deleteAttributeNode.set({styles:this.style.deleteDutyNode_desable,disable:true});this.deleteAttributeNode.removeEvents("click")}}},deleteAttribute:function(t){var e=this;this.explorer.app.confirm("infor",t,this.explorer.app.lp.deleteAttributeTitle,this.explorer.app.lp.deleteAttribute,300,120,function(){this.close();e.selectedAttributes.each(function(t){t.remove()});delete e.selectedAttributes;e.selectedAttribute=[];e.checkDeleteAttributeAction()},function(){this.close()})},listAttribute:function(){var t="<table cellspacing='0' cellpadding='5' border='0' width='95%' align='center' style='line-height:normal'>";t+="<tr><th style='width:20px'></th>";t+="<th style='width: 30%; border-right: 1px solid #FFF'>"+this.explorer.app.lp.attributeName+"</th>";t+="<th>"+this.explorer.app.lp.attributeValue+"</th><th style='width:20px'></th></tr>";t+="</table>";this.propertyAttributeContentNode.set("html",t);this.propertyAttributeContentNode.getElements("th").setStyles(this.style.propertyDutyContentTdTitle);if(this.data.id){this.explorer.actions.listCompanyAttribute(function(t){t.data.each(function(t){new MWF.xApplication.Organization.CompanyAttribute(this.propertyAttributeContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}.bind(this))}.bind(this),null,this.data.id)}},getAttributeCount:function(){if(this.data.id){var t=0;this.explorer.actions.listCompanyAttribute(function(e){t=e.data.length}.bind(this),null,this.data.id,false);return t}return 0},getMemberCount:function(){return 0},delete:function(t,e){this.children.each(function(t){t["delete"]()});this._deleteDutys();this._deleteAttributes();this._deleteMembers();this._deleteItem(this.data.id,function(){this.destroy();if(t)t()}.bind(this),function(t,i,s){var n=s;if(t)n=t.responseText;if(e)e(n)}.bind(this))},_deleteItem:function(t,e,i){this.explorer.actions.deleteCompany(t,e,i,false)},_deleteDutys:function(){this._listDutys(function(t){t.data.each(function(t){this.explorer.actions.deleteCompanyDuty(t.id,null,null,false)}.bind(this))}.bind(this))},_listDutys:function(t){this.explorer.actions.listCompanyDuty(function(e){if(t)t(e)}.bind(this),null,this.data.id,false)},_deleteAttributes:function(){this._listAttributes(function(t){t.data.each(function(t){this.explorer.actions.deleteCompanyAttribute(t.id,null,null,false)}.bind(this))}.bind(this))},_listAttributes:function(t){this.explorer.actions.listCompanyAttribute(function(e){if(t)t(e)}.bind(this),null,this.data.id,false)},_deleteMembers:function(){return true}});MWF.xApplication.Organization.OrgExplorer.Company=new Class({Extends:MWF.xApplication.Organization.OrgExplorer.Item});MWF.xApplication.Organization.OrgExplorer.Department=new Class({Extends:MWF.xApplication.Organization.OrgExplorer.Item,initStyle:function(){this.style=this.explorer.css.departmentItem},addActions:function(){MWF.AC.isDepartmentEditor({id:this.data.company,yes:function(){this.isEditor=true;this.deleteNode=new Element("div",{styles:this.style.actionDeleteNode}).inject(this.actionNode);this.addDepartmentNode=new Element("div",{styles:this.style.actionAddDepartmentNode,title:this.explorer.app.lp.createSubDepartment}).inject(this.actionNode);this.deleteNode.addEvent("click",function(t){this.deleteButton();t.stopPropagation()}.bind(this));this.addDepartmentNode.addEvent("click",function(t){if(!this.checkDelete())if(this.data.id)this.addDepartment();t.stopPropagation()}.bind(this))}.bind(this)})},addDepartment:function(){var t=true;if(this.explorer.currentItem)t=this.explorer.currentItem.unSelected();if(t){var e=this.explorer._getAddDepartmentData();e.superior=this.data.id;var i=new MWF.xApplication.Organization.OrgExplorer.Department(e,this.explorer);i.parentItem=this;i.load();i.selected();i.editBaseInfor();new Fx.Scroll(this.explorer.chartScrollNode).toElementCenter(i.node,"y")}else{this.app.notice(this.explorer.app.lp.organizationSave,"error",this.propertyContentNode)}},saveBaseInfor:function(t){if(!this.departmentNameInput.input.get("value")){this.explorer.app.notice(this.explorer.app.lp.inputOrganizationInfor,"error",this.explorer.propertyContentNode);return false}this.propertyBaseNode.mask({style:{opacity:.7,"background-color":"#999"}});this.save(function(){this.baseActionNode.empty();this.cancelBaseNode=null;this.saveBaseNode=null;this.createEditBaseNode();this.readMode();this.setNewItem();this.propertyBaseNode.unmask();if(t)t()}.bind(this),function(t,e,i){var s=i;if(t)s=t.responseText;this.explorer.app.notice("request json error: "+s,"error");this.propertyBaseNode.unmask()}.bind(this))},showItemProperty:function(){this.explorer.propertyTitleNode.set("text",this.data.name);this.showItemPropertyBase();this.showItemPropertyDuty();this.showItemPropertyAttribute();this.showItemMembers()},showItemPropertyBase:function(){this.propertyBaseNode=new Element("div",{styles:this.style.propertyInforNode}).inject(this.explorer.propertyContentNode);this.baseActionNode=new Element("div",{styles:this.style.propertyInforActionNode}).inject(this.propertyBaseNode);this.propertyBaseTextNode=new Element("div",{styles:this.style.propertyInforTextNode,text:this.explorer.app.lp.departmentBaseText}).inject(this.propertyBaseNode);if(this.isEditor)this.createEditBaseNode();this.propertyBaseContentNode=new Element("div",{styles:this.style.propertyInforContentNode}).inject(this.propertyBaseNode);var t="<table cellspacing='0' cellpadding='0' border='0' width='95%' align='center'>";t+="<tr><td class='formTitle'>"+this.explorer.app.lp.departmentName+"</td><td id='formDepartmentName'></td></tr>";
t+="<tr><td class='formTitle'>"+this.explorer.app.lp.departmentNumber+"</td><td id='formDepartmentNumber'></td></tr>";t+="<tr><td class='formTitle'>"+this.explorer.app.lp.departmentShortname+"</td><td id='formDepartmentShortname'></td></tr>";t+="<tr><td class='formTitle'>"+this.explorer.app.lp.orderNumber+"</td><td id='formOrderNumber'></td></tr>";t+="</table>";this.propertyBaseContentNode.set("html",t);this.propertyBaseContentNode.getElements("td.formTitle").setStyles(this.style.propertyBaseContentTdTitle);this.departmentNameInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formDepartmentName"),this.data.name,this.explorer.css.formInput);this.departmentNumberInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formDepartmentNumber"),this.data.number,this.explorer.css.formInput);this.departmentShortnameInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formDepartmentShortname"),this.data.shortname,this.explorer.css.formInput);this.orderNumberInput=new MWF.xApplication.Organization.Input(this.propertyBaseContentNode.getElement("#formOrderNumber"),this.data.orderNumber,this.explorer.css.formInput)},editMode:function(){this.departmentNameInput.editMode();this.departmentNumberInput.editMode();this.departmentShortnameInput.editMode();this.orderNumberInput.editMode();this.isEdit=true},readMode:function(){this.departmentNameInput.readMode();this.departmentNumberInput.readMode();this.departmentShortnameInput.readMode();this.orderNumberInput.readMode();this.isEdit=false},save:function(t){this.data.name=this.departmentNameInput.save();this.data.number=this.departmentNumberInput.save();this.data.shortname=this.departmentShortnameInput.save();this.data.orderNumber=this.orderNumberInput.save();this.explorer.actions.saveDepartment(this.data,function(e){if(!this.data.id)this.data.id=e.data.id;this.textNode.set("text",this.data.name);if(t)t()}.bind(this))},getNewDutyData:function(){return{department:this.data.id,name:""}},getNewAttributeData:function(){return{department:this.data.id,name:"",attributeList:[]}},listDuty:function(){this.propertyDutyTextNode.set("text",this.explorer.app.lp.departmentDutyText);var t="<table cellspacing='0' cellpadding='5' border='0' width='95%' align='center' style='line-height:normal'>";t+="<tr><th style='width:20px'></th>";t+="<th style='width: 30%; border-right: 1px solid #FFF'>"+this.explorer.app.lp.dutyName+"</th>";t+="<th>"+this.explorer.app.lp.dutyMember+"</th><th style='width:20px'></th></tr>";t+="</table>";this.propertyDutyContentNode.set("html",t);this.propertyDutyContentNode.getElements("th").setStyles(this.style.propertyDutyContentTdTitle);if(this.data.id){this.explorer.actions.listDepartmentDuty(function(t){t.data.each(function(t){new MWF.xApplication.Organization.DepartmentDuty(this.propertyDutyContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}.bind(this))}.bind(this),null,this.data.id)}},getDutyCount:function(){if(this.data.id){var t=0;this.explorer.actions.listDepartmentDuty(function(e){t=e.data.length}.bind(this),null,this.data.id,false);return t}return 0},addDuty:function(){var t=this.getNewDutyData();if(!this.created){this.saveBaseInfor(function(){new MWF.xApplication.Organization.DepartmentDuty(this.propertyDutyContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}.bind(this))}else{new MWF.xApplication.Organization.DepartmentDuty(this.propertyDutyContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}},listAttribute:function(){this.propertyAttributeTextNode.set("text",this.explorer.app.lp.departmentAttributeText);var t="<table cellspacing='0' cellpadding='5' border='0' width='95%' align='center' style='line-height:normal'>";t+="<tr><th style='width:20px'></th>";t+="<th style='width: 30%; border-right: 1px solid #FFF'>"+this.explorer.app.lp.attributeName+"</th>";t+="<th>"+this.explorer.app.lp.attributeValue+"</th><th style='width:20px'></th></tr>";t+="</table>";this.propertyAttributeContentNode.set("html",t);this.propertyAttributeContentNode.getElements("th").setStyles(this.style.propertyDutyContentTdTitle);if(this.data.id){this.explorer.actions.listDepartmentAttribute(function(t){t.data.each(function(t){new MWF.xApplication.Organization.DepartmentAttribute(this.propertyAttributeContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}.bind(this))}.bind(this),null,this.data.id)}},getAttributeCount:function(){if(this.data.id){var t=0;this.explorer.actions.listDepartmentAttribute(function(e){t=e.data.length}.bind(this),null,this.data.id,false);return t}return 0},addAttribute:function(){var t=this.getNewAttributeData();if(!this.created){this.saveBaseInfor(function(){new MWF.xApplication.Organization.DepartmentAttribute(this.propertyAttributeContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}.bind(this))}else{new MWF.xApplication.Organization.DepartmentAttribute(this.propertyAttributeContentNode.getElement("table").getFirst(),t,this,this.explorer.css.map)}},showItemMembers:function(){this.propertyMembersNode=new Element("div",{styles:this.style.propertyInforNode}).inject(this.explorer.propertyContentNode);this.membersActionNode=new Element("div",{styles:this.style.propertyInforActionNode}).inject(this.propertyMembersNode);this.propertyMembersTextNode=new Element("div",{styles:this.style.propertyInforTextNode,text:this.explorer.app.lp.departmentMemberText}).inject(this.propertyMembersNode);this.propertyMemberContentNode=new Element("div",{styles:this.style.propertyInforContentNode}).inject(this.propertyMembersNode);if(this.isEditor)this.createAddMemberNode();this.listMembers()},createAddMemberNode:function(){this.addMemberNode=new Element("button",{styles:this.style.addDutyNode,text:this.explorer.app.lp.add,events:{click:this.addMember.bind(this)}}).inject(this.membersActionNode)},createDeleteMemberNode:function(){this.deleteMemberNode=new Element("button",{styles:this.style.deleteDutyNode_desable,text:this.explorer.app.lp["delete"],disable:true}).inject(this.membersActionNode)},checkSaveBaseInfor:function(t){if(!this.created){this.saveBaseInfor(function(){if(t)t()}.bind(this))}else{if(t)t()}},addMember:function(){this.checkSaveBaseInfor(function(){MWF.xDesktop.requireApp("Organization","Selector.Person",function(){var t=new MWF.xApplication.Organization.Selector.Person(this.explorer.app.content,{values:[],onComplete:function(t){var e=0;t.each(function(t){var e={person:t.data.id,department:this.data.id,name:t.data.name+"("+this.data.name+")"};this.explorer.actions.saveIdentity(e,function(t){e.id=t.data.id;this.createIdentity(e)}.bind(this))}.bind(this))}.bind(this)});t.load()}.bind(this))}.bind(this))},listMembers:function(){if(this.data.id){this.explorer.actions.listIdentity(function(t){t.data.each(function(t){var e=this;this.createIdentity(t)}.bind(this))}.bind(this),null,this.data.id)}},getMemberCount:function(){if(this.data.id){var t=0;this.explorer.actions.listIdentity(function(e){t=e.data.length}.bind(this),null,this.data.id,false);return t}return 0},createIdentity:function(t){_department=this;MWF.require("MWF.widget.Identity",function(){new MWF.widget.Identity(t,this.propertyMemberContentNode,this.explorer,this.isEditor,function(t){var e=this;var i=this.explorer.app.lp.deleteIdentityInDepartment;i=i.replace("{depart}",_department.data.name);i=i.replace("{identity}",this.data.name);e.explorer.app.confirm("warn",t,this.explorer.app.lp.deleteIdentityInDepartmentTitle,i,400,140,function(){e.explorer.actions.deleteIdentity(e.data.id,function(){e.node.destroy();delete e});this.close()},function(){this.close()})})}.bind(this))},_deleteItem:function(t,e,i){this.explorer.actions.deleteDepartment(t,e,i,false)},_deleteDutys:function(){this._listDutys(function(t){t.data.each(function(t){this.explorer.actions.deleteDepartmentDuty(t.id,null,null,false)}.bind(this))}.bind(this))},_listDutys:function(t){this.explorer.actions.listDepartmentDuty(function(e){if(t)t(e)}.bind(this),null,this.data.id,false)},_deleteAttributes:function(){this._listAttributes(function(t){t.data.each(function(t){this.explorer.actions.deleteDepartmentAttribute(t.id,null,null,false)}.bind(this))}.bind(this))},_listAttributes:function(t){this.explorer.actions.listDepartmentAttribute(function(e){if(t)t(e)}.bind(this),null,this.data.id,false)},_deleteMembers:function(){this.explorer.actions.listIdentity(function(t){t.data.each(function(t){this.explorer.actions.deleteIdentity(t.id,null,null,false)}.bind(this))}.bind(this),null,this.data.id,false)}});MWF.xApplication.Organization.Input=new Class({Implements:[Events],initialize:function(t,e,i){this.node=$(t);this.value=e||"";this.style=i;this.load()},load:function(){this.content=new Element("div",{styles:this.style.content,text:this.value}).inject(this.node)},editMode:function(){this.content.empty();this.input=new Element("input",{styles:this.style.input,value:this.value}).inject(this.content);this.input.addEvents({focus:function(){this.input.setStyles(this.style.input_focus)}.bind(this),blur:function(){this.input.setStyles(this.style.input)}.bind(this)})},readMode:function(){this.content.empty();this.input=null;this.content.set("text",this.value)},save:function(){if(this.input)this.value=this.input.get("value");return this.value}});MWF.xApplication.Organization.CompanyDuty=new Class({initialize:function(t,e,i,s){this.container=$(t);this.data=e;if(this.data.identityList)this.data.identityList=e.identityList.filter(function(t){return t});this.style=s;this.item=i;this.identitys=[];this.selected=false;this.load()},load:function(){this.node=new Element("tr",{styles:this.style.contentNode}).inject(this.container);this.selectNode=new Element("td",{styles:this.style.selectNode}).inject(this.node);this.nameNode=new Element("td",{styles:this.style.nameNode,html:this.data.name?this.data.name:"<input type='text'/>"}).inject(this.node);this.input=this.nameNode.getFirst("input");if(this.input)this.setEditNameInput();this.valueNode=new Element("td",{styles:this.style.valueNode}).inject(this.node);this.createActionNode();this.setEvent();this.loadValue()},createActionNode:function(){this.actionNode=new Element("td",{styles:this.style.actionNode}).inject(this.node);if(this.item.isEditor){this.actionNode.addEvent("click",function(){this.addIdentitys()}.bind(this))}else{this.actionNode.setStyle("background","transparent")}},setEvent:function(){this.selectNode.addEvent("click",function(){this.selectNodeClick()}.bind(this));this.nameNode.addEvent("click",function(){if(!this.input){this.nameNode.empty();this.input=new Element("input",{type:"text",value:this.data.name}).inject(this.nameNode);this.setEditNameInput()}}.bind(this));this.valueNodeClick()},selectNodeClick:function(){if(!this.selected){this.selected=true;this.selectNode.setStyles(this.style.selectNode_selected);this.node.setStyles(this.style.contentNode_selected);this.item.selectedDutys.push(this);this.item.checkDeleteDutyAction()}else{this.selected=false;this.selectNode.setStyles(this.style.selectNode);this.node.setStyles(this.style.contentNode);this.item.selectedDutys.erase(this);this.item.checkDeleteDutyAction()}},valueNodeClick:function(){},setEditNameInput:function(){this.input.setStyles(this.style.nameInputNode);this.input.focus();this.input.addEvents({blur:function(){var t=this.input.get("value");if(t){if(t!=this.data.name){this.save(t)}else{this.nameNode.empty();this.input=null;this.nameNode.set("text",this.data.name)}}else{if(!this.data.id){this.node.destroy();delete this}else{this.nameNode.empty();this.input=null;this.nameNode.set("text",this.data.name)}}}.bind(this)})},save:function(t){var e=this.data.name;if(t)this.data.name=t;this.item.explorer.actions.saveCompanyDuty(this.data,function(t){this.data.id=t.data.id;this.nameNode.empty();this.input=null;this.nameNode.set("text",this.data.name);this.loadValue()}.bind(this),function(t,i,s){this.data.name=e;this.input.focus();var n=s;if(t)n=t.responseText;this.item.explorer.app.notice("request json error: "+n,"error")}.bind(this))},loadValue:function(){this.identitys=[];this.valueNode.empty();if(this.data.identityList){this.data.identityList.each(function(t){if(t){this.item.explorer.actions.getIdentity(function(t){MWF.require("MWF.widget.Identity",function(){this.identitys.push(new MWF.widget.Identity(t.data,this.valueNode,this.item.explorer))}.bind(this))}.bind(this),null,t,false)}}.bind(this))}},addIdentitys:function(){var t=new MWF.OrgSelector(this.item.explorer.app.content,{type:"Identity",values:this.data.identityList||[],onComplete:function(t){var e=[];t.each(function(t){e.push(t.data.id)});this.data.identityList=e;this.save()}.bind(this)})},remove:function(){this.item.explorer.actions.deleteCompanyDuty(this.data.id,function(){this.node.destroy();delete this}.bind(this))}});MWF.xApplication.Organization.DepartmentDuty=new Class({Extends:MWF.xApplication.Organization.CompanyDuty,save:function(t){var e=this.data.name;if(t)this.data.name=t;this.item.explorer.actions.saveDepartmentDuty(this.data,function(t){this.data.id=t.data.id;this.nameNode.empty();this.input=null;this.nameNode.set("text",this.data.name);this.loadValue()}.bind(this),function(t,i,s){this.data.name=e;this.input.focus();var n=s;if(t)n=t.responseText;this.item.explorer.app.notice("request json error: "+n,"error")}.bind(this))},remove:function(){this.item.explorer.actions.deleteDepartmentDuty(this.data.id,function(){this.node.destroy();delete this}.bind(this))}});MWF.xApplication.Organization.CompanyAttribute=new Class({Extends:MWF.xApplication.Organization.CompanyDuty,createActionNode:function(){this.actionNode=new Element("td",{styles:this.style.actionAttributeNode}).inject(this.node)},selectNodeClick:function(){if(!this.selected){this.selected=true;this.selectNode.setStyles(this.style.selectNode_selected);this.node.setStyles(this.style.contentNode_selected);this.item.selectedAttributes.push(this);this.item.checkDeleteAttributeAction()}else{this.selected=false;this.selectNode.setStyles(this.style.selectNode);this.node.setStyles(this.style.contentNode);this.item.selectedAttributes.erase(this);this.item.checkDeleteAttributeAction()}},valueNodeClick:function(){this.valueNode.addEvent("click",function(){if(!this.valueInput){this.valueNode.empty();this.valueInput=new Element("input",{type:"text",value:this.data.attributeList?this.data.attributeList.join(","):""}).inject(this.valueNode);this.setEditValueInput()}}.bind(this))},setEditValueInput:function(){this.valueInput.setStyles(this.style.nameInputNode);this.valueInput.focus();this.valueInput.addEvents({blur:function(){var t=this.valueInput.get("value");if(t){if(t!=this.data.attributeList.join(",")){this.saveValue(t)}else{this.valueNode.empty();this.valueInput=null;this.valueNode.set("text",this.data.attributeList.join(","))}}else{if(!this.data.id){this.node.destroy();delete this}else{this.valueNode.empty();this.valueInput=null;this.valueNode.set("text",this.data.attributeList.join(","))}}}.bind(this)})},saveValue:function(t){var e=this.data.attributeList;this.data.attributeList=t.split("/,s*/");this.item.explorer.actions.saveCompanyAttribute(this.data,function(t){this.data.id=t.data.id;this.valueNode.empty();this.valueInput=null;this.valueNode.set("text",this.data.attributeList.join(","))}.bind(this),function(t,i,s){this.data.attributeList=e;this.valueInput.focus();var n=s;if(t)n=t.responseText;this.item.explorer.app.notice("request json error: "+n,"error")}.bind(this))},loadValue:function(){if(this.data.attributeList)this.valueNode.set("text",this.data.attributeList.join(","))},save:function(t){var e=this.data.name;this.data.name=t;this.item.explorer.actions.saveCompanyAttribute(this.data,function(t){this.data.id=t.data.id;this.nameNode.empty();this.input=null;this.nameNode.set("text",this.data.name)}.bind(this),function(t,i,s){this.data.name=e;this.input.focus();var n=s;if(t)n=t.responseText;this.item.explorer.app.notice("request json error: "+n,"error")}.bind(this))},remove:function(){this.item.explorer.actions.deleteCompanyAttribute(this.data.id,function(){this.node.destroy();delete this}.bind(this))}});MWF.xApplication.Organization.DepartmentAttribute=new Class({Extends:MWF.xApplication.Organization.CompanyAttribute,saveValue:function(t){var e=this.data.attributeList;this.data.attributeList=t.split("/,s*/");this.item.explorer.actions.saveDepartmentAttribute(this.data,function(t){this.data.id=t.data.id;this.valueNode.empty();this.valueInput=null;this.valueNode.set("text",this.data.attributeList.join(","))}.bind(this),function(t,i,s){this.data.attributeList=e;this.valueInput.focus();var n=s;if(t)n=t.responseText;this.item.explorer.app.notice("request json error: "+n,"error")}.bind(this))},save:function(t){var e=this.data.name;this.data.name=t;this.item.explorer.actions.saveDepartmentAttribute(this.data,function(t){this.data.id=t.data.id;this.nameNode.empty();this.input=null;this.nameNode.set("text",this.data.name)}.bind(this),function(t,i,s){this.data.name=e;this.input.focus();var n=s;if(t)n=t.responseText;this.item.explorer.app.notice("request json error: "+n,"error")}.bind(this))},remove:function(){this.item.explorer.actions.deleteDepartmentAttribute(this.data.id,function(){this.node.destroy();delete this}.bind(this))}});