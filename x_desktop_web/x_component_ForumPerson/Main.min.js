MWF.xApplication.Forum=MWF.xApplication.Forum||{};MWF.xApplication.ForumPerson=MWF.xApplication.ForumPerson||{};MWF.require("MWF.widget.Identity",null,false);MWF.xDesktop.requireApp("Forum","Actions.RestActions",null,false);MWF.xDesktop.requireApp("Forum","lp."+MWF.language,null,false);MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.xDesktop.requireApp("Forum","Access",null,false);MWF.xApplication.ForumPerson.options={multitask:true,executable:true};MWF.xApplication.ForumPerson.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"ForumPerson",icon:"icon.png",width:"1210",height:"700",isResize:false,isMax:true,title:MWF.xApplication.ForumPerson.LP.title,personName:""},onQueryLoad:function(){this.lp=MWF.xApplication.Forum.LP},loadApplication:function(t){this.userName=layout.desktop.session.user.name;this.restActions=new MWF.xApplication.Forum.Actions.RestActions;this.path="/x_component_ForumPerson/$Main/"+this.options.style+"/";this.createNode();this.loadApplicationContent()},loadController:function(t){this.access=new MWF.xApplication.Forum.Access(this.restActions,this.lp);if(t)t()},createNode:function(){this.content.setStyle("overflow","hidden");this.node=new Element("div",{styles:this.css.node}).inject(this.content)},loadApplicationContent:function(){if(!this.options.personName&&this.status&&this.status.personName){this.options.personName=this.status.personName}this.isCurrentUser=this.userName==this.options.personName;this.setTitle(this.options.personName);this.loadController(function(){this.access.login(function(){this.getUserData(this.options.personName,function(t){this.personData=t.data;this.loadApplicationLayout()}.bind(this))}.bind(this))}.bind(this))},getUserData:function(t,e){if(this.access.isAnonymous()){this.restActions.getPersonIcon(t,function(t){if(e)e({data:{icon:t,genderType:"m",signature:""}})})}else{this.restActions.getPerson(function(t){if(t.data){if(t.data.icon){t.data.icon="data:image/png;base64,"+t.data.icon}else{t.data.icon="/x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif"}}if(!t.data.signature)t.data.signature="";if(e)e(t)}.bind(this),null,t,true)}},loadApplicationLayout:function(){this.contentContainerNode=new Element("div.contentContainerNode",{styles:this.css.contentContainerNode}).inject(this.node);this.createTopNode();this.createMiddleNode()},reloadAllParents:function(t){this.restActions.getSection(t,function(e){var i="Forum";if(this.desktop.apps[i]){this.desktop.apps[i].reload()}i="ForumCategory"+e.data.forumId;if(this.desktop.apps[i]){this.desktop.apps[i].reload()}i="ForumSection"+t;if(this.desktop.apps[i]){this.desktop.apps[i].reload()}}.bind(this))},createTopNode:function(){var t=this.lp.defaultForumColor;var e=this.topNode=new Element("div.topNode",{styles:this.css.topNode}).inject(this.contentContainerNode);e.setStyle("border-bottom","1px solid "+t);var i=new Element("div.topTitleLeftNode",{styles:this.css.topTitleLeftNode}).inject(e);i.setStyle("background-color",t);var s=new Element("div.topTitleMiddleNode",{styles:this.css.topTitleMiddleNode}).inject(e);s.setStyle("background-color",t);var o=new Element("div.topTitleRightNode",{styles:this.css.topTitleRightNode}).inject(e);o.setStyle("background-color",t);var n=new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.lp.title}).inject(s);n.addEvent("click",function(){var t="Forum";if(this.desktop.apps[t]){this.desktop.apps[t].setCurrent()}else{this.desktop.openApplication(null,"Forum",{appId:t})}if(!this.inBrowser){this.close()}}.bind(this));var a=new Element("div.topItemSepNode",{styles:this.css.topItemSepNode}).inject(s);var n=new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.lp.personCenter+"："+this.options.personName}).inject(s)},createMiddleNode:function(){this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainerNode);this.createPersonNode();this._createMiddleNode();this.addEvent("resize",function(){this.setContentSize()}.bind(this));this.setContentSize()},createPersonNode:function(){var t=new Element("div.personNode",{styles:this.css.personNode}).inject(this.middleNode);this.restActions.getUserInfor({userName:this.options.personName},function(e){var i=this.userInfor=e.data;var s=new Element("div.personLeftNode",{styles:this.css.personLeftNode}).inject(t);var o=new Element("div.personLeftIconNode",{styles:this.css.personLeftIconNode}).inject(s);var n=new Element("img",{styles:this.css.personLeftIcon,src:this.personData.icon}).inject(o);var a=new Element("div.personLeftContent",{styles:this.css.personLeftContent}).inject(s);var r=new Element("div.personTopDiv",{styles:this.css.personTopDiv}).inject(a);var p=new Element("div.personTopInfor",{styles:this.css.personTopInfor,text:this.options.personName}).inject(r);if(!this.access.isAnonymous()&&!this.inBrowser){if(this.isCurrentUser){var l=new Element("input",{type:"button",styles:this.css.personSettingAction,value:this.lp.changePersonSetting}).inject(r);l.addEvent("click",function(){var t="Profile";if(this.desktop.apps[t]){this.desktop.apps[t].setCurrent()}else{this.desktop.openApplication(null,"Profile",{})}}.bind(this))}else{var l=new Element("input",{type:"button",styles:this.css.personSettingAction,value:this.lp.sendMessage}).inject(r);l.addEvent("click",function(t){if(layout.desktop.widgets["IMIMWidget"]){var e=layout.desktop.widgets["IMIMWidget"];var i=this.options.personName;e.getOwner(function(){this.openChat(t,{from:i})}.bind(e))}}.bind(this))}}var c=new Element("div.personLeftDiv",{styles:this.css.personLeftDiv,text:this.lp.subject+"："+i.subjectCount+"，"+this.lp.replyCount+"："+i.replyCount+"，"+this.lp.prime+"："+i.creamCount+"，"+this.lp.todaySubject+"："+i.subjectCountToday+"，"+this.lp.todayReply+"："+i.replyCountToday}).inject(a);var c=new Element("div.personLeftDiv",{styles:this.css.personLeftDiv,text:this.lp.signature+"："+this.personData.signature}).inject(a)}.bind(this))},_createMiddleNode:function(){this.contentDiv=new Element("div.contentDiv",{styles:this.css.contentDiv}).inject(this.middleNode);if(this.contentDiv)this.contentDiv.empty();if(this.explorer){this.explorer.destroy();delete this.explorer}this.explorer=new MWF.xApplication.ForumPerson.Explorer(this.contentDiv,this,this,{style:this.options.style,type:this.status&&this.status.type?this.status.type:"subject",viewPageNum:this.status&&this.status.viewPageNum?this.status.viewPageNum:1});this.explorer.load()},setContentSize:function(){var t={x:0,y:0};var e=this.node.getSize();var i=this.contentContainerNode.getStyle("padding-top").toFloat();var s=this.contentContainerNode.getStyle("padding-bottom").toFloat();var o=e.y-t.y-i-s;this.contentContainerNode.setStyle("height",""+o+"px")},recordStatus:function(){return{type:this.explorer.options.type,personName:this.options.personName,viewPageNum:this.explorer.view.getCurrentPageNum()}},getDateDiff:function(t){var e=Date.parse(t.replace(/-/gi,"/"));var i=1e3*60;var s=i*60;var o=s*24;var n=o*15;var a=o*30;var r=a*12;var p=(new Date).getTime();var l=p-e;if(l<0){}var c=(new Date).decrement("day",1);var d=(new Date).decrement("day",2);var h=l/r;var u=l/a;var m=l/(7*o);var f=l/o;var v=l/s;var y=l/i;if(c.getFullYear()==e.getFullYear()&&c.getMonth()==e.getMonth()&&c.getDate()==e.getDate()){result="昨天 "+e.getHours()+":"+e.getMinutes()}else if(d.getFullYear()==e.getFullYear()&&d.getMonth()==e.getMonth()&&d.getDate()==e.getDate()){result="前天 "+e.getHours()+":"+e.getMinutes()}else if(h>1){result=e.getFullYear()+"年"+(e.getMonth()+1)+"月"+e.getDate()+"日"}else if(u>=1){result=e.getMonth()+1+"月"+e.getDate()+"日"}else if(m>=1){result=parseInt(m)+"周前"}else if(f>=1){result=parseInt(f)+"天前"}else if(v>=1){result=parseInt(v)+"小时前"}else if(y>=1){result=parseInt(y)+"分钟前"}else result="刚刚发表";return result}});MWF.xApplication.ForumPerson.Explorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",type:"subject",viewPageNum:1},initialize:function(t,e,i,s){this.setOptions(s);this.container=t;this.parent=i;this.app=e;this.css=this.parent.css;this.lp=this.app.lp},load:function(){this.container.empty();this.loadToolbar();this.viewContainer=Element("div",{styles:this.css.viewContainer}).inject(this.container);this.loadToolbar();if(this.options.type=="subject"){this.loadSubjectView()}else{this.loadReplyView()}},destroy:function(){if(this.resizeWindowFun)this.app.removeEvent("resize",this.resizeWindowFun);this.view.destroy()},loadToolbar:function(){var t=new Element("div",{styles:this.css.toolbar}).inject(this.container);if(!this.toolbarTop){if(this.app.isCurrentUser){this.toolbarLeft=new Element("div.toolbarLeft",{styles:this.css.toolbarLeft}).inject(t);this.mySubjectNode=new Element("div.toolbarLeftItem",{styles:this.css.toolbarLeftItem,text:this.lp.mySubject}).inject(this.toolbarLeft);this.mySubjectNode.addEvents({mouseover:function(){if(this.currentNaviNode!=this.mySubjectNode)this.mySubjectNode.setStyles(this.css.toolbarLeftItem_over)}.bind(this),mouseout:function(){if(this.currentNaviNode!=this.mySubjectNode)this.mySubjectNode.setStyles(this.css.toolbarLeftItem)}.bind(this),click:function(){this.options.type="subject";if(this.currentNaviNode)this.currentNaviNode.setStyles(this.css.toolbarLeftItem);this.currentNaviNode=this.mySubjectNode;this.mySubjectNode.setStyles(this.css.toolbarLeftItem_current);this.loadSubjectView()}.bind(this)});this.myReplyNode=new Element("div.toolbarLeftItem",{styles:this.css.toolbarLeftItem,text:this.lp.myReply}).inject(this.toolbarLeft);this.myReplyNode.addEvents({mouseover:function(){if(this.currentNaviNode!=this.myReplyNode)this.myReplyNode.setStyles(this.css.toolbarLeftItem_over)}.bind(this),mouseout:function(){if(this.currentNaviNode!=this.myReplyNode)this.myReplyNode.setStyles(this.css.toolbarLeftItem)}.bind(this),click:function(){this.options.type="reply";if(this.currentNaviNode)this.currentNaviNode.setStyles(this.css.toolbarLeftItem);this.currentNaviNode=this.myReplyNode;this.myReplyNode.setStyles(this.css.toolbarLeftItem_current);this.loadReplyView()}.bind(this)});if(this.options.type=="reply"){this.myReplyNode.setStyles(this.css.toolbarLeftItem_current);this.currentNaviNode=this.myReplyNode}else{this.mySubjectNode.setStyles(this.css.toolbarLeftItem_current);this.currentNaviNode=this.mySubjectNode}}else{this.toolbarLeft=new Element("div.toolbarLeft",{styles:this.css.toolbarLeft}).inject(t);this.mySubjectNode=new Element("div.toolbarLeftItem",{styles:this.css.toolbarLeftItem,text:this.app.personData.genderType.toLowerCase()=="f"?this.lp.herSubject:this.lp.hisSubject}).inject(this.toolbarLeft);this.mySubjectNode.setStyles(this.css.toolbarLeftItem_current);this.mySubjectNode.setStyle("cursor","default")}}if(this.toolbarTop){this.toolbarBottom=t}else{this.toolbarTop=t}var e=new Element("div",{styles:this.css.fileterNode}).inject(t);if(this.pagingBarTop){this.pagingBarBottom=e}else{this.pagingBarTop=e}},loadSubjectView:function(){if(this.view)this.view.destroy();this.view=new MWF.xApplication.ForumPerson.SubjectView(this.viewContainer,this.app,this,{templateUrl:this.parent.path+"listItem.json",pagingEnable:true,pagingPar:{countPerPage:30,onPostLoad:function(t){if(t.nextPageNode){t.nextPageNode.inject(this.toolbarBottom,"before")}}.bind(this),onPageReturn:function(t){var e="Forum";if(this.app.desktop.apps[e]){this.app.desktop.apps[e].setCurrent()}else{this.app.desktop.openApplication(null,"Forum",{appId:e})}this.app.close()}.bind(this)}});this.view.filterData={creatorName:this.app.options.personName};this.view.pagingContainerTop=this.pagingBarTop;this.view.pagingContainerBottom=this.pagingBarBottom;this.view.load()},loadReplyView:function(){if(this.view)this.view.destroy();this.view=new MWF.xApplication.ForumPerson.ReplyView(this.viewContainer,this.app,this,{templateUrl:this.parent.path+"listItemReply.json",pagingEnable:true,pagingPar:{countPerPage:30,onPostLoad:function(t){if(t.nextPageNode){t.nextPageNode.inject(this.toolbarBottom,"before")}}.bind(this),onPageReturn:function(t){var e="Forum";if(this.app.desktop.apps[e]){this.app.desktop.apps[e].setCurrent()}else{this.app.desktop.openApplication(null,"Forum",{appId:e})}this.app.close()}.bind(this)}});this.view.filterData={creatorName:this.app.options.personName};this.view.pagingContainerTop=this.pagingBarTop;this.view.pagingContainerBottom=this.pagingBarBottom;this.view.load()},resizeWindow:function(){var t=this.app.content.getSize();this.viewContainer.setStyles({height:t.y-121+"px"})}});MWF.xApplication.ForumPerson.SubjectView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.ForumPerson.SubjectDocument(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.clearBody();if(!e)e=30;if(!i)i=1;var s=this.filterData||{};if(this.app.isCurrentUser){this.actions.listMySubjectPage(i,e,s,function(e){if(!e.data)e.data=[];if(!e.count)e.count=0;if(t)t(e)}.bind(this))}else{this.actions.listUserSubjectPage(i,e,s,function(e){if(!e.data)e.data=[];if(!e.count)e.count=0;if(t)t(e)}.bind(this))}},_removeDocument:function(t,e){this.actions.deleteSubject(t.id,function(e){this.reload();this.app.reloadAllParents(t.sectionId);this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_create:function(){},_openDocument:function(t,e){var i="ForumDocument"+t.id;if(this.app.desktop.apps[i]){this.app.desktop.apps[i].setCurrent()}else{this.app.desktop.openApplication(null,"ForumDocument",{sectionId:t.sectionId,id:t.id,appId:i,isEdited:false,isNew:false,index:e})}},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.ForumPerson.SubjectDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(t){this.view._openDocument(this.data,this.index)},edit:function(){var t="ForumDocument"+this.data.id;if(this.app.desktop.apps[t]){this.app.desktop.apps[t].setCurrent()}else{this.app.desktop.openApplication(null,"ForumDocument",{sectionId:this.data.sectionId,id:this.data.id,appId:t,isEdited:true,isNew:false,index:this.index})}},openSection:function(t){var e=this.data;var i="ForumSection"+e.sectionId;if(this.app.desktop.apps[i]){this.app.desktop.apps[i].setCurrent()}else{this.app.desktop.openApplication(t,"ForumSection",{sectionId:e.sectionId,appId:i})}t.stopPropagation()},isAdmin:function(){return this.app.access.isAdmin()}});MWF.xApplication.ForumPerson.ReplyView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.ForumPerson.ReplyDocument(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.clearBody();if(!e)e=30;if(!i)i=1;var s=this.filterData||{};this.actions.listMyReplyPage(i,e,s,function(e){if(!e.data)e.data=[];if(!e.count)e.count=0;if(t)t(e)}.bind(this))},_removeDocument:function(t,e){this.actions.deleteReply(t.id,function(t){this.reload();this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_create:function(){},_openDocument:function(t,e){var i="ForumDocument"+t.id;if(this.app.desktop.apps[i]){this.app.desktop.apps[i].setCurrent()}else{this.app.desktop.openApplication(null,"ForumDocument",{sectionId:t.sectionId,id:t.subjectId,replyIndex:t.orderNumber,appId:i,isEdited:false,isNew:false,index:e})}},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.ForumPerson.ReplyDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(t){this.view._openDocument(this.data,this.index)},edit:function(){var t="ForumDocument"+this.data.id;if(this.app.desktop.apps[t]){this.app.desktop.apps[t].setCurrent()}else{this.app.desktop.openApplication(null,"ForumDocument",{sectionId:this.data.sectionId,id:this.data.id,appId:t,isEdited:true,isNew:false,index:this.index})}},openSection:function(t){var e=this.data;var i="ForumSection"+e.sectionId;if(this.app.desktop.apps[i]){this.app.desktop.apps[i].setCurrent()}else{this.app.desktop.openApplication(t,"ForumSection",{sectionId:e.sectionId,appId:i})}t.stopPropagation()},isAdmin:function(){return this.app.access.isAdmin()},htmlToString:function(t){t=t.replace(/<img[^>]+>/g," [图片] ");return t.replace(/<[^>]+>/g,"")}});