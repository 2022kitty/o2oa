MWF.xApplication.cms=MWF.xApplication.cms||{};MWF.CMSE=MWF.xApplication.cms.Explorer=MWF.xApplication.cms.Explorer||{};MWF.require("MWF.widget.Identity",null,false);MWF.xDesktop.requireApp("cms.Explorer","Actions.RestActions",null,false);MWF.xApplication.cms.Explorer.options={multitask:false,executable:true};MWF.xApplication.cms.Explorer.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"cms.Explorer",icon:"icon.png",width:"1200",height:"700",isResize:false,isMax:true,title:MWF.CMSE.LP.title},onQueryLoad:function(){this.lp=MWF.CMSE.LP},loadApplication:function(t){this.restActions=new MWF.xApplication.cms.Explorer.Actions.RestActions;this.createNode();this.loadApplicationContent()},createNode:function(){this.content.setStyle("overflow","hidden");this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},loadApplicationContent:function(){this.loadDefaultMenu()},loadDefaultMenu:function(t){this.defaultMenuNode=new Element("div",{styles:this.css.defaultMenuNode}).inject(this.node);this.menu=new MWF.xApplication.cms.Explorer.Menu(this,this.defaultMenuNode,{onPostLoad:function(){if(this.status){if(this.status.navi!=null){if(this.status.navi.type=="default"){this.menu.doAction(this.menu.items[this.status.navi.id])}else if(this.status.navi.type=="column"){this.menu.doColumnAction(this.menu.items[this.status.navi.id])}else{this.menu.doColumnAction(this.menu.items[this.status.navi.columnId],function(){this.menu.doCategoryAction(this.menu.items[this.status.navi.id],this.status.view)}.bind(this))}}else{if(this.menu.status=="start"){this.menu.toNormal();this.menu.status="normal"}}}else{if(this.menu.status=="start"){this.menu.toNormal();this.menu.status="normal"}}}.bind(this)});this.addEvent("resize",function(){if(this.menu)this.menu.onResize()}.bind(this))},clearContent:function(){if(this.draftContent){if(this.draftExplorer)delete this.draftExplorer;this.draftContent.destroy();this.draftContent=null}if(this.explorerContent){if(this.explorer)delete this.explorer;this.explorerContent.destroy();this.explorerContent=null}},openDraft:function(){this.clearContent();this.draftContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);MWF.xDesktop.requireApp("cms.Explorer","DraftExplorer",function(){if(!this.restActions)this.restActions=new MWF.xApplication.cms.Explorer.Actions.RestActions;this.draftExplorer=new MWF.xApplication.cms.Explorer.DraftExplorer(this.draftContent,this.restActions);this.draftExplorer.app=this;this.draftExplorer.load()}.bind(this))},openRecycleBin:function(){alert("openRecycleBin")},openManager:function(){var t="cms.Column";if(this.desktop.apps[t]){this.desktop.apps[t].setCurrent()}else{this.desktop.openApplication(null,"cms.Column",{appId:t,onQueryLoad:function(){}})}},openCategory:function(t,e,i){MWF.xDesktop.requireApp("cms.Explorer","ViewExplorer",function(){this.clearContent();this.explorerContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);if(!this.restActions)this.restActions=new MWF.xApplication.cms.Explorer.Actions.RestActions;this.explorer=new MWF.xApplication.cms.Explorer.ViewExplorer(this.explorerContent,this.restActions,t,e,i?{viewId:i}:null);this.explorer.app=this;this.explorer.load()}.bind(this))},recordStatus:function(){if(this.menu.currentNavi){var t=this.menu.currentNavi.retrieve("type");var e=this.menu.currentNavi.retrieve("naviData");return{navi:{type:t,id:e.id,columnId:e.appId},view:this.explorer.currentViewData.id?this.explorer.currentViewData.id:"default"}}}});MWF.xApplication.cms.Explorer.Menu=new Class({Implements:[Options,Events],initialize:function(t,e,i){this.setOptions(i);this.app=t;this.node=$(e);this.currentNavi=null;this.status="start";this.navis=[];this.columns={};this.items={};this.load()},load:function(){var t=this.app.path+"defaultMenu.json";MWF.getJSON(t,function(t){t.each(function(t){if(t.access&&t.access=="admin"){if(MWF.AC.isAdministrator())this.createDefaultNaviNode(t)}else{this.createDefaultNaviNode(t)}}.bind(this));this.app.restActions.listColumn(function(t){if(t.data){t.data.each(function(t){if(!t.name)t.name=t.appName;this.createColumnNaviNode(t)}.bind(this))}this.setDefaultMenuWidth();this.fireEvent("postLoad")}.bind(this),function(){this.setDefaultMenuWidth();this.fireEvent("postLoad")}.bind(this),true)}.bind(this))},createDefaultNaviNode:function(t){var e=new Element("div",{styles:this.app.css.defaultMenuNaviNode});e.store("naviData",t);e.store("type","default");var i=new Element("div",{styles:this.app.css.defaultMenuIconNode}).inject(e);i.setStyle("background-image","url("+this.app.path+this.app.options.style+"/icon/"+t.icon+")");var s=new Element("div",{styles:this.app.css.defaultMenuTextNode,text:t.title});s.inject(e);e.inject(this.node);this.navis.push(e);this.items[t.id]=e;this.setDefaultNaviEvent(e,t);this.setNodeCenter(this.node)},createColumnNaviNode:function(t){var e=this.columns[t.id]=this.columns[t.id]||{};var i=e.node=new Element("div",{styles:this.app.css.columnMenuNaviNode});i.store("naviData",t);i.store("type","column");var s=new Element("div",{styles:this.app.css.columnMenuIconNode}).inject(i);if(t.appIcon&&t.appIcon!=""){var n=new Element("img",{src:"data:image/png;base64,"+t.appIcon}).inject(s);n.setStyles(this.app.css.columnMenuImgNode)}else{s.setStyle("background-image","url("+this.app.path+this.app.options.style+"/icon/column24.png)")}var o=new Element("div",{styles:this.app.css.columnMenuTextNode,text:t.name});o.inject(i);i.inject(this.node);this.navis.push(i);this.items[t.id]=i;this.setColumnNaviEvent(i);this.setNodeCenter(this.node)},createCategoryNaviNode:function(t,e,i){var s=this.columns[e].categoryNodes=this.columns[e].categoryNodes||[];var n=new Element("div",{styles:this.app.css.categoryMenuNaviNode});n.setStyle("display","block");s.push(n);n.store("naviData",t);n.store("type","category");var o=new Element("div",{styles:this.app.css.categoryMenuIconNode}).inject(n);var a=new Element("div",{styles:this.app.css.categoryMenuTextNode,text:t.name});a.inject(n);n.inject(i,"after");this.navis.push(n);this.items[t.id]=n;this.setCategoryNaviEvent(n);this.setNodeCenter(this.node)},setDefaultNaviEvent:function(t){var e=this;t.addEvents({mouseover:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.defaultMenuNaviNode_over)},mouseout:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.defaultMenuNaviNode)},mousedown:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.defaultMenuNaviNode_down)},mouseup:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.defaultMenuNaviNode_over)},click:function(){e.doAction.apply(e,[this])}})},setColumnNaviEvent:function(t){var e=this;t.addEvents({mouseover:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.columnMenuNaviNode_over)},mouseout:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.columnMenuNaviNode)},mousedown:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.columnMenuNaviNode_down)},mouseup:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.columnMenuNaviNode_over)},click:function(){e.doColumnAction.apply(e,[this])}})},setCategoryNaviEvent:function(t){var e=this;t.addEvents({mouseover:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.categoryMenuNaviNode_over)},mouseout:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.categoryMenuNaviNode)},mousedown:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.categoryMenuNaviNode_down)},mouseup:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.categoryMenuNaviNode_over)},click:function(){e.doCategoryAction.apply(e,[this])}})},doAction:function(t){this.closeCurrentColumn();var e=t.retrieve("naviData");var i=e.action;var s=t.retrieve("type");if(!e.target||e.target!="_blank"){if(this.currentNavi)this.currentNavi.setStyles(this.currentNavi.retrieve("type")!="column"?this.app.css.defaultMenuNaviNode:this.app.css.columnMenuNaviNode);t.setStyles(s!="column"?this.app.css.defaultMenuNaviNode_current:this.app.css.columnMenuNaviNode_current);this.currentNavi=t}if(this.app[i])this.app[i].apply(this.app);if(this.status=="start"){this.toNormal();this.status="normal"}},doColumnAction:function(t,e){var i=t.retrieve("naviData");var s=i.action;this.closeCurrentColumn();if(this.columns[i.id].categoryNodes){this.columns[i.id].categoryNodes.each(function(t){t.setStyle("display","block")})}else{this.app.restActions.listCategory(i.id,function(s){s.data.reverse().each(function(e){this.createCategoryNaviNode(e,i.id,t)}.bind(this));if(e)e()}.bind(this))}this.currentColumn=t;var n=t.retrieve("type");if(!i.target||i.target!="_blank"){if(this.currentNavi)this.currentNavi.setStyles(this.currentNavi.retrieve("type")!="column"?this.app.css.defaultMenuNaviNode:this.app.css.columnMenuNaviNode);t.setStyles(n!="column"?this.app.css.defaultMenuNaviNode_current:this.app.css.columnMenuNaviNode_current);this.currentNavi=t}if(this.status=="start"){this.toNormal();this.status="normal"}},doCategoryAction:function(t,e){var i=t.retrieve("naviData");var s=i.action;var n=t.retrieve("type");if(!i.target||i.target!="_blank"){if(this.currentNavi)this.currentNavi.setStyles(this.currentNavi.retrieve("type")!="column"?this.app.css.defaultMenuNaviNode:this.app.css.columnMenuNaviNode);t.setStyles(n!="column"?this.app.css.defaultMenuNaviNode_current:this.app.css.columnMenuNaviNode_current);this.currentNavi=t}this.app.openCategory.call(this.app,this.currentColumn.retrieve("naviData"),i,e);if(this.status=="start"){this.toNormal();this.status="normal"}},closeCurrentColumn:function(){if(this.currentColumn){var t=this.currentColumn.retrieve("naviData");if(this.columns[t.id].categoryNodes){this.columns[t.id].categoryNodes.each(function(t){t.setStyle("display","none")})}this.currentColumn=null}},toNormal:function(){var t=this.app.css.normalDefaultMenuNode;this.node.setStyles(t);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.node,{style:"xApp_CMSExplorer_StartMenu",distance:100,friction:4,axis:{x:false,y:true}})}.bind(this))},setNodeCenter:function(t){var e=t.getSize();var i=this.app.node.getSize();var s=i.y/2-e.y/2;var n=i.x/2-e.x/2;if(n<0)n=0;if(s<0)s=0;t.setStyles({left:n,top:s})},getDefaultMenuNormalSize:function(){var t=this.node.getFirst();var e=t.getComputedSize();var i=t.getStyle("margin-top").toFloat();var s=t.getStyle("margin-bottom").toFloat();var n=e.totalWidth+i+s;var o=t.getStyle("margin-left").toFloat();var a=t.getStyle("margin-right").toFloat();var r=e.totalWidth+o+a;return{width:r,height:n*this.navis.length}},setDefaultMenuWidth:function(){var t=this.node.getFirst();var e=t.getComputedSize();var i=t.getStyle("margin-left").toFloat();var s=t.getStyle("margin-right").toFloat();var n=e.totalWidth+i+s;this.node.setStyle("width",n*this.navis.length+"px")},onResize:function(){if(this.status=="start"){this.setNodeCenter(this.node)}}});