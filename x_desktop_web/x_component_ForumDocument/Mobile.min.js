MWF.xApplication.Forum=MWF.xApplication.Forum||{};MWF.xApplication.ForumDocument=MWF.xApplication.ForumDocument||{};MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.xApplication.ForumDocument.Mobile=new Class({Implements:[Options,Events],options:{id:"",sectionId:"",viewPageNum:1,replyIndex:null,isNew:false,isEdited:false},initialize:function(e,t,i,n,s,o){this.setOptions(o);this.app=t;this.node=$(e);this.actions=i;this.lp=n;this.css=s;this.path="/x_component_ForumDocument/$Mobile/default/"},load:function(){this.actions.login({},function(e){this.actions.listSubjectPermission(this.options.id,function(e){this.permission=e.data;this.actions.getSubjectView(this.options.id,function(e){this.data=e.data.currentSubject;this.options.sectionId=this.data.sectionId;this.createMiddleNode()}.bind(this))}.bind(this))}.bind(this))},createMiddleNode:function(){this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.node);this.subjectConainer=new Element("div.subjectConainer",{styles:this.css.subjectConainer}).inject(this.middleNode);this.replyViewConainer=new Element("div.replyViewConainer",{styles:this.css.replyViewConainer}).inject(this.middleNode);this.createSubject();this.createReplyView()},createSubject:function(){this.subjectView=new MWF.xApplication.ForumDocument.Mobile.SubjectView(this.subjectConainer,this.app,this,{templateUrl:this.path+"listItemSubject.json",scrollEnable:false});this.subjectView.data=this.data;this.subjectView.load()},createReplyView:function(){new Element("div.itemReplyTitle",{styles:this.css.itemReplyTitle,text:this.lp.reply}).inject(this.replyViewConainer);this.replyView=new MWF.xApplication.ForumDocument.Mobile.ReplyView(this.replyViewConainer,this.app,this,{templateUrl:this.path+"listItemReply.json",scrollEnable:false,pagingEnable:true,documentKeyWord:"orderNumber",pagingPar:{currentPage:this.options.viewPageNum||1,countPerPage:10,hasPrevPage:true,hasTruningBar:false,onPostLoad:function(){if(this.replyView.getCurrentPageNum()==1){if(this.replyView.paging&&this.replyView.paging.nextPageNode)this.replyView.paging.nextPageNode.setStyle("width","99%")}else if(this.replyView.getCurrentPageNum()==this.replyView.getPageSize()){if(this.replyView.paging&&this.replyView.paging.prevPageNode)this.replyView.paging.prevPageNode.setStyle("width","99%")}else{if(this.replyView.paging&&this.replyView.paging.prevPageNode)this.replyView.paging.prevPageNode.setStyle("width","49%");if(this.replyView.paging&&this.replyView.paging.nextPageNode)this.replyView.paging.nextPageNode.setStyle("width","49%")}}.bind(this)}});this.replyView.data=this.data;this.replyView.filterData={subjectId:this.data.id};this.replyView.load()},getDateDiff:function(e){var t=Date.parse(e.replace(/-/gi,"/"));var i=1e3*60;var n=i*60;var s=n*24;var o=s*15;var a=s*30;var r=a*12;var l=(new Date).getTime();var c=l-t;if(c<0){}var u=(new Date).decrement("day",1);var p=(new Date).decrement("day",2);var d=c/r;var h=c/a;var m=c/(7*s);var g=c/s;var f=c/n;var w=c/i;if(u.getFullYear()==t.getFullYear()&&u.getMonth()==t.getMonth()&&u.getDate()==t.getDate()){result="昨天 "+t.getHours()+":"+t.getMinutes()}else if(p.getFullYear()==t.getFullYear()&&p.getMonth()==t.getMonth()&&p.getDate()==t.getDate()){result="前天 "+t.getHours()+":"+t.getMinutes()}else if(d>1){result=t.getFullYear()+"年"+(t.getMonth()+1)+"月"+t.getDate()+"日"}else if(h>=1){result=t.getMonth()+1+"月"+t.getDate()+"日"}else if(m>=1){result=parseInt(m)+"周前"}else if(g>=1){result=parseInt(g)+"天前"}else if(f>=1){result=parseInt(f)+"小时前"}else if(w>=1){result=parseInt(w)+"分钟前"}else result="刚才";return result}});MWF.xApplication.ForumDocument.Mobile.SubjectView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(e,t){e.index=t;this.getUserData(e.creatorName,function(t){e.userIcon=t.data.icon;return new MWF.xApplication.ForumDocument.Mobile.SubjectDocument(this.viewNode,e,this.explorer,this,null,e.index)}.bind(this))},getUserData:function(e,t){this.actions.getPerson(function(e){if(t)t(e)}.bind(this),null,e,true)},_getCurrentPageData:function(e,t){var i={type:"success",count:1,size:1,data:[this.data]};if(e)e(i)},_removeDocument:function(e,t){this.actions.deleteSection(e.id,function(e){this.reload();this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_create:function(){},_queryCreateViewNode:function(){},_postCreateViewNode:function(e){},_queryCreateViewHead:function(){},_postCreateViewHead:function(e){}});MWF.xApplication.ForumDocument.Mobile.SubjectDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,mouseoverSubject:function(e,t){},mouseoutSubject:function(e,t){},_queryCreateDocumentNode:function(e){},_postCreateDocumentNode:function(e,t){},createReply:function(e,t){var i=new MWF.xApplication.ForumDocument.ReplyForm(this,{},{toMain:true,onPostOk:function(e){this.app.postCreateReply(e)}.bind(this)});i.mainData=this.data;i.create()}});MWF.xApplication.ForumDocument.Mobile.ReplyView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(e,t){e.index=t;return new MWF.xApplication.ForumDocument.Mobile.ReplyDocument(this.viewNode,e,this.explorer,this,null,e.index)},_getCurrentPageData:function(e,t,i){this.clearBody();if(!t)t=10;if(!i)i=1;if(i==1){this.explorer.subjectConainer.setStyle("display","block")}else{this.explorer.subjectConainer.setStyle("display","none")}var n=this.filterData||{};this.actions.listReplyFilterPage(i,t,n,function(t){if(!t.data)t.data=[];if(!t.count)t.count=0;if(e)e(t)}.bind(this))},_removeDocument:function(e,t){this.actions.deleteReply(e.id,function(){this.reload();this.app.notice(this.lp.deleteReplySuccess,"ok")}.bind(this))},_create:function(){},_queryCreateViewNode:function(){},_postCreateViewNode:function(e){},_queryCreateViewHead:function(){},_postCreateViewHead:function(e){}});MWF.xApplication.ForumDocument.Mobile.ReplyDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,mouseoverSubject:function(e,t){},mouseoutSubject:function(e,t){},getUserData:function(e,t){this.actions.getPerson(function(e){if(t)t(e)}.bind(this),null,e,true)},_queryCreateDocumentNode:function(e){},_postCreateDocumentNode:function(e,t){if(t.parentId&&t.parentId!=""){var i=e.getElements("[item='quoteContent']")[0];this.actions.getReply(t.parentId,function(e){var t=this.parentData=e.data;var n=new Element("div",{styles:this.css.itemQuote}).inject(i);var s=n.set("html",t.content).get("text");n.empty();t.contentText=s;var o=new Element("div",{styles:this.css.quoteArea}).inject(n);var a=new Element("div",{styles:this.css.quoteInfor,text:this.lp.replyTo+" "+t.orderNumber+this.lp.floor+" "+t.creatorName+" "+t.createTime}).inject(o);new Element("div",{styles:this.css.quoteText,text:s.length>100?s.substr(0,100)+"...":s}).inject(o)}.bind(this),function(e){new Element("div",{styles:this.css.replyBeinngDelete,text:this.lp.quoteReplyBeingDeleted}).inject(i)}.bind(this))}var n=e.getElements("[item='userIcon']")[0];this.getUserData(t.creatorName,function(e){n.src="data:image/png;base64,"+e.data.icon}.bind(this))},createReply:function(e,t){var i=navigator.userAgent.toLowerCase();if(/iphone|ipad|ipod/.test(i)){window.webkit.messageHandlers.ReplyAction.postMessage({body:this.data.id})}else if(/android/.test(i)){window.o2bbs.reply(this.data.id)}}});