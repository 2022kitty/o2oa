MWF.xApplication.Meeting.MonthView=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(i);this.path="/x_component_Meeting/$MonthView/";this.cssPath="/x_component_Meeting/$MonthView/"+this.options.style+"/css.wcss";this._loadCss();this.app=e;this.container=$(t);this.load()},load:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.container);this.resetNodeSize();this.app.addEvent("resize",this.resetNodeSize.bind(this));this.loadCalendar()},resetNodeSize:function(){var t=this.container.getSize();if(this.app.meetingConfig.hideMenu=="static"){var e=t.y-120;this.node.setStyle("height",""+e+"px");this.node.setStyle("margin-top","60px")}else{var e=t.y-20;this.node.setStyle("height",""+e+"px")}},loadCalendar:function(){this.calendar=new MWF.xApplication.Meeting.MonthView.Calendar(this)},hide:function(){var t=new Fx.Morph(this.node,{duration:"300",transition:Fx.Transitions.Expo.easeOut});if(this.currentMeetingDocument)this.currentMeetingDocument.closeDocument();t.start({opacity:0}).chain(function(){this.node.setStyle("display","none")}.bind(this))},show:function(){this.node.setStyles(this.css.node);var t=new Fx.Morph(this.node,{duration:"800",transition:Fx.Transitions.Expo.easeOut});this.app.fireAppEvent("resize");t.start({opacity:1,left:"0px"}).chain(function(){this.node.setStyles({position:"static",width:"auto"})}.bind(this))},reload:function(){if(this.calendar)this.calendar.reLoadCalendar()}});MWF.xApplication.Meeting.MonthView.Calendar=new Class({Implements:[Events],initialize:function(t){this.view=t;this.css=this.view.css;this.container=this.view.node;this.app=this.view.app;this.date=new Date;this.today=new Date;this.days={};this.load()},load:function(){this.titleNode=new Element("div",{styles:this.css.calendarTitleNode}).inject(this.container);this.bodyNode=new Element("div",{styles:this.css.calendarBodyNode}).inject(this.container);this.setTitleNode();this.setBodyNode();this.resetBodySize();this.app.addEvent("resize",this.resetBodySize.bind(this))},resetBodySize:function(){var t=this.container.getSize();var e=this.titleNode.getSize();var i=t.y-e.y;this.bodyNode.setStyle("height",""+i+"px");var s=(i-30)/6;s=s-34;var n=this.calendarTable.getElements("td");n.each(function(t){var e=s;var i=t.getLast("div");if(i.childNodes.length>=4){if(e<92)e=69}i.setStyle("height",""+e+"px")}.bind(this))},setTitleNode:function(){this.prevMonthNode=new Element("div",{styles:this.css.calendarPrevMonthNode}).inject(this.titleNode);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode=new Element("div",{styles:this.css.calendarTitleTextNode,text:t}).inject(this.titleNode);this.nextMonthNode=new Element("div",{styles:this.css.calendarNextMonthNode}).inject(this.titleNode);this.prevMonthNode.addEvents({mouseover:function(){this.prevMonthNode.setStyles(this.css.calendarPrevMonthNode_over)}.bind(this),mouseout:function(){this.prevMonthNode.setStyles(this.css.calendarPrevMonthNode)}.bind(this),mousedown:function(){this.prevMonthNode.setStyles(this.css.calendarPrevMonthNode_down)}.bind(this),mouseup:function(){this.prevMonthNode.setStyles(this.css.calendarPrevMonthNode_over)}.bind(this),click:function(){this.changeMonthPrev()}.bind(this)});this.nextMonthNode.addEvents({mouseover:function(){this.nextMonthNode.setStyles(this.css.calendarNextMonthNode_over)}.bind(this),mouseout:function(){this.nextMonthNode.setStyles(this.css.calendarNextMonthNode)}.bind(this),mousedown:function(){this.nextMonthNode.setStyles(this.css.calendarNextMonthNode_down)}.bind(this),mouseup:function(){this.nextMonthNode.setStyles(this.css.calendarNextMonthNode_over)}.bind(this),click:function(){this.changeMonthNext()}.bind(this)});this.titleTextNode.addEvents({mouseover:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_over)}.bind(this),mouseout:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode)}.bind(this),mousedown:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_down)}.bind(this),mouseup:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_over)}.bind(this),click:function(){this.changeMonthSelect()}.bind(this)})},changeMonthPrev:function(){this.date.decrement("month",1);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",t);this.reLoadCalendar()},changeMonthNext:function(){this.date.increment("month",1);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",t);this.reLoadCalendar()},changeMonthSelect:function(){if(!this.monthSelector)this.createMonthSelector();this.monthSelector.show()},createMonthSelector:function(){this.monthSelector=new MWF.xApplication.Meeting.MonthView.Calendar.MonthSelector(this.date,this)},changeMonthTo:function(t){this.date=t;var e=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",e);this.reLoadCalendar()},setBodyNode:function(){var t="<tr><th>"+this.app.lp.weeks.Mon+"</th><th>"+this.app.lp.weeks.Tues+"</th><th>"+this.app.lp.weeks.Wed+"</th>"+"<th>"+this.app.lp.weeks.Thur+"</th><th>"+this.app.lp.weeks.Fri+"</th><th>"+this.app.lp.weeks.Sat+"</th><th>"+this.app.lp.weeks.Sun+"</th></tr>";t+='<tr><td vAlign="top"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>';t+="<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>";t+="<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>";t+="<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>";t+="<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>";t+="<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>";this.calendarTable=new Element("table",{styles:this.css.calendarTable,height:"100%",border:"0",cellPadding:"0",cellSpacing:"0",html:t}).inject(this.bodyNode);this.calendarTableTitleTr=this.calendarTable.getElement("tr");this.calendarTableTitleTr.setStyles(this.css.calendarTableTitleTr);var e=this.calendarTableTitleTr.getElements("th");e.setStyles(this.css.calendarTableTh);this.loadCalendar()},reLoadCalendar:function(){Object.each(this.days,function(t){t.destroy()}.bind(this));this.loadCalendar()},loadCalendar:function(){var t=this.date.clone();t.set("date",1);var e=t.getDay();var i=e-1<0?6:e-1;t.decrement("day",i);var s=this.calendarTable.getElements("td");s.each(function(e){this.loadDay(e,t);t.increment()}.bind(this))},loadDay:function(t,e){var i="thisMonth";var s=e.get("month");var n=e.get("year");var o=e.get("date");var d=this.date.get("month");var h=this.date.get("year");var a=this.today.get("month");var l=this.today.get("year");var c=this.today.get("date");if(s==a&&n==l&&o==c){i="today"}else if(s==d&&n==h){i="thisMonth"}else{i="otherMonth"}var r=e.format(this.app.lp.dateFormat);this.days[r]=new MWF.xApplication.Meeting.MonthView.Calendar.Day(t,e,this,i)}});MWF.xApplication.Meeting.MonthView.Calendar.Day=new Class({Implements:[Events],initialize:function(t,e,i,s){this.node=t;this.calendar=i;this.view=this.calendar.view;this.css=this.calendar.css;this.app=this.calendar.app;this.date=e.clone();this.key=this.date.format(this.app.lp.dateFormat);this.type=s;this.meetings=[];this.load()},load:function(){this.day=this.date.getDate();this.month=this.date.getMonth();this.year=this.date.getYear();this.node.setStyles(this.css["calendarTableCell_"+this.type]);this.titleNode=new Element("div",{styles:this.css["calendarDayTitle_"+this.type]}).inject(this.node);this.titleDayNode=new Element("div",{styles:this.css["calendarDayTitleDay_"+this.type],text:this.day}).inject(this.titleNode);if((new Date).diff(this.date)>=0){this.titleNode.set("title",this.app.lp.titleNode);this.titleNode.addEvent("click",function(){this.app.addMeeting(this.date)}.bind(this))}this.contentNode=new Element("div",{styles:this.css.calendarDayContentNode}).inject(this.node);this.loadMeetings()},loadMeetings:function(){var t=this.date.getFullYear();var e=this.date.getMonth()+1;var i=this.date.getDate();var s=0;this.app.actions.listMeetingDay(t,e,i,function(t){t.data.each(function(t,e){if(!t.myReject){s++;if(s==4){this.contentNode.setStyle("height","100px")}if(s<5)this.meetings.push(new MWF.xApplication.Meeting.MonthView.Calendar.Day.Meeting(this,t))}}.bind(this));if(s==0){var e=new Element("div",{styles:{"line-height":"40px","font-size":"14px",color:"#888",padding:"0px 10px"}}).inject(this.contentNode);e.set("text",this.app.lp.noMeeting)}else{if(s>3){this.titleInforNode=new Element("div",{styles:this.css["calendarDayTitleInfor_"+this.type]}).inject(this.titleNode);this.titleInforNode.addEvent("click",function(t){this.app.toDay(this.date);t.stopPropagation()}.bind(this));this.titleInforNode.set("text",s+this.app.lp.countMeetings)}}}.bind(this))},destroy:function(){this.meetings.each(function(t){t.destroy()}.bind(this));this.meetings=[];this.titleNode.destroy();this.titleNode=null;this.titleDayNode=null;this.titleInforNode=null;delete this.calendar.days[this.key];this.node.empty();MWF.release(this)}});MWF.xApplication.Meeting.MonthView.Calendar.Day.Meeting=new Class({initialize:function(t,e){this.day=t;this.css=this.day.css;this.view=this.day.view;this.app=this.day.app;this.container=this.day.contentNode;this.data=e;this.load()},load:function(){this.node=new Element("div",{styles:this.css.calendarDayContentMeetingNode}).inject(this.container);this.iconNode=new Element("div",{styles:this.css.calendarDayContentMeetingIconNode}).inject(this.node);this.timeNode=new Element("div",{styles:this.css.calendarDayContentMeetingTimeNode}).inject(this.node);this.textNode=new Element("div",{styles:this.css.calendarDayContentMeetingTextNode}).inject(this.node);var t=Date.parse(this.data.startTime).format("%H:%M");this.timeNode.set("text",t);this.textNode.set("text",this.data.subject);this.node.set("title",this.data.subject);switch(this.data.status){case"wait":break;case"processing":this.node.setStyles({"border-left":"5px solid #18da14","background-color":"#deffdd"});break;case"completed":this.node.setStyles({"border-left":"5px solid #555","background-color":"#F3F3F3"});this.textNode.setStyle("color","#666");break}if(this.data.myWaitAccept){this.node.setStyles({"border-left":"5px solid #ecd034","background-color":"#fffade"})}this.node.addEvent("click",function(){this.openMeeting()}.bind(this))},openMeeting:function(){if(!this.document){if(this.view.currentMeetingDocument)this.view.currentMeetingDocument.closeDocument();this.document=new MWF.xApplication.Meeting.MonthView.Calendar.Day.Document(this);this.view.currentMeetingDocument=this.document}},destroy:function(){if(this.document){this.document.closeDocument(function(){this.node.destroy();MWF.release(this)}.bind(this))}else{this.node.destroy();MWF.release(this)}}});MWF.xApplication.Meeting.MonthView.Calendar.Day.Document=new Class({Extends:MWF.xApplication.Meeting.MeetingView.Document,initialize:function(t){this.item=t;this.view=this.item.view;this.container=this.view.node;this.app=this.view.app;this.path="/x_component_Meeting/$MeetingView/";this.cssPath="/x_component_Meeting/$MeetingView/default/css.wcss";this._loadCss();this.app.actions.getMeeting(this.item.data.id,function(t){this.data=t.data;this.isEdit=this.data.applicant==this.app.desktop.session.user.name;this.load()}.bind(this))},closeDocument:function(t){if(this.setDescriptionNodeSizeFun)this.app.removeEvent("resize",this.setDescriptionNodeSizeFun);if(this.setNodeSizeFun)this.app.removeEvent("resize",this.setNodeSizeFun);var e=this.item.node.getSize();var i=this.item.node.getPosition(this.app.content);var s=new Fx.Morph(this.node,{duration:"500",transition:Fx.Transitions.Expo.easeOut});this.node.empty();this.view.currentMeetingDocument=null;s.start({opacity:0,width:""+e.x+"px",height:""+e.y+"px",left:""+i.x+"px",top:""+i.y+"px"}).chain(function(){this.destroy();if(t)t()}.bind(this))},_loadCss:function(){var t=encodeURIComponent(this.cssPath);if(MWF.widget.css[t]){this.css=MWF.widget.css[t]}else{var e=new Request.JSON({url:this.cssPath,secure:false,async:false,method:"get",noCache:false,onSuccess:function(e,i){this.css=e;MWF.widget.css[t]=e}.bind(this),onError:function(t,e){alert(e+t)}});e.send()}}});MWF.xApplication.Meeting.MonthView.Calendar.MonthSelector=new Class({Implements:[Events],initialize:function(t,e){this.calendar=e;this.css=this.calendar.css;this.app=this.calendar.app;this.date=t;this.year=this.date.get("year");this.load()},load:function(){this.monthSelectNode=new Element("div",{styles:this.css.calendarMonthSelectNode}).inject(this.calendar.container);this.monthSelectNode.position({relativeTo:this.calendar.titleTextNode,position:"bottomCenter",edge:"upperCenter"});this.monthSelectNode.addEvent("mousedown",function(t){t.stopPropagation()});this.monthSelectTitleNode=new Element("div",{styles:this.css.calendarMonthSelectTitleNode}).inject(this.monthSelectNode);this.monthSelectPrevYearNode=new Element("div",{styles:this.css.calendarMonthSelectTitlePrevYearNode}).inject(this.monthSelectTitleNode);this.monthSelectNextYearNode=new Element("div",{styles:this.css.calendarMonthSelectTitleNextYearNode}).inject(this.monthSelectTitleNode);this.monthSelectTextNode=new Element("div",{styles:this.css.calendarMonthSelectTitleTextNode}).inject(this.monthSelectTitleNode);this.monthSelectTextNode.set("text",this.year);var t="<tr><td></td><td></td><td></td></tr>";t+="<tr><td></td><td></td><td></td></tr>";t+="<tr><td></td><td></td><td></td></tr>";t+="<tr><td></td><td></td><td></td></tr>";this.monthSelectTable=new Element("table",{styles:{"margin-top":"10px"},height:"200px",width:"90%",align:"center",border:"0",cellPadding:"0",cellSpacing:"5",html:t}).inject(this.monthSelectNode);this.monthSelectBottomNode=new Element("div",{styles:this.css.calendarMonthSelectBottomNode,text:this.app.lp.today}).inject(this.monthSelectNode);this.setEvent()},loadMonth:function(){this.monthSelectTextNode.set("text",this.year);var t=new Date;var e=t.get("year");var i=t.get("month");var s=this.date.get("year");var n=this.date.get("month");var o=this;var d=this.monthSelectTable.getElements("td");d.each(function(t,d){t.empty();t.removeEvents("mouseover");t.removeEvents("mouseout");t.removeEvents("mousedown");t.removeEvents("mouseup");t.removeEvents("click");var h=d+1;t.store("month",h);t.setStyles(this.css.calendarMonthSelectTdNode);t.set("text",""+h+this.app.lp.month);t.setStyle("background-color","#FFF");if(this.year==s&&d==n){t.setStyle("background-color","#EEE")}if(this.year==e&&d==i){t.setStyle("background-color","#CCC")}t.addEvents({mouseover:function(){this.setStyles(o.css.calendarMonthSelectTdNode_over)},mouseout:function(){this.setStyles(o.css.calendarMonthSelectTdNode)},mousedown:function(){this.setStyles(o.css.calendarMonthSelectTdNode_down)},mouseup:function(){this.setStyles(o.css.calendarMonthSelectTdNode_over)},click:function(){o.selectedMonth(this)}})}.bind(this))},setEvent:function(){this.monthSelectPrevYearNode.addEvent("click",function(){this.prevYear()}.bind(this));this.monthSelectNextYearNode.addEvent("click",function(){this.nextYear()}.bind(this));this.monthSelectBottomNode.addEvent("click",function(){this.todayMonth()}.bind(this))},prevYear:function(){debugger;this.year--;if(this.year<1900)this.year=1900;this.monthSelectTextNode.set("text",this.year);this.loadMonth()},nextYear:function(){this.year++;this.monthSelectTextNode.set("text",this.year);this.loadMonth()},todayMonth:function(){var t=new Date;this.calendar.changeMonthTo(t);this.hide()},selectedMonth:function(t){var e=t.retrieve("month");var i=Date.parse(this.year+"/"+e+"/1");this.calendar.changeMonthTo(i);this.hide()},show:function(){this.date=this.calendar.date;this.year=this.date.get("year");this.loadMonth();this.monthSelectNode.setStyle("display","block");this.hideFun=this.hide.bind(this);document.body.addEvent("mousedown",this.hideFun)},hide:function(){this.monthSelectNode.setStyle("display","none");document.body.removeEvent("mousedown",this.hideFun)},destroy:function(){}});