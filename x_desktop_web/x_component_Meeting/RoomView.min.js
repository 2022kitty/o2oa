MWF.xDesktop.requireApp("Meeting","MeetingView",null,false);MWF.xApplication.Meeting.RoomView=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(i);this.path="/x_component_Meeting/$RoomView/";this.cssPath="/x_component_Meeting/$RoomView/"+this.options.style+"/css.wcss";this._loadCss();this.app=e;this.container=$(t);this.buildings=[];this.date=new Date;this.hours=1;this.load()},load:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.container);this.roomArea=new Element("div",{styles:this.css.roomArea}).inject(this.node);this.infoArea=new Element("div",{styles:this.css.infoArea}).inject(this.node);this.roomDateArea=new Element("div",{styles:this.css.roomDateArea}).inject(this.roomArea);this.roomBuildingsArea=new Element("div",{styles:this.css.roomBuildingsArea}).inject(this.roomArea);this.resetNodeSize();this.app.addEvent("resize",this.resetNodeSize.bind(this));this.loadDate();this.loadRooms()},loadDate:function(){var t=this.date.format(this.app.lp.dateFormatAll);this.roomDateNode=new Element("div",{styles:this.css.roomDateNode}).inject(this.roomDateArea);this.roomDateTextNode=new Element("div",{styles:this.css.roomDateTextNode}).inject(this.roomDateNode);this.roomDateIconNode=new Element("div",{styles:this.css.roomDateIconNode}).inject(this.roomDateNode);this.roomHourRangeNode=new Element("div",{styles:this.css.roomHourRangeNode}).inject(this.roomDateArea);var e=this.app.lp.persist+" <select>"+"<option "+(this.hours==1?"selected":"")+" value=1>1</option>"+"<option "+(this.hours==2?"selected":"")+" value=2>2</option>"+"<option "+(this.hours==3?"selected":"")+" value=3>3</option>"+"<option "+(this.hours==4?"selected":"")+" value=4>4</option>"+"<option "+(this.hours==5?"selected":"")+" value=5>5</option>"+"<option "+(this.hours==6?"selected":"")+" value=6>6</option>"+"<option "+(this.hours==7?"selected":"")+" value=7>7</option>"+"<option "+(this.hours==8?"selected":"")+" value=8>8</option>"+"<option "+(this.hours==9?"selected":"")+" value=9>9</option>"+"<option "+(this.hours==10?"selected":"")+" value=10>10</option>"+"<option "+(this.hours==11?"selected":"")+" value=11>11</option>"+"<option "+(this.hours==12?"selected":"")+" value=12>12</option>"+"<option "+(this.hours==13?"selected":"")+" value=13>13</option>"+"<option "+(this.hours==14?"selected":"")+" value=14>14</option>"+"<option "+(this.hours==15?"selected":"")+" value=15>15</option>"+"<option "+(this.hours==16?"selected":"")+" value=16>16</option>"+"<option "+(this.hours==17?"selected":"")+" value=17>17</option>"+"<option "+(this.hours==18?"selected":"")+" value=18>18</option>"+"<option "+(this.hours==19?"selected":"")+" value=19>19</option>"+"<option "+(this.hours==20?"selected":"")+" value=20>20</option>"+"<option "+(this.hours==21?"selected":"")+" value=21>21</option>"+"<option "+(this.hours==22?"selected":"")+" value=22>22</option>"+"<option "+(this.hours==23?"selected":"")+" value=23>23</option>"+"<option "+(this.hours==24?"selected":"")+" value=24>24</option>"+"</select> "+this.app.lp.hour;this.roomDateTextNode.set("text",t);this.roomHourRangeNode.set("html",e);this.roomHourRangeSelect=this.roomHourRangeNode.getElement("select").setStyles(this.css.roomHourRangeSelectNode);this.roomHourRangeSelect.addEvent("change",function(){var t=this.roomHourRangeSelect.options[this.roomHourRangeSelect.selectedIndex].get("value");debugger;this.reload(this.date,t)}.bind(this));this.roomDateNode.addEvents({mouseover:function(){this.roomDateNode.setStyles(this.css.roomDateNode_over);this.roomDateIconNode.setStyles(this.css.roomDateIconNode_over)}.bind(this),mouseout:function(){this.roomDateNode.setStyles(this.css.roomDateNode);this.roomDateIconNode.setStyles(this.css.roomDateIconNode)}.bind(this),mousedown:function(){this.roomDateNode.setStyles(this.css.roomDateNode_down);this.roomDateIconNode.setStyles(this.css.roomDateIconNode_down)}.bind(this),mouseup:function(){this.roomDateNode.setStyles(this.css.roomDateNode_over);this.roomDateIconNode.setStyles(this.css.roomDateIconNode_over)}.bind(this)});MWF.require("MWF.widget.Calendar",function(){new MWF.widget.Calendar(this.roomDateNode,{style:"meeting",isTime:true,target:this.node,onQueryComplate:function(t,e,i){var s=new Date.parse(e);var o=this.roomHourRangeSelect.options[this.roomHourRangeSelect.selectedIndex].get("value");this.reload(s,o)}.bind(this)})}.bind(this))},resetNodeSize:function(){var t=this.container.getSize();if(this.app.meetingConfig.hideMenu=="static"){var e=t.y-120;this.node.setStyle("height",""+e+"px");this.node.setStyle("margin-top","60px")}else{var e=t.y-20;this.node.setStyle("height",""+e+"px")}var i=this.roomDateArea.getSize();e=e-i.y;this.roomBuildingsArea.setStyle("height",""+e+"px")},loadRooms:function(){var t=this.date.clone();t.set("sec",0);var e=t.format("%Y-%m-%d %H:%M");t.increment("hour",this.hours);var i=t.format("%Y-%m-%d %H:%M");this.app.actions.listBuildingByRange(e,i,function(t){this.roomJson=t.data;this.roomJson.each(function(t){this.buildings.push(new MWF.xApplication.Meeting.RoomView.Building(this,t))}.bind(this));this.checkWidth();this.checkWidthFun=this.checkWidth.bind(this);this.app.addEvent("resize",this.checkWidthFun);this.buildings.each(function(t){t.loadRooms()}.bind(this))}.bind(this))},checkWidth:function(){var t=this.buildings.length;if(t){var e=this.buildings[0].node.getStyle("min-width").toInt();var i=this.roomArea.getSize();while(t>0&&i.x/t<e)t--;var s=i.x/t;var o=s*this.buildings.length;this.buildings.each(function(t){t.node.setStyle("width",""+s+"px")}.bind(this));this.roomBuildingsArea.setStyle("width",""+o+"px")}},reload:function(t,e){if(t)this.date=t;if(e)this.hours=e;this.buildings.each(function(t){t.destroy()}.bind(this));this.buildings=[];if(this.currentDocument)this.currentDocument.close();this.app.removeEvent("resize",this.checkWidthFun);this.currentDocument=null;this.selectedItem=null;this.node.destroy();this.load();this.show()},hide:function(){var t=new Fx.Morph(this.node,{duration:"300",transition:Fx.Transitions.Expo.easeOut});if(this.currentMeetingDocument)this.currentMeetingDocument.closeDocument();t.start({opacity:0}).chain(function(){this.node.setStyle("display","none")}.bind(this))},show:function(){this.node.setStyles(this.css.node);var t=new Fx.Morph(this.node,{duration:"800",transition:Fx.Transitions.Expo.easeOut});this.app.fireAppEvent("resize");t.start({opacity:1,left:"0px"}).chain(function(){this.node.setStyles({position:"static",width:"auto"})}.bind(this))}});MWF.xApplication.Meeting.RoomView.Building=new Class({Implements:[Events],initialize:function(t,e){this.view=t;this.json=e;this.container=this.view.roomBuildingsArea;this.css=this.view.css;this.app=this.view.app;this.rooms=[];this.floors=[];this.load()},load:function(){this.node=new Element("div",{styles:this.css.buildingNode}).inject(this.container);this.titleNode=new Element("div",{styles:this.css.buildingTitleNode}).inject(this.node);this.titleNameNode=new Element("div",{styles:this.css.buildingTitleNameNode,text:this.json.name}).inject(this.titleNode);this.titleAddrNode=new Element("div",{styles:this.css.buildingTitleAddrNode,text:this.json.address}).inject(this.titleNode);this.contentScrollNode=new Element("div",{styles:this.css.buildingContentScrollNode}).inject(this.node);this.setContentScrollSize();this.setContentScrollSizeFun=this.setContentScrollSize.bind(this);this.app.addEvent("resize",this.setContentScrollSizeFun);this.contentNode=new Element("div",{styles:this.css.buildingContentNode}).inject(this.contentScrollNode);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.contentScrollNode,{style:"view",distance:100,indent:false})}.bind(this));this.titleNode.addEvent("click",function(){this.selected()}.bind(this))},selected:function(){var t=this.view.selectedItem!=this;if(this.view.selectedItem)this.view.selectedItem.unSelected();this.titleNode.setStyles(this.css.buildingTitleNode_selected);this.node.setStyles(this.css.buildingNode_selected);this.titleNameNode.setStyles(this.css.buildingTitleNameNode_selected);this.titleAddrNode.setStyles(this.css.buildingTitleAddrNode_selected);this.view.selectedItem=this;if(t)this.openDocBuilding()},unSelected:function(){this.titleNode.setStyles(this.css.buildingTitleNode);this.node.setStyles(this.css.buildingNode);this.titleNameNode.setStyles(this.css.buildingTitleNameNode);this.titleAddrNode.setStyles(this.css.buildingTitleAddrNode);this.view.selectedItem=null},openDocBuilding:function(){if(this.view.currentDocument)this.view.currentDocument.close();var t=new MWF.xApplication.Meeting.RoomView.Building.Document(this);this.view.currentDocument=t},setContentScrollSize:function(){var t=this.view.roomBuildingsArea.getSize();var e=this.titleNode.getSize();var i=t.y-e.y;this.contentScrollNode.setStyle("height",""+i+"px")},loadRooms:function(){var t;var e=null;this.json.roomList.each(function(i){if(t!=i.floor){if(e)e.checkWidth();t=i.floor;e=new MWF.xApplication.Meeting.RoomView.Building.Floor(this,i);this.floors.push(e)}this.rooms.push(new MWF.xApplication.Meeting.RoomView.Building.Room(e,i))}.bind(this));if(e)e.checkWidth()},destroy:function(){this.rooms.each(function(t){t.destroy()}.bind(this));this.floors.each(function(t){t.destroy()}.bind(this));this.app.removeEvent("resize",this.setContentScrollSizeFun);this.node.destroy();MWF.release(this)}});MWF.xApplication.Meeting.RoomView.Building.Document=new Class({Implements:[Events],initialize:function(t){this.building=t;this.view=this.building.view;this.json=this.building.json;this.container=this.view.infoArea;this.css=this.building.css;this.app=this.building.app;this.isEditMode=false;this.load()},load:function(){this.node=new Element("div",{styles:this.css.buildingDocNode}).inject(this.container);this.actionNode=new Element("div",{styles:this.css.buildingDocActionNode}).inject(this.node);this.titleNode=new Element("div",{styles:this.css.buildingDocTitleNode,text:this.json.name}).inject(this.node);this.loadContentNode();this.setMeetingNodeSize();this.setMeetingNodeSizeFun=this.setMeetingNodeSize.bind(this);this.app.addEvent("resize",this.setMeetingNodeSizeFun);if(this.app.isManager)this.loadActions()},loadContentNode:function(){this.contentNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.node);this.addrNode=new Element("div",{styles:this.css.buildingDocAddrNode}).inject(this.contentNode);var t=this.json.address||this.app.lp.inputAddress;this.addrNode.set("text",t)},setMeetingNodeSize:function(){if(this.meetingNode){var t=this.node.getSize();var e=this.actionNode.getSize();var i=this.titleNode.getSize();var s=this.contentNode.getSize();var o=t.y-e.y-i.y-s.y-30;this.meetingNode.setStyle("height",""+o+"px")}},loadActions:function(){this.deleteAction=new Element("div",{styles:this.css.buildingDocDeleteActionNode}).inject(this.actionNode);this.saveAction=new Element("div",{styles:this.css.buildingDocSaveActionNode}).inject(this.actionNode);this.saveAction.setStyle("display","none");this.editAction=new Element("div",{styles:this.css.buildingDocEditActionNode}).inject(this.actionNode);this.deleteAction.addEvents({mouseover:function(){this.deleteAction.setStyles(this.css.buildingDocDeleteActionNode_over)}.bind(this),mouseout:function(){this.deleteAction.setStyles(this.css.buildingDocDeleteActionNode)}.bind(this),mousedown:function(){this.deleteAction.setStyles(this.css.buildingDocDeleteActionNode_down)}.bind(this),mouseup:function(){this.deleteAction.setStyles(this.css.buildingDocDeleteActionNode_over)}.bind(this),click:function(t){this.deleteDocument(t)}.bind(this)});this.saveAction.addEvents({mouseover:function(){this.saveAction.setStyles(this.css.buildingDocSaveActionNode_over)}.bind(this),mouseout:function(){this.saveAction.setStyles(this.css.buildingDocSaveActionNode)}.bind(this),mousedown:function(){this.saveAction.setStyles(this.css.buildingDocSaveActionNode_down)}.bind(this),mouseup:function(){this.saveAction.setStyles(this.css.buildingDocSaveActionNode_over)}.bind(this),click:function(){this.saveDocument()}.bind(this)});this.editAction.addEvents({mouseover:function(){this.editAction.setStyles(this.css.buildingDocEditActionNode_over)}.bind(this),mouseout:function(){this.editAction.setStyles(this.css.buildingDocEditActionNode)}.bind(this),mousedown:function(){this.editAction.setStyles(this.css.buildingDocEditActionNode_down)}.bind(this),mouseup:function(){this.editAction.setStyles(this.css.buildingDocEditActionNode_over)}.bind(this),click:function(){this.editDocument()}.bind(this)});this.editDocumentFun=this.editDocument.bind(this);this.titleNode.addEvent("click",this.editDocumentFun);if(this.addrNode)this.addrNode.addEvent("click",this.editDocumentFun)},editDocument:function(){this.saveAction.setStyle("display","block");this.editAction.setStyle("display","none");var t=this.titleNode.get("text");this.titleNode.empty();this.titleInput=new Element("input",{styles:this.css.buildingDocTitleInputNode,type:"text",value:t}).inject(this.titleNode);var e=this.addrNode.get("text");this.addrNode.empty();this.addrInput=new Element("textarea",{styles:this.css.buildingDocAddrInputNode,text:e}).inject(this.addrNode);this.addrInput.addEvents({focus:function(){if(this.addrInput.get("value")==this.app.lp.inputAddress)this.addrInput.set("value","")}.bind(this),blur:function(){if(!this.addrInput.get("value"))this.addrInput.set("value",this.app.lp.inputAddress)}.bind(this)});this.titleNode.removeEvent("click",this.editDocumentFun);if(this.addrNode)this.addrNode.removeEvent("click",this.editDocumentFun);this.isEditMode=true},readDocument:function(){this.saveAction.setStyle("display","none");this.editAction.setStyle("display","block");var t=this.titleInput.get("value");var e=this.addrInput.get("value");this.titleInput.destroy();this.addrInput.destroy();this.titleNode.set("text",t);this.addrNode.set("text",e);this.titleNode.addEvent("click",this.editDocumentFun);if(this.addrNode)this.addrNode.addEvent("click",this.editDocumentFun);this.isEditMode=false},saveDocument:function(t,e){var i=this.titleInput.get("value");var s=this.addrInput.get("value");this.app.actions.saveBuilding({name:i,address:s,id:this.json.id},function(i){if(!t)this.app.notice(this.app.lp.save_success,"success",this.node,{x:"right",y:"top"});this.app.actions.getBuilding(this.json.id,function(t){this.json.name=t.data.name;this.json.address=t.data.address;this.building.titleNameNode.set("text",this.json.name);this.building.titleAddrNode.set("text",this.json.address);if(e)e()}.bind(this));this.readDocument()}.bind(this))},deleteDocument:function(t){var e=this.app.lp.delete_building;e=e.replace(/{name}/g,this.json.name);var i=this;this.app.confirm("warn",t,this.app.lp.delete_building_title,e,300,120,function(){i.remove();this.close()},function(){this.close()})},remove:function(){this.app.actions.deleteBuilding(this.json.id,function(){this.view.reload()}.bind(this))},close:function(t){if(this.isEditMode){this.saveDocument(true,function(){this.node.destroy();this.app.removeEvent("resize",this.setMeetingNodeSizeFun);this.view.currentDocument=null;MWF.release(this);if(t)t()}.bind(this))}else{this.node.destroy();this.app.removeEvent("resize",this.setMeetingNodeSizeFun);this.view.currentDocument=null;MWF.release(this);if(t)t()}}});MWF.xApplication.Meeting.RoomView.Building.Floor=new Class({Implements:[Events],initialize:function(t,e){this.building=t;this.view=this.building.view;this.json=e;this.container=this.building.contentNode;this.css=this.building.css;this.app=this.building.app;this.rooms=[];this.load()},load:function(){this.node=new Element("div",{styles:this.css.buildingContentFloorNode}).inject(this.container);this.checkWidthFun=this.checkWidth.bind(this);this.app.addEvent("resize",this.checkWidthFun)},checkWidth:function(){var t=this.rooms.length;if(t){var e=this.rooms[0].node.getStyle("min-width").toInt();var i=this.node.getSize();while(t>0&&(i.x-10)/t-12<e)t--;var s=(i.x-10)/t-12;this.rooms.each(function(t){t.node.setStyle("width",""+s+"px")}.bind(this))}},destroy:function(){this.app.removeEvent("resize",this.checkWidthFun);this.node.destroy();MWF.release(this)}});MWF.xApplication.Meeting.RoomView.Building.Room=new Class({Implements:[Events],initialize:function(t,e){this.floor=t;this.building=this.floor.building;this.view=this.floor.view;this.json=e;this.container=this.floor.node;this.css=this.floor.css;this.app=this.floor.app;this.floor.rooms.push(this);this.isBusy=this.json.idle===false;this.meetings=[];this.load()},load:function(){this.node=new Element("div",{styles:this.css.roomNode}).inject(this.container);this.titleNode=new Element("div",{styles:this.css.roomTitleNode}).inject(this.node);this.capacityNode=new Element("div",{styles:this.css.roomTitleCapacityNode,text:this.json.capacity+this.app.lp.person}).inject(this.titleNode);this.inforNode=new Element("div",{styles:this.css.roomTitleInforNode}).inject(this.titleNode);var t=new Element("div",{styles:{height:"20px"}}).inject(this.inforNode);this.numberNode=new Element("div",{styles:this.css.roomTitleNumberNode,text:this.json.roomNumber?"#"+this.json.roomNumber:""}).inject(t);this.nameNode=new Element("div",{styles:this.css.roomTitleNameNode,text:this.json.name}).inject(t);this.iconsNode=new Element("div",{styles:this.css.roomTitleIconsNode}).inject(this.inforNode);this.contentNode=new Element("div",{styles:this.css.roomContentNode}).inject(this.node);this.loadContent();if(this.view.selectedItem==this)this.selected();this.titleNode.addEvent("click",function(){this.selected()}.bind(this))},loadContent:function(){if(!this.json.available){this.node.setStyles(this.css.roomNode_disable);this.titleNode.setStyles(this.css.roomTitleNode_disable)}else{if(this.isBusy){this.node.setStyles(this.css.roomNode_busy);this.titleNode.setStyles(this.css.roomTitleNode_busy)}}var t=this.json.device.split("#");t.each(function(t){var e=new Element("div",{styles:this.css.roomTitleIconNode,title:this.app.lp.device[t]}).inject(this.iconsNode);e.setStyle("background-image","url(/x_component_Meeting/$RoomView/default/icon/"+t+".png)")}.bind(this));this.json.meetingList.each(function(t,e){if(e<4)this.meetings.push(new MWF.xApplication.Meeting.RoomView.Building.Room.Meeting(this,t))}.bind(this));if(!this.isBusy&&this.json.available){var e=new Element("div",{styles:this.css.roomContentAddMeetingNode}).inject(this.node);e.set("text",this.app.lp.applyMeeting);e.addEvent("click",function(){this.app.addMeeting(this.view.date,this.view.date.getHours(),this.json.id)}.bind(this))}},selected:function(){var t=this.view.selectedItem!=this;if(this.view.selectedItem)this.view.selectedItem.unSelected();this.node.setStyles(this.css.roomNode_selected);this.view.selectedItem=this;if(t)this.openDocRoom()},unSelected:function(){this.node.setStyles(this.css.roomNode);if(!this.json.available){this.node.setStyles(this.css.roomNode_disable)}else{if(this.isBusy){this.node.setStyles(this.css.roomNode_busy)}}this.view.selectedItem=null},openDocRoom:function(){debugger;if(this.view.currentDocument){this.view.currentDocument.close(function(){var t=new MWF.xApplication.Meeting.RoomView.Building.Room.Document(this);this.view.currentDocument=t}.bind(this))}else{var t=new MWF.xApplication.Meeting.RoomView.Building.Room.Document(this);this.view.currentDocument=t}},reload:function(){this.node.destroy();this.load();this.floor.checkWidth()},destroy:function(){this.node.destroy();MWF.release(this)}});MWF.xApplication.Meeting.RoomView.Building.Room.Meeting=new Class({initialize:function(t,e){this.room=t;this.view=this.room.view;this.json=this.room.json;this.container=this.room.contentNode;this.css=this.room.css;this.app=this.room.app;this.data=e;this.load()},load:function(){this.node=new Element("div",{styles:this.css.roomMeetingNode}).inject(this.container);var t="";var e=new Date;var i=Date.parse(this.data.startTime);var s=e.diff(i);if(s==0){t=Date.parse(this.data.startTime).format("%H:%M")}else if(s==1){t=this.app.lp.tomorrow}else if(s==2){t=this.app.lp.afterTomorrow}else{var o=e.diff(i,"month");if(o==0){t=Date.parse(this.data.startTime).format(this.app.lp.dateFormatDayOnly)}else if(o==1){t=this.app.lp.nextMonth}else{t=Date.parse(this.data.startTime).format(this.app.lp.dateFormatMonthOnly)}}var n=t+" "+this.data.subject;this.node.set("text",n);this.node.set("title",n);switch(this.data.status){case"wait":break;case"processing":this.node.setStyles({"border-left":"5px solid #18da14","background-color":"#deffdd"});break;case"completed":this.node.setStyles({"border-left":"5px solid #555","background-color":"#F3F3F3"});break}this.node.addEvent("click",function(){this.openMeeting()}.bind(this))},openMeeting:function(){if(!this.document){if(this.view.currentMeetingDocument)this.view.currentMeetingDocument.closeDocument();this.document=new MWF.xApplication.Meeting.RoomView.Building.Room.Meeting.Document(this);this.view.currentMeetingDocument=this.document}}});MWF.xApplication.Meeting.RoomView.Building.Room.Meeting.Document=new Class({Extends:MWF.xApplication.Meeting.MeetingView.Document,initialize:function(t){this.item=t;this.view=this.item.view;this.container=this.view.node;this.app=this.view.app;this.path="/x_component_Meeting/$MeetingView/";this.cssPath="/x_component_Meeting/$MeetingView/default/css.wcss";this._loadCss();this.app.actions.getMeeting(this.item.data.id,function(t){this.data=t.data;this.isEdit=this.data.applicant==this.app.desktop.session.user.name;this.load()}.bind(this))},closeDocument:function(t){if(this.setDescriptionNodeSizeFun)this.app.removeEvent("resize",this.setDescriptionNodeSizeFun);if(this.setNodeSizeFun)this.app.removeEvent("resize",this.setNodeSizeFun);var e=this.item.node.getSize();var i=this.item.node.getPosition(this.item.node.getOffsetParent());var s=new Fx.Morph(this.node,{duration:"500",transition:Fx.Transitions.Expo.easeOut});this.node.empty();this.view.currentMeetingDocument=null;s.start({opacity:0,width:""+e.x+"px",height:""+e.y+"px",left:""+i.x+"px",top:""+i.y+"px"}).chain(function(){this.destroy();if(t)t()}.bind(this))},_loadCss:function(){var t=encodeURIComponent(this.cssPath);if(MWF.widget.css[t]){this.css=MWF.widget.css[t]}else{var e=new Request.JSON({url:this.cssPath,secure:false,async:false,method:"get",noCache:false,onSuccess:function(e,i){this.css=e;MWF.widget.css[t]=e}.bind(this),onError:function(t,e){alert(e+t)}});e.send()}}});MWF.xApplication.Meeting.RoomView.Building.Room.Document=new Class({Extends:MWF.xApplication.Meeting.RoomView.Building.Document,Implements:[Events],initialize:function(t){this.room=t;this.view=this.room.view;this.json=this.room.json;this.container=this.view.infoArea;this.css=this.room.css;this.app=this.room.app;this.isEditMode=false;this.load()},loadContentNode:function(){this.contentNode=new Element("div",{styles:{overflow:"hidden",padding:"20px","border-bottom":"0px solid #999"}}).inject(this.node);this.floorNode=new Element("div",{styles:this.css.roomDocItemNode}).inject(this.contentNode);var t=new Element("div",{styles:this.css.roomDocItemTitleNode,text:this.app.lp.roomForm.floor}).inject(this.floorNode);var e=new Element("div",{styles:this.css.roomDocItemContentNode,text:this.json.floor+this.app.lp.floor}).inject(this.floorNode);this.roomNumberNode=new Element("div",{styles:this.css.roomDocItemNode}).inject(this.contentNode);t=new Element("div",{styles:this.css.roomDocItemTitleNode,text:this.app.lp.roomForm.roomNumber}).inject(this.roomNumberNode);e=new Element("div",{styles:this.css.roomDocItemContentNode,text:this.json.roomNumber}).inject(this.roomNumberNode);this.phoneNumberNode=new Element("div",{styles:this.css.roomDocItemNode}).inject(this.contentNode);t=new Element("div",{styles:this.css.roomDocItemTitleNode,text:this.app.lp.roomForm.phone}).inject(this.phoneNumberNode);e=new Element("div",{styles:this.css.roomDocItemContentNode,text:this.json.phoneNumber||""}).inject(this.phoneNumberNode);this.deviceberNode=new Element("div",{styles:this.css.roomDocItemNode}).inject(this.contentNode);t=new Element("div",{styles:this.css.roomDocItemTitleNode,text:this.app.lp.roomForm.device}).inject(this.deviceberNode);e=new Element("div",{styles:this.css.roomDocItemContentNode}).inject(this.deviceberNode);var i=this.json.device.split("#");var s=[];i.each(function(t){s.push(this.app.lp.device[t])}.bind(this));e.set("text",s.join(" "));this.capacityNode=new Element("div",{styles:this.css.roomDocItemNode}).inject(this.contentNode);t=new Element("div",{styles:this.css.roomDocItemTitleNode,text:this.app.lp.roomForm.capacity}).inject(this.capacityNode);e=new Element("div",{styles:this.css.roomDocItemContentNode,text:this.json.capacity+this.app.lp.person}).inject(this.capacityNode);this.auditorNode=new Element("div",{styles:this.css.roomDocItemNode}).inject(this.contentNode);t=new Element("div",{styles:this.css.roomDocItemTitleNode,text:this.app.lp.roomForm.auditor}).inject(this.auditorNode);e=new Element("div",{styles:this.css.roomDocItemContentNode}).inject(this.auditorNode);this.auditorNode.setStyle("display","none");var o={actions:this.app.personActions,app:{lp:this.app.lp}};if(this.json.auditor){MWF.require("MWF.widget.Identity",function(){var t=this;var i=new MWF.widget.Person({name:this.json.auditor},e,o,false,null,{style:"meeting"})}.bind(this))}this.availableNode=new Element("div",{styles:this.css.roomDocItemNode}).inject(this.contentNode);t=new Element("div",{styles:this.css.roomDocItemTitleNode,text:this.app.lp.roomForm.available}).inject(this.availableNode);e=new Element("div",{styles:this.css.roomDocItemContentNode,text:this.json.capacity+this.app.lp.auditor}).inject(this.availableNode);var n=this.json.available?this.app.lp.enable:this.app.lp.disable;e.set("text",n);this.meetingNode=new Element("div",{styles:this.css.buildingDocMeetingNode}).inject(this.node);this.loadRoomMeetings()},loadRoomMeetings:function(){this.app.actions.getRoom(this.json.id,function(t){var e="<table width='100%' border='0' cellSpacing='0' cellPadding='0'><tr><th>"+this.app.lp.beginTime+"</th><th>"+this.app.lp.subject+"</th><th>"+this.app.lp.applyPerson+"</th></tr></table>";this.meetingNode.set("html",e);var i=this.meetingNode.getElement("table");var s=this;t.data.meetingList.each(function(t){var e=new Element("tr").inject(i);var o=new Element("td",{text:Date.parse(t.startTime).format(this.app.lp.dateFormatMonthDay+" %H:%M")}).inject(e);var o=new Element("td",{text:t.subject}).inject(e);var o=new Element("td",{text:t.applicant}).inject(e);e.store("meeting",t);e.addEvent("click",function(){var t=this.retrieve("meeting");if(t){if(!s.document){if(s.view.currentMeetingDocument)s.view.currentMeetingDocument.closeDocument();s.data=t;s.document=new MWF.xApplication.Meeting.RoomView.Building.Room.Meeting.Document(s);s.view.currentMeetingDocument=s.document}}})}.bind(this));i.setStyles(this.css.roomDocMeetingListTable);i.getElements("th").setStyles(this.css.roomDocMeetingListTh);i.getElements("td").setStyles(this.css.roomDocMeetingListTd)}.bind(this))},editDocument:function(){this.saveAction.setStyle("display","block");this.editAction.setStyle("display","none");var t=this.titleNode.get("text");this.titleNode.empty();this.titleInput=new Element("input",{styles:this.css.buildingDocTitleInputNode,type:"text",value:t}).inject(this.titleNode);var e=this.floorNode.getLast().empty();var i=new Element("select",{styles:this.css.roomDocItemSelectNode}).inject(e);for(var s=-2;s<=50;s++){var o=new Element("option",{value:s,text:s+this.app.lp.floor,selected:s==this.json.floor}).inject(i)}e=this.roomNumberNode.getLast().empty();var n=new Element("input",{styles:this.css.roomDocItemInputNode,type:"text",value:this.json.roomNumber}).inject(e);e=this.phoneNumberNode.getLast().empty();var n=new Element("input",{styles:this.css.roomDocItemInputNode,type:"text",value:this.json.phoneNumber||""}).inject(e);e=this.deviceberNode.getLast().empty();var d=this.json.device.split("#");Object.each(this.app.lp.device,function(t,i){var s=d.indexOf(i)!=-1?"checked":"";new Element("div",{styles:{float:"left",width:"90px"},html:'<input type="checkbox" name="updateRoomDeviceCheckbox" '+s+' value="'+i+'">'+t}).inject(e)}.bind(this));e=this.capacityNode.getLast().empty();n=new Element("input",{styles:this.css.roomDocItemInputNode,type:"number",value:this.json.capacity}).inject(e);e=this.auditorNode.getLast().empty();auditorDiv=new Element("div",{styles:this.css.roomDocItemAuditorDivNode}).inject(e);this.auditorNode.store("names",this.json.auditor);var h={actions:this.app.personActions,app:{lp:this.app.lp}};if(this.json.auditor){MWF.require("MWF.widget.Identity",function(){var t=this;var e=new MWF.widget.Person({name:this.json.auditor},auditorDiv,h,true,function(e){this.node.destroy();MWF.release(this);t.auditorNode.eliminate("names");t.auditorNode.eliminate("person");e.stopPropagation()},{style:"meeting"});this.auditorNode.store("person",e)}.bind(this))}var t=this.json.auditor;MWF.xDesktop.requireApp("Organization","Selector.package",function(){auditorDiv.addEvents({click:function(){var e={type:"person",names:t?[t]:[],count:1,onComplete:function(t){var e=this.auditorNode.retrieve("person");if(e){e.node.destroy();MWF.release(e);this.auditorNode.eliminate("person")}this.auditorNode.store("names",t[0].data.name);MWF.require("MWF.widget.Identity",function(){var e=this;var i=new MWF.widget.Person(t[0].data,auditorDiv,h,true,function(t){this.node.destroy();MWF.release(this);e.auditorNode.eliminate("names");e.auditorNode.eliminate("person");t.stopPropagation()},{style:"meeting"});this.auditorNode.store("person",i)}.bind(this))}.bind(this)};var i=new MWF.OrgSelector(this.app.content,e)}.bind(this)})}.bind(this));e=this.availableNode.getLast().empty();new Element("div",{styles:{float:"left"},html:'<input type="radio" name="updateRoomAvailableRadio" '+(this.json.available?"checked":"")+' value="y">'+this.app.lp.enable}).inject(e);new Element("div",{styles:{float:"left"},html:'<input type="radio" name="updateRoomAvailableRadio" '+(!this.json.available?"checked":"")+' value="n">'+this.app.lp.disable}).inject(e);this.titleNode.removeEvent("click",this.editDocumentFun);if(this.addrNode)this.addrNode.removeEvent("click",this.editDocumentFun);this.isEditMode=true;this.setMeetingNodeSize()},readDocument:function(){this.saveAction.setStyle("display","none");this.editAction.setStyle("display","block");var t=this.titleInput.get("value");this.titleInput.destroy();this.titleNode.set("text",t);var e=this.floorNode.getLast().empty();e.set("text",this.json.floor+this.app.lp.floor);e=this.roomNumberNode.getLast().empty();e.set("text",this.json.roomNumber);e=this.phoneNumberNode.getLast().empty();e.set("text",this.json.phoneNumber);e=this.deviceberNode.getLast().empty();var i=this.json.device.split("#");var s=[];i.each(function(t){s.push(this.app.lp.device[t])}.bind(this));e.set("text",s.join(" "));e=this.capacityNode.getLast().empty();e.set("text",this.json.capacity+this.app.lp.person);e=this.auditorNode.getLast().empty();var o={actions:this.app.personActions,app:{lp:this.app.lp}};if(this.json.auditor){MWF.require("MWF.widget.Identity",function(){var t=this;var i=new MWF.widget.Person({name:this.json.auditor},e,o,false,null,{style:"meeting"})}.bind(this))}e=this.availableNode.getLast().empty();var n=this.json.available?this.app.lp.enable:this.app.lp.disable;e.set("text",n);this.titleNode.addEvent("click",this.editDocumentFun);if(this.addrNode)this.addrNode.addEvent("click",this.editDocumentFun);this.isEditMode=false},saveDocument:function(t,e){if(this.getRoomData()){this.app.actions.saveRoom(this.json,function(i){if(!t)this.app.notice(this.app.lp.save_success,"success",this.node,{x:"right",y:"top"});this.readDocument();this.room.reload();if(e)e()}.bind(this))}},getRoomData:function(){var t=true;var e=this.titleInput.get("value");var i=this.floorNode.getElement("select");var s=i.options[i.selectedIndex].value;var o=this.roomNumberNode.getElement("input").get("value");var n=this.phoneNumberNode.getElement("input").get("value");var d=[];
var h=this.deviceberNode.getElements("input");h.each(function(t){if(t.checked)d.push(t.get("value"))}.bind(this));var l=d.join("#");var a=this.capacityNode.getElement("input").get("value");var c=this.auditorNode.retrieve("names","");var r=true;var u=this.availableNode.getElements("input");for(var m=0;m<u.length;m++){if(u[m].checked){r=u[m].get("value")=="y"?true:false;break}}if(!e){this.app.notice(this.app.lp.verification.inputName,"error",this.node,{x:"right",y:"top"});return false}this.json.name=e;this.json.floor=s;this.json.roomNumber=o;this.json.phoneNumber=n;this.json.device=l;this.json.capacity=a;this.json.auditor=c;this.json.available=r;return true},deleteDocument:function(t){var e=this.app.lp.delete_room;e=e.replace(/{name}/g,this.json.name);var i=this;this.app.confirm("warn",t,this.app.lp.delete_building_title,e,300,120,function(){i.remove();this.close()},function(){this.close()})},remove:function(){this.app.actions.deleteRoom(this.json.id,function(){this.view.reload()}.bind(this))}});