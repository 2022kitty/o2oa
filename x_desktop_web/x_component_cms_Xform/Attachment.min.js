MWF.xDesktop.requireApp("process.Xform","Attachment",null,false);MWF.xApplication.cms.Xform.Attachment=MWF.CMSAttachment=new Class({Extends:MWF.APPAttachment,options:{moduleEvents:["upload","delete"]},initialize:function(t,e,i,a){this.node=$(t);this.node.store("module",this);this.json=e;this.form=i;this.field=true},_loadUserInterface:function(){this.node.empty();this.loadAttachmentController()},loadAttachmentController:function(){MWF.require("MWF.widget.AttachmentController",function(){var t={title:"附件区域",listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:this.json.size=="true"?true:false,attachmentCount:this.json.attachmentCount||0,isUpload:this.json.isUpload=="y"?true:false,isDelete:this.json.isDelete=="y"?true:false,isReplace:this.json.isReplace=="y"?true:false,isDownload:this.json.isDownload=="y"?true:false,isSizeChange:this.json.isSizeChange=="y"?true:false,readonly:this.json.readonly=="y"?true:false};if(this.readonly)t.readonly=true;this.attachmentController=new MWF.widget.ATTER(this.node,this,t);this.attachmentController.load();this.form.businessData.attachmentList.each(function(t){if(t.site==this.json.id)this.attachmentController.addAttachment(t)}.bind(this))}.bind(this))},loadAttachmentSelecter:function(t,e){MWF.require("MWF.widget.AttachmentSelector",function(){var i={title:"选择附件",listStyle:"icon",selectType:"all",size:"max",attachmentCount:0,isUpload:true,isDelete:true,isReplace:true,isDownload:true,toBase64:true,base64MaxSize:800,readonly:false};i=Object.merge(i,t);if(this.readonly)i.readonly=true;this.attachmentController=new MWF.widget.AttachmentSelector(this.node,this,i);this.attachmentController.load();this.postSelect=e;this.form.businessData.attachmentList.each(function(t){this.attachmentController.addAttachment(t)}.bind(this))}.bind(this))},selectAttachment:function(t,e,i){if(i.length>0){var a=i[i.length-1].data;this.form.documentAction.getAttachmentUrl(a.id,this.form.businessData.document.id,function(t){if(this.attachmentController.options.toBase64){this.form.documentAction.getSubjectAttachmentBase64(a.id,this.attachmentController.options.base64MaxSize,function(e){var i=e.data?"data:image/png;base64,"+e.data.value:null;if(this.postSelect)this.postSelect(t,a,i)}.bind(this))}else{if(this.postSelect)this.postSelect(t,a)}}.bind(this))}},createUploadFileNode:function(){this.uploadFileAreaNode=new Element("div");var t='<input name="file" type="file" multiple/>';this.uploadFileAreaNode.set("html",t);this.fileUploadNode=this.uploadFileAreaNode.getFirst();this.fileUploadNode.addEvent("change",function(){this.validationMode();var t=this.fileUploadNode.files;if(t.length){if(t.length+this.attachmentController.attachments.length>this.attachmentController.options.attachmentCount&&this.attachmentController.options.attachmentCount>0){var e=MWF.xApplication.cms.Xform.LP.uploadMore;e=e.replace("{n}",this.attachmentController.options.attachmentCount);this.form.notice(e,"error")}else{for(var i=0;i<t.length;i++){var a=t.item(i);var n=new FormData;n.append("file",a);n.append("site",this.json.id);this.form.documentAction.uploadAttachment(this.form.businessData.document.id,function(t,e){if(t.id){this.form.documentAction.getAttachment(t.id,this.form.businessData.document.id,function(t){if(t.data){this.attachmentController.addAttachment(t.data);this.form.businessData.attachmentList.push(t.data)}this.attachmentController.checkActions();this.fireEvent("upload",[t.data])}.bind(this))}this.attachmentController.checkActions()}.bind(this),null,n,a)}}}}.bind(this))},getData:function(){return this.attachmentController.getAttachmentNames()},deleteAttachment:function(t){this.fireEvent("delete",[t.data]);this.form.documentAction.deleteAttachment(t.data.id,this.form.businessData.document.id,function(e){this.attachmentController.removeAttachment(t);this.attachmentController.checkActions()}.bind(this))},createReplaceFileNode:function(t){this.replaceFileAreaNode=new Element("div");var e='<input name="file" type="file" multiple/>';this.replaceFileAreaNode.set("html",e);this.fileReplaceNode=this.replaceFileAreaNode.getFirst();this.fileReplaceNode.addEvent("change",function(){var e=this.fileReplaceNode.files;if(e.length){for(var i=0;i<e.length;i++){var a=e.item(i);var n=new FormData;n.append("file",a);this.form.documentAction.replaceAttachment(t.data.id,this.form.businessData.document.id,function(e,i){this.form.documentAction.getAttachment(t.data.id,this.form.businessData.document.id,function(e){t.data=e.data;t.reload();this.attachmentController.checkActions()}.bind(this))}.bind(this),null,n,a)}}}.bind(this))},downloadAttachment:function(t,e,i){if(this.form.businessData.document){i.each(function(t){this.form.documentAction.getAttachmentStream(t.data.id,this.form.businessData.document.id)}.bind(this))}},openAttachment:function(t,e,i){if(this.form.businessData.document){i.each(function(t){this.form.documentAction.getAttachmentData(t.data.id,this.form.businessData.document.id)}.bind(this))}},getAttachmentUrl:function(t,e){if(this.form.businessData.document){this.form.documentAction.getAttachmentUrl(t.data.id,this.form.businessData.document.id,e)}},validationConfigItem:function(t,e){var i=e.status=="all"?true:t=="publish";if(i){var a=this.getData();var n=e.valueType=="value"?a:a.length;switch(e.operateor){case"isnull":if(!n){this.notValidationMode(e.prompt);return false}break;case"notnull":if(n){this.notValidationMode(e.prompt);return false}break;case"gt":if(n>e.value){this.notValidationMode(e.prompt);return false}break;case"lt":if(n<e.value){this.notValidationMode(e.prompt);return false}break;case"equal":if(n==e.value){this.notValidationMode(e.prompt);return false}break;case"neq":if(n!=e.value){this.notValidationMode(e.prompt);return false}break;case"contain":if(n.indexOf(e.value)!=-1){this.notValidationMode(e.prompt);return false}break;case"notcontain":if(n.indexOf(e.value)==-1){this.notValidationMode(e.prompt);return false}break}}return true}});