MWF.xDesktop.requireApp("cms.Xform","$Input",null,false);MWF.xDesktop.requireApp("Organization","Selector.package",null,false);MWF.xApplication.cms.Xform.Personfield=MWF.CMSPersonfield=new Class({Implements:[Events],Extends:MWF.CMS$Input,iconStyle:"personfieldIcon",getDepartments:function(){if(this.json.range=="depart"){var t=this.form.CMSMacro.exec(this.json.rangeKey.code,this);if(typeOf(t)=="array"){return t}else{var e=t.toString();return e?[e]:[]}}if(this.json.range=="currentdepart"){return[this.form.app.document.creatorDepartment]}return[]},getCompanys:function(){if(this.json.range=="company"){var t="";if(this.json.rangeKey){t=this.form.CMSMacro.exec(this.json.rangeKey.code,this)}if(typeOf(t)=="array"){return t}else{var e=t.toString();return e?[e]:[]}}if(this.json.range=="currentcompany"){return[this.form.app.document.creatorCompany]}return[]},clickSelect:function(){var t=this.getInputData();var e=t;var n=this.json.count?this.json.count:0;var r=this.getCompanys();var a=this.getDepartments();if(this.json.range=="depart"){if(!a.length){this.form.notice(MWF.xApplication.cms.Xform.LP.noSelectRange,"error",this.node);return false}}if(this.json.range=="company"){if(!r.length){this.form.notice(MWF.xApplication.cms.Xform.LP.noSelectRange,"error",this.node);return false}}var i={type:this.json.selectType,names:e,count:n,departments:a,companys:r,onComplete:function(t){var e=[];t.each(function(t){e.push(t.data.name)}.bind(this));this.setData(e.join(", "));this._setBusinessData(this.getInputData());this.validationMode();this.validation()}.bind(this),onCancel:function(){this.validation()}.bind(this)};var s=new MWF.OrgSelector(this.form.node.getParent(),i)},resetData:function(){var t=this.getValue();this.setData(t?t.join(", "):"")},getInputData:function(){var t=this.node.get("value");return t?t.split(/,\s*/g):""}});