MWF.xDesktop.requireApp("cms.Xform","$Module",null,false);MWF.xApplication.cms.Xform.Datagrid=MWF.CMSDatagrid=new Class({Implements:[Events],Extends:MWF.CMS$Module,isEdit:false,initialize:function(t,e,i,r){this.node=$(t);this.node.store("module",this);this.json=e;this.form=i;this.field=true},_loadUserInterface:function(){this.editModules=[];this.table=this.node.getElement("table");this.editable=this.readonly?false:true;if(this.editable)this.editable=this.form.CMSMacro.exec(this.json.editableScript.code,this);this.gridData=this._getValue();this.totalModules=[];this._loadDatagridTitleModules();if(this.editable!=false){this._loadDatagridDataModules();this._addTitleActionColumn();this._loadEditDatagrid()}else{this._loadReadDatagrid()}},_loadStyles:function(){this.table.setStyles(this.json.styles)},_getValue:function(){var t=[];t=this._getBusinessData();if(!t){if(this.json.defaultData.code)t=this.form.CMSMacro.exec(this.json.defaultData.code,this)}return t||[]},_getDatagridTr:function(){this._getDatagridTitleTr();this._getDatagridEditorTr()},_getDatagridTitleTr:function(){this.titleTr=this.table.getElement("tr");return this.titleTr},_getDatagridEditorTr:function(){var t=this.table.getElements("tr");this.editorTr=t[t.length-1];this.editorTr.addClass("datagridEditorTr");return this.editorTr},_addTitleActionColumn:function(){if(!this.titleTr)this._getDatagridTitleTr();if(!this.editorTr)this._getDatagridEditorTr();var t=new Element("th",{styles:{width:"46px"}}).inject(this.titleTr,"top");new Element("th").inject(this.titleTr,"bottom");this._createAddLineAction(t);var e=new Element("td").inject(this.editorTr,"top");this._createCompleteAction(e);new Element("td").inject(this.editorTr,"bottom")},_loadEditDatagrid:function(){var t=this.titleTr.getElements("th");var e=this.editorTr.getElements("td");this.gridData.each(function(i,r){var s=this.table.insertRow(r+1);s.store("data",i);t.each(function(r,a){var o=i[r.get("id")];var n="";for(key in o){var d=o[key];n=this._getValueText(a-1,d);break}this._createNewEditTd(s,a,e[a].get("id"),n,t.length-1)}.bind(this))}.bind(this));this.editorTr.setStyle("display","none")},_getValueText:function(t,e){var i=this.editModules[t];if(i){switch(i.json.type){case"Select":var r=i.node.getElements("option");for(var s=0;s<r.length;s++){if(r[s].value==e){return r[s].get("text");break}}break;case"Radio":var r=i.node.getElements("input");for(var s=0;s<r.length;s++){if(r[s].value==e){return r[s].get("showText");break}}break;case"Checkbox":var r=i.node.getElements("input");var a=[];for(var s=0;s<r.length;s++){if(e.indexOf(r[s].value)!=-1)a.push(r[s].get("showText"))}if(a.length)return a.join(", ");break}}return e},_createNewEditTd:function(t,e,i,r,s){var a=t.insertCell(e);if(e==0){a.setStyles(this.form.css.gridLineActionCell);this._createAddLineAction(a);this._createDelLineAction(a)}else if(e==s){a.setStyles(this.form.css.gridMoveActionCell);this._createMoveLineAction(a)}else{a.set("MWFId",i);a.set("text",r);a.addEvent("click",function(t){this._editLine(t.target)}.bind(this))}var o=this.form._getDomjson(a);if(o){a.store("dataGrid",this);var n=this.form._loadModule(o,a);a.store("module",n);this.form.modules.push(n)}},_createAddLineAction:function(t){var e=new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this._addLine(t.target)}.bind(this)}});e.inject(t)},_createDelLineAction:function(t){var e=new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._deleteLine(t)}.bind(this)}});e.inject(t)},_createCompleteAction:function(t){var e=new Element("div",{styles:this.form.css.completeLineAction,events:{click:function(t){this._completeLineEdit(t)}.bind(this)}});e.inject(t)},_editLine:function(t){if(this.isEdit){this._completeLineEdit()}this.currentEditLine=t.getParent("tr");if(this.currentEditLine){this.editorTr.setStyles({"background-color":"#fffeb5",display:"table-row"});this.editorTr.inject(this.currentEditLine,"before");this.currentEditLine.setStyle("display","none");var e=this.currentEditLine.retrieve("data");var i=this.titleTr.getElements("th");i.each(function(t,i){var r=t.get("id");var s=this.editModules[i-1];if(s){if(s.json.type=="sequence"){s.node.set("text",s.node.getParent("tr").rowIndex)}else{if(e[r]){s.setData(e[r][s.json.id])}else{s.setData(null)}}}}.bind(this));var r=this.currentEditLine.getElements("td").indexOf(t);var s=this.editModules[r-1];if(s)s.focus();this.isEdit=true}this.validationMode()},editValidation:function(){var t=true;this.editModules.each(function(e,i){if(e.json.type!="sequence"){e.validationMode();if(!e.validation())t=false}}.bind(this));return t},_completeLineEdit:function(){if(!this.editValidation()){return false}this.isEdit=false;var t=true;var e={};var i=null;if(this.currentEditLine){i=this.currentEditLine;e=this.currentEditLine.retrieve("data")}else{i=new Element("tr").inject(this.editorTr,"before");e={}}var r=this.titleTr.getElements("th");var s=this.editorTr.getElements("td");var a=i.getElements("td");r.each(function(o,n){var d=a[n];var l=o.get("id");var h=this.editModules[n-1];if(h){if(h.json.type=="sequence"){var c=i.rowIndex;var f={value:[c],text:[c]}}else{var f=h.getTextData();if(f.value[0])t=false;if(f.value.length<2){if(!e[l])e[l]={};e[l][h.json.id]=f.value[0]}else{if(!e[l])e[l]={};e[l][h.json.id]=f.value}}if(d){d.set("text",f.text.join(", "))}else{this._createNewEditTd(i,n,s[n].get("id"),f.text.join(", "),r.length-1)}}else{if(!d)this._createNewEditTd(i,n,l,"",r.length-1)}}.bind(this));i.store("data",e);i.setStyle("display","table-row");if(t){i.destroy()}this.currentEditLine=null;this._editorTrGoBack();this._loadTotal();this._loadBorderStyle();this._loadZebraStyle();this._loadSequence();this.getData();this.validationMode()},_editorTrGoBack:function(){this.editorTr.setStyle("display","none");var t=this.table.getElements("tr");var e=t[t.length-1];this.editorTr.inject(e,"after")},_addLine:function(t){if(this.isEdit){this._completeLineEdit()}this.editorTr.setStyles({"background-color":"#fffeb5",display:"table-row"});this.currentEditLine=null;var e=t.getParent("tr");if(e){this.editorTr.inject(e,"after")}this.isEdit=true;this.validationMode();this.fireEvent("addLine")},_deleteLine:function(t){var e=t.target.getParent("tr");if(e){var i=e.getStyle("background-color");e.store("bgcolor",i);e.tween("background-color","#ffd4d4");var r=this;this.form.confirm("warn",t,MWF.xApplication.cms.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.cms.Xform.LP.deleteDatagridLine,300,120,function(){this.fireEvent("deleteLine",[e]);e.destroy();r._loadZebraStyle();r._loadSequence();r._loadTotal();r.getData();this.close()},function(){var t=e.retrieve("bgcolor");e.tween("background-color",t);this.close()},null)}this.validationMode()},_createMoveLineAction:function(t){var e=new Element("div",{styles:this.form.css.moveLineAction,events:{mousedown:function(t){this._moveLine(t)}.bind(this)}});e.inject(t)},_getMoveDragNode:function(t){var e=t.getParent("table");var i=e.getParent("div");var r=i.getSize();var s=i.clone().setStyle("width",r.x).inject(document.body);var a=s.getElement("table");a.empty();var o=t.clone().setStyles(this.form.css.gridMoveLineDragNodeTr).inject(a);var n=t.getElements("td");var d=o.getElements("td");n.each(function(t,e){var i=t.getComputedSize();d[e].setStyle("width",i.width+1)});var l=t.getCoordinates();s.setStyles(this.form.css.gridMoveLineDragNode);s.setStyles(l);return s},_moveLine:function(t){var e=this.table.getElements("tr");var i=t.target;var r=i.getParent("tr");var s=this._getMoveDragNode(r);coordinates=s.getCoordinates();var a=s.getElement("tr");var o=s.getElement("table");var n=r.getStyle("background-color");r.store("bgcolor",n);r.tween("background-color","#e4f6e9");var d=new Drag.Move(s,{droppables:e.erase(r),limit:{x:[coordinates.left,coordinates.left]},onDrop:function(t,e){t.destroy();if(e!=null){r.inject(a,"after");r.setStyle("display","table-row");a.destroy();this._loadZebraStyle();this._loadSequence();this._loadTotal();this.getData()}else{var i=r.retrieve("bgcolor");if(i){r.tween("background-color",i)}else{r.tween("background-color","#FFF")}r.setStyle("display","table-row")}}.bind(this),onEnter:function(t,e){var i=e.getStyle("background-color");if(i.toUpperCase()!="#d1eaf3")e.store("bgcolor",i);e.tween("background-color","#d1eaf3");s.setStyle("display","none");a.inject(e,"after")},onLeave:function(t,e){var i=e.retrieve("bgcolor");if(i){e.tween("background-color",i)}else{e.tween("background-color","#FFF")}a.inject(o);s.setStyle("display","block")},ondrag:function(){this.table.setStyle("cursor","move");s.setStyle("cursor","move")},onCancel:function(t){t.destroy();var e=r.retrieve("bgcolor");if(e){r.tween("background-color",e)}else{r.tween("background-color","#FFF")}r.setStyle("display","table-row")}});d.start(t);r.setStyle("display","none")},_loadReadDatagrid:function(){this.gridData=this._getValue();if(!this.titleTr)this._getDatagridTitleTr();var t=this.titleTr.getElements("th");var e=this.table.getElements("tr");var i=e[e.length-1];var r=i.getElements("td");this.gridData.each(function(e,i){var s=this.table.insertRow(i+1);s.store("data",e);t.each(function(t,i){var a=s.insertCell(i);a.set("MWFId",r[i].get("id"));var o=e[t.get("id")];if(o){for(key in o){a.set("text",o[key]);break}}else{a.setStyle("text-align","center");a.set("text",s.rowIndex)}}.bind(this))}.bind(this));i.destroy();this._loadTotal()},_loadDatagridStyle:function(){var t=this.titleTr.getElements("th");t.setStyles(this.form.css.datagridTitle);this._loadTotal();this._loadBorderStyle();this._loadZebraStyle();this._loadSequence()},_loadZebraStyle:function(){var t=this.table.getElements("tr");for(var e=1;e<t.length;e++){if(!t[e].hasClass("datagridTotalTr")){if(this.json.backgroundColor)t[e].setStyle("background-color",this.json.backgroundColor);if(e%2==0){if(this.json.zebraColor)t[e].setStyle("background-color",this.json.zebraColor)}}}},createTotalTr:function(){var t=this.node.getElements("tr");var e=t[t.length-1];this.totalTr=new Element("tr.datagridTotalTr",{styles:this.form.css.datagridTotalTr}).inject(e,"after");var i=this.node.getElements("th");i.each(function(t){new Element("td",{text:"",styles:this.form.css.datagridTotalTd}).inject(this.totalTr)}.bind(this))},_loadTotal:function(){if(this.totalModules.length){if(!this.totalTr){this.createTotalTr()}var t=[];var e=this.table.getElements("tr");var i=this.totalTr.getElements("td");for(var r=1;r<e.length;r++){if(!e[r].hasClass("datagridTotalTr")&&!e[r].hasClass("datagridEditorTr")){var s=e[r].getElements("td");this.totalModules.each(function(e,i){if(!t[i])t.push(0);var r=t[i];if(e.type=="number"){var a=s[e.index];var o=a.get("text").toFloat();r=r+o}if(e.type=="count"){r=r+1}t[i]=r}.bind(this))}}this.totalModules.each(function(e,r){var s=i[e.index];s.set("text",t[r])}.bind(this))}},_loadSequence:function(){var t=this.table.getElements("tr");for(var e=1;e<t.length;e++){var i=t[e].getElements("td");i.each(function(t){var i=t.retrieve("module");if(i){if(i.json.cellType=="sequence"){t.set("text",e)}}}.bind(this))}},_loadBorderStyle:function(){if(this.json.border){this.table.setStyles({"border-top":this.json.border,"border-left":this.json.border});var t=this.table.getElements("th");t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border});var e=this.table.getElements("td");e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})}},_loadDatagridTitleModules:function(){var t=this.node.getElements("th");t.each(function(t){var e=this.form._getDomjson(t);t.store("dataGrid",this);if(e){var i=this.form._loadModule(e,t);this.form.modules.push(i)}}.bind(this))},_loadDatagridDataModules:function(){var t=this.node.getElements("td");t.each(function(t){var e=this.form._getDomjson(t);t.store("dataGrid",this);if(e){var i=this.form._loadModule(e,t,function(){this.field=false});t.store("module",i);this.form.modules.push(i)}}.bind(this))},_afterLoaded:function(){this._loadDatagridStyle()},resetData:function(){this.setData()},setData:function(t){this._setBusinessData(t);if(t){this.gridData=t}else{this.gridData=this._getValue()}if(this.isEdit)this._completeLineEdit();if(this.gridData){var e=this.table.getElements("tr");for(var i=1;i<e.length-1;i++){var r=e[i];var s=r.getElements("td");for(var a=0;a<s.length;a++){var o=s[a];var n=o.retrieve("module");if(n){this.form.modules.erase(n);delete n}}}while(this.table.rows.length>2){this.table.rows[1].destroy()}if(this.editable!=false){this._loadEditDatagrid()}else{this._loadReadDatagrid()}this._loadDatagridStyle()}},getData:function(){if(this.editable!=false){var t=[];var e=this.table.getElements("tr");for(var i=1;i<e.length-1;i++){var r=e[i];var s=r.retrieve("data");if(s)t.push(s)}this.gridData=null;this.gridData=t;this._setBusinessData(t);return this.gridData.length?this.gridData:null}else{return this._getBusinessData()}},createErrorNode:function(t){var e=new Element("div");var i=new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url("+"/x_component_cms_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e);var r=new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red"},text:t}).inject(e);return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=true;this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom"));this.node.setStyle("border","1px solid red");this.errNode=this.createErrorNode(t).inject(this.node,"after")}},validationMode:function(){if(this.isNotValidationMode){this.isNotValidationMode=false;this.node.setStyles(this.node.retrieve("borderStyle"));if(this.errNode){this.errNode.destroy();this.errNode=null}}},validation:function(){if(this.isEdit){if(!this.editValidation()){return false}}if(!this.json.validation)return true;if(!this.json.validation.code)return true;var t=this.form.CMSMacro.exec(this.json.validation.code,this);if(!t)t=MWF.xApplication.cms.Xform.LP.notValidation;if(t.toString()!="true"){this.notValidationMode(t);return false}return true}});MWF.xApplication.cms.Xform.Datagrid$Title=MWF.CMSDatagrid$Title=new Class({Extends:MWF.CMS$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");if(this.json.total=="number"||this.json.total=="count"){this.dataGrid.totalModules.push({module:this,index:this.dataGrid.editable!=false?this.node.cellIndex+1:this.node.cellIndex,type:this.json.total})}}});MWF.xApplication.cms.Xform.Datagrid$Data=MWF.CMSDatagrid$Data=new Class({Extends:MWF.CMS$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if(this.json.cellType=="sequence"){this.dataGrid.editModules.push({json:{type:"sequence"},node:t})}else{var e=this.form._getModuleNodes(this.node);e.each(function(t){var e=this.form._getDomjson(t);var i=this.form._loadModule(e,t,function(){this.field=false});i.dataModule=this;this.dataGrid.editModules.push(i)}.bind(this))}}});