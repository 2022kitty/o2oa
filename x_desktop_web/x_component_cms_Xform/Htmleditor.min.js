MWF.xDesktop.requireApp("cms.Xform","$Module",null,false);MWF.xApplication.cms.Xform.Htmleditor=MWF.CMSHtmleditor=new Class({Extends:MWF.CMS$Module,initialize:function(t,e,i,o){this.node=$(t);this.node.store("module",this);this.json=e;this.form=i;this.field=true},_loadUserInterface:function(){this.node.empty();if(this.readonly){this.node.set("html",this._getBusinessData());this.node.setStyles({overflow:"hidden","-webkit-user-select":"text","-moz-user-select":"text"})}else{var t=Object.clone(this.json.editorProperties);if(this.json.config){if(this.json.config.code){var e=MWF.CMSMacro.exec(this.json.config.code,this);Object.each(e,function(e,i){t[i]=e})}}this.loadCkeditor(t)}},loadCkeditor:function(t){_self=this;COMMON.AjaxModule.load("ckeditor",function(){var e=new Element("div").inject(this.node);var i=this._getBusinessData();if(i){e.set("html",i)}else if(this.json.templateCode){e.set("html",this.json.templateCode)}var o=this.node.getSize().y;var s=t||{};if(this.form.json.mode=="Mobile"){if(!s.toolbar&&!s.toolbarGroups){s.toolbar=[{name:"paragraph",items:["Bold","Italic","-","TextColor","BGColor","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","-","Undo","Redo"]},{name:"basicstyles",items:["Styles","FontSize"]}]}}s.filebrowserCurrentDocumentImage=function(t,e){_self.selectCurrentDocumentImage(t,e)};s.filebrowserFilesImage=function(t,e){_self.selectCloudFilesImage(t,e)};this.editor=CKEDITOR.replace(e,s);this.editor.on("change",function(){this._setBusinessData(this.getData())}.bind(this))}.bind(this))},_loadEvents:function(t){Object.each(this.json.events,function(t,e){if(t.code){this.editor.on(e,function(e){return this.form.CMSMacro.fire(t.code,this,e)}.bind(this),this)}}.bind(this))},_loadValue:function(){var t=this._getBusinessData()},resetData:function(){this.setData(this._getBusinessData())},getData:function(){return this.editor.getData()},setData:function(t){this._setBusinessData(t);if(this.editor)this.editor.setData(t)},createErrorNode:function(t){var e=new Element("div");var i=new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url("+"/x_component_cms_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e);var o=new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red"},text:t}).inject(e);return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=true;this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom"));this.node.setStyle("border","1px solid red");this.errNode=this.createErrorNode(t).inject(this.node,"after")}},validationMode:function(){if(this.isNotValidationMode){this.isNotValidationMode=false;this.node.setStyles(this.node.retrieve("borderStyle"));if(this.errNode){this.errNode.destroy();this.errNode=null}}},validation:function(){if(!this.json.validation)return true;if(!this.json.validation.code)return true;var t=this.form.CMSMacro.exec(this.json.validation.code,this);if(!t)t=MWF.xApplication.cms.Xform.LP.notValidation;if(t.toString()!="true"){this.notValidationMode(t);return false}return true},selectCurrentDocumentImage:function(t,e){var i=this;MWF.xDesktop.requireApp("cms.Xform","Attachment",function(){i.selector_doc=new MWF.xApplication.cms.Xform.Attachment(document.body,{},i.form,{});i.selector_doc.loadAttachmentSelecter({style:"cms",title:"选择本文档图片",listStyle:"preview",toBase64:true,selectType:"images"},function(t,i,o){if(e)e(t,o,i)})},true)},selectCloudFilesImage:function(t,e){var i=this;MWF.xDesktop.requireApp("File","FileSelector",function(){i.selector_cloud=new MWF.xApplication.File.FileSelector(document.body,{style:"default",title:"选择云文件图片",toBase64:true,listStyle:"preview",selectType:"images",onPostSelectAttachment:function(t,i){if(e)e(t,i)}});i.selector_cloud.load()},true)}});