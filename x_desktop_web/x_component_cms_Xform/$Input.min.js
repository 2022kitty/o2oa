MWF.xDesktop.requireApp("cms.Xform","$Module",null,false);MWF.xApplication.cms.Xform.$Input=MWF.CMS$Input=new Class({Implements:[Events],Extends:MWF.CMS$Module,styles:"textfieldNode",iconStyle:"personfieldIcon",initialize:function(t,e,i,s){this.node=$(t);this.node.store("module",this);this.json=e;this.form=i;this.field=true},_loadUserInterface:function(){this._loadNode();if(this.json.compute=="show"){this._setValue(this._computeValue())}else{this._loadValue()}},_loadNode:function(){if(this.readonly){this._loadNodeRead()}else{this._loadNodeEdit()}},_loadNodeRead:function(){this.node.empty()},_loadNodeEdit:function(){var t=new Element("input");t.set(this.json.properties);t.inject(this.node,"after");this.node.destroy();this.node=t;this.node.set({id:this.json.id,MWFType:this.json.type,readonly:true,events:{click:this.clickSelect.bind(this)}});var e=this.form.css[this.styles];if(e)this.node.setStyles(e);var i=this.form.css[this.styles+"_select"];if(e&&i){this.node.addEvents({focus:function(){this.node.setStyles(this.form.css[this.styles+"_select"])}.bind(this),blur:function(){this.node.setStyles(this.form.css[this.styles])}.bind(this)})}this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:this.clickSelect.bind(this)}}).inject(this.node,"after");this.node.addEvent("change",function(){this.validationMode();if(this.validation())this._setBusinessData(this.getInputData("change"))}.bind(this))},_computeValue:function(t){return this.json.defaultValue.code?this.form.CMSMacro.exec(this.json.defaultValue.code,this):t||""},getValue:function(){var t=this._getBusinessData();if(!t)t=this._computeValue();return t||""},_setValue:function(t){this._setBusinessData(t);this.node.set("value",t);if(this.readonly)this.node.set("text",t)},_loadValue:function(){this._setValue(this.getValue())},clickSelect:function(){},_afterLoaded:function(){if(this.iconNode){}},getTextData:function(){var t=this.node.get("value");var e=this.node.get("text");return{value:[t]||"",text:[e||t||""]}},getData:function(t){if(this.json.compute=="save")this._setValue(this._computeValue());return this.getInputData()},getInputData:function(){return this.node.get("value")},resetData:function(){this.setData(this.getValue())},setData:function(t){this._setBusinessData(t);this.node.set("value",t)},createErrorNode:function(t){var e=new Element("div");var i=new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url("+"/x_component_cms_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e);var s=new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red"},text:t}).inject(e);return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=true;this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom"));this.node.setStyle("border","1px solid red");this.errNode=this.createErrorNode(t);if(this.iconNode){this.errNode.inject(this.iconNode,"after")}else{this.errNode.inject(this.node,"after")}}},validationMode:function(){if(this.isNotValidationMode){this.isNotValidationMode=false;this.node.setStyles(this.node.retrieve("borderStyle"));if(this.errNode){this.errNode.destroy();this.errNode=null}}},validation:function(){if(!this.json.validation)return true;if(!this.json.validation.code)return true;var t=this.form.CMSMacro.exec(this.json.validation.code,this);if(!t)t=MWF.xApplication.cms.Xform.LP.notValidation;if(t.toString()!="true"){this.notValidationMode(t);return false}return true}});