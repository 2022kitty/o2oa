MWF.xDesktop.requireApp("process.Xform","$Module",null,false);MWF.xApplication.process.Xform.DatagridMobile=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:false,options:{moduleEvents:["completeLineEdit","addLine","deleteLine","afterDeleteLine"]},initialize:function(t,e,i,s){this.node=$(t);this.node.store("module",this);this.json=e;this.form=i;this.field=true},_loadUserInterface:function(){this.editModules=[];this.node.setStyle("overflow-x","hidden");this.node.setStyle("overflow-y","hidden");this.table=this.node.getElement("table");this.createMobileTable();this.editable=this.readonly?false:true;if(this.editable)this.editable=this.form.Macro.exec(this.json.editableScript.code,this);this.gridData=this._getValue();this.totalModules=[];this._loadDatagridTitleModules();if(this.editable!=false){this._loadDatagridDataModules();this._loadEditDatagrid()}else{this._loadReadDatagrid()}},createMobileTable:function(){var t=new Element("table").inject(this.node);t.set(this.json.properties);var e=this.table.getElements("tr");var i=e[0].getElements("th");var s=e[1].getElements("td");i.each(function(e,i){var n=t.insertRow();var a=new Element("th").inject(n);a.set({html:e.get("html"),id:e.get("id"),mwftype:e.get("mwftype")});var o=new Element("td").inject(n);o.set({html:s[i].get("html"),id:s[i].get("id"),mwftype:s[i].get("mwftype")})}.bind(this));this.table.destroy();this.table=null;this.table=t},_loadStyles:function(){this.node.setStyles(this.json.styles);var t=this.node.getElements("table");t.each(function(t){t.setStyles(this.json.tableStyles)}.bind(this))},_getValue:function(){var t=[];t=this._getBusinessData();if(!t){if(this.json.defaultData.code)t=this.form.Macro.exec(this.json.defaultData.code,this);t={data:t||[]}}return t||[]},_getValueText:function(t,e){var i=this.editModules[t];if(i){switch(i.json.type){case"Select":var s=i.node.getElements("option");for(var n=0;n<s.length;n++){if(s[n].value==e){return s[n].get("text");break}}break;case"Radio":var s=i.node.getElements("input");for(var n=0;n<s.length;n++){if(s[n].value==e){return s[n].get("showText");break}}break;case"Checkbox":var s=i.node.getElements("input");var a=[];for(var n=0;n<s.length;n++){if(e.indexOf(s[n].value)!=-1)a.push(s[n].get("showText"))}if(a.length)return a.join(", ");break}}return e},editValidation:function(){var t=true;this.editModules.each(function(e,i){if(e.json.type!="sequence"){e.validationMode();if(!e.validation())t=false}}.bind(this));return t},_loadReadDatagrid:function(){this.gridData=this._getValue();var t=this.table.getElements("th");var e=this.table.getElements("td");if(this.gridData.data){this.gridData.data.each(function(i,s){var n=new Element("div",{styles:{overflow:"hidden","margin-bottom":"10px"}}).inject(this.node);var a=new Element("div",{styles:{overflow:"hidden"}}).inject(n);var o=new Element("table").inject(a);o.set(this.json.properties);o.store("data",i);t.each(function(t,n){var a=o.insertRow(n);var l=new Element("th").inject(a);l.set("text",t.get("text"));l.setStyle("width","30%");var r=a.insertCell(1);r.set("MWFId",e[n].get("id"));var d=i[t.get("id")];if(d){for(key in d){r.set("text",d[key]);break}}else{r.setStyle("text-align","left");r.set("text",s+1)}}.bind(this))}.bind(this))}},_loadEditDatagrid:function(){this.gridData=this._getValue();var t=this.table.getElements("th");var e=this.table.getElements("td");var i=this;if(this.gridData.data.length){this.gridData.data.each(function(i,s){var n=new Element("div",{styles:{overflow:"hidden","margin-bottom":"10px"}}).inject(this.node);this._createItemTitleNode(n,s);var a=new Element("div",{styles:{overflow:"hidden"}}).inject(n);var o=new Element("table").inject(a);o.set(this.json.properties);o.store("data",i);t.each(function(t,n){var a=o.insertRow(n);var l=new Element("th").inject(a);l.set("text",t.get("text"));l.setStyle("width","30%");var r=a.insertCell(1);r.set("MWFId",e[n].get("id"));var d=i[t.get("id")];if(d){for(key in d){r.set("text",d[key]);break}}else{r.setStyle("text-align","left");r.set("text",s+1)}}.bind(this));var l=n.getSize()}.bind(this))}else{this._loadAddAction()}},_loadActions:function(t){var e=new Element("div",{styles:this.form.css.mobileDatagridActionNode}).inject(t);var i=new Element("div",{styles:this.form.css.mobileDatagridDelActionNode,text:MWF.xApplication.process.Xform.LP.delete}).inject(e);var s=new Element("div",{styles:this.form.css.mobileDatagridEditActionNode,text:MWF.xApplication.process.Xform.LP.edit}).inject(e);var n=new Element("div",{styles:this.form.css.mobileDatagridAddActionNode,text:MWF.xApplication.process.Xform.LP.add}).inject(e);var a=new Element("div",{styles:this.form.css.mobileDatagridCompleteActionNode,text:MWF.xApplication.process.Xform.LP.completedEdit}).inject(e);var o=this;i.addEvent("click",function(t){o._deleteLine(this.getParent().getParent().getParent(),t)});s.addEvent("click",function(t){o._editLine(this.getParent().getParent().getParent(),t)});a.addEvent("click",function(t){o._completeLineEdit()});n.addEvent("click",function(t){o._addLine()})},_createItemTitleNode:function(t,e){var i=e+1;var s=new Element("div",{styles:this.json.itemTitleStyles}).inject(t);s.setStyle("overflow","hidden");var n=new Element("div",{styles:{float:"left"},text:MWF.xApplication.process.Xform.LP.item+i}).inject(s);this._loadActions(s)},_createHelpNode:function(){this.helpNode=new Element("div",{styles:this.form.css.mobileGridHelpNode}).inject(this.node,"top");this.helpContentNode=new Element("div",{styles:this.form.css.mobileGridHelpContentNode}).inject(this.helpNode);this.helpContentNode.set("html",MWF.xApplication.process.Xform.LP.mobileGridHelp);new mBox.Tooltip({content:this.helpContentNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.helpNode,transition:"flyin",position:{x:["right"],y:["center"]},event:"click"})},_editLine:function(t){if(this.isEdit){if(!this._completeLineEdit())return false}this.currentEditLine=t;var e=t.getElement("table");if(this.currentEditLine){this.table.setStyles({"background-color":"#fffeb5",display:"table"});this.table.inject(e,"after");e.setStyle("display","none");var i=this.currentEditLine.getFirst("div").getLast("div").getElements("div");if(i[0])i[0].setStyle("display","none");if(i[1])i[1].setStyle("display","none");if(i[2])i[2].setStyle("display","none");if(i[3])i[3].setStyle("display","block");var s=this.currentEditLine.getElement("table").retrieve("data");var n=this.table.getElements("th");n.each(function(t,e){var i=t.get("id");var n=this.editModules[e];if(n){if(n.json.type=="sequence"){debugger;n.node.set("text",this.currentEditLine.getElement("table").getElements("tr")[e].getElement("td").get("text"))}else{if(s[i]){n.setData(s[i][n.json.id])}else{n.setData(null)}}}}.bind(this));this.isEdit=true}this.validationMode()},_loadAddAction:function(){this.addAction=new Element("div",{styles:this.form.css.gridMobileActionNode}).inject(this.node);this.addAction.set("text",MWF.xApplication.process.Xform.LP.addLine);this.addAction.addEvent("click",function(){this._addLine()}.bind(this))},_addLine:function(){if(this.isEdit){if(!this._completeLineEdit())return false}if(this.addAction)this.addAction.setStyle("display","none");var t=this.node.getElements("table");var e;var i=new Element("div",{styles:{overflow:"hidden","margin-bottom":"10px"}});if(this.totalDiv){e=t.length-2;i.inject(this.totalDiv,"before")}else{e=t.length-1;i.inject(this.node)}this._createItemTitleNode(i,e);var s=new Element("div",{styles:{overflow:"hidden"}}).inject(i);this.table.setStyles({"background-color":"#fffeb5",display:"table"});this.currentEditLine=null;this.table.inject(s);this.isEdit=true;var n=i.getFirst("div").getLast("div").getElements("div");if(n[0])n[0].setStyle("display","none");if(n[1])n[1].setStyle("display","none");if(n[2])n[2].setStyle("display","none");if(n[3])n[3].setStyle("display","block");i.scrollIntoView(true);this.validationMode();this.fireEvent("addLine")},_completeLineEdit:function(){if(!this.editValidation()){return false}this.isEdit=false;var t={};var e=null;var i;if(this.currentEditLine){e=this.currentEditLine;t=e.getElement("table").retrieve("data");this.currentEditLine.getElement("table").setStyle("display","table");i=e.getElement("table");var s=this.currentEditLine.getFirst("div").getLast("div").getElements("div");if(s[0])s[0].setStyle("display","block");if(s[1])s[1].setStyle("display","block");if(s[2])s[2].setStyle("display","block");if(s[3])s[3].setStyle("display","none")}else{var s=this.table.getParent().getPrevious("div").getLast("div").getElements("div");if(s[0])s[0].setStyle("display","block");if(s[1])s[1].setStyle("display","block");if(s[2])s[2].setStyle("display","block");if(s[3])s[3].setStyle("display","none");i=new Element("table").inject(this.table,"before");i.set(this.json.properties);t={}}var n=this.node.getElements("table");var a=this.table.getElements("th");var o=this.table.getElements("td");var l=i.getElements("tr");a.each(function(e,s){var a=l[s];var r=e.get("id");var d=this.editModules[s];if(d){var h;if(d.json.type=="sequence"){var c;if(!this.currentEditLine){c=n.length-1;if(this.totalTable)c=n.length-2}else{c=this.currentEditLine.getElement("table").getElements("tr")[s].getElement("td").get("text")}h={value:[c],text:[c]}}else{h=d.getTextData();if(h.value.length<2){if(!t[r])t[r]={};t[r][d.json.id]=h.value[0]}else{if(!t[r])t[r]={};t[r][d.json.id]=h.value}}var f;if(a){f=a.getElement("td");f.set("text",h.text.join(", "))}else{a=i.insertRow(s);var u=new Element("th").inject(a);u.set("text",e.get("text"));u.setStyle("width","30%");f=a.insertCell(1);f.set("MWFId",o[s].get("id"));var v=h[e.get("id")];f.set("text",h.text.join(", "))}}else{if(!a){a=i.insertRow(s);var g=new Element("th").inject(a);g.set("text",e.get("text"));g.setStyle("width","30%");f=a.insertCell(1)}}d=null}.bind(this));i.store("data",t);i.setStyle("display","table");this.currentEditLine=null;this._editorTrGoBack();this.getData();this._loadDatagridStyle();this.validationMode();this.fireEvent("completeLineEdit");this.addAction.set("text",MWF.xApplication.process.Xform.LP.addLine);this.addAction.removeEvents("click");this.addAction.addEvent("click",function(){this._addLine()}.bind(this));return true},_editorTrGoBack:function(){this.table.setStyle("display","none");this.table.inject(this.node,"top")},_actionMousedown:function(t,e){var i=t.retrieve("editStatus");if(!i){t.store("editStatus",new Date)}this._checkMouseDown(t)},_checkMouseDown:function(t){var e=t.retrieve("editStatus");if(e){var i=(new Date).getTime();if(i-e.getTime()>1e3){this._editLine(t);t.eliminate("editStatus")}else{window.setTimeout(function(){this._checkMouseDown(t)}.bind(this),1e3)}}},_actionMouseup:function(t,e){t.eliminate("editStatus")},actionTouchstart:function(t,e){var i={x:e.touches[0].pageX,y:e.touches[0].pageY};var s=t.retrieve("action");if(s){t.store("touchStatus",{p:i,status:"hide",isHide:false})}else{t.store("touchStatus",{p:i,status:"show"})}this._actionMousedown(t,e)},actionTouchmove:function(t,e){var i=t.retrieve("touchStatus");var s=i.p;var n=i.status;var a=e.touches[0].pageX;var o=e.touches[0].pageY;if(Math.abs(s.x-a)>10||Math.abs(s.y-o)>10){this._actionMouseup(t)}if(n=="show"){if(s.x-a>20&&Math.abs(s.y-o)<40){this.showMoveAction(t,s.x-a);e.preventDefault()}}else{if(a-s.x>20&&Math.abs(s.y-o)<40){i.isHide=true;this.hideMoveAction(t,a-s.x);e.preventDefault()}}},actionTouchend:function(t,e){var i=t.retrieve("touchStatus");var s=i.p;var n=i.status;if(n=="show"){var a=t.retrieve("action");if(a)this.showEndMoveAction(t)}else{if(i.isHide)this.hideEndMoveAction(t)}},actionTouchcancel:function(t,e){this._actionMouseup(t)},showEndMoveAction:function(t){var e=t.retrieve("action");var i=t.getLast("div");new Fx.Tween(e,{duration:100}).start("width","60px");new Fx.Tween(i,{duration:100}).start("margin-right","60px");var s=this;e.addEvent("click",function(e){s._deleteLine(t,e)})},_deleteLine:function(t,e){var i=t.getElement("table");if(i){var s=this;var n=this;this.form.confirm("warn",e,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,function(){n.fireEvent("deleteLine",[i]);t.destroy();s._loadSequence();s._loadTotal();s.getData();if(!n.gridData.data.length)if(n.addAction)n.addAction.setStyle("display","block");this.close();n.fireEvent("afterDeleteLine")},function(){this.close()},null)}this.validationMode()},hideEndMoveAction:function(t){var e=t.retrieve("action");var i=t.getLast("div");new Fx.Tween(e,{duration:100}).start("width","0px");new Fx.Tween(i,{duration:100}).start("margin-right","0px").chain(function(){e.destroy();t.eliminate("action")})},showMoveAction:function(t,e){var i=t.retrieve("action");var s=t.getLast("div");if(!i){var n=t.getSize();i=new Element("div",{styles:this.form.css.gridMobileDeleteActionAreaNode}).inject(t,"top");var a=new Element("div",{styles:this.form.css.gridMobileDeleteActionNode,text:MWF.xApplication.process.Xform.LP.delete}).inject(i);i.setStyle("height",""+n.y+"px");i.setStyle("line-height",""+n.y+"px");t.store("action",i)}if(e>60)e=60;i.setStyle("width",""+e+"px");s.setStyle("margin-right",""+e+"px")},hideMoveAction:function(t,e){var i=t.retrieve("action");var s=t.getLast("div");var n=60-e;if(n<0)n=0;if(i)i.setStyle("width",""+n+"px");s.setStyle("margin-right",""+n+"px")},_loadDatagridStyle:function(){this.loadGridTitleStyle();this.loadGridContentStyle();this.loadGridEditStyle();this._loadTotal();this._loadBorderStyle();this._loadZebraStyle();this._loadSequence()},loadGridEditStyle:function(){if(this.table){if(this.json.editStyles){var t=this.table.getElements("td");t.setStyles(this.json.editStyles)}}},loadGridTitleStyle:function(){if(this.json.titleStyles){var t=this.node.getElements("th");t.setStyles(this.json.titleStyles)}},loadGridContentStyle:function(){if(this.json.contentStyles){var t=this.node.getElements("td");t.setStyles(this.json.contentStyles)}},_loadZebraStyle:function(){if(this.json.zebraColor||this.json.backgroundColor){var t=this.node.getElements("table");t.each(function(t){this._loadTableZebraStyle(t)}.bind(this))}},_loadTableZebraStyle:function(t){var e=t.getElements("tr");for(var i=0;i<e.length;i++){if(this.json.backgroundColor)e[i].setStyle("background-color",this.json.backgroundColor);if(i%2==0){if(this.json.zebraColor)e[i].setStyle("background-color",this.json.zebraColor)}}},createTotalDiv:function(){this.totalDiv=new Element("div",{styles:{overflow:"hidden","margin-bottom":"10px"}}).inject(this.node);var t=new Element("div",{styles:this.json.itemTitleStyles}).inject(this.totalDiv);t.set("text",MWF.xApplication.process.Xform.LP.amount);var e=new Element("div",{styles:{overflow:"hidden"}}).inject(this.totalDiv);this.totalTable=new Element("table").inject(e);this.totalTable.set(this.json.properties)},_loadTotal:function(){var t={};this.totalResaults={};if(this.totalModules.length){if(!this.totalDiv){this.createTotalDiv()}var e=[];var i=this.node.getElements("table");for(var s=1;s<i.length-1;s++){var n=i[s].getElements("td");this.totalModules.each(function(i,s){if(!e[s])e.push(0);var a=new Decimal(e[s]);if(i.type=="number"){var o=n[i.index];var l=o.get("text").toFloat();a=a.plus(l)}if(i.type=="count"){a=a.plus(1)}e[s]=a.toString();t[i.module.json.id]=e[s]}.bind(this))}var a=this.totalTable.getElements("tr");this.totalModules.each(function(t,i){var s=a[i];if(!s){s=this.totalTable.insertRow(i);var n=new Element("th").inject(s);n.set("text",t.module.node.get("text"));n.setStyles(this.json.titleStyles);s.insertCell(1).setStyles(this.json.amountStyles).set("text",e[i]||"")}else{s.getElement("td").set("text",e[i]||"")}this.totalResaults[t.module.json.id]=e[i]}.bind(this));if(this.totalTable){var o=this.totalTable.getElements("th");o.setStyles(this.json.titleStyles)}}return t},_loadSequence:function(){var t=this.node.getElements("table");t.each(function(t,e){var i=t.getElements("td");i.each(function(t){var i=t.retrieve("module");if(i){if(i.json.cellType=="sequence"){t.set("text",e)}}}.bind(this))}.bind(this))},_loadBorderStyle:function(){if(this.json.border){var t=this.node.getElements("table");t.each(function(t){this._loadTableBorderStyle(t)}.bind(this))}},_loadTableBorderStyle:function(t){t.setStyles({"border-top":this.json.border,"border-left":this.json.border});var e=t.getElements("th");e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border});var i=t.getElements("td");i.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})},_loadDatagridTitleModules:function(){var t=this.node.getElements("th");t.each(function(t){var e=this.form._getDomjson(t);t.store("dataGrid",this);if(e){var i=this.form._loadModule(e,t);this.form.modules.push(i)}}.bind(this))},_loadDatagridDataModules:function(){var t=this.node.getElements("td");t.each(function(t){var e=this.form._getDomjson(t);t.store("dataGrid",this);if(e){var i=this.form._loadModule(e,t,function(){this.field=false});t.store("module",i);this.form.modules.push(i)}}.bind(this))},_afterLoaded:function(){this._loadDatagridStyle();if(this.table)this.table.setStyle("display","none")},resetData:function(){this.setData()},setData:function(t){this._setBusinessData(t);if(t){this.gridData=t}else{this.gridData=this._getValue()}if(this.isEdit)this._completeLineEdit();if(this.gridData){var e=this.node.getElements("table");for(var i=1;i<e.length-1;i++){var s=e[i];var n=s.getElements("td");for(var a=0;a<n.length;a++){var o=n[a];var l=o.retrieve("module");if(l){this.form.modules.erase(l);delete l}}var r=s.getElements("th");for(var d=0;d<r.length;d++){var h=r[d];var c=h.retrieve("module");if(c){this.form.modules.erase(c);delete c}}}while(e.length>2){e[1].destroy();e=this.node.getElements("table")}if(this.editable!=false){this._loadEditDatagrid()}else{this._loadReadDatagrid()}this._loadDatagridStyle()}},getTotal:function(){this._loadTotal();return this.totalResaults},getData:function(){if(this.editable!=false){var t=[];var e=this.node.getElements("table");for(var i=1;i<(this.totalTable?e.length-1:e.length);i++){var s=e[i];var n=s.retrieve("data");if(n)t.push(n)}this.gridData={};this.gridData.data=t;this._loadTotal();this.gridData.total=this.totalResaults;this._setBusinessData(t);return this.gridData.data.length?this.gridData:null}else{return this._getBusinessData()}},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");var i=new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url("+"/x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e);var s=new Element("div",{styles:{"line-height":"20px","margin-left":"20px","text-align":"left",color:"red"},text:t}).inject(e);return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=true;this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom"));this.node.setStyle("border","1px solid red");this.errNode=this.createErrorNode(t).inject(this.node,"after");this.showNotValidationMode(this.node)}},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if(e.get("MWFtype")=="tab$Content"){if(e.getParent("div").getStyle("display")=="none"){var i=e.getParent("div").getParent("div");var s=i.getPrevious("div");var n=i.getChildren().indexOf(e.getParent("div"));var a=s.getChildren()[n];a.click();e=s.getParent("div")}}this.showNotValidationMode(e)}},validationMode:function(){if(this.isNotValidationMode){this.isNotValidationMode=false;this.node.setStyles(this.node.retrieve("borderStyle"));if(this.errNode){this.errNode.destroy();this.errNode=null}}},validationConfigItem:function(t,e){var i=e.status=="all"?true:t==e.decision;if(i){var s=this.getData();var n=e.valueType=="value"?s:s.length;switch(e.operateor){case"isnull":if(!n){this.notValidationMode(e.prompt);return false}break;case"notnull":if(n){this.notValidationMode(e.prompt);return false}break;case"gt":if(n>e.value){this.notValidationMode(e.prompt);return false}break;case"lt":if(n<e.value){this.notValidationMode(e.prompt);return false}break;case"equal":if(n==e.value){this.notValidationMode(e.prompt);return false}break;case"neq":if(n!=e.value){this.notValidationMode(e.prompt);return false}break;case"contain":if(n.indexOf(e.value)!=-1){this.notValidationMode(e.prompt);return false}break;case"notcontain":if(n.indexOf(e.value)==-1){this.notValidationMode(e.prompt);return false}break}}return true},validationConfig:function(t,e){debugger;if(this.json.validationConfig){if(this.json.validationConfig.length){for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return false}}return true}return true},validation:function(t,e){if(this.isEdit){if(!this.editValidation()){return false}}if(!this.validationConfig(t,e))return false;if(!this.json.validation)return true;if(!this.json.validation.code)return true;var i=this.form.Macro.exec(this.json.validation.code,this);if(!i)i=MWF.xApplication.process.Xform.LP.notValidation;if(i.toString()!="true"){this.notValidationMode(i);return false}return true}});MWF.xApplication.process.Xform.DatagridMobile$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");if(this.json.total=="number"||this.json.total=="count"){this.dataGrid.totalModules.push({module:this,index:this.node.getParent("tr").rowIndex,type:this.json.total})}}});MWF.xApplication.process.Xform.DatagridMobile$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if(this.json.cellType=="sequence"){var e=true;for(var i=0;i<this.dataGrid.editModules.length;i++){if(this.dataGrid.editModules[i].json.id==this.json.id){e=false;break}}if(e){this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}})}t.empty()}else{var s=this.form._getModuleNodes(this.node);s.each(function(t){var e=this.form._getDomjson(t);var i=this.form._loadModule(e,t,function(){this.field=false});i.dataModule=this;this.dataGrid.editModules.push(i)}.bind(this))}}});