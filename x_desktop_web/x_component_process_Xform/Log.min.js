MWF.xDesktop.requireApp("process.Xform","$Module",null,false);MWF.xApplication.process.Xform.Log=MWF.APPLog=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty();this.node.setStyle("-webkit-user-select","text");if(this.form.businessData){if(this.form.businessData.workLogList){this.workLog=this.form.businessData.workLogList;this.loadWorkLog()}}},loadWorkLog:function(){if(this.json.mode=="table"){this.loadWorkLogTable()}else if(this.json.mode=="text"){this.loadWorkLogText()}else{this.loadWorkLogDefault()}},loadWorkLogTable:function(){this.workLog.each(function(e,t){if(this.checkShow(e))this.loadWorkLogLine_table(e,t)}.bind(this))},loadWorkLogLine_table:function(e,t){if(e.taskCompletedList.length||this.json.isTask!="false"&&e.taskList.length){var s=new Element("div",{styles:this.form.css.logActivityNode}).inject(this.node);var i=new Element("div",{styles:this.form.css.logActivityTitleNode}).inject(s);var o=new Element("div",{styles:this.form.css.logActivityChildNode}).inject(s);var l=new Element("div",{styles:this.form.css.logActivityIconNode}).inject(i);var n=new Element("div",{styles:this.form.css.logActivityFromNode}).inject(i);var r=new Element("div",{styles:this.form.css.logActivityArrowNode}).inject(i);var c=new Element("div",{styles:this.form.css.logActivityArrivedNode}).inject(i);var a=new Element("div",{styles:this.form.css.logActivityTimeNode}).inject(i);if(e.connected){l.setStyle("background-image","url("+"/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)")}else{l.setStyle("background-image","url("+"/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)")}n.set("html","<b>"+e.fromActivityName+"</b>");if(e.arrivedActivityName){r.setStyle("background-image","url("+"/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)");c.set("html","<b>"+e.arrivedActivityName+"</b>");a.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+e.arrivedTime)}else{a.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime)}if(t%2==0){s.setStyles(this.form.css.logActivityNode_even);i.setStyles(this.form.css.logActivityTitleNode_even)}var f=new Element("table",{styles:this.form.css.logTableTask,border:"0",cellSpacing:"0",cellpadding:"3px",width:"100%"}).inject(o);var m=f.insertRow(0).setStyles(this.form.css.logTableTaskTitleLine);var h=m.insertCell(0).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.person);h=m.insertCell(1).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.department);h=m.insertCell(2).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.startTime);h=m.insertCell(3).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.completedTime);h=m.insertCell(4).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.route);h=m.insertCell(5).setStyles(this.form.css.logTableTaskTitle);h.set("text",MWF.xApplication.process.Xform.LP.opinion);e.taskCompletedList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_table(t,f,e,false)}.bind(this));if(this.json.isTask!="false"){e.taskList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_table(t,f,e,true)}.bind(this))}}},loadTaskLine_table:function(e,t,s,i){var o="logTableTaskLine";if(i)o="logTableTaskLine_task";var l=t.insertRow(t.rows.length);var n=l.insertCell(0).setStyles(this.form.css[o]);n.set("text",e.person||"");n=l.insertCell(1).setStyles(this.form.css[o]);n.set("text",e.department||"");n=l.insertCell(2).setStyles(this.form.css[o]);n.set("text",e.startTime||"");n=l.insertCell(3).setStyles(this.form.css[o]);n.set("text",e.completedTime||"");n=l.insertCell(4).setStyles(this.form.css[o]);n.set("text",e.routeName||"");n=l.insertCell(5).setStyles(this.form.css[o]);n.set("text",e.opinion||"")},loadWorkLogText:function(){this.lineClass="logTaskNode";this.workLog.each(function(e,t){if(this.checkShow(e))this.loadWorkLogLine_text(e,t)}.bind(this))},loadWorkLogLine_text:function(e,t){e.taskCompletedList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_text(t,this.node,e,false)}.bind(this));if(this.json.isTask!="false"){e.taskList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_text(t,this.node,e,true)}.bind(this))}},loadTaskLine_text:function(e,t,s,i){this.loadTaskLine_default(e,t,s,i,"0px",false)},checkShow:function(e){var t=true;if(this.json.filterScript&&this.json.filterScript.code){this.form.Macro.environment.log=e;this.form.Macro.environment.list=null;t=this.form.Macro.exec(this.json.filterScript.code,this)}else{if(this.json.filterActivity.length){filterActivitys=this.json.filterActivity;t=filterActivitys.indexOf(e.fromActivityName)!=-1}if(this.json.filterPerson.length){t=false;filterPersons=this.json.filterPerson;var s=[];e.taskCompletedList.each(function(e){if(filterPersons.indexOf(e.person)!=-1||filterPersons.indexOf(e.identity)!=-1){s.push(e)}}.bind(this));if(s.length){t=true}}if(this.json.filterRoute.length){filterRoutes=this.json.filterRoute;t=filterRoutes.indexOf(e.routeName)!=-1}}return t},checkListShow:function(e,t){var s=true;if(this.json.filterScript&&this.json.filterScript.code){this.form.Macro.environment.log=e;this.form.Macro.environment.list=t;s=this.form.Macro.exec(this.json.filterScript.code,this)}else{if(this.json.filterPerson.length){s=filterPersons.indexOf(t.person)!=-1||filterPersons.indexOf(t.identity)!=-1}}return s},loadWorkLogDefault:function(){this.workLog.each(function(e,t){if(this.checkShow(e))this.loadWorkLogLine_default(e,t)}.bind(this))},loadWorkLogLine_default:function(e,t){if(e.taskCompletedList.length||this.json.isTask!="false"&&e.taskList.length){var s=new Element("div",{styles:this.form.css.logActivityNode}).inject(this.node);var i=new Element("div",{styles:this.form.css.logActivityTitleNode}).inject(s);var o=new Element("div",{styles:this.form.css.logActivityChildNode}).inject(s);var l=new Element("div",{styles:this.form.css.logActivityIconNode}).inject(i);var n=new Element("div",{styles:this.form.css.logActivityFromNode}).inject(i);var r=new Element("div",{styles:this.form.css.logActivityArrowNode}).inject(i);var c=new Element("div",{styles:this.form.css.logActivityArrivedNode}).inject(i);var a=new Element("div",{styles:this.form.css.logActivityTimeNode}).inject(i);if(e.connected){l.setStyle("background-image","url(/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)")}else{l.setStyle("background-image","url(/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)")}n.set("html","<b>"+e.fromActivityName+"</b>");if(e.arrivedActivityName){r.setStyle("background-image","url(/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)");c.set("html","<b>"+e.arrivedActivityName+"</b>");a.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+e.arrivedTime)}else{a.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime)}if(t%2==0){s.setStyles(this.form.css.logActivityNode_even);i.setStyles(this.form.css.logActivityTitleNode_even)}e.taskCompletedList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_default(t,o,e,false)}.bind(this));if(this.json.isTask!="false"){e.taskList.each(function(t){if(this.checkListShow(e,t))this.loadTaskLine_default(t,o,e,true)}.bind(this))}}},loadTaskLine_default:function(e,t,s,i,o,l,n){var r="logTaskNode";if(n)r="logTaskTextNode";var c=new Element("div",{styles:this.form.css[r]}).inject(t);var a=new Element("div",{styles:this.form.css.logTaskIconNode}).inject(c);var f=new Element("div",{styles:this.form.css.logTaskTextNode}).inject(c);if(l){c.setStyles(this.form.css[this.lineClass]);if(this.lineClass=="logTaskNode"){this.lineClass="logTaskNode_even"}else{this.lineClass="logTaskNode"}}if(o)a.setStyle("margin-left",o);var m=a.getStyle("margin-left").toInt();m=m+28;f.setStyle("margin-left",""+m+"px");if(!i){var h=this.json.textStyle;h=h.replace(/\{person\}/g,e.person);h=h.replace(/\{department\}/g,e.department);h=h.replace(/\{route\}/g,e.routeName);h=h.replace(/\{time\}/g,e.completedTime);h=h.replace(/\{opinion\}/g,e.opinion);h=h.replace(/\{company\}/g,e.company);h=h.replace(/\{startTime\}/g,e.startTime);h=h.replace(/\{activity\}/g,s.fromActivityName);h=h.replace(/\{arrivedActivity\}/g,e.arrivedActivityName);f.set("html",h)}else{var h=e.person+"("+e.department+")"+MWF.xApplication.process.Xform.LP.processing+", "+MWF.xApplication.process.Xform.LP.comeTime+": "+e.startTime;f.set("html",h);a.setStyle("background-image","url("+"/x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)")}}});