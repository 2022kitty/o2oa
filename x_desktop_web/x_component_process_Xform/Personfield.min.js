MWF.xDesktop.requireApp("process.Xform","$Input",null,false);MWF.xDesktop.requireApp("Organization","Selector.package",null,false);MWF.xApplication.process.Xform.Personfield=MWF.APPPersonfield=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"personfieldIcon",loadDescription:function(){var t=this._getBusinessData();if(!t||!t.length){if(this.json.description){var e=this.node.getFirst().getSize();var i=e.x-3;if(COMMON.Browser.safari)i=i-20;this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node);this.descriptionNode.setStyles({width:""+i+"px",height:""+e.y+"px","line-height":""+e.y+"px"});this.setDescriptionEvent()}}},setDescriptionEvent:function(){if(this.descriptionNode){this.descriptionNode.addEvents({mousedown:function(){this.descriptionNode.setStyle("display","none");this.clickSelect()}.bind(this)})}},getRange:function(){var t=[];if(this.json.rangeField&&this.json.rangeField.length){this.json.rangeField.each(function(e){var i=this.form.businessData.data[e];if(typeOf(i)!="array")i=i?[i.toString()]:[];i.each(function(e){if(e)t.push(e)})}.bind(this))}if(this.json.rangeKey&&this.json.rangeKey.code){var e=this.form.Macro.exec(this.json.rangeKey.code,this);if(typeOf(e)!="array")e=e?[e.toString()]:[];e.each(function(e){if(e)t.push(e)})}return t},_computeValue:function(t){var e=[];if(this.json.identityValue){this.json.identityValue.each(function(t){if(t)e.push(t)})}if(this.json.departmentValue){this.json.departmentValue.each(function(t){if(t)e.push(t)})}if(this.json.companyValue){this.json.companyValue.each(function(t){if(t)e.push(t)})}if(this.json.dutyValue){debugger;var i=JSON.decode(this.json.dutyValue);var n;if(i.length){i.each(function(t){if(t.code)n=this.form.Macro.exec(t.code,this);var i='return this.org.getDepartmentDuty({"name": "'+t.name+'", "departmentName": "'+n+'"})';var s=this.form.Macro.exec(i,this);if(typeOf(s)!="array")s=s?[s.toString()]:[];s.each(function(t){e.push(t)});i='return this.org.getCompanyDuty({"name": "'+t.name+'", "compName": "'+n+'"})';s=this.form.Macro.exec(i,this);if(typeOf(s)!="array")s=s?[s.toString()]:[];s.each(function(t){e.push(t)})}.bind(this))}}if(this.json.defaultValue&&this.json.defaultValue.code){var s=this.form.Macro.exec(this.json.defaultValue.code,this);if(typeOf(s)!="array")s=s?[s.toString()]:[];s.each(function(t){e.push(t)})}if(this.json.count>0){return e.slice(0,this.json.count)}return e},getDepartments:function(){if(this.json.range=="depart"){return this.getRange()}if(this.json.range=="currentdepart"){return[this.form.app.currentTask.department]}return[]},getCompanys:function(){if(this.json.range=="company"){var t="";return this.getRange()}if(this.json.range=="currentcompany"){return[this.form.app.currentTask.company]}return[]},clickSelect:function(){var t=this.getInputData();var e=t;var i=this.json.count?this.json.count:0;var n=this.getCompanys();var s=this.getDepartments();if(this.json.range=="depart"){if(!s.length){this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node);return false}}if(this.json.range=="company"){if(!n.length){this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node);return false}}var o={type:this.json.selectType,names:e,count:i,departments:s,companys:n,onComplete:function(t){var e=[];t.each(function(t){e.push(t.data.name)}.bind(this));this.setData(e.join(", "));this._setBusinessData(this.getInputData());this.validationMode();this.validation()}.bind(this),onCancel:function(){this.validation()}.bind(this),onLoad:function(){if(this.descriptionNode)this.descriptionNode.setStyle("display","none")}.bind(this),onClose:function(){var t=this.node.getFirst().get("value");if(!t||!t.length)if(this.descriptionNode)this.descriptionNode.setStyle("display","block")}.bind(this)};var a=new MWF.OrgSelector(this.form.app.content,o)},resetData:function(){var t=this.getValue();this.setData(t?t.join(", "):"")},getInputData:function(){debugger;var t=this.node.getElement("input").get("value");return t?t.split(/,\s*/g):""}});