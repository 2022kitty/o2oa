MWF.xDesktop.requireApp("process.Xform","$Module",null,false);MWF.xApplication.process.Xform.DatagridPC=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:false,options:{moduleEvents:["completeLineEdit","addLine","deleteLine","afterDeleteLine"]},initialize:function(t,e,i,s){this.node=$(t);this.node.store("module",this);this.json=e;this.form=i;this.field=true},_loadUserInterface:function(){this.editModules=[];this.node.setStyle("overflow-x","auto");this.node.setStyle("overflow-y","hidden");this.table=this.node.getElement("table");this.editable=this.readonly?false:true;if(this.editable)this.editable=this.form.Macro.exec(this.json.editableScript.code,this);this.gridData=this._getValue();this.totalModules=[];this._loadDatagridTitleModules();if(this.editable!=false){this._loadDatagridDataModules();this._addTitleActionColumn();this._loadEditDatagrid()}else{this._loadReadDatagrid()}},_loadStyles:function(){this.table.setStyles(this.json.tableStyles);this.node.setStyles(this.json.styles)},_getValue:function(){var t=[];t=this._getBusinessData();if(!t){if(this.json.defaultData.code)t=this.form.Macro.exec(this.json.defaultData.code,this)}return t||[]},_getDatagridTr:function(){this._getDatagridTitleTr();this._getDatagridEditorTr()},_getDatagridTitleTr:function(){this.titleTr=this.table.getElement("tr");return this.titleTr},_getDatagridEditorTr:function(){var t=this.table.getElements("tr");this.editorTr=t[t.length-1];this.editorTr.addClass("datagridEditorTr");return this.editorTr},_addTitleActionColumn:function(){if(!this.titleTr)this._getDatagridTitleTr();if(!this.editorTr)this._getDatagridEditorTr();var t=new Element("th",{styles:{width:"46px"}}).inject(this.titleTr,"top");new Element("th").inject(this.titleTr,"bottom");this._createAddLineAction(t);var e=new Element("td").inject(this.editorTr,"top");this._createCompleteAction(e);new Element("td").inject(this.editorTr,"bottom")},_loadEditDatagrid:function(){var t=this.titleTr.getElements("th");var e=this.editorTr.getElements("td");this.gridData.each(function(i,s){var r=this.table.insertRow(s+1);r.store("data",i);t.each(function(s,a){var n=i[s.get("id")];var o="";for(key in n){var l=n[key];o=this._getValueText(a-1,l);break}this._createNewEditTd(r,a,e[a].get("id"),o,t.length-1)}.bind(this))}.bind(this));this.editorTr.setStyle("display","none")},_getValueText:function(t,e){var i=this.editModules[t];if(i){switch(i.json.type){case"Select":var s=i.node.getElements("option");for(var r=0;r<s.length;r++){if(s[r].value==e){return s[r].get("text");break}}break;case"Radio":var s=i.node.getElements("input");for(var r=0;r<s.length;r++){if(s[r].value==e){return s[r].get("showText");break}}break;case"Checkbox":var s=i.node.getElements("input");var a=[];for(var r=0;r<s.length;r++){if(e.indexOf(s[r].value)!=-1)a.push(s[r].get("showText"))}if(a.length)return a.join(", ");break}}return e},_createNewEditTd:function(t,e,i,s,r){var a=t.insertCell(e);if(e==0){a.setStyles(this.form.css.gridLineActionCell);this._createAddLineAction(a);this._createDelLineAction(a)}else if(e==r){a.setStyles(this.form.css.gridMoveActionCell);this._createMoveLineAction(a)}else{a.set("MWFId",i);a.set("text",s);a.addEvent("click",function(t){this._editLine(t.target)}.bind(this))}var n=this.form._getDomjson(a);if(n){a.store("dataGrid",this);var o=this.form._loadModule(n,a);a.store("module",o);this.form.modules.push(o)}},_createAddLineAction:function(t){var e=new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this._addLine(t.target)}.bind(this)}});e.inject(t)},_createDelLineAction:function(t){var e=new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._deleteLine(t)}.bind(this)}});e.inject(t)},_createCompleteAction:function(t){var e=new Element("div",{styles:this.form.css.completeLineAction,events:{click:function(t){this._completeLineEdit(t)}.bind(this)}});e.inject(t)},_editLine:function(t){if(this.isEdit){if(!this._completeLineEdit())return false}this.currentEditLine=t.getParent("tr");if(this.currentEditLine){this.editorTr.setStyles({display:"table-row"});this.editorTr.inject(this.currentEditLine,"before");this.currentEditLine.setStyle("display","none");var e=this.currentEditLine.retrieve("data");var i=this.titleTr.getElements("th");i.each(function(t,i){var s=t.get("id");var r=this.editModules[i-1];if(r){if(r.json.type=="sequence"){r.node.set("text",r.node.getParent("tr").rowIndex)}else{if(e[s]){r.setData(e[s][r.json.id])}else{r.setData(null)}}}}.bind(this));var s=this.currentEditLine.getElements("td").indexOf(t);var r=this.editModules[s-1];if(r)r.focus();this.isEdit=true}this.validationMode()},editValidation:function(){var t=true;this.editModules.each(function(e,i){if(e.json.type!="sequence"){e.validationMode();if(!e.validation())t=false}}.bind(this));return t},_completeLineEdit:function(){if(!this.editValidation()){return false}this.isEdit=false;var t=true;var e={};var i=null;if(this.currentEditLine){i=this.currentEditLine;e=this.currentEditLine.retrieve("data")}else{i=new Element("tr").inject(this.editorTr,"before");e={}}var s=this.titleTr.getElements("th");var r=this.editorTr.getElements("td");var a=i.getElements("td");debugger;s.each(function(n,o){var l=a[o];var d=n.get("id");var h=this.editModules[o-1];if(h){if(h.json.type=="sequence"){var f=i.rowIndex;var c={value:[f],text:[f]}}else{var c=h.getTextData();if(c.value[0])t=false;if(c.value.length<2){if(!e[d])e[d]={};e[d][h.json.id]=c.value[0]}else{if(!e[d])e[d]={};e[d][h.json.id]=c.value}}if(l){l.set("text",c.text.join(", "))}else{this._createNewEditTd(i,o,r[o].get("id"),c.text.join(", "),s.length-1)}}else{if(!l)this._createNewEditTd(i,o,d,"",s.length-1)}h=null}.bind(this));i.store("data",e);i.setStyle("display","table-row");if(t){i.destroy()}this.currentEditLine=null;this._editorTrGoBack();if(this.json.contentStyles){var n=i.getElements("td");n.setStyles(this.json.contentStyles)}if(this.json.actionStyles){i.getFirst().setStyles(this.json.actionStyles)}this._loadTotal();this._loadBorderStyle();this._loadZebraStyle();this._loadSequence();this.getData();this.validationMode();this.fireEvent("completeLineEdit");return true},_editorTrGoBack:function(){this.editorTr.setStyle("display","none");if(this.totalTr){this.editorTr.inject(this.totalTr,"before")}else{var t=this.table.getElements("tr");var e=t[t.length-1];this.editorTr.inject(e,"after")}},_addLine:function(t){if(this.isEdit){if(!this._completeLineEdit())return false}this.editorTr.setStyles({display:"table-row"});this.currentEditLine=null;var e=t.getParent("tr");if(e){this.editorTr.inject(e,"after")}this.isEdit=true;this.validationMode();this.fireEvent("addLine");debugger},_deleteLine:function(t){var e=t.target.getParent("tr");if(e){var i=e.getStyle("background");e.store("bgcolor",i);e.tween("background-color","#ffd4d4");var s=this;var r=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,function(){r.fireEvent("deleteLine",[e]);e.destroy();s._loadZebraStyle();s._loadSequence();s._loadTotal();s.getData();this.close();r.fireEvent("afterDeleteLine")},function(){var t=e.retrieve("bgcolor");e.tween("background",t);this.close()},null)}this.validationMode()},_createMoveLineAction:function(t){var e=new Element("div",{styles:this.form.css.moveLineAction,events:{mousedown:function(t){this._moveLine(t)}.bind(this)}});e.inject(t)},_getMoveDragNode:function(t){var e=t.getParent("table");var i=e.getParent("div");var s=i.getSize();var r=i.clone().setStyle("width",s.x).inject(document.body);var a=r.getElement("table");a.empty();var n=t.clone().setStyles(this.form.css.gridMoveLineDragNodeTr).inject(a);var o=t.getElements("td");var l=n.getElements("td");o.each(function(t,e){var i=t.getComputedSize();l[e].setStyle("width",i.width+1)});var d=t.getCoordinates();r.setStyles(this.form.css.gridMoveLineDragNode);r.setStyles(d);return r},_moveLine:function(t){var e=this.table.getElements("tr");var i=t.target;var s=i.getParent("tr");var r=this._getMoveDragNode(s);coordinates=r.getCoordinates();var a=r.getElement("tr");var n=r.getElement("table");var o=s.getStyle("background");s.store("bgcolor",o);s.tween("background-color","#e4f6e9");var l=new Drag.Move(r,{droppables:e.erase(s),limit:{x:[coordinates.left,coordinates.left]},onDrop:function(t,e){t.destroy();var i=s.retrieve("bgcolor");if(i){s.tween("background",i)}else{s.tween("background","transparent")}s.setStyle("display","table-row");if(e!=null){s.inject(a,"after");a.destroy();this._loadDatagridStyle();this.getData()}}.bind(this),onEnter:function(t,e){r.setStyle("display","none");a.inject(e,"after")},onLeave:function(t,e){a.inject(n);r.setStyle("display","block")},ondrag:function(){this.table.setStyle("cursor","move");r.setStyle("cursor","move")},onCancel:function(t){t.destroy();var e=s.retrieve("bgcolor");if(e){s.tween("background",e)}else{s.tween("background","transparent")}s.setStyle("display","table-row")}});l.start(t);s.setStyle("display","none")},_loadReadDatagrid:function(){this.gridData=this._getValue();if(!this.titleTr)this._getDatagridTitleTr();var t=this.titleTr.getElements("th");var e=this.table.getElements("tr");var i=e[e.length-1];var s=i.getElements("td");this.gridData.each(function(e,i){var r=this.table.insertRow(i+1);r.store("data",e);t.each(function(t,i){var a=r.insertCell(i);a.set("MWFId",s[i].get("id"));var n=e[t.get("id")];if(n){for(key in n){a.set("text",n[key]);break}}else{a.setStyle("text-align","center");a.set("text",r.rowIndex)}}.bind(this))}.bind(this));i.destroy();this._loadTotal()},_loadDatagridStyle:function(){this.loadGridTitleStyle();this.loadGridContentStyle();this.loadGridActionStyle();this.loadGridEditStyle();this._loadTotal();this._loadBorderStyle();this._loadZebraStyle();this._loadSequence()},loadGridEditStyle:function(){if(this.editorTr){if(this.json.editStyles){var t=this.editorTr.getElements("td");t.setStyles(this.json.editStyles)}}},loadGridActionStyle:function(){if(this.editable!=false){if(this.json.actionStyles){var t=this.table.getElements("tr");t.each(function(t,e){if(e!=0)t.getFirst().setStyles(this.json.actionStyles)}.bind(this))}}},loadGridTitleStyle:function(){if(this.json.titleStyles){var t=this.titleTr.getElements("th");t.setStyles(this.json.titleStyles)}},loadGridContentStyle:function(){if(this.json.contentStyles){var t=this.table.getElements("td");t.setStyles(this.json.contentStyles)}},_loadZebraStyle:function(){var t=this.table.getElements("tr");for(var e=1;e<t.length;e++){if(!t[e].hasClass("datagridTotalTr")){if(this.json.backgroundColor)t[e].setStyle("background-color",this.json.backgroundColor);if(e%2==0){if(this.json.zebraColor)t[e].setStyle("background-color",this.json.zebraColor)}}}},createTotalTr:function(){var t=this.node.getElements("tr");var e=t[t.length-1];this.totalTr=new Element("tr.datagridTotalTr",{styles:this.form.css.datagridTotalTr}).inject(e,"after");var i=this.node.getElements("th");i.each(function(t,e){var i=new Element("td",{text:"",styles:this.form.css.datagridTotalTd}).inject(this.totalTr);if(this.json.amountStyles)i.setStyles(this.json.amountStyles)}.bind(this))},_loadTotal:function(){var t={};if(this.totalModules.length){if(!this.totalTr){this.createTotalTr()}var e=[];var i=this.table.getElements("tr");var s=this.totalTr.getElements("td");for(var r=1;r<i.length;r++){if(!i[r].hasClass("datagridTotalTr")&&!i[r].hasClass("datagridEditorTr")){var a=i[r].getElements("td");this.totalModules.each(function(i,s){if(!e[s])e.push(0);var r=new Decimal(e[s]);if(i.type=="number"){var n=a[i.index];var o=n.get("text").toFloat();r=r.plus(o)}if(i.type=="count"){r=r.plus(1)}e[s]=r.toString();t[i.module.json.id]=e[s]}.bind(this))}}this.totalModules.each(function(t,i){var r=s[t.index];r.set("text",e[i]||"")}.bind(this))}return t},_loadSequence:function(){var t=this.table.getElements("tr");for(var e=1;e<t.length;e++){var i=t[e].getElements("td");i.each(function(t){var i=t.retrieve("module");if(i){if(i.json.cellType=="sequence"){t.set("text",e)}}}.bind(this))}},_loadBorderStyle:function(){if(this.json.border){this.table.setStyles({"border-top":this.json.border,"border-left":this.json.border});var t=this.table.getElements("th");t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border});var e=this.table.getElements("td");e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})}},_loadDatagridTitleModules:function(){var t=this.node.getElements("th");t.each(function(t){var e=this.form._getDomjson(t);t.store("dataGrid",this);if(e){var i=this.form._loadModule(e,t);this.form.modules.push(i)}}.bind(this))},_loadDatagridDataModules:function(){var t=this.node.getElements("td");t.each(function(t){var e=this.form._getDomjson(t);t.store("dataGrid",this);if(e){var i=this.form._loadModule(e,t,function(){this.field=false});t.store("module",i);this.form.modules.push(i)}}.bind(this))},_afterLoaded:function(){this._loadDatagridStyle()},resetData:function(){this.setData()},setData:function(t){this._setBusinessData(t);if(t){this.gridData=t}else{this.gridData=this._getValue()}if(this.isEdit)this._completeLineEdit();if(this.gridData){var e=this.table.getElements("tr");for(var i=1;i<e.length-1;i++){var s=e[i];var r=s.getElements("td");for(var a=0;a<r.length;a++){var n=r[a];var o=n.retrieve("module");if(o){this.form.modules.erase(o);delete o}}}while(this.table.rows.length>2){this.table.rows[1].destroy()}if(this.editable!=false){this._loadEditDatagrid()}else{this._loadReadDatagrid()}this._loadDatagridStyle()}},getData:function(){if(this.editable!=false){var t=[];var e=this.table.getElements("tr");for(var i=1;i<e.length-1;i++){var s=e[i];var r=s.retrieve("data");if(r)t.push(r)}this.gridData=null;this.gridData=t;this._setBusinessData(t);return this.gridData.length?this.gridData:null}else{return this._getBusinessData()}},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");var i=new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url("+"/x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e);var s=new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red"},text:t}).inject(e);return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=true;this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom"));this.node.setStyle("border","1px solid red");this.errNode=this.createErrorNode(t).inject(this.node,"after");this.showNotValidationMode(this.node)}},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if(e.get("MWFtype")=="tab$Content"){if(e.getParent("div").getStyle("display")=="none"){var i=e.getParent("div").getParent("div");var s=i.getPrevious("div");var r=i.getChildren().indexOf(e.getParent("div"));var a=s.getChildren()[r];a.click();e=s.getParent("div")}}this.showNotValidationMode(e)}},validationMode:function(){if(this.isNotValidationMode){this.isNotValidationMode=false;this.node.setStyles(this.node.retrieve("borderStyle"));if(this.errNode){this.errNode.destroy();this.errNode=null}}},validationConfigItem:function(t,e){var i=e.status=="all"?true:t==e.decision;if(i){var s=this.getData();var r=e.valueType=="value"?s:s.length;switch(e.operateor){case"isnull":if(!r){this.notValidationMode(e.prompt);return false}break;case"notnull":if(r){this.notValidationMode(e.prompt);return false}break;case"gt":if(r>e.value){this.notValidationMode(e.prompt);return false}break;case"lt":if(r<e.value){this.notValidationMode(e.prompt);return false}break;case"equal":if(r==e.value){this.notValidationMode(e.prompt);return false}break;case"neq":if(r!=e.value){this.notValidationMode(e.prompt);return false}break;case"contain":if(r.indexOf(e.value)!=-1){this.notValidationMode(e.prompt);return false}break;case"notcontain":if(r.indexOf(e.value)==-1){this.notValidationMode(e.prompt);return false}break}}return true},validationConfig:function(t,e){debugger;if(this.json.validationConfig){if(this.json.validationConfig.length){for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return false}}return true}return true},validation:function(t,e){if(this.isEdit){if(!this.editValidation()){return false}}if(!this.validationConfig(t,e))return false;if(!this.json.validation)return true;if(!this.json.validation.code)return true;var i=this.form.Macro.exec(this.json.validation.code,this);if(!i)i=MWF.xApplication.process.Xform.LP.notValidation;if(i.toString()!="true"){this.notValidationMode(i);return false}return true}});MWF.xApplication.process.Xform.DatagridPC$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");if(this.json.total=="number"||this.json.total=="count"){this.dataGrid.totalModules.push({module:this,index:this.dataGrid.editable!=false?this.node.cellIndex+1:this.node.cellIndex,type:this.json.total})}}});MWF.xApplication.process.Xform.DatagridPC$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if(this.json.cellType=="sequence"){var e=true;for(var i=0;i<this.dataGrid.editModules.length;i++){if(this.dataGrid.editModules[i].json.id==this.json.id){e=false;break}}if(e){this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}})}}else{var s=this.form._getModuleNodes(this.node);s.each(function(t){var e=this.form._getDomjson(t);var i=this.form._loadModule(e,t,function(){this.field=false});i.dataModule=this;this.dataGrid.editModules.push(i)}.bind(this))}}});