MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.xAction.org.express.RestActions",null,false);MWF.xDesktop.requireApp("Organization","Selector.package",null,false);MWF.require("MWF.widget.Identity",null,false);MWF.xApplication.process=MWF.xApplication.process||{};MWF.xApplication.process.Xform=MWF.xApplication.process.Xform||{};MWF.xDesktop.requireApp("process.Xform","Package",null,false);MWF.xApplication.process.Xform.Form=MWF.APPForm=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",readonly:false,cssPath:"",moduleEvents:["postLoad","afterLoad","beforeSave","afterSave","beforeClose","beforeProcess","afterProcess"]},initialize:function(t,e,i){this.setOptions(i);this.container=$(t);this.container.setStyle("-webkit-user-select","text");this.data=e;this.json=e.json;this.html=e.html;this.path="/x_component_process_Xform/$Form/";this.cssPath=this.options.cssPath||"/x_component_process_Xform/$Form/"+this.options.style+"/css.wcss";this._loadCss();this.modules=[];this.all={};this.forms={};if(!this.personActions)this.personActions=new MWF.xAction.org.express.RestActions},load:function(){if(this.app){if(this.app.formNode)this.app.formNode.setStyles(this.json.styles)}if(!this.businessData.control.allowSave)this.setOptions({readonly:true});if(this.fireEvent("queryLoad")){this.fireEvent("beforeLoad");MWF.xDesktop.requireApp("process.Xform","lp."+MWF.language,null,false);this._loadBusinessData();this.Macro=new MWF.Macro.FormContext(this);this._loadHtml();this._loadForm();this._loadModules(this.node);this.fireEvent("postLoad");this.fireEvent("afterLoad")}},_loadBusinessData:function(){if(!this.businessData){this.businessData={data:{select:"222",radio:"bbb",checkbox:["check1","check3"],orderData:[{orderName:{namefield:"电脑"},orderCount:{countField:"3"},priceCount:{priceField:"9000"}},{orderName:{namefield:"路由器"},orderCount:{countField:"2"},priceCount:{priceField:"1000"}},{orderName:{namefield:"网线"},orderCount:{countField:"10"},priceCount:{priceField:"200"}}]}}}},_loadHtml:function(){this.container.set("html",this.html);this.node=this.container.getFirst();this.node.addEvent("selectstart",function(t){var e="text";if(t.target.getStyle("-webkit-user-select")){e=t.target.getStyle("-webkit-user-select").toString().toLowerCase()}if(e!="text"&&e!="auto")t.preventDefault()})},_loadForm:function(){this._loadStyles();this._loadCssLinks();this._loadScriptSrc();this._loadJsheader();this._loadEvents()},_loadStyles:function(){this.node.setStyles(this.json.styles)},_loadCssLinks:function(){var t=this.json.cssLinks;t.each(function(t){new Element("link",{rel:"stylesheet",type:"text/css",href:t}).inject($(document.head))})},_loadScriptSrc:function(){var t=this.json.scriptSrc;t.each(function(t){new Element("script",{src:t}).inject($(document.head))})},_loadJsheader:function(){var t=this.json.jsheader.code;if(t)Browser.exec(t)},_loadEvents:function(){debugger;Object.each(this.json.events,function(t,e){if(t.code){if(this.options.moduleEvents.indexOf(e)!=-1){this.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this))}else{if(e=="load"){this.addEvent("postLoad",function(){return this.Macro.fire(t.code,this)}.bind(this))}else if(e=="submit"){this.addEvent("beforeProcess",function(){return this.Macro.fire(t.code,this)}.bind(this))}else{this.node.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this))}}}}.bind(this))},_getDomjson:function(t){var e=t.get("MWFtype");switch(e){case"form":return this.json;case"":return null;default:var i=t.get("id");if(!i)i=t.get("MWFId");if(i){return this.json.moduleList[i]}else{return null}}},_getModuleNodes:function(t){var e=[];var i=t.getFirst();while(i){if(i.get("MWFtype")){var o=i.get("MWFtype");if(o.indexOf("$")==-1){e.push(i)}if(i.get("MWFtype")!="datagrid"){e=e.concat(this._getModuleNodes(i))}}else{e=e.concat(this._getModuleNodes(i))}i=i.getNext()}return e},_loadModules:function(t){var e=this._getModuleNodes(t);e.each(function(t){var e=this._getDomjson(t);var i=this._loadModule(e,t);this.modules.push(i)}.bind(this))},_loadModule:function(t,e,i){var o=new MWF["APP"+t.type](e,t,this);if(i)i.apply(o);if(!this.all[t.id])this.all[t.id]=o;if(o.field){if(!this.forms[t.id])this.forms[t.id]=o}o.readonly=this.options.readonly;o.load();return o},getData:function(){var t=Object.clone(this.businessData.data);Object.each(this.forms,function(e,i){if(e.json.section=="yes"){t[i]=this.getSectionData(e,t[i])}else{t[i]=e.getData()}}.bind(this));this.businessData.data=t;this.Macro.environment.setData(this.businessData.data);return t},getSectionData:function(t,e){var i=t.getData();switch(t.json.sectionBy){case"person":return this.getSectionDataByPerson(i,e);break;case"department":return this.getSectionDataByDepartment(i,e);break;case"activity":return this.getSectionDataByPActivity(i,e);break;case"script":return this.getSectionDataByScript(t.json.sectionByScript.code,i,e);break;default:return i}},getSectionDataByPerson:function(t,e){var i=layout.desktop.session.user.id;if(!e||typeOf(e)!="object")e={};e[i]=t;return e},getSectionDataByDepartment:function(t,e){var i=this.businessData.task?this.businessData.task.department:"";if(!e||typeOf(e)!="object")e={};if(i)e[i]=t;return e},getSectionDataByPActivity:function(t,e){var i=this.businessData.work?this.businessData.work.activity:"";if(!e||typeOf(e)!="object")e={};if(i)e[i]=t;return e},getSectionDataByScript:function(t,e,i){var o=this.form.Macro.exec(t,this);if(!i||typeOf(i)!="object")i={};if(o)i[o]=e;return i},saveWork:function(t){if(this.businessData.control["allowSave"]){this.fireEvent("beforeSave");this.workAction.saveData(function(e){this.notice(MWF.xApplication.process.Xform.LP.dataSaved,"success");if(t)t();this.fireEvent("afterSave")}.bind(this),null,this.businessData.work.id,this.getData())}else{MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied")}},closeWork:function(){this.fireEvent("beforeClose");if(this.app){this.app.close()}},addMessage:function(t){var e="";if(t.length){t.each(function(t){var i=[];t.taskList.each(function(t){i.push(t.person+"("+t.department+")")}.bind(this));e+="<div><b>"+MWF.xApplication.process.Xform.LP.nextActivity+'<font style="color: #ea621f">'+t.fromActivityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+i.join(", ")+"</font></b></div>"}.bind(this))}else{e+=MWF.xApplication.process.Xform.LP.workCompleted}var i={subject:MWF.xApplication.process.Xform.LP.taskProcessed,content:"<div>"+MWF.xApplication.process.Xform.LP.taskProcessedMessage+"“"+this.businessData.work.title+"”</div>"+e};layout.desktop.message.addTooltip(i);return layout.desktop.message.addMessage(i)},formValidation:function(t,e){if(this.options.readonly)return true;this.Macro.environment.form.currentRouteName=t;this.Macro.environment.form.opinion=e;var i=true;Object.each(this.forms,function(o,s){o.validationMode();if(!o.validation(t,e))i=false}.bind(this));return i},validation:function(t,e,i){this.Macro.environment.form.currentRouteName=t;this.Macro.environment.form.opinion=e;var o=this.validationRoute(i);var s=this.validationOpinion(i);return o&&s},validationRoute:function(t){if(!this.json.validationRoute)return true;if(!this.json.validationRoute.code)return true;var e=this.Macro.exec(this.json.validationRoute.code,this);if(!e)e=MWF.xApplication.process.Xform.LP.notValidation;if(e.toString()!="true"){this.notValidationRouteMode(e,t);return false}return true},validationOpinion:function(t){if(!this.json.validationOpinion)return true;if(!this.json.validationOpinion.code)return true;var e=this.Macro.exec(this.json.validationOpinion.code,this);if(!e)e=MWF.xApplication.process.Xform.LP.notValidation;if(e.toString()!="true"){this.notValidationOpinionMode(e,t);return false}return true},notValidationRouteMode:function(t,e){e.routeSelectorArea.setStyle("background-color","#ffe9e9");new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:false,target:e.routeSelectorArea,delayClose:6e3,content:t})},notValidationOpinionMode:function(t,e){e.inputTextarea.setStyle("background-color","#ffe9e9");new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:false,target:e.inputTextarea,delayClose:6e3,content:t})},submitWork:function(t,e,i,o){if(!this.businessData.control["allowProcessing"]){MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied");this.app.content.unmask();o.node.unmask();return false}if(!this.formValidation(t,e)){this.app.content.unmask();if(i)i();return false}if(!this.validation(t,e,o)){o.node.unmask();return false}if(!e)e=t;this.fireEvent("beforeProcess");MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});this.mask.loadNode(this.app.content);this.fireEvent("beforeSave");this.workAction.saveData(function(o){this.businessData.task.routeName=t;this.businessData.task.opinion=e;this.fireEvent("afterSave");this.workAction.processTask(function(t){if(i)i();this.fireEvent("afterProcess");this.addMessage(t.data);if(this.app.taskObject)this.app.taskObject.destroy();this.app.close()}.bind(this),null,this.businessData.task.id,this.businessData.task)}.bind(this),null,this.businessData.work.id,this.getData())}.bind(this))},processWork:function(){if(this.app.inBrowser){this.app.content.setStyle("height",document.body.getSize().y)}this.app.content.mask({destroyOnHide:true,style:this.app.css.maskNode});if(!this.formValidation("","")){this.app.content.unmask();return false}var t=this.createProcessNode();this.setProcessNode(t);this.showProcessNode(t)},createProcessNode:function(){var t=new Element("div",{styles:this.app.css.processNode_from}).inject(this.app.content);t.position({relativeTo:this.app.content,position:"topcenter",edge:"topcenter"});return t},setProcessNode:function(t){var e=this;MWF.xDesktop.requireApp("process.Work","Processor",function(){new MWF.xApplication.process.Work.Processor(t,this.businessData.task,{onCancel:function(){t.destroy();e.app.content.unmask();delete this},onSubmit:function(i,o){e.submitWork(i,o,function(){this.destroy();t.destroy();delete this}.bind(this),this)}})}.bind(this))},showProcessNode:function(t){var e=this.app.content.getSize();var i=t.getSize();var o=e.y/2-i.y/2-20;var s=e.x/2-i.x/2;if(o<0)o=0;this.app.css.processNode.top=""+o+"px";this.app.css.processNode.left=""+s+"px";var n=new Fx.Morph(t,{duration:300,transition:Fx.Transitions.Expo.easeOut});n.start(this.app.css.processNode)},confirm:function(t,e,i,o,s,n,a,r,c){MWF.require("MWF.xDesktop.Dialog",function(){var c=this.container.getSize();var l=parseFloat(Browser.name=="firefox"?e.event.clientX:e.event.x);var d=parseFloat(Browser.name=="firefox"?e.event.clientY:e.event.y);if(l+parseFloat(s)>c.x){l=l-parseFloat(s)}var p=new MWF.xDesktop.Dialog({title:i,style:"flat",top:d,left:l-20,fromTop:e.event.y,fromLeft:Browser.name=="firefox"?e.event.clientX-20:e.event.x-20,width:s,height:n,text:o,container:this.content,buttonList:[{text:MWF.LP.process.button.ok,action:a},{text:MWF.LP.process.button.cancel,action:r}]});switch(t.toLowerCase()){case"success":p.content.setStyle("background-image","url(data:image/png;base64,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)");break;case"error":p.content.setStyle("background-image","url(data:image/png;base64,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)");break;case"info":p.content.setStyle("background-image","url(data:image/png;base64,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)");break;case"warn":p.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABgtJREFUeNqsWG2IlFUUft6vmdlZd539GFdTY5VMomy1oBJUSPLXkmQt5I8gCIMK+iH0K4ooEvtTRP7JX9JKWCC1mUUkIkQKSoaZH60t2pboOK37Mc6Ozsw779t57t5xx5ndnTvhC4d373nnnnPuOeee85y1Jr+G6dNcCrBB6AnbQo9tY4UFLLYstIYhMsK/IjRULOF0voATx87jp60fICPygzmFbpn+26pnzK0ilrk2+kTp5kgC6+w4YDfJxpiQJ+QAYUmoKHQLCG4K5YDsCI7fzOPgcBr7172BP0VUILrC/22MnHSbvF6KLcRap1WMmGfsRQRZ2Z8BJv7BybEs9t6/DbuFXaj2VKUx7ize6BZvbHcdvB67D5bdrD/ocwUiruiLZPFGSbziiHci4iVPpEn41MM9pPZWPBofwiOX9uDh05fwkSgf5Dln8lKNZwo+HnRsvBVbjK1eJ39RdWIxJCfhGB0HxjNTBtGQhHiuPQHEY9MG3X5EbXEESA3i4KmL2Ln5Xfwi3CINmjVM9IjnYGeTGOJ2zOx+SU5cE8Hp/DMIopvgxFejlDsFO38IC6ID6JIDRCMz7/WvA1cG8d2PJ/H2y5/gLA2a9ndVmBia2CIxpL3yJ1XG5MUzTh8S3e/B9Zo09x74xSeRS7vyfT+i3sx7KXfRCvSuz2NUltuFJmhj+btdmazMEa+NsZidfIYlsQXzE51oa2tDV1eXenNNPr/PtZ/ylybxwtEP8Ypw4pU22OXrq27NvZIh4dzCeI07lvQiHo8jFovBdV315pp8fp9rP+VTT/cCPL/jRawSTqScma4OT1+sA2vtqN4w552V03meMsKyprLblowlj2s/qC+DepJLsWpjD56T5aDOnRI908yC5jTVOVEl1THWhKhPwrVx/UNYqL0DmyU+0iyVNWooKKxjTGgmh/o6k+h5tRcbhBNTDla9JtKAV+6SZ5RBondZF9YwOkKOq5qeZ6CkUpmJMQYP9Xa0YqX8ySRxXdV9bXMBloShnLg134RvhQ3IEr2tTViqc8ZxNQwwFuCJANsqiOJ4jSHke40cTPQ2RdFZNsYmHrEaiHVEmqI/drTGO+paC5/fTWVRghTaZl1ibJvAqG6hqqygIsG+/iXCID8VFk1ck+9Z5rKoV8BYThc9yyVCE2A0nyDJKOmEoiP98GV7mNwKO7EOwfjPwL9fKL7q2CUzWTRGANiILgghjRkKfTwAyxw4cWt4pR+F4X72NAn2FIxQzg4aECMtcmISl3WzDFxi1sDH046hZ4JQ45kbgmeyFXhGUGB7i8YzhgcTvbg2jiHCKPrTJXgmE56ZgKIoH5XGn/YEz3QLnpm/GrcmTiE9dkiOOaBuU9QzN+bsMM7dNoYo/qk1OC597vEahDbDU5BtuVbBMysr8ExS45lBV74LnjHwMhFjahRndn2rUN9NhsrmOEEUX/LNbgB/F13yLBJtyTvwDNfkNyLnj8s4dv5vBbQmVdcmWuc4IYl0MjC44jz0guWb0NLSojAMoQTfXJPvGNQs6hGvnNt7GIeFkyGk4hcVGM41HCcEZIV1ix53jJ+QieDOWKi18CN2fWOo58QF/PD5ETVPZXTO3IZ8Aeea9Dj2FOt4R7WDq1L0SlVFT9bke3WMofzf/8I3fTvwlXAYomy5IChj9AxT4FyTmsBBPyyXoVpSRe9qP8LfXkNw7ZAaIfnmmnwbs++l3AspHPl4APuEw2I3pr0S1owqMsO4B97BYz3L8eaiFvR6uHsPceWFNI7s/h6f7TqgblBq1umgPCRwwOJcc3EEe3NsOXN4yYRUkRQ5vw5j4P19+FQbkha6Ud04aiZK8Y6lS2ALxwmi+GQcqxyGKDT3RCBSSkKpLM4xWXWOjGi6UXeirDKI1yXOcYIonuC5s1lQoTbKKlPZCdYUBZpSGZxhHeH11bdmVOdIrnLWNv4vhPzQ1sBnHlE8wTMxK6EiERqBEfEIYQC7L5seew1LPCurLmgZTdl6/4UwaWmWzq2IRvHNGrNGNLmYdpCvb0dBl/hJXdAKJrOF1eClsHX4XP12NM+qGFJKmnz9NgYV/wkwAMYATK0QLuhAAAAAAElFTkSuQmCC)");break;default:}p.show()}.bind(this))},notice:function(t,e,i,o){if(!o)o={x:"right",y:"top"};if(!i)i=this.node;if(!e)e="ok";var s=i||layout.layout.contentNode;new mBox.Notice({type:e,position:o,move:false,target:s,delayClose:e=="error"?5e3:1e3,offset:{x:10,y:o.y.toString().toLowerCase()=="bottom"?10:10},content:t})},resetWork:function(){if(!this.businessData.control["allowReset"]){MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied");return false}MWF.require("MWF.xDesktop.Dialog",function(){var t=680;var e=300;var i=MWF.getCenterPosition(this.app.content,t,e);var o=this;var s=new MWF.xDesktop.Dialog({title:this.app.lp.reset,style:"work",top:i.y-100,left:i.x,fromTop:i.y-100,fromLeft:i.x,width:t,height:e,url:this.app.path+"reset.html",container:this.app.content,isClose:true,onPostShow:function(){$("resetWork_okButton").addEvent("click",function(){o.doResetWork(this)}.bind(this));$("resetWork_cancelButton").addEvent("click",function(){this.close()}.bind(this));$("resetWork_selPeopleButton").addEvent("click",function(){o.selectPeople(this)}.bind(this))}});s.show()}.bind(this))},selectPeople:function(t){var e=this.businessData.activity.resetRange||"department";var i=this.businessData.activity.resetCount||0;switch(e){case"department":this.personActions.getDepartmentByIdentity(function(e){this.selectPeopleDepartment(t,e.data,i)}.bind(this),null,this.businessData.task.identity);break;case"company":this.personActions.getCompanyByIdentity(function(e){this.selectPeopleCompany(t,e.data,i)}.bind(this),null,this.businessData.task.identity);break;default:this.selectPeopleAll(t,i)}},selectPeopleDepartment:function(t,e,i){var o=t.identityList||[];var s=$("resetWork_selPeopleArea");var n={names:o,type:"identity",count:i,departments:e?[e.name]:[],title:this.app.lp.reset,onComplete:function(e){s.empty();var i=[];e.each(function(t){var e={actions:this.personActions,app:{lp:this.app.lp}};debugger;new MWF.widget.Identity(t.data,s,e,false,null,{style:"reset"});i.push(t.data.name)}.bind(this));t.identityList=i}.bind(this)};var a=new MWF.OrgSelector(this.app.content,n)},selectPeopleCompany:function(t,e,i){var o=t.identityList||[];var s=$("resetWork_selPeopleArea");var n={names:o,type:"identity",count:i,companys:[e.name],title:this.app.lp.reset,onComplete:function(e){s.empty();var i=[];e.each(function(t){var e={actions:this.personActions,app:{lp:this.app.lp}};debugger;new MWF.widget.Identity(t.data,s,e,false,null,{style:"reset"});i.push(t.data.name)}.bind(this));t.identityList=i}.bind(this)};var a=new MWF.Selector(this.app.content,n)},selectPeopleAll:function(t,e){var i=t.identityList||[];var o=$("resetWork_selPeopleArea");var s={names:i,type:"identity",count:e,title:this.app.lp.reset,onComplete:function(e){o.empty();var i=[];e.each(function(t){var e={actions:this.personActions,app:{lp:this.app.lp}};debugger;new MWF.widget.Identity(t.data,o,e,false,null,{style:"reset"});i.push(t.data.name)}.bind(this));t.identityList=i}.bind(this)};var n=new MWF.Selector(this.app.content,s)},doResetWork:function(t){var e=t.identityList||[];if(!e.length){this.app.notice(MWF.xApplication.process.Xform.LP.inputResetPeople,"error",t.node);return false}var i=$("resetWork_opinion").get("value");if(!i){i=MWF.xApplication.process.Xform.LP.resetTo+": "+e.join(", ")}MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});this.mask.loadNode(this.app.content);this.fireEvent("beforeReset");this.resetWorkToPeson(e,i,function(){this.workAction.getJobByWork(function(t){this.addResetMessage(t.data);this.app.notice(MWF.xApplication.process.Xform.LP.resetOk+": "+e.join(", "),"success");this.app.close()}.bind(this),null,this.businessData.work.id);t.close();if(this.mask){this.mask.hide();this.mask=null}}.bind(this),function(e,i,o){var s=o+":"+i;if(e)s=e.responseText;this.app.notice("request json error: "+s,"error",t.node);if(this.mask){this.mask.hide();this.mask=null}}.bind(this))}.bind(this))},resetWorkToPeson:function(t,e,i,o){var s={opinion:e,routeName:MWF.xApplication.process.Xform.LP.reset,identityList:t};this.workAction.saveData(function(t){this.workAction.resetWork(function(t){if(i)i()}.bind(this),function(t,e,i){if(o)o(t,e,i)},this.businessData.task.id,s)}.bind(this),function(t,e,i){if(o)o(t,e,i)},this.businessData.work.id,this.getData())},addResetMessage:function(t){var e=[];t.taskList.each(function(t){e.push(t.person+"("+t.department+")")}.bind(this));var i="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t.work.activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";var o={subject:MWF.xApplication.process.Xform.LP.workReset,content:"<div>"+MWF.xApplication.process.Xform.LP.resetWorkInfor+"“"+this.businessData.work.title+"”</div>"+i};layout.desktop.message.addTooltip(o);return layout.desktop.message.addMessage(o)},retractWork:function(t,e){var i=this;var o=MWF.getCenterPosition(this.app.content,300,150);var s={event:{x:o.x,y:o.y-200,clientX:o.x,clientY:o.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.retractTitle,MWF.xApplication.process.Xform.LP.retractText,300,120,function(){i.app.content.mask({style:{"background-color":"#999",opacity:.6}});MWF.require("MWF.widget.Mask",function(){i.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});i.mask.loadNode(i.app.content);i.fireEvent("beforeRetract");i.doRetractWork(function(){i.workAction.getJobByWork(function(t){i.app.notice(MWF.xApplication.process.Xform.LP.workRetract,"success");f;i.app.content.unmask();i.app.reload(t.data)},i.businessData.work.id);this.close();if(i.mask){i.mask.hide();i.mask=null}}.bind(this))}.bind(this),function(t,e,o){var s=o+":"+e;if(t)s=t.responseText;i.app.notice("request json error: "+s,"error",dlg.node);if(i.mask){i.mask.hide();i.mask=null}})},function(){this.close()})},doRetractWork:function(t,e){if(this.businessData.control["allowRetract"]){this.workAction.retractWork(function(e){if(t)t()}.bind(this),function(t,i,o){if(e)e(t,i,o)},this.businessData.work.id)}else{if(e)e(null,"Permission Denied","")}},addRetractMessage:function(t){var e=[];t.taskList.each(function(t){e.push(t.person+"("+t.department+")")}.bind(this));var i="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t.work.activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";var o={subject:MWF.xApplication.process.Xform.LP.workRetract,content:"<div>"+MWF.xApplication.process.Xform.LP.retractWorkInfor+"“"+this.businessData.work.title+"”</div>"+i};layout.desktop.message.addTooltip(o);return layout.desktop.message.addMessage(o)},rerouteWork:function(t,e){if(!this.businessData.control["allowReroute"]){MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied");return false}MWF.require("MWF.xDesktop.Dialog",function(){var t=480;var e=160;var i=MWF.getCenterPosition(this.app.content,t,e);var o=this;var s=new MWF.xDesktop.Dialog({title:this.app.lp.reroute,style:"work",top:i.y-100,left:i.x,fromTop:i.y-100,fromLeft:i.x,width:t,height:e,url:this.app.path+"reroute.html",container:this.app.content,isClose:true,onPostShow:function(){$("rerouteWork_okButton").addEvent("click",function(){o.doRerouteWork(this)}.bind(this));$("rerouteWork_cancelButton").addEvent("click",function(){this.close()}.bind(this));var t=$("rerouteWork_selectActivity");o.workAction.getRerouteTo(o.businessData.work.process,function(e){e.data.agentList.each(function(e){new Element("option",{value:e.id+"#agent",text:e.name}).inject(t)}.bind(o));e.data.cancelList.each(function(e){new Element("option",{value:e.id+"#cancel",text:e.name}).inject(t)}.bind(o));e.data.choiceList.each(function(e){new Element("option",{value:e.id+"#choice",text:e.name}).inject(t)}.bind(o));e.data.conditionList.each(function(e){new Element("option",{value:e.id+"#condition",text:e.name}).inject(t)}.bind(o));e.data.delayList.each(function(e){new Element("option",{value:e.id+"#delay",text:e.name}).inject(t)}.bind(o));e.data.embedList.each(function(e){new Element("option",{value:e.id+"#embed",text:e.name}).inject(t)}.bind(o));e.data.endList.each(function(e){new Element("option",{value:e.id+"#end",text:e.name}).inject(t)}.bind(o));e.data.invokeList.each(function(e){new Element("option",{value:e.id+"#invoke",text:e.name}).inject(t)}.bind(o));e.data.manualList.each(function(e){new Element("option",{value:e.id+"#manual",text:e.name}).inject(t)}.bind(o));e.data.mergeList.each(function(e){new Element("option",{value:e.id+"#merge",text:e.name}).inject(t)}.bind(o));e.data.messageList.each(function(e){new Element("option",{value:e.id+"#message",text:e.name}).inject(t)}.bind(o));e.data.parallelList.each(function(e){new Element("option",{value:e.id+"#parallel",text:e.name}).inject(t)}.bind(o));e.data.serviceList.each(function(e){new Element("option",{value:e.id+"#service",text:e.name}).inject(t)}.bind(o));e.data.splitList.each(function(e){new Element("option",{value:e.id+"#split",text:e.name}).inject(t)}.bind(o))}.bind(o))}});s.show()}.bind(this))},doRerouteWork:function(t){var e=$("rerouteWork_opinion").get("value");var i=$("rerouteWork_selectActivity");var o=i.options[i.selectedIndex].get("value");var s=i.options[i.selectedIndex].get("text");var n=o.split("#");o=n[0];var a=n[1];MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});this.mask.loadNode(this.app.content);this.fireEvent("beforeReroute");this.rerouteWorkToActivity(o,a,e,function(){this.workAction.getJobByWork(function(t){this.addRerouteMessage(t.data);this.app.notice(MWF.xApplication.process.Xform.LP.rerouteOk+": "+s,"success");this.app.close()}.bind(this),null,this.businessData.work.id);t.close();if(this.mask){this.mask.hide();this.mask=null}}.bind(this),function(e,i,o){var s=o+":"+i;if(e)s=e.responseText;this.app.notice("request json error: "+s,"error",t.node);if(this.mask){this.mask.hide();this.mask=null}}.bind(this))}.bind(this))},rerouteWorkToActivity:function(t,e,i,o,s){if(this.businessData.task){this.workAction.saveData(function(i){this.workAction.rerouteWork(function(t){if(o)o()}.bind(this),function(t,e,i){if(s)s(t,e,i)},this.businessData.work.id,t,e)}.bind(this),function(t,e,i){if(s)s(t,e,i)},this.businessData.work.id,this.getData())}else{this.workAction.rerouteWork(function(t){if(o)o()}.bind(this),function(t,e,i){if(s)s(t,e,i)},this.businessData.work.id,t,e)}},addRerouteMessage:function(t){var e=[];t.taskList.each(function(t){e.push(t.person+"("+t.department+")")}.bind(this));var i="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t.work.activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";
var o={subject:MWF.xApplication.process.Xform.LP.workReroute,content:"<div>"+MWF.xApplication.process.Xform.LP.rerouteWorkInfor+"“"+this.businessData.work.title+"”</div>"+i};layout.desktop.message.addTooltip(o);return layout.desktop.message.addMessage(o)},deleteWork:function(){var t=this;var e=MWF.getCenterPosition(this.app.content,380,150);var i={event:{x:e.x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",i,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText,380,120,function(){MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});t.mask.loadNode(t.app.content);t.fireEvent("beforeDelete");t.doDeleteWork(function(){t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success");t.app.close();this.close();if(t.mask){t.mask.hide();t.mask=null}}.bind(this),function(e,i,o){var s=o+":"+i;if(e)s=e.responseText;t.app.notice("request json error: "+s,"error",dlg.node);if(t.mask){t.mask.hide();t.mask=null}}.bind(this))}.bind(this))},function(){this.close()})},doDeleteWork:function(t,e){if(this.businessData.control["allowDelete"]){this.workAction.deleteWork(function(e){if(t)t()}.bind(this),function(t,i,o){if(e)e(t,i,o)},this.businessData.work.id)}else{if(e)e(null,"Permission Denied","")}},printWork:function(t,e){var i=t||this.businessData.work.application;var e=e;if(!e){e=this.json.id;if(this.json.printForm)e=this.json.printForm}window.open("/x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+this.businessData.work.application+"&form="+e)}});