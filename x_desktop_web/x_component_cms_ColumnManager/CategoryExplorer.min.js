MWF.xDesktop.requireApp("cms.ColumnManager","Explorer",null,false);MWF.xApplication.cms.ColumnManager.CategoryExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer,Implements:[Options,Events],initialize:function(t,e,i){this.setOptions(i);this.setTooltip();this.path="/x_component_cms_ColumnManager/$CategoryExplorer/";this.cssPath="/x_component_cms_ColumnManager/$CategoryExplorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=e;this.node=$(t);this.initData()},_createElement:function(t){this.category=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.Category(this,null);this.category.css=this.css;this.category.app=this.app;this.category.parent=this;this.category.createCategory()},_loadItemDataList:function(t){this.app.restActions.listCategory(this.app.options.application.id,t)},_getItemObject:function(t){var e=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.Category(this,t);e.css=this.css;e.app=this.app;e.parent=this;return e},deleteItems:function(){while(this.deleteMarkItems.length){var t=this.deleteMarkItems.shift();if(this.deleteMarkItems.length){t.deleteCategory()}else{t.deleteCategory(function(){this.hideDeleteAction();this.reload()}.bind(this))}}}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.Category=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer.Item,Implements:[Events],_open:function(t){var e=this;var i={onQueryLoad:function(){this.actions=e.explorer.actions;this.category=e;this.options.id=e.data.id;this.application=e.app.options.application}};this.isNew=false;this.isEdited=false},_getIcon:function(){var t=(Math.random()*33).toInt();return"process_icon_"+t+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"processIcon/lnk.png",title:this.data.name,par:'cms.CategoryDesigner#{"id": "'+this.data.id+'"}'}},deleteCategory:function(t){this.app.restActions.removeCategory(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this),function(t,e,i){var a=i;if(t)a=t.responseText;if(a.indexOf("referenced")>-1){var s=this.explorer.app.lp.category;var e=s.deleteFailAsHasDocument.replace(/{title}/g,this.data.name);this.app.notice(e,"error")}}.bind(this))},createCategory:function(){this.isNew=true;this._openCategory()},_open:function(){this.isEdited=true;this.app.restActions.getCategory(this.data.id,function(t){this.data=t.data;this._openCategory()}.bind(this))},_openCategory:function(){this.categoryCreateMarkNode=new Element("div",{styles:this.css.categoryCreateMarkNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.app.content,"after");this.categoryCreateAreaNode=new Element("div",{styles:this.css.categoryCreateAreaNode});this.createCategoryCreateNode();this.categoryCreateAreaNode.inject(this.categoryCreateMarkNode,"after");this.categoryCreateAreaNode.fade("in");$("createCategoryName").focus();this.setCategoryCreateNodeSize();this.setCategoryCreateNodeSizeFun=this.setCategoryCreateNodeSize.bind(this);this.addEvent("resize",this.setCategoryCreateNodeSizeFun)},createCategoryCreateNode:function(){this.categoryCreateNode=new Element("div",{styles:this.css.categoryCreateNode}).inject(this.categoryCreateAreaNode);this.categoryCreateIconNode=new Element("div",{styles:this.isNew?this.css.categoryCreateNewNode:this.css.categoryCreateIconNode}).inject(this.categoryCreateNode);this.categoryCreateFormNode=new Element("div",{styles:this.css.categoryCreateFormNode}).inject(this.categoryCreateNode);var t=this.data&&this.data.formName?this.data.formName:"";var e=this.data&&this.data.formId?this.data.formId:"";var i=this.data&&this.data.readFormName?this.data.readFormName:"";var a=this.data&&this.data.readFormId?this.data.readFormId:"";var s=this.data&&this.data.defaultViewName?this.data.defaultViewName:"";var r="width: 99%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC;height: 26px;";var o='<table width="100%" height="80%" border="0" cellPadding="0" cellSpacing="0">'+"<tr>"+'<td style="height: 30px; line-height: 30px; text-align: left; min-width: 80px; width:25%">'+this.app.lp.category.nameLabel+":</td>"+'<td style="; text-align: right;">'+(!this.isNew&&!this.isEdited?"":'<input type="text" id="createCategoryName" '+'style="'+r+'"'+' value="'+(this.data&&this.data.name?this.data.name:"")+'"/>')+"</td>"+"</tr>"+"<tr>"+'<td style="height: 30px; line-height: 30px; text-align: left">'+this.app.lp.category.aliasLabel+":</td>"+'<td style="; text-align: right;">'+(!this.isNew&&!this.isEdited?"":'<input type="text" id="createCategoryAlias" '+'style="'+r+'"'+' value="'+(this.data&&this.data.alias?this.data.alias:"")+'"/>')+"</td>"+"</tr>"+"<tr>"+'<td style="height: 30px; line-height: 30px;  text-align: left">'+this.app.lp.category.descriptionLabel+":</td>"+'<td style="; text-align: right;">'+(!this.isNew&&!this.isEdited?"":'<input type="text" id="createCategoryDescription" '+'style="'+r+'"'+' value="'+(this.data&&this.data.description?this.data.description:"")+'"/>')+"</td>"+"</tr>"+"<tr>"+'<td style="height: 30px; line-height: 30px;  text-align: left">'+this.app.lp.category.sortLabel+":</td>"+'<td style="; text-align: right;">'+(!this.isNew&&!this.isEdited?"":'<input type="text" id="createCategorySort" '+'style="'+r+'"'+' value="'+(this.data&&this.data.catagorySeq?this.data.catagorySeq:"")+'"/>')+"</td>"+"</tr>"+"<tr>"+'<td style="height: 30px; line-height: 30px;  text-align: left">'+this.app.lp.category.formLabelEdit+":</td>"+'<td style="; text-align: left;">'+(!this.isNew&&!this.isEdited?t:this.getFormString(t,e,"edit"))+"</td>"+"</tr>"+"<tr>"+'<td style="height: 30px; line-height: 30px;  text-align: left">'+this.app.lp.category.formLabelRead+":</td>"+'<td style="; text-align: left;">'+(!this.isNew&&!this.isEdited?i:this.getFormString(i,a,"read"))+"</td>"+"</tr>"+"<tr>"+'<td style="height: 30px; line-height: 30px;  text-align: left">'+this.app.lp.category.viewLabel+":</td>"+'<td style="; text-align: left;" class="viewArea">'+"</td>"+"</tr>"+"<tr>"+'<td style="height: 30px; line-height: 30px;  text-align: left">'+this.app.lp.category.defaultViewLabel+":</td>"+'<td style="; text-align: left;" class="defaultViewArea">'+"</td>"+"</tr>"+"</table>";this.categoryCreateFormNode.set("html",o);this.viewArea=this.categoryCreateFormNode.getElements(".viewArea")[0];this.defaultViewArea=this.categoryCreateFormNode.getElements(".defaultViewArea")[0];this.createCategoryForm=this.categoryCreateFormNode.getElements("#createCategoryForm_edit")[0];if(e!=""){this.setViewElement(this.data&&this.data.id?this.data.id:"",e,this.viewArea,!this.isNew&&!this.isEdited);this.setDefaultViewElement(s,this.data&&this.data.id?this.data.id:"",e,this.defaultViewArea)}this.createCategoryForm.addEvent("change",function(t){this.viewArea.set("html","");this.defaultViewArea.set("html","");var e=this.getFormSelectedOption();this.setViewElement(this.data&&this.data.id?this.data.id:"",e.value,this.viewArea,!this.isNew&&!this.isEdited);this.setDefaultViewElement(s,this.data&&this.data.id?this.data.id:"",e.value,this.defaultViewArea)}.bind(this));this.categoryCancelActionNode=new Element("div",{styles:this.css.categoryCreateCancelActionNode,text:this.app.lp.category.cancel}).inject(this.categoryCreateFormNode);this.categoryCreateOkActionNode=new Element("div",{styles:this.css.categoryCreateOkActionNode,text:this.app.lp.category.ok}).inject(this.categoryCreateFormNode);this.categoryCancelActionNode.addEvent("click",function(t){this.cancelCreateCategory(t)}.bind(this));this.categoryCreateOkActionNode.addEvent("click",function(t){this.okCreateCategory(t)}.bind(this))},setCategoryCreateNodeSize:function(){var t=this.app.node.getSize();var e=this.app.content.getSize();this.categoryCreateAreaNode.setStyles({width:""+t.x+"px",height:""+t.y+"px"});var i=t.y*.8;var a=t.y*.2/2;this.categoryCreateNode.setStyles({height:""+i+"px","margin-top":""+a+"px"});var s=this.categoryCreateIconNode.getSize();var r=i*.7;if(r>250)r=250;var o=i*.3/2-s.y;this.categoryCreateFormNode.setStyles({height:""+r+"px","margin-top":""+o+"px"})},cancelCreateCategory:function(t){var e=this;if(this.isNew&&($("createCategoryName").get("value")||$("createCategoryAlias").get("value")||$("createCategoryDescription").get("value"))){this.app.confirm("warn",t,this.app.lp.category.create_cancel_title,this.app.lp.category.create_cancel,"320px","100px",function(){e.categoryCreateMarkNode.destroy();e.categoryCreateAreaNode.destroy();this.close()},function(){this.close()})}else{this.categoryCreateMarkNode.destroy();this.categoryCreateAreaNode.destroy();delete e}},okCreateCategory:function(t){var e=this.getFormSelectedOption("edit");var i=this.getFormSelectedOption("read");var a=this.getDefaultViewSelectedOption();var s={isNew:this.isNew,id:this.data&&this.data.id?this.data.id:this.app.restActions.getUUID(),catagoryName:$("createCategoryName").get("value"),catagoryAlias:$("createCategoryAlias").get("value"),description:$("createCategoryDescription").get("value"),catagorySeq:$("createCategorySort").get("value"),formName:e.get("text"),formId:e.get("value"),readFormName:i.get("text"),readFormId:i.get("value"),defaultViewName:a.get("value"),appId:this.app.options.application.id};if(s.catagoryName){this.app.restActions.saveCategory(s,function(t){this.saveViewData(this.viewArea,t.data.id,s.formId);this.categoryCreateMarkNode.destroy();this.categoryCreateAreaNode.destroy();if(this.explorer.noElementNode)this.explorer.noElementNode.destroy();this.app.restActions.getCategory(t.data.id,function(t){t.data.processList=[];t.data.formList=[];if(!this.isNew)this.node.destroy();var e=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.Category(this.parent,t.data,{where:"top"});e.load();e.css=this.css;e.app=this.app;e.parent=this.parent;if(this.app.categorys)this.app.categorys.push(e)}.bind(this));this.app.notice(this.isNew?MWF.CMSCM.LP.category.createCategorySuccess:MWF.CMSCM.LP.category.updateCategorySuccess,"success")}.bind(this))}else{$("createCategoryName").setStyle("border-color","red");$("createCategoryName").focus();this.app.notice(MWF.CMSCM.LP.category.inputName,"error")}},setViewElement:function(t,e,i,a,s){if(!e||e=="")return;var r;this.app.restActions.listViewByForm(e,function(t){r=t.data;if(s)s()}.bind(this),null,false);this.selectedViews=[];this.selectedCategoryViews=[];if(t&&t!=""){this.app.restActions.listCategoryViewByCatagory(t,function(t){t.data.each(function(t){this.selectedViews.push(t.viewId);this.selectedCategoryViews.push(t.id)}.bind(this));if(s)s()}.bind(this),null,false)}var o=this;var n=new Element("span",{styles:o.css.categoryCheckBox}).inject(i);r.each(function(t){if(a){if(o.selectedViews.contains(t.id)){new Element("span",{text:t.name,styles:o.css.categoryCheckBox}).inject(i)}}else{var e=new Element("span",{styles:o.css.categoryCheckBox}).inject(i);var s=new Element("input",{type:"checkbox",value:t.id}).inject(e);if(o.selectedViews.contains(t.id))s.checked=true;new Element("span",{text:t.name}).inject(e)}})},setDefaultViewElement:function(t,e,i,a,s){if(!i||i=="")return;var r;this.app.restActions.listViewByForm(i,function(t){r=t.data;if(s)s()}.bind(this),null,false);var o=this;var n=new Element("select",{id:"defaultViewSelect"}).inject(a);var d=new Element("option",{text:MWF.CMSCM.LP.category.defaultView,value:"default"}).inject(n);if(t=="default"||this.isNew)d.selected=true;r.each(function(e){var i=new Element("option",{text:e.name,value:e.id}).inject(n);if(t==e.id)i.selected=true})},getDefaultViewSelectedOption:function(){var t;this.categoryCreateFormNode.getElement("#defaultViewSelect").getElements("option").each(function(e){if(e.selected)t=e});return t},getFormString:function(t,e,i){var a='<select id="createCategoryForm_'+i+'">';a+="<option value=''></option>";if(this.forms){this.forms.each(function(t){if(e==t.id){a+="<option value='"+t.id+"' selected>"+t.name+"</option>"}else{a+="<option value='"+t.id+"'>"+t.name+"</option>"}});a+="</select>"}else{this.app.restActions.listForm(this.app.options.application.id,function(t){this.forms=t.data;t.data.each(function(t){if(e==t.id){a+="<option value='"+t.id+"' selected>"+t.name+"</option>"}else{a+="<option value='"+t.id+"'>"+t.name+"</option>"}})}.bind(this),null,false);a+="</select>"}return a},getFormSelectedOption:function(t){var e;if(!t)t="edit";this.categoryCreateFormNode.getElement("#createCategoryForm_"+t).getElements("option").each(function(t){if(t.selected)e=t});return e},saveViewData:function(t,e,i){var a=[];t.getElements("input:checked").each(function(t){a.push(t.value)});if(this.isNew){for(var s=0;s<a.length;s++){var r={catagoryId:e,viewId:a[s]};this.app.restActions.addCategoryView(r)}}else if(this.data&&this.data.formId!=i){for(var s=0;s<this.selectedCategoryViews.length;s++){this.app.restActions.deleteCategoryView(this.selectedCategoryViews[s])}for(var s=0;s<a.length;s++){var r={catagoryId:e,viewId:a[s]};this.app.restActions.addCategoryView(r,function(t){}.bind(this),null,false)}}else{for(var s=0;s<this.selectedViews.length;s++){if(!a.contains(this.selectedViews[s])){this.app.restActions.deleteCategoryView(this.selectedCategoryViews[s])}}for(var s=0;s<a.length;s++){if(!this.selectedViews.contains(a[s])){var r={catagoryId:e,viewId:a[s]};this.app.restActions.addCategoryView(r,function(t){}.bind(this),null,false)}}}}});