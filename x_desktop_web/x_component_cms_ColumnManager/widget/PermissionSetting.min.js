MWF.xApplication.cms.ColumnManager=MWF.xApplication.cms.ColumnManager||{};MWF.xApplication.cms.ColumnManager.PermissionSetting=new Class({Implements:[Options],options:{objectId:"",objectType:"APPINFO",permission:"VIEW"},initialize:function(t,i,e,s){this.app=t;this.node=$(e);this.lp=i;this.setOptions(s);this.data=[];this.personList=[];this.departmentList=[];this.companyList=[]},load:function(){this.listData(function(t){t.data=t.data||[];this.data=t.data;t.data.each(function(t){if(t.usedObjectType=="USER"){this.personList.push(t.usedObjectName)}else if(t.usedObjectType=="DEPARTMENT"){this.departmentList.push(t.usedObjectName)}else{this.companyList.push(t.usedObjectName)}}.bind(this));this.createNode()}.bind(this))},createNode:function(){if(!this.personActions)this.personActions=new MWF.xAction.org.express.RestActions;this.titleNode=new Element("div",{styles:this.app.css.availableTitleNode,text:this.lp.title}).inject(this.node);this.contentNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.node);this.itemsContentNode=new Element("div",{styles:this.app.css.availableItemsContentNode}).inject(this.contentNode);this.actionAreaNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.node);var t=new Element("div",{styles:this.app.css.selectButtonStyle,text:this.lp.setPerson}).inject(this.actionAreaNode);t.addEvent("click",function(){this.changeIdentitys()}.bind(this));var i=new Element("div",{styles:this.app.css.selectButtonStyle,text:this.lp.setDepartment}).inject(this.actionAreaNode);i.addEvent("click",function(){this.changeDepartments()}.bind(this));var e=new Element("div",{styles:this.app.css.selectButtonStyle,text:this.lp.setCompany}).inject(this.actionAreaNode);e.addEvent("click",function(){this.changeCompanys()}.bind(this));this.setItems()},setItems:function(){var t={actions:this.personActions,app:{lp:this.app.lp}};if(this.personList){this.personList.each(function(i){if(i)new MWF.widget.Person({name:i},this.itemsContentNode,t,false,null,{style:"application"})}.bind(this))}if(this.departmentList){this.departmentList.each(function(i){if(i)new MWF.widget.Department({name:i},this.itemsContentNode,t,false,null,{style:"application"})}.bind(this))}if(this.companyList){this.companyList.each(function(i){if(i)new MWF.widget.Company({name:i},this.itemsContentNode,t,false,null,{style:"application"})}.bind(this))}},changeIdentitys:function(){var t={actions:this.personActions,app:{lp:this.app.lp}};var i={type:"person",title:this.lp.setPerson,names:this.personList||[],onComplete:function(t){var i=[];t.each(function(t){i.push(t.data.name)}.bind(this));i.each(function(t){if(!this.personList.contains(t)){var i={objectType:this.options.objectType,objectId:this.options.objectId,usedObjectType:"USER",usedObjectCode:t,usedObjectName:t,permission:this.options.permission};this.saveData(i,function(t){i.id=t.data.id;this.data.push(i)}.bind(this),null,false)}}.bind(this));this.personList.each(function(t){if(!i.contains(t)){var e=null;var s="";this.data.each(function(i){if(i.usedObjectName==t){e=i;s=i.id}}.bind(this));this.removeData(s,function(t){this.data.erase(e)}.bind(this))}}.bind(this));this.personList=i;this.itemsContentNode.empty();this.setItems();this.app.notice(this.lp.setIdentitySuccess,"success")}.bind(this)};var e=new MWF.OrgSelector(this.app.content,i)},changeDepartments:function(){var t={actions:this.personActions,app:{lp:this.app.lp}};var i={type:"department",title:this.lp.setDepartment,names:this.departmentList||[],onComplete:function(t){var i=[];t.each(function(t){i.push(t.data.name)}.bind(this));i.each(function(t){if(!this.departmentList.contains(t)){var i={objectType:this.options.objectType,objectId:this.options.objectId,usedObjectType:"DEPARTMENT",usedObjectCode:t,usedObjectName:t,permission:this.options.permission};this.saveData(i,function(t){i.id=t.data.id;this.data.push(i)}.bind(this))}}.bind(this));this.departmentList.each(function(t){if(!i.contains(t)){var e=null;var s="";this.data.each(function(i){if(i.usedObjectName==t){e=i;s=i.id}}.bind(this));this.removeData(s,function(t){this.data.erase(e)}.bind(this))}}.bind(this));this.departmentList=i;this.itemsContentNode.empty();this.setItems();this.app.notice(this.lp.setDepartmentSuccess,"success")}.bind(this)};var e=new MWF.OrgSelector(this.app.content,i)},changeCompanys:function(){var t={actions:this.personActions,app:{lp:this.app.lp}};var i={type:"company",title:this.lp.setCompany,names:this.companyList||[],onComplete:function(t){var i=[];t.each(function(t){i.push(t.data.name)}.bind(this));i.each(function(t){if(!this.companyList.contains(t)){var i={objectType:this.options.objectType,objectId:this.options.objectId,usedObjectType:"COMPANY",usedObjectCode:t,usedObjectName:t,permission:this.options.permission};this.saveData(i,function(t){i.id=t.data.id;this.data.push(i)}.bind(this))}}.bind(this));this.companyList.each(function(t){if(!i.contains(t)){var e=null;var s="";this.data.each(function(i){if(i.usedObjectName==t){e=i;s=i.id}}.bind(this));this.removeData(s,function(t){this.data.erase(e)}.bind(this))}}.bind(this));this.companyList=i;this.itemsContentNode.empty();this.setItems();this.app.notice(this.lp.setCompanySuccess,"success")}.bind(this)};var e=new MWF.OrgSelector(this.app.content,i)},listData:function(t){this.app.restActions.listColumnPermission(this.options.objectId,function(i){if(t)t(i)}.bind(this),null,false)},removeData:function(t,i){this.app.restActions.removePermission(t,function(t){if(i)i(t)}.bind(this),null,false)},saveData:function(t,i){debugger;this.app.restActions.savePermission(t,function(t){if(i)i(t)}.bind(this),null,false)}});