MWF.xDesktop.requireApp("cms.ColumnManager","Explorer",null,false);MWF.xDesktop.requireApp("cms.ColumnManager","FormExplorer",null,false);MWF.xDesktop.requireApp("cms.ColumnManager","ViewExplorer",null,false);MWF.xApplication.cms.ColumnManager.CategoryExplorerV2=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer,Implements:[Options,Events],initialize:function(t,e,i){this.setOptions(i);this.setTooltip();this.path="/x_component_cms_ColumnManager/$CategoryExplorer/";this.cssPath="/x_component_cms_ColumnManager/$CategoryExplorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=e;this.node=$(t);this.initData()},load:function(){this.loadToolbar();this.loadContentNode()},loadContentNode:function(){this.elementContentNode=new Element("div.elementContentNode",{styles:this.css.elementContentNode}).inject(this.node);this.elementContentListNode=new Element("div.elementContentListNode",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);this.loadNodes();this.setContentSize();this.app.addEvent("resize",function(){this.setContentSize()}.bind(this));this.loadCategoryList();this.loadForm();this.loadView()},loadNodes:function(){this.naviContainerNode=new Element("div.naviContainerNode",{styles:this.css.naviContainerNode}).inject(this.elementContentListNode);this.naviArea=new Element("div.naviArea",{styles:this.css.naviArea}).inject(this.naviContainerNode);this.naviNode=new Element("div.naviNode",{styles:this.css.naviNode}).inject(this.naviArea);this.categoryListResizeNode=new Element("div.categoryListResizeNode",{styles:this.css.categoryListResizeNode}).inject(this.elementContentListNode);this.rightContent=new Element("div.rightContent",{styles:this.css.rightContent}).inject(this.elementContentListNode);this.loadCategoryListResize();this.createFormNode();this.rightContentResizeNode=new Element("div.rightContentResizeNode",{styles:this.css.rightContentResizeNode}).inject(this.rightContent);this.createViewNode();this.formPercent=.5;this.loadRightContentResize();this.setNodeScroll()},setNodeScroll:function(){MWF.require("MWF.widget.DragScroll",function(){new MWF.widget.DragScroll(this.naviArea)}.bind(this));MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.naviArea,{indent:false})}.bind(this))},loadCategoryList:function(t){this.categoryList=new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.CategoryList(this,this.naviNode,{columnId:this.app.options.column.id})},_createElement:function(){this.categoryList.newCategory()},createFormNode:function(){this.formTitleNode=new Element("div.formTitleNode",{styles:this.css.formTitleNode}).inject(this.rightContent);this.formCreateNode=new Element("div.formCreateNode",{styles:this.css.formCreateNode}).inject(this.formTitleNode);this.formCreateNode.addEvent("click",function(t){this.formExplorer._createElement(t)}.bind(this));this.formTitleSepNode=new Element("div.formTitleSepNode",{styles:this.css.formTitleSepNode}).inject(this.formTitleNode);this.formTitleTextNode=new Element("div.formTitleTextNode",{styles:this.css.formTitleTextNode,text:"选择表单"}).inject(this.formTitleNode);this.formNode=new Element("div.formNode",{styles:this.css.formNode}).inject(this.rightContent)},loadForm:function(){this.formExplorer=new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.FormExplorer(this.formNode,this.app.restActions,{style:"full"});this.formExplorer.app=this.app;this.formExplorer.explorer=this;this.formExplorer.load()},createViewNode:function(){this.viewTitleNode=new Element("div.viewTitleNode",{styles:this.css.viewTitleNode}).inject(this.rightContent);this.viewCreateNode=new Element("div.viewCreateNode",{styles:this.css.viewCreateNode}).inject(this.viewTitleNode);this.viewCreateNode.addEvent("click",function(t){this.viewExplorer._createElement(t)}.bind(this));this.viewTitleSepNode=new Element("div.viewTitleSepNode",{styles:this.css.viewTitleSepNode}).inject(this.viewTitleNode);this.viewTitleTextNode=new Element("div.viewTitleTextNode",{styles:this.css.viewTitleTextNode,text:"选择列表"}).inject(this.viewTitleNode);this.viewNode=new Element("div.viewNode",{styles:this.css.viewNode}).inject(this.rightContent)},loadView:function(){this.viewExplorer=new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.ViewExplorer(this.viewNode,this.app.restActions);this.viewExplorer.app=this.app;this.viewExplorer.explorer=this;this.viewExplorer.load()},loadCategoryListResize:function(){this.categoryistResize=new Drag(this.categoryListResizeNode,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var s=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:s});var o=this.naviContainerNode.getSize();t.store("initialWidth",o.x)}.bind(this),onDrag:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var s=this.elementContentNode.getSize();var o=t.retrieve("position");var n=t.retrieve("initialWidth").toFloat();var a=i.toFloat()-o.x.toFloat();var r=n+a;if(r>s.x/2)r=s.x/2;if(r<130)r=130;this.naviContainerNode.setStyle("width",r);this.rightContent.setStyle("margin-left",r+1);var l=s.x-r;this.rightContent.setStyle("width",l);this.formNode.setStyle("width",""+(l-15)+"px");this.viewNode.setStyle("width",""+(l-15)+"px");if(this.formExplorer)this.formExplorer.setContentSize();if(this.viewExplorer)this.viewExplorer.setContentSize()}.bind(this)})},loadRightContentResize:function(){this.rightContentResize=new Drag(this.rightContentResizeNode,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var s=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:s});var o=this.formNode.getSize();t.store("initialHeight",o.y)}.bind(this),onDrag:function(t,e){var i=this.rightContent.getSize();var s=Browser.name=="firefox"?e.event.clientY:e.event.y;var o=t.retrieve("position");var n=s.toFloat()-o.y.toFloat();var a=t.retrieve("initialHeight").toFloat();var r=a+n;if(r<40)r=40;if(r>i.y-40)r=i.y-40;this.formPercent=r/i.y;this.setRightContentResize()}.bind(this)})},setRightContentResize:function(){var t=this.rightContent.getSize();var e=this.rightContentResizeNode.getSize();var i=this.formTitleNode.getSize();var s=this.viewTitleNode.getSize();var o=t.y-e.y-i.y-s.y;var n=this.formPercent*o;var a=o-n;this.formNode.setStyle("height",""+n+"px");this.viewNode.setStyle("height",""+a+"px");if(this.formExplorer)this.formExplorer.setContentSize();if(this.viewExplorer)this.viewExplorer.setContentSize()},setContentSize:function(){var t=this.toolbarNode.getSize();var e=this.node.getSize();var i=this.elementContentNode.getStyle("padding-top").toFloat();var s=this.elementContentNode.getStyle("padding-bottom").toFloat();var o=this.naviContainerNode.getSize();var n=e.y-t.y-i-s;this.elementContentListNode.setStyle("height",""+n+"px");this.elementContentListNode.setStyles({width:""+e.x+"px"});this.naviArea.setStyle("height",""+n+"px");this.categoryListResizeNode.setStyle("height",""+n+"px");var a=e.x-o.x;this.rightContent.setStyle("width",""+a+"px");this.formNode.setStyle("width",""+(a-15)+"px");this.viewNode.setStyle("width",""+(a-15)+"px");this.rightContent.setStyle("height",""+n+"px");var r=this.formTitleNode.getSize();var l=this.viewTitleNode.getSize();var h=this.rightContentResizeNode.getSize();var d=n-r.y-l.y-h.y;this.formNode.setStyle("height",""+d*this.formPercent+"px");this.viewNode.setStyle("height",""+(d-d*this.formPercent)+"px")}});MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.CategoryList=new Class({Implements:[Options,Events],options:{columnId:""},initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.app=t.app;this.node=$(e);this.css=t.css;this.categoryArr=[];this.categoryObj={};this.currentCategory=null;this.currentView=null;this.load()},load:function(){var t=this;this.app.restActions.listCategory(this.options.columnId,function(t){t.data.each(function(t){this.loadCategoryByData(t)}.bind(this));this.fireEvent("postLoad")}.bind(this),function(){this.fireEvent("postLoad")}.bind(this),true)},getCurrentNode:function(){return this.currentNode},getCategoryNodes:function(){var t=[];this.categoryArr.each(function(e){t.push(e.node)}.bind(this));return t},cancelCurrentNode:function(){if(this.currentNode){if(this.currentNodeType=="category"){this.currentNode.setStyles(this.css.categoryNaviNode);this.currentCategory._hideActions()}else{this.currentNode.setStyles(this.css.viewNaviNode)}}},setCurrentCategory:function(t){this.cancelCurrentNode();this.currentCategory=t;this.currentNodeType="category";this.currentNode=t.node;t.node.setStyles(this.css.categoryNaviNode_selected);this.currentTimeout=setTimeout(function(){t._showActions();this.currentTimeout=null}.bind(this),100);this.explorer.formExplorer.refreshByCategory(t);this.explorer.viewExplorer.refreshByCategory(t)},setCurrentView:function(t){this.cancelCurrentNode();this.currentView=t;this.currentNodeType="view";this.currentNode=t.node;t.node.setStyles(this.css.viewNaviNode_selected)},destroyCategory:function(t){if(t.options.isNew){}else{var e=t.data.id;delete this.categoryObj[e];var i=this.categoryArr.indexOf(t);if(i>-1){this.categoryArr.splice(i,1)}}t.destroy()},loadCategoryByData:function(t,e,i,s){var o=new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.CategoryV2(this,this.node,t,{relativeNode:e,relativePosition:i});this.categoryObj[t.id]=o;this.categoryArr.push(o);if(s)s(o)},loadCategoryById:function(t,e,i,s){this.app.restActions.getCategory(t,function(t){var o=t.data;var n=new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.CategoryV2(this,this.node,o,{relativeNode:e,relativePosition:i});this.categoryObj[o.id]=n;this.categoryArr.push(n);if(s)s(n)}.bind(this))},adjustSeq:function(t){var e=this.node.getElements(".categoryNaviNode");var i=this.app.restActions;e.each(function(s,o){var n=s.retrieve("category");if(!n.options.isNew){var a=n.data;var r="000"+(e.length-o);a.catagorySeq=r.substr(r.length-3,3);i.saveCategory(a,null,null,t===false?false:true)}})},newCategory:function(t,e){var i=new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.CategoryV2(this,this.node,{},{isNew:true,relativeNode:t,relativePosition:e})}});MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.CategoryV2=new Class({Implements:[Options,Events],options:{style:"default",isNew:false,relativeNode:null,relativePosition:"bottom",actions_edit:[{name:"saveCategory",icon:"save.png",event:"click",action:"saveCategory",title:MWF.xApplication.cms.ColumnManager.LP.category.saveCategory},{name:"cancel",icon:"cancel.png",event:"click",action:"cancel",title:MWF.xApplication.cms.ColumnManager.LP.category.cancelEdit}],actions_read:[{name:"editCategory",icon:"edit.png",event:"click",action:"editCategory",title:MWF.xApplication.cms.ColumnManager.LP.category.editCategory},{name:"insertCateogryBefore",icon:"insertColBefore.png",event:"click",action:"insertCateogryBefore",title:MWF.xApplication.cms.ColumnManager.LP.category.insertCateogryBefore},{name:"insertCateogryAfter",icon:"insertColAfter.png",event:"click",action:"insertCateogryAfter",title:MWF.xApplication.cms.ColumnManager.LP.category.insertCateogryAfter},{name:"deleteCategory",icon:"trash.png",event:"click",action:"deleteCategory",title:MWF.xApplication.cms.ColumnManager.LP.category.deleteCategory},{name:"moveCategory",icon:"move1.png",event:"click",action:"moveCategory",title:MWF.xApplication.cms.ColumnManager.LP.category.moveCategory}]},initialize:function(t,e,i,s){this.setOptions(s);this.list=t;this.explorer=t.explorer;this.app=t.app;this.css=t.css;this.container=$(e);this.data=i;this.lp=this.app.lp.category;this.categoryViewArr=[];this.categoryViewObj={};this.load()},load:function(){var t=this;this.node=new Element("div.categoryNaviNode",{styles:this.css.categoryNaviNode}).inject(this.options.relativeNode||this.container,this.options.relativePosition||"bottom");this.node.store("category",this);this.textNode=new Element("div.categoryNaviTextNode",{styles:this.css.categoryNaviTextNode,text:this.data.name}).inject(this.node);this.node.addEvents({mouseover:function(){if(t.list.getCurrentNode()!=this&&!t.list.isOnDragging)this.setStyles(t.css.categoryNaviNode_over)},mouseout:function(){if(t.list.getCurrentNode()!=this)this.setStyles(t.css.categoryNaviNode)},click:function(){if(!t.list.isOnDragging){t.setCurrentNode(this)}}});this.loadViewNode();this.createIconAction();if(this.options.isNew){this.editCategory()}},loadViewNode:function(){var t=this.viewNaviListNode=new Element("div.viewNaviListNode",{styles:this.css.viewNaviListNode}).inject(this.node,"after");this.app.restActions.listViewByCategory(this.data.id,function(e){e.data.each(function(e){this.createViewsNode(t,e)}.bind(this));new Element("div",{styles:this.css.viewNaviSepartorNode}).inject(t)}.bind(this))},destroy:function(){this.node.destroy();this.viewNaviListNode.destroy();delete this},setCategoryView:function(t,e){var i={catagoryId:this.data.id,viewId:t};this.app.restActions.addCategoryView(i,function(e){this.app.restActions.getView(t,function(t){this.createViewsNode(this.viewNaviListNode,t.data);this.app.notice("设置分类列表成功")}.bind(this))}.bind(this),null,false)},setDefaultCategoryView:function(t,e){var i=this.data;i.defaultViewName=t;this.app.restActions.saveCategory(i,function(t){this.app.notice("设置默认视图成功")}.bind(this))},cancelCategoryView:function(t,e){this.app.restActions.listCategoryViewByCatagory(this.data.id,function(e){e.data.each(function(e){if(e.viewId==t){this.app.restActions.deleteCategoryView(e.id,function(e){var i=this.categoryViewObj[t];delete this.categoryViewObj[t];this.categoryViewArr.erase(i);i.destroy();this.app.notice("取消分类列表成功")}.bind(this),null,false)}}.bind(this))}.bind(this),null,false)},setEditForm:function(t,e){var i=this.data;i.formId=t;i.formName=e;this.app.restActions.saveCategory(i,function(t){this.app.notice("设置编辑表单成功")}.bind(this))},setReadForm:function(t,e){var i=this.data;i.readFormId=t;i.readFormName=e;this.app.restActions.saveCategory(i,function(t){this.app.notice("设置阅读表单成功")}.bind(this))},saveCategory:function(){var t=this.data||{};if(this.options.isNew){t.isNew=this.options.isNew;t.appId=this.app.options.column.id}if(this.editMode&&this.input){var e=this.input.get("value");if(e==""||e=="请输入分类名称"){this.app.notice("请输入分类名称","error");return}else{t.catagoryName=e;t.name=e}}this.app.restActions.saveCategory(t,function(t){this.list.loadCategoryById(t.data.id,this.node,"before",function(t){this.list.setCurrentCategory(t);this.list.adjustSeq(false);this.list.destroyCategory(this)}.bind(this))}.bind(this))},cancel:function(){if(this.options.isNew){this.destroy()}else{this.editMode=false;this.input.destroy();this.textNode.setStyle("display","");this._showActions()}},editCategory:function(){this.textNode.setStyle("display","none");this.editMode=true;this.input=new Element("input",{type:"text",value:this.options.isNew?"请输入分类名称":this.data.name,styles:this.css.categoryInput}).inject(this.node,"top");this.input.addEvents({click:function(t){this._showActions(true);t.stopPropagation()},focus:function(t){if(t.target.value=="请输入分类名称"){t.target.value=""}}.bind(this),blur:function(t){if(t.target.value==""){t.target.value="请输入分类名称"}}.bind(this)});this._showActions(true)},setCurrentNode:function(){this.list.setCurrentCategory(this)},createViewsNode:function(t,e){var i=new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.CategoryView(this,t,e);var s=e.isDefault?"default":e.id;this.categoryViewObj[s]=i;this.categoryViewArr.push(i)},_showActions:function(){if(this.editMode){if(this.actionArea_edit){this.actionArea_edit.setStyle("display","")}if(this.actionArea_read){this.actionArea_read.setStyle("display","none")}}else{if(this.actionArea_edit){this.actionArea_edit.setStyle("display","none")}if(this.actionArea_read){this.actionArea_read.setStyle("display","")}}},_hideActions:function(){if(this.actionArea_read)this.actionArea_read.setStyle("display","none");if(this.actionArea_edit){this.actionArea_edit.setStyle("display","none")}},createIconAction:function(){this.actionNodes=this.actionNodes||{};if(!this.actionArea_read){this.actionArea_read=new Element("div",{styles:this.css.actionArea}).inject(this.node);this.options.actions_read.each(function(t){var e=this.actionNodes[t.name]=new Element("div",{styles:this.css.actionNodeStyles,title:t.title}).inject(this.actionArea_read);e.setStyle("background","url("+this.explorer.path+this.options.style+"/icon/"+t.icon+") no-repeat left center");e.addEvent(t.event,function(e){this[t.action](e);e.stopPropagation()}.bind(this));e.addEvents({mouseover:function(t){t.target.setStyle("border","1px solid #999")}.bind(this),mouseout:function(t){t.target.setStyle("border","1px solid #eee")}.bind(this)})}.bind(this))}if(!this.actionArea_edit){this.actionArea_edit=new Element("div",{styles:this.css.actionArea}).inject(this.node);this.options.actions_edit.each(function(t){var e=this.actionNodes[t.name]=new Element("div",{styles:this.css.actionNodeStyles,title:t.title}).inject(this.actionArea_edit);e.setStyle("background","url("+this.explorer.path+this.options.style+"/icon/"+t.icon+") no-repeat left center");e.addEvent(t.event,function(e){this[t.action](e);e.stopPropagation()}.bind(this));e.addEvents({mouseover:function(t){t.target.setStyle("border","1px solid #999")}.bind(this),mouseout:function(t){t.target.setStyle("border","1px solid #eee")}.bind(this)})}.bind(this))}},insertCateogryBefore:function(t){this.list.newCategory(this.node,"before")},insertCateogryAfter:function(t){this.list.newCategory(this.viewNaviListNode,"after")},deleteCategory:function(t){var e=this;this.app.confirm("warn",this.actionNodes.deleteCategory,this.lp.deleteCategoryTitle,this.lp.deleteCategoryConfirm,300,120,function(){e._deleteCategory();this.close()},function(){this.close()})},_deleteCategory:function(t){this.app.restActions.removeCategory(this.data.id,function(){this.node.destroy();this.viewNaviListNode.destroy();if(t)t()}.bind(this),function(t,e,i){var s=i;if(t)s=t.responseText;if(s.indexOf("referenced")>-1){var o=this.explorer.app.lp.category;var e=o.deleteFailAsHasDocument.replace(/{title}/g,this.data.name);this.app.notice(e,"error")}}.bind(this))},moveCategory:function(t){this._createMoveNode();this._setNodeMove(t)},_createMoveNode:function(){this.moveNode=new Element("div",{styles:this.css.moduleNodeMove,text:this.node.get("text"),events:{selectstart:function(){return false}}}).inject(this.container)},_setNodeMove:function(t){this._setMoveNodePosition(t);var e=this.list.getCategoryNodes();var i=new Drag.Move(this.moveNode,{droppables:e,onEnter:function(t,e){var i=e.retrieve("category");if(i)i._dragIn(this)}.bind(this),onLeave:function(t,e){var i=e.retrieve("category");if(i)i._dragOut(this)}.bind(this),onDrag:function(t){this.list.isOnDragging=true;this._setScroll()}.bind(this),onDrop:function(t,e,i){if(e){var s=e.retrieve("category");if(s){this._dragComplete(s);s._dragDrop(this)}else{this._dragCancel(t)}}else{this._dragCancel(t)}if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}setTimeout(function(){this.list.isOnDragging=false}.bind(this),100);i.stopPropagation()}.bind(this),onCancel:function(t){if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}setTimeout(function(){this.list.isOnDragging=false}.bind(this),100)}.bind(this)});i.start(t)},_dragIn:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode_dragIn)},_dragOut:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode)},_dragDrop:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode)},_dragComplete:function(t){this.node.inject(t.viewNaviListNode,"after");this.viewNaviListNode.inject(this.node,"after");this.setCurrentNode();if(this.moveNode)this.moveNode.destroy();this.moveNode=null;this.list.adjustSeq()},_dragCancel:function(){if(this.moveNode)this.moveNode.destroy();this.moveNode=null},_setScroll:function(){var t=this.explorer.naviArea;var e=t.getCoordinates();var i=e.top;var s=i+e.height;var o=this.explorer.naviNode;var n=this.moveNode.getCoordinates();if(n.top<i&&n.bottom>i){if(!this.dragInterval){this.dragInterval=setInterval(function(){if(t.getScroll().y-15>0){t.scrollTo(0,t.getScroll().y-15)}else{t.scrollTo(0,0)}}.bind(this),100)}}else if(n.top<s&&n.bottom>s){if(!this.dragInterval){this.dragInterval=setInterval(function(){if(t.getScroll().y+15<o.getSize().y){t.scrollTo(0,t.getScroll().y+15)}else{t.scrollTo(0,o.getSize().y)}}.bind(this),100)}}else{if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}}},_setMoveNodePosition:function(t){var e=t.page.x+2;var i=t.page.y+2;this.moveNode.positionTo(e,i)}});MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.CategoryView=new Class({Implements:[Options,Events],initialize:function(t,e,i,s){this.setOptions(s);this.category=t;this.list=t.list;this.explorer=t.explorer;this.app=t.app;this.css=t.css;this.container=$(e);this.data=i;this.load()},destroy:function(){this.node.destroy();delete this},load:function(){var t=this;this.node=new Element("div.viewNaviNode",{styles:this.css.viewNaviNode,text:this.data.isDefault?this.app.lp.defaultView:this.data.name}).inject(this.container);this.node.addEvents({mouseover:function(){if(t.list.getCurrentNode()!=this)this.setStyles(t.css.viewNaviNode_over)},mouseout:function(){if(t.list.getCurrentNode()!=this)this.setStyles(t.css.viewNaviNode)},click:function(e){t.setCurrentNode(this)}})},setCurrentNode:function(){this.list.setCurrentView(this)}});MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.FormExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.FormExplorer,Implements:[Options,Events],load:function(){this.loadContentNode();this.setNodeScroll();this.refresh()},refreshByCategory:function(t){this.currentCategory=t;var e=t.data.formId;var i=t.data.formName;var s=t.data.readFormId;this.currentEditForm=null;this.currentReadForm=null;this.refresh(t,function(){this.itemArray.each(function(t){var i=t.data;if(i.id==e){this.currentEditForm=t;t.setEditFormStyle()}else if(i.id==s){this.currentReadForm=t;t.setReadFormStyle()}else{t.setNormalStyle()}}.bind(this))}.bind(this))},refresh:function(t,e){if(this.noElementNode)this.noElementNode.destroy();if(!t){this.itemArray.each(function(t){t.node.setStyle("display","none")});this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:"请先新建或选择分类"}).inject(this.elementContentListNode)}else if(t.options.isNew){this.itemArray.each(function(t){t.node.setStyle("display","none")});this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:"请先保存分类"}).inject(this.elementContentListNode)}else{if(this.itemArray&&this.itemArray.length){this.itemArray.each(function(t){t.node.setStyle("display","")});if(e)e()}else{this.loadElementList(e)}}},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node);this.elementContentListNode=new Element("div",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);this.setContentSize();this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0};var e=this.node.getSize();var i=this.elementContentNode.getStyle("padding-top").toFloat();var s=this.elementContentNode.getStyle("padding-bottom").toFloat();var o=e.y-t.y-i-s;var n=e.x-50;this.elementContentNode.setStyle("height",""+o+"px");this.elementContentListNode.setStyles({width:""+n+"px"})},loadElementList:function(t){this._loadItemDataList(function(e){if(e.data.length){e.data.each(function(t){var e=this._getItemObject(t);e.load();this.itemObject[t.id]=e;this.itemArray.push(e)}.bind(this));if(t)t()}else{var i=this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:this.options.tooltip.noElement}).inject(this.elementContentListNode);i.addEvent("click",function(t){this._createElement(t)}.bind(this))}}.bind(this))},_getItemObject:function(t){return new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.Form(this,t)},_loadItemDataList:function(t){this.app.restActions.listForm(this.app.options.column.id,t,null,false)}});MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.Form=new Class({Extends:MWF.xApplication.cms.ColumnManager.FormExplorer.Form,initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.app=t.app;this.css=this.explorer.css;this.lp=this.app.lp.form;this.data=e;this.container=this.explorer.elementContentListNode;this.icon="form.png"},load:function(){this.node=new Element("div",{styles:this.css.itemNode,events:{mouseover:function(){if(this.actionsArea)this.actionsArea.setStyle("display","")}.bind(this),mouseout:function(){if(this.actionsArea)this.actionsArea.setStyle("display","none")}.bind(this)}}).inject(this.container);if(this.data.name.icon)this.icon=this.data.name.icon;var t=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon;var e=new Element("div",{styles:this.css.itemIconNode}).inject(this.node);e.setStyle("background","url("+t+") center center no-repeat");e.makeLnk({par:this._getLnkPar()});this.actionsArea=new Element("div.formActionsArea",{styles:this.css.formActionsArea}).inject(this.node);this.setEditAction=new Element("div.setEditAction",{styles:this.css.setEditAction,title:"设为编辑表单"}).inject(this.actionsArea);this.setEditAction.addEvents({click:function(t){this.setEditForm()}.bind(this)});this.setReadAction=new Element("div.setReadAction",{styles:this.css.setReadAction,title:"设为阅读表单"}).inject(this.actionsArea);this.setReadAction.addEvents({click:function(t){this.setReadForm()}.bind(this)});if(!this.explorer.options.noDelete){this.deleteActionNode=new Element("div.deleteAction",{styles:this.css.deleteAction,title:"删除"}).inject(this.actionsArea);this.deleteActionNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this))}var i=new Element("div",{styles:this.css.itemInforNode}).inject(this.node);var s=new Element("div",{styles:this.css.itemInforBaseNode}).inject(i);new Element("div",{styles:this.css.itemTextTitleNode,text:this.data.name,title:this.data.name,events:{click:function(t){this._open(t);t.stopPropagation()}.bind(this)}}).inject(s);new Element("div",{styles:this.css.itemTextDateNode,text:this.data.updateTime||""}).inject(s);new Element("div",{styles:this.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(i);this._isNew()},setEditForm:function(){if(this.explorer.currentEditForm){this.explorer.currentEditForm.setNormalStyle()}this.setEditFormStyle();this.explorer.currentEditForm=this;this.explorer.currentCategory.setEditForm(this.data.id,this.data.name);this.explorer.explorer.viewExplorer.refreshByForm(this.data.id,this.data.name)},setReadForm:function(){if(this.explorer.currentReadForm){this.explorer.currentReadForm.setNormalStyle()}this.setReadFormStyle();this.explorer.currentCategory.setReadForm(this.data.id,this.data.name);this.explorer.currentReadForm=this},setEditFormStyle:function(){this.node.setStyles({"background-color":"#e6f3ff"})},setReadFormStyle:function(){this.node.setStyles({"background-color":"#dbfecd"})},setNormalStyle:function(){this.node.setStyles(this.css.itemNode)},deleteItem:function(t){var e=this;this.explorer.app.confirm("warn",t.target,this.lp.deleteFormTitle,this.lp.deleteForm,300,120,function(){e._deleteItem();this.close()},function(){this.close()})},_deleteItem:function(t){this.explorer.app.restActions.deleteForm(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))}});MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.ViewExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.ViewExplorer,Implements:[Options,Events],load:function(){this.loadContentNode();this.setNodeScroll();this.loadElementList()},refreshByCategory:function(t){this.category=t;this.options.categoryId=t.data.id;this.options.defaultViewId=t.data.defaultViewName;this.options.formId=t.data.formId;this.options.formName=t.data.formName;this.reload()},refreshByForm:function(t,e){this.options.formId=t;this.options.formName=e;this.reload()},loadElementList:function(){if(!this.category){var t=new Element("div",{styles:this.css.noElementNode,text:"请先新建或选择分类"}).inject(this.elementContentListNode)}else if(this.category.options.isNew){var t=new Element("div",{styles:this.css.noElementNode,text:"请先保存分类"}).inject(this.elementContentListNode)}else{this._loadItemDataList(function(t){if(t.data.length){t.data.each(function(t){var e=this._getItemObject(t);e.load();this.itemObject[t.id]=e;this.itemArray.push(e)}.bind(this))}else{var e=new Element("div",{styles:this.css.noElementNode,text:"未设置表单“"+(this.options.formName||"")+"”的关联列表，点击创建关联列表"}).inject(this.elementContentListNode);if(!this.options.noCreate){e.addEvent("click",function(t){this._createElement(t)}.bind(this))}}}.bind(this))}},_loadItemDataList:function(t){var e=this.options.categoryId;var i=this.options.formId;this.categoryViewData=[];this.categoryViewIds=[];if(i){if(e){this.actions.listViewByCategory(e,function(t){this.categoryViewData=t.data;t.data.each(function(t){this.categoryViewIds.push(t.id)}.bind(this))}.bind(this),null,false)}this.actions.listViewByForm(i,t)}else{var s=new Element("div",{styles:this.css.noElementNode,text:e?"请先设置分类的编辑表单！":"请先选择分类！"}).inject(this.elementContentListNode)}},_createElement:function(t){var e=this;layout.desktop.getFormDesignerStyle(function(){var i={style:layout.desktop.formDesignerStyle,onQueryLoad:function(){this.actions=e.app.restActions;this.column=e.app.options.column;this.application=e.app.options.column;this.relativeForm={name:e.options.formName,id:e.options.formId}},onPostSave:function(){e.reload()}};layout.desktop.openApplication(t,"cms.ViewDesigner",i)}.bind(this))},_getItemObject:function(t){var e=this.options.defaultViewId==t.id;var i=new MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.View(this,t,{isCategoryView:this.categoryViewIds.indexOf(t.id)>-1,isCategoryDefaultView:e});if(e)this.defaultView=i;return i}});MWF.xApplication.cms.ColumnManager.CategoryExplorerV2.View=new Class({Extends:MWF.xApplication.cms.ColumnManager.ViewExplorer.View,Implements:[Options],options:{where:"bottom",isCategoryView:false,isCategoryDefaultView:false},initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.css=this.explorer.css;this.data=e;this.container=this.explorer.elementContentListNode;this.icon="list.png"},load:function(){this.node=new Element("div",{styles:this.css.itemNode,events:{mouseover:function(){if(this.actionsArea)this.actionsArea.setStyle("display","")}.bind(this),mouseout:function(){if(this.actionsArea)this.actionsArea.setStyle("display","none")}.bind(this)}}).inject(this.container);if(this.data.name.icon)this.icon=this.data.name.icon;var t=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon;var e=new Element("div",{styles:this.css.itemIconNode}).inject(this.node);e.setStyle("background","url("+t+") center center no-repeat");e.makeLnk({par:this._getLnkPar()});this.actionsArea=new Element("div.viewActionsArea",{styles:this.css.viewActionsArea}).inject(this.node);this.cancelCategoryViewAction=new Element("div.cancelCategoryViewAction",{styles:this.css.cancelCategoryViewAction,title:"取消分类列表"}).inject(this.actionsArea);this.cancelCategoryViewAction.addEvents({click:function(t){this.cancelCategoryView()}.bind(this)});this.setCategoryViewAction=new Element("div.setCategoryViewAction",{styles:this.css.setCategoryViewAction,title:"设为分类列表"}).inject(this.actionsArea);this.setCategoryViewAction.addEvents({click:function(t){this.setCategoryView()}.bind(this)});if(this.options.isCategoryView){this.setCategoryViewAction.setStyle("display","none")}else{this.cancelCategoryViewAction.setStyle("display","none")}this.setDefaultCategoryViewAction=new Element("div.setDefaultCategoryViewAction",{styles:this.css.setDefaultCategoryViewAction,title:"设为分类默认列表"}).inject(this.actionsArea);this.setDefaultCategoryViewAction.addEvents({click:function(t){this.setDefaultCategoryView()}.bind(this)});if(!this.explorer.options.noDelete){
this.deleteActionNode=new Element("div.deleteAction",{styles:this.css.deleteAction,title:"删除"}).inject(this.actionsArea);this.deleteActionNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this))}var i=new Element("div",{styles:this.css.itemInforNode}).inject(this.node);var s=new Element("div",{styles:this.css.itemInforBaseNode}).inject(i);new Element("div",{styles:this.css.itemTextTitleNode,text:this.data.name,title:this.data.name,events:{click:function(t){this._open(t);t.stopPropagation()}.bind(this)}}).inject(s);new Element("div",{styles:this.css.itemTextDateNode,text:this.data.updateTime||""}).inject(s);new Element("div",{styles:this.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(i);this._customNodes();this._isNew()},setCategoryView:function(){if(this.options.isCategoryView){return}this.options.isCategoryView=true;this.setCategoryViewAction.setStyle("display","none");this.cancelCategoryViewAction.setStyle("display","");this.explorer.category.setCategoryView(this.data.id,this.data.name);this.setStyle()},cancelCategoryView:function(){if(!this.options.isCategoryView){return}this.options.isCategoryView=false;this.setCategoryViewAction.setStyle("display","");this.cancelCategoryViewAction.setStyle("display","none");this.explorer.category.cancelCategoryView(this.data.id,this.data.name);this.setStyle()},setDefaultCategoryView:function(){if(this.explorer.defaultView){this.explorer.defaultView.cancelDefaultView()}this.explorer.category.setDefaultCategoryView(this.data.id,this.data.name);this.options.isCategoryDefaultView=true;this.explorer.defaultView=this;this.setStyle()},cancelDefaultView:function(){this.options.isCategoryDefaultView=false;this.setStyle()},setStyle:function(){if(this.options.isCategoryDefaultView){this.setDefaultCategoryViewStyle()}else if(this.options.isCategoryView){this.setCategoryViewStyle()}else{this.setNormalStyle()}},setNormalStyle:function(){this.node.setStyles({"background-color":"#fff"})},setCategoryViewStyle:function(){this.node.setStyles({"background-color":"#e6f3ff"})},setDefaultCategoryViewStyle:function(){this.node.setStyles({"background-color":"#dbfecd"})},_customNodes:function(){if(this.options.isCategoryView){this.setCategoryViewStyle()}if(this.options.isCategoryDefaultView){this.setDefaultCategoryViewStyle()}},_open:function(t){var e=this;var i={onQueryLoad:function(){this.actions=e.explorer.actions;this.category=e;this.options.id=e.data.id;this.column=e.explorer.app.options.column;this.application=e.explorer.app.options.column;this.options.noModifyName=e.explorer.options.noModifyName;this.options.readMode=e.explorer.options.readMode,this.options.formId=e.data.formId}};this.explorer.app.desktop.openApplication(t,"cms.ViewDesigner",i)},_getIcon:function(){var t=(Math.random()*33).toInt();return"process_icon_"+t+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/viewIcon/lnk.png",title:this.data.name,par:'cms.ViewDesigner#{"id": "'+this.data.id+'"}'}},deleteView:function(t){this.explorer.app.restActions.deleteView(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))}});